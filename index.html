<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventuras de Acero y Runas</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg-dark: #0a0908;
            --bg-panel: #1a1614;
            --bg-panel-light: #2a2320;
            --bg-input: #151210;
            --gold: #d4a437;
            --gold-dim: #a67c00;
            --gold-bright: #ffd700;
            --red: #8b0000;
            --red-bright: #dc143c;
            --green: #2d5a27;
            --green-bright: #4caf50;
            --blue: #1e3a5f;
            --blue-bright: #4a9eff;
            --purple: #4a1a6b;
            --purple-bright: #9c27b0;
            --orange: #ff6b35;
            --text: #e8dcc4;
            --text-dim: #8a8078;
            --border: #3d3530;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Crimson Text', Georgia, serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        .main-nav {
            display: flex;
            justify-content: center;
            background: var(--bg-panel);
            border-bottom: 2px solid var(--gold-dim);
            position: sticky;
            top: 0;
            z-index: 50;
            flex-wrap: wrap;
        }

        .nav-btn {
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            padding: 0.5rem 0.9rem;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn:hover { color: var(--gold); }
        .nav-btn.active { color: var(--gold-bright); background: rgba(212,164,55,0.15); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .firebase-status {
            position: fixed;
            top: 0.3rem;
            right: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.6rem;
            background: var(--bg-panel);
            padding: 0.1rem 0.3rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            z-index: 100;
        }

        .status-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--red);
        }

        .status-dot.connected { background: var(--green-bright); }

        /* Game Layout */
        .game-container {
            display: grid;
            grid-template-columns: 1fr 240px;
            gap: 0.5rem;
            max-width: 1100px;
            margin: 0 auto;
            padding: 0.5rem;
            min-height: calc(100vh - 38px);
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .panel-title {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            color: var(--gold);
            margin-bottom: 0.4rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* Story */
        .story-panel {
            grid-row: 1 / 3;
            display: flex;
            flex-direction: column;
            max-height: 75vh;
        }

        .story-content {
            flex: 1;
            overflow-y: auto;
            line-height: 1.55;
            font-size: 0.88rem;
            padding-right: 0.3rem;
        }

        .story-content::-webkit-scrollbar { width: 3px; }
        .story-content::-webkit-scrollbar-thumb { background: var(--gold-dim); }

        .story-entry {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 3px;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; } }

        .story-narrative {
            background: linear-gradient(135deg, rgba(30,25,22,0.95), rgba(45,38,33,0.8));
            border-left: 3px solid var(--gold-dim);
            font-style: italic;
            line-height: 1.65;
        }

        .story-combat {
            background: rgba(139,0,0,0.18);
            border-left: 3px solid var(--red);
        }

        .story-loot {
            background: rgba(212,164,55,0.18);
            border-left: 3px solid var(--gold);
        }

        .story-system {
            background: rgba(74,158,255,0.12);
            border-left: 3px solid var(--blue-bright);
            font-size: 0.8rem;
        }

        .story-trap {
            background: rgba(255,107,53,0.18);
            border-left: 3px solid var(--orange);
        }

        .story-choice {
            background: var(--bg-panel-light);
            border: 1px dashed var(--gold-dim);
            text-align: center;
            padding: 0.6rem;
        }

        .story-dialogue {
            background: rgba(156,39,176,0.12);
            border-left: 3px solid var(--purple-bright);
        }

        /* Combat Arena */
        .combat-arena {
            display: none;
            grid-column: 1 / -1;
            background: linear-gradient(180deg, rgba(139,0,0,0.2), transparent);
            border: 2px solid var(--red);
            border-radius: 6px;
            padding: 0.6rem;
        }

        .combat-arena.active { display: block; }

        .combat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid var(--red);
        }

        .combat-title {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            color: var(--red-bright);
        }

        .turn-indicator {
            background: var(--red);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
        }

        .combat-main {
            display: grid;
            grid-template-columns: 1fr 260px;
            gap: 0.6rem;
        }

        .combatants-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
        }

        .combatant {
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 5px;
            padding: 0.4rem;
            text-align: center;
            min-width: 120px;
        }

        .combatant.player { border-color: var(--gold-dim); }
        .combatant.enemy { border-color: var(--red); }

        .combatant-sprite { font-size: 1.8rem; margin-bottom: 0.15rem; }
        .combatant-sprite img { width: 56px; height: 56px; object-fit: contain; image-rendering: pixelated; }

        .combatant-name { font-family: 'Cinzel', serif; font-size: 0.8rem; }
        .combatant-stats { font-size: 0.65rem; color: var(--text-dim); margin-bottom: 0.25rem; }

        .hp-bar-container {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 3px;
            height: 16px;
            position: relative;
            overflow: hidden;
        }

        .hp-bar-fill { height: 100%; transition: width 0.4s; }
        .hp-bar-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 0.6rem;
            color: white;
            text-shadow: 1px 1px 1px black;
            top: 50%;
            transform: translateY(-50%);
        }

        .hp-high { background: linear-gradient(180deg, var(--green-bright), var(--green)); }
        .hp-medium { background: linear-gradient(180deg, var(--gold-bright), var(--gold-dim)); }
        .hp-low { background: linear-gradient(180deg, var(--orange), #cc4400); }
        .hp-critical { background: linear-gradient(180deg, var(--red-bright), var(--red)); animation: pulse 1s infinite; }

        @keyframes pulse { 50% { opacity: 0.7; } }

        .vs-icon { font-size: 1.1rem; color: var(--gold); }

        .effects-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.15rem; margin-top: 0.25rem; min-height: 16px; }
        .effect-tag { font-size: 0.55rem; padding: 0.08rem 0.2rem; border-radius: 2px; }
        .eff-bleed { background: rgba(139,0,0,0.6); border: 1px solid var(--red); }
        .eff-poison { background: rgba(0,100,0,0.6); border: 1px solid var(--green-bright); }
        .eff-fire { background: rgba(255,100,0,0.5); border: 1px solid orange; }

        .combat-log {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            max-height: 180px;
        }

        .combat-log-header {
            background: var(--bg-panel-light);
            padding: 0.3rem;
            font-family: 'Cinzel', serif;
            font-size: 0.65rem;
            color: var(--gold);
            border-bottom: 1px solid var(--border);
        }

        .combat-log-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.3rem;
            font-size: 0.7rem;
        }

        .log-turn-header {
            background: var(--bg-panel-light);
            color: var(--gold);
            padding: 0.2rem;
            margin: 0.2rem -0.3rem;
            text-align: center;
            font-size: 0.65rem;
        }

        .log-entry { padding: 0.15rem 0; border-bottom: 1px dashed rgba(255,255,255,0.08); }
        .log-section { margin: 0.15rem 0; padding-left: 0.3rem; border-left: 2px solid var(--border); }
        .log-section.player-action { border-left-color: var(--gold-dim); }
        .log-section.enemy-action { border-left-color: var(--red); }
        .log-damage { color: var(--orange); }
        .log-heal { color: var(--green-bright); }
        .log-miss { color: var(--text-dim); font-style: italic; }
        .log-crit { color: var(--gold-bright); font-weight: bold; }
        .log-dice { color: var(--blue-bright); font-family: monospace; }

        .combat-actions {
            display: flex;
            justify-content: center;
            gap: 0.35rem;
            flex-wrap: wrap;
            margin-top: 0.4rem;
            padding-top: 0.4rem;
            border-top: 1px solid var(--border);
        }

        /* Character Panel */
        .char-panel { font-size: 0.75rem; overflow-y: auto; max-height: 40vh; }
        .char-section { margin-bottom: 0.4rem; }

        .char-header { display: flex; align-items: center; gap: 0.35rem; margin-bottom: 0.3rem; }
        .char-avatar {
            font-size: 1.5rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-dark);
            border: 2px solid var(--gold-dim);
            border-radius: 4px;
        }

        .char-name { font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--gold-bright); }
        .char-race { font-size: 0.65rem; color: var(--text-dim); }

        .health-section .bar-outer {
            height: 14px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .health-section .bar-inner { height: 100%; transition: width 0.4s; }
        .health-section .bar-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 0.6rem;
            color: white;
            text-shadow: 1px 1px black;
            top: 50%;
            transform: translateY(-50%);
        }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.2rem; }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.15rem 0.25rem;
            background: var(--bg-panel-light);
            border-radius: 2px;
            font-size: 0.65rem;
        }
        .stat-label { color: var(--text-dim); }
        .stat-value { color: var(--gold); }

        .equip-slot {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem;
            background: var(--bg-panel-light);
            border-radius: 3px;
            margin-bottom: 0.2rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .equip-slot:hover:not(.disabled) { border-color: var(--gold-dim); background: var(--bg-dark); }
        .equip-slot.disabled { opacity: 0.5; cursor: not-allowed; }

        .equip-icon { font-size: 1rem; width: 22px; text-align: center; }
        .equip-icon img { width: 22px; height: 22px; object-fit: contain; }
        .equip-name { font-size: 0.7rem; }
        .equip-stats { font-size: 0.6rem; color: var(--text-dim); }

        .currency-row { display: flex; gap: 0.5rem; font-size: 0.75rem; }
        .coin-gold { color: var(--gold-bright); }
        .coin-silver { color: #c0c0c0; }

        .location-badge {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.2rem 0.4rem;
            font-size: 0.65rem;
            text-align: center;
        }
        .location-badge.safe { border-color: var(--green); color: var(--green-bright); }
        .location-badge.danger { border-color: var(--red); color: var(--red-bright); }

        /* Actions */
        .actions-panel { grid-column: 1 / -1; }
        .actions-grid { display: flex; flex-wrap: wrap; gap: 0.35rem; }

        .action-btn {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            padding: 0.35rem 0.7rem;
            background: var(--bg-panel-light);
            border: 1px solid var(--gold-dim);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 2px;
        }

        .action-btn:hover:not(:disabled) { background: var(--gold-dim); color: var(--bg-dark); transform: translateY(-1px); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn.primary { background: var(--gold-dim); color: var(--bg-dark); }
        .action-btn.danger { border-color: var(--red); color: var(--red-bright); }
        .action-btn.danger:hover:not(:disabled) { background: var(--red); color: white; }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 100;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 0.75rem;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-panel);
            border: 2px solid var(--gold-dim);
            border-radius: 6px;
            padding: 0.85rem;
            max-width: 550px;
            width: 100%;
            max-height: 82vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-large { max-width: 750px; }

        .modal-close {
            position: absolute;
            top: 0.3rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.1rem;
            cursor: pointer;
        }
        .modal-close:hover { color: var(--gold); }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            color: var(--gold);
            margin-bottom: 0.6rem;
            text-align: center;
            padding-bottom: 0.35rem;
            border-bottom: 1px solid var(--border);
        }

        /* Item Detail */
        .item-detail { text-align: center; }
        .item-detail-icon { font-size: 3rem; margin-bottom: 0.3rem; }
        .item-detail-icon img { width: 72px; height: 72px; object-fit: contain; image-rendering: pixelated; }
        .item-detail-name { font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--gold-bright); }
        .item-detail-type { color: var(--text-dim); font-size: 0.75rem; margin-bottom: 0.6rem; }
        .item-detail-desc {
            background: var(--bg-dark);
            padding: 0.6rem;
            border-radius: 4px;
            margin-bottom: 0.6rem;
            text-align: left;
            line-height: 1.5;
            font-size: 0.8rem;
        }
        .item-detail-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 0.35rem; margin-bottom: 0.6rem; }
        .item-stat { background: var(--bg-panel-light); padding: 0.35rem; border-radius: 3px; }
        .item-stat-label { font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; }
        .item-stat-value { font-size: 0.85rem; color: var(--gold); font-family: 'Cinzel', serif; }
        .item-detail-actions { display: flex; gap: 0.35rem; justify-content: center; flex-wrap: wrap; }

        /* Inventory */
        .inventory-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.25rem; }
        .inv-slot {
            aspect-ratio: 1;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.1rem;
        }
        .inv-slot:hover { border-color: var(--gold-dim); transform: scale(1.03); }
        .inv-slot-icon { font-size: 1.3rem; }
        .inv-slot-icon img { width: 28px; height: 28px; object-fit: contain; }
        .inv-slot-name { font-size: 0.48rem; text-align: center; color: var(--text-dim); margin-top: 0.08rem; line-height: 1; max-height: 1.6em; overflow: hidden; }
        .inv-slot-empty { color: var(--text-dim); font-size: 0.5rem; }

        .rarity-common { border-color: #555; }
        .rarity-rare { border-color: var(--blue-bright); }
        .rarity-epic { border-color: var(--purple-bright); }
        .rarity-legendary { border-color: var(--gold-bright); box-shadow: 0 0 4px var(--gold); }

        /* Editor */
        .editor-container { max-width: 1050px; margin: 0 auto; padding: 0.6rem; }
        .editor-tabs { display: flex; gap: 0.15rem; flex-wrap: wrap; background: var(--bg-panel); padding: 0.25rem; border-radius: 4px; margin-bottom: 0.5rem; }
        .editor-tab {
            padding: 0.3rem 0.6rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 0.65rem;
            border-radius: 2px;
        }
        .editor-tab:hover { border-color: var(--gold-dim); color: var(--gold); }
        .editor-tab.active { background: var(--gold-dim); color: var(--bg-dark); }

        .editor-section { display: none; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 0.65rem; }
        .editor-section.active { display: block; }
        .editor-section h3 { font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 0.5rem; font-size: 0.85rem; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.4rem; margin-bottom: 0.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.12rem; }
        .form-group label { font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea {
            background: var(--bg-input);
            border: 1px solid var(--border);
            padding: 0.3rem;
            color: var(--text);
            font-size: 0.75rem;
            border-radius: 3px;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--gold-dim); }
        .form-actions { display: flex; gap: 0.35rem; justify-content: flex-end; padding-top: 0.35rem; border-top: 1px solid var(--border); }

        .items-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 0.3rem; margin-top: 0.5rem; max-height: 200px; overflow-y: auto; }
        .item-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.3rem;
            display: flex;
            gap: 0.3rem;
            align-items: center;
            font-size: 0.7rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .item-card:hover { border-color: var(--gold-dim); }
        .item-card-icon { font-size: 1.1rem; width: 24px; text-align: center; }
        .item-card-icon img { width: 24px; height: 24px; object-fit: contain; }
        .item-card-info { flex: 1; }
        .item-card-name { color: var(--gold); font-size: 0.75rem; }
        .item-card-stats { color: var(--text-dim); font-size: 0.6rem; }
        .item-card-actions { display: flex; gap: 0.15rem; }

        .icon-btn { background: none; border: 1px solid var(--border); color: var(--text-dim); padding: 0.12rem 0.2rem; cursor: pointer; font-size: 0.55rem; border-radius: 2px; }
        .icon-btn:hover { border-color: var(--gold-dim); color: var(--gold); }
        .icon-btn.delete:hover { border-color: var(--red); color: var(--red-bright); }

        .multi-select { background: var(--bg-input); border: 1px solid var(--border); border-radius: 3px; padding: 0.3rem; max-height: 80px; overflow-y: auto; font-size: 0.7rem; }
        .multi-select label { display: flex; align-items: center; gap: 0.3rem; padding: 0.08rem; cursor: pointer; }

        .sprite-preview { width: 44px; height: 44px; background: var(--bg-dark); border: 1px dashed var(--border); border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
        .sprite-preview img { max-width: 100%; max-height: 100%; object-fit: contain; image-rendering: pixelated; }

        /* Toast */
        .toast-container { position: fixed; top: 2.2rem; right: 0.6rem; z-index: 200; }
        .toast { padding: 0.35rem 0.7rem; border-radius: 3px; margin-bottom: 0.25rem; animation: slideIn 0.3s, fadeOut 0.3s 2.5s forwards; font-size: 0.75rem; }
        @keyframes slideIn { from { transform: translateX(100%); } }
        @keyframes fadeOut { to { opacity: 0; } }
        .toast.success { background: var(--green); }
        .toast.error { background: var(--red); }
        .toast.info { background: var(--blue); }

        /* Dice */
        .dice-display { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 1rem 1.25rem; border-radius: 8px; border: 2px solid var(--gold-dim); text-align: center; z-index: 150; }
        .dice-display.active { display: block; }
        .dice-icon { font-size: 2.2rem; animation: roll 0.4s; }
        @keyframes roll { 0% { transform: rotate(0) scale(0.5); } 50% { transform: rotate(180deg) scale(1.2); } 100% { transform: rotate(360deg) scale(1); } }
        .dice-label { font-size: 0.7rem; color: var(--text-dim); margin-top: 0.15rem; }
        .dice-result { font-family: 'Cinzel', serif; font-size: 1.6rem; color: var(--gold-bright); margin-top: 0.15rem; }
        .dice-result.crit { color: var(--red-bright); text-shadow: 0 0 8px var(--red); font-size: 1.8rem; }

        /* Rules */
        .rules-container { max-width: 750px; margin: 0 auto; padding: 0.6rem; }
        .rules-section { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 0.6rem; margin-bottom: 0.5rem; }
        .rules-section h3 { font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 0.35rem; font-size: 0.85rem; }
        .rules-table { width: 100%; border-collapse: collapse; margin: 0.25rem 0; font-size: 0.75rem; }
        .rules-table th, .rules-table td { border: 1px solid var(--border); padding: 0.25rem; text-align: left; }
        .rules-table th { background: var(--bg-panel-light); color: var(--gold); }
        .highlight-box { background: var(--bg-dark); border-left: 3px solid var(--gold); padding: 0.4rem; margin: 0.25rem 0; font-size: 0.8rem; }

        @media (max-width: 768px) {
            .game-container { grid-template-columns: 1fr; }
            .combat-main { grid-template-columns: 1fr; }
            .combatants-row { flex-direction: column; }
            .vs-icon { display: none; }
            .inventory-grid { grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>
<body>
    <div class="firebase-status"><div class="status-dot" id="fbDot"></div><span id="fbText">...</span></div>

    <nav class="main-nav">
        <button class="nav-btn active" onclick="switchTab('game')">‚öîÔ∏è Juego</button>
        <button class="nav-btn" onclick="switchTab('rules')">üìú Reglas</button>
        <button class="nav-btn" onclick="switchTab('editor')">üõ†Ô∏è Editor</button>
    </nav>

    <!-- GAME TAB -->
    <div class="tab-content active" id="gameTab">
        <div class="game-container">
            <div class="combat-arena" id="combatArena">
                <div class="combat-header">
                    <div class="combat-title">‚öîÔ∏è COMBATE</div>
                    <div class="turn-indicator">Turno <span id="turnNumber">1</span></div>
                </div>
                <div class="combat-main">
                    <div>
                        <div class="combatants-row">
                            <div class="combatant player">
                                <div class="combatant-sprite" id="pSprite">üßô</div>
                                <div class="combatant-name" id="pCombatName">Jugador</div>
                                <div class="combatant-stats">‚öîÔ∏è <span id="pCombatDmg">1d4</span> | üõ°Ô∏è <span id="pCombatDef">0</span></div>
                                <div class="hp-bar-container"><div class="hp-bar-text" id="pHpText">20/20</div><div class="hp-bar-fill hp-high" id="pHpBar" style="width:100%"></div></div>
                                <div class="effects-row" id="pEffects"></div>
                            </div>
                            <div class="vs-icon">‚öî</div>
                            <div class="combatant enemy">
                                <div class="combatant-sprite" id="eSprite">üëπ</div>
                                <div class="combatant-name" id="eCombatName">Enemigo</div>
                                <div class="combatant-stats">‚öîÔ∏è <span id="eCombatDmg">1d6</span> | Dif: <span id="eCombatDiff">10</span></div>
                                <div class="hp-bar-container"><div class="hp-bar-text" id="eHpText">30/30</div><div class="hp-bar-fill hp-high" id="eHpBar" style="width:100%"></div></div>
                                <div class="effects-row" id="eEffects"></div>
                            </div>
                        </div>
                        <div class="combat-actions" id="combatActions"></div>
                    </div>
                    <div class="combat-log">
                        <div class="combat-log-header">üìú Registro</div>
                        <div class="combat-log-content" id="combatLogContent"></div>
                    </div>
                </div>
            </div>

            <main class="story-panel panel">
                <h2 class="panel-title">üìñ Cr√≥nica</h2>
                <div class="story-content" id="storyContent"></div>
            </main>

            <aside class="char-panel panel">
                <h2 class="panel-title">Personaje</h2>
                <div class="char-section">
                    <div class="char-header">
                        <div class="char-avatar" id="charAvatar">üßô</div>
                        <div><div class="char-name" id="charName">---</div><div class="char-race" id="charRace">---</div></div>
                    </div>
                </div>
                <div class="char-section health-section">
                    <div class="bar-outer"><div class="bar-text" id="hpDisplay">0/0</div><div class="bar-inner hp-high" id="hpBar" style="width:100%"></div></div>
                </div>
                <div class="char-section"><div class="location-badge" id="locationBadge">üìç Zona Segura</div></div>
                <div class="char-section">
                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-label">Armadura</span><span class="stat-value" id="statArm">0</span></div>
                        <div class="stat-item"><span class="stat-label">Evasi√≥n</span><span class="stat-value" id="statEva">0</span></div>
                        <div class="stat-item"><span class="stat-label">Precisi√≥n</span><span class="stat-value" id="statPrec">0</span></div>
                        <div class="stat-item"><span class="stat-label">Da√±o+</span><span class="stat-value" id="statDmg">0</span></div>
                    </div>
                </div>
                <div class="char-section">
                    <div class="equip-slot" id="weaponSlot" onclick="handleEquipClick('weapon')">
                        <div class="equip-icon" id="weaponIcon">‚öîÔ∏è</div>
                        <div><div class="equip-name" id="weaponName">---</div><div class="equip-stats" id="weaponStats">---</div></div>
                    </div>
                    <div class="equip-slot" id="armorSlot" onclick="handleEquipClick('armor')">
                        <div class="equip-icon" id="armorIcon">üõ°Ô∏è</div>
                        <div><div class="equip-name" id="armorName">---</div><div class="equip-stats" id="armorStats">---</div></div>
                    </div>
                </div>
                <div class="char-section">
                    <div class="currency-row">
                        <span><span class="coin-gold">‚óè</span> <span id="goldAmt">0</span> MO</span>
                        <span><span class="coin-silver">‚óè</span> <span id="silverAmt">0</span> MP</span>
                    </div>
                </div>
                <div class="char-section" id="petSection" style="display:none;">
                    <div class="panel-title" style="font-size:0.6rem;">Compa√±ero</div>
                    <div id="petDisplay"></div>
                </div>
            </aside>

            <nav class="actions-panel panel">
                <div class="actions-grid" id="actionsGrid"></div>
            </nav>
        </div>
    </div>

    <!-- RULES TAB -->
    <div class="tab-content" id="rulesTab">
        <div class="rules-container">
            <div class="rules-section">
                <h3>‚öîÔ∏è Combate</h3>
                <div class="highlight-box"><strong>Atacar:</strong> D20 ‚â• dificultad enemigo ‚Üí Aciertas<br><strong>Cr√≠tico:</strong> 20 natural = da√±o √ó2<br><strong>Esquivar:</strong> D20 ‚â• 12 ‚Üí Esquivas</div>
                <table class="rules-table"><tr><th>Enemigo</th><th>Dificultad</th></tr><tr><td>D√©bil</td><td>6-8</td></tr><tr><td>Moderado</td><td>9-12</td></tr><tr><td>Fuerte</td><td>13-15</td></tr><tr><td>√âpico</td><td>16-18</td></tr><tr><td>Legendario</td><td>19-20</td></tr></table>
            </div>
            <div class="rules-section">
                <h3>ü™§ Trampas</h3>
                <p style="font-size:0.8rem;">1. <strong>Detectar:</strong> D20 ‚â• dificultad de la trampa<br>2. <strong>Esquivar/Desactivar:</strong> D20 ‚â• 12</p>
                <table class="rules-table"><tr><th>Trampa</th><th>Da√±o</th><th>Efecto</th></tr><tr><td>P√∫as</td><td>1d6</td><td>Sangrado</td></tr><tr><td>Dardo venenoso</td><td>1d4</td><td>Veneno</td></tr><tr><td>Foso</td><td>2d6</td><td>-</td></tr><tr><td>Runa explosiva</td><td>2d8</td><td>Fuego</td></tr></table>
            </div>
            <div class="rules-section">
                <h3>üéí Equipamiento</h3>
                <p style="font-size:0.8rem;">Solo puedes cambiar arma/armadura en <strong>zonas seguras</strong> (pueblo, descanso). Durante el combate no es posible cambiar equipo.</p>
            </div>
        </div>
    </div>

    <!-- EDITOR TAB -->
    <div class="tab-content" id="editorTab">
        <div class="editor-container">
            <div class="editor-tabs">
                <button class="editor-tab active" onclick="switchEditorTab('weapons')">‚öîÔ∏è Armas</button>
                <button class="editor-tab" onclick="switchEditorTab('armors')">üõ°Ô∏è Armaduras</button>
                <button class="editor-tab" onclick="switchEditorTab('items')">üéí Items</button>
                <button class="editor-tab" onclick="switchEditorTab('enemies')">üëπ Enemigos</button>
                <button class="editor-tab" onclick="switchEditorTab('pets')">üê∫ Mascotas</button>
                <button class="editor-tab" onclick="switchEditorTab('npcs')">üßî NPCs</button>
            </div>

            <div class="editor-section active" id="weaponsEditor">
                <h3>‚öîÔ∏è Armas <span style="font-size:0.7rem;color:var(--text-dim);">(Base + Personalizadas)</span></h3>
                <div class="form-grid">
                    <div class="form-group"><label>Nombre</label><input type="text" id="wName" placeholder="Espada..."></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="wDamage" placeholder="1d8"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="wIcon" placeholder="‚öîÔ∏è" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="wSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Rareza</label><select id="wRarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="wValue" placeholder="50"></div>
                    <div class="form-group"><label>Efecto</label><select id="wEffect"><option value="">Ninguno</option><option value="bleed">Sangrado</option><option value="poison">Veneno</option><option value="fire">Fuego</option></select></div>
                    <div class="form-group"><label>Descripci√≥n</label><input type="text" id="wDesc" placeholder="Una espada..."></div>
                </div>
                <div class="form-actions"><button class="action-btn" onclick="clearForm('weapon')">Limpiar</button><button class="action-btn primary" onclick="saveWeapon()">üíæ Guardar</button></div>
                <div class="items-list" id="weaponsList"></div>
            </div>

            <div class="editor-section" id="armorsEditor">
                <h3>üõ°Ô∏è Armaduras</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Nombre</label><input type="text" id="aName" placeholder="Cota..."></div>
                    <div class="form-group"><label>Defensa</label><input type="number" id="aDefense" placeholder="3"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="aIcon" placeholder="üõ°Ô∏è" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="aSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Rareza</label><select id="aRarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="aValue" placeholder="100"></div>
                    <div class="form-group"><label>Descripci√≥n</label><input type="text" id="aDesc" placeholder="Armadura..."></div>
                </div>
                <div class="form-actions"><button class="action-btn" onclick="clearForm('armor')">Limpiar</button><button class="action-btn primary" onclick="saveArmor()">üíæ Guardar</button></div>
                <div class="items-list" id="armorsList"></div>
            </div>

            <div class="editor-section" id="itemsEditor">
                <h3>üéí Items</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Nombre</label><input type="text" id="iName" placeholder="Poci√≥n..."></div>
                    <div class="form-group"><label>Tipo</label><select id="iType"><option value="potion">Poci√≥n</option><option value="food">Comida</option><option value="antidote">Ant√≠doto</option><option value="escape">Escape</option><option value="backpack">Mochila</option><option value="misc">Otro</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="iIcon" placeholder="üß™" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="iSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Efecto</label><input type="text" id="iEffect" placeholder="1d8"></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="iValue" placeholder="10"></div>
                    <div class="form-group"><label>Descripci√≥n</label><input type="text" id="iDesc" placeholder="Restaura..."></div>
                </div>
                <div class="form-actions"><button class="action-btn" onclick="clearForm('item')">Limpiar</button><button class="action-btn primary" onclick="saveItem()">üíæ Guardar</button></div>
                <div class="items-list" id="itemsList"></div>
            </div>

            <div class="editor-section" id="enemiesEditor">
                <h3>üëπ Enemigos</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Nombre</label><input type="text" id="enName" placeholder="Troll..."></div>
                    <div class="form-group"><label>Salud</label><input type="number" id="enHealth" placeholder="30"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="enDamage" placeholder="1d8"></div>
                    <div class="form-group"><label>Dificultad</label><select id="enDiff"><option value="6">D√©bil (6)</option><option value="10">Moderado (10)</option><option value="14">Fuerte (14)</option><option value="17">√âpico (17)</option><option value="19">Legendario (19)</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="enIcon" placeholder="üëπ" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="enSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Efecto ataque</label><select id="enEffect"><option value="">Ninguno</option><option value="bleed">Sangrado</option><option value="poison">Veneno</option><option value="fire">Fuego</option></select></div>
                    <div class="form-group"><label>H√°bitat</label><select id="enHabitat"><option value="any">Cualquiera</option><option value="forest">Bosque</option><option value="dungeon">Mazmorra</option><option value="mountain">Monta√±a</option><option value="swamp">Pantano</option></select></div>
                    <div class="form-group"><label>MP min</label><input type="number" id="enLootMin" placeholder="5"></div>
                    <div class="form-group"><label>MP max</label><input type="number" id="enLootMax" placeholder="20"></div>
                </div>
                <div class="form-group"><label>Narrativa de encuentro</label><textarea id="enDesc" rows="2" placeholder="El troll emerge de las sombras..."></textarea></div>
                <div class="form-group"><label>Drops</label><div class="multi-select" id="enDropsSelect"></div></div>
                <div class="form-actions"><button class="action-btn" onclick="clearForm('enemy')">Limpiar</button><button class="action-btn primary" onclick="saveEnemy()">üíæ Guardar</button></div>
                <div class="items-list" id="enemiesList"></div>
            </div>

            <div class="editor-section" id="petsEditor">
                <h3>üê∫ Mascotas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Nombre</label><input type="text" id="petName" placeholder="Lobo..."></div>
                    <div class="form-group"><label>Salud</label><input type="number" id="petHealth" placeholder="20"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="petDamage" placeholder="1d6"></div>
                    <div class="form-group"><label>Dificultad</label><select id="petDiff"><option value="24">Com√∫n (D24)</option><option value="30">Raro (D30)</option><option value="60">√âpico (D60)</option><option value="100">Legendario (D100)</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="petIcon" placeholder="üê∫" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="petSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Descripci√≥n</label><input type="text" id="petDesc" placeholder="Un lobo..."></div>
                </div>
                <div class="form-actions"><button class="action-btn" onclick="clearForm('pet')">Limpiar</button><button class="action-btn primary" onclick="savePet()">üíæ Guardar</button></div>
                <div class="items-list" id="petsList"></div>
            </div>

            <div class="editor-section" id="npcsEditor">
                <h3>üßî NPCs</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Nombre</label><input type="text" id="npcName" placeholder="Aldric..."></div>
                    <div class="form-group"><label>Rol</label><select id="npcRole"><option value="merchant">Comerciante</option><option value="blacksmith">Herrero</option><option value="alchemist">Alquimista</option><option value="innkeeper">Tabernero</option><option value="baker">Panadero</option><option value="healer">Curandero</option><option value="guard">Guardia</option><option value="questgiver">Misiones</option><option value="villager">Aldeano</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="npcIcon" placeholder="üßî" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="npcSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Ubicaci√≥n</label><input type="text" id="npcLocation" placeholder="Plaza..."></div>
                    <div class="form-group"><label>Di√°logo</label><input type="text" id="npcDialogue" placeholder="¬°Bienvenido!"></div>
                </div>
                <div class="form-group"><label>Items que vende</label><div class="multi-select" id="npcShopSelect"></div></div>
                <div class="form-actions"><button class="action-btn" onclick="clearForm('npc')">Limpiar</button><button class="action-btn primary" onclick="saveNpc()">üíæ Guardar</button></div>
                <div class="items-list" id="npcsList"></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="inventoryModal">
        <div class="modal modal-large">
            <button class="modal-close" onclick="closeModal('inventoryModal')">&times;</button>
            <h3 class="modal-title">üéí Inventario</h3>
            <div id="invInfo" style="text-align:center;margin-bottom:0.4rem;color:var(--text-dim);font-size:0.75rem;"></div>
            <div class="inventory-grid" id="invGrid"></div>
        </div>
    </div>

    <div class="modal-overlay" id="itemDetailModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('itemDetailModal')">&times;</button>
            <div class="item-detail">
                <div class="item-detail-icon" id="detailIcon">üì¶</div>
                <div class="item-detail-name" id="detailName">Item</div>
                <div class="item-detail-type" id="detailType">Tipo</div>
                <div class="item-detail-desc" id="detailDesc">Descripci√≥n...</div>
                <div class="item-detail-stats" id="detailStats"></div>
                <div class="item-detail-actions" id="detailActions"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="townModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('townModal')">&times;</button>
            <h3 class="modal-title">üèòÔ∏è Pueblo</h3>
            <div id="townContent"></div>
        </div>
    </div>

    <div class="modal-overlay" id="shopModal">
        <div class="modal modal-large">
            <button class="modal-close" onclick="closeModal('shopModal')">&times;</button>
            <h3 class="modal-title" id="shopTitle">üè™ Tienda</h3>
            <div id="shopContent"></div>
        </div>
    </div>

    <div class="dice-display" id="diceDisplay">
        <div class="dice-icon">üé≤</div>
        <div class="dice-label" id="diceLabel">D20</div>
        <div class="dice-result" id="diceResult">--</div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <script>
        // ==================== FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAV4eSg9QjyE08zwtFsvjAomuMYVcNik9k",
            authDomain: "rpggo-756a7.firebaseapp.com",
            databaseURL: "https://rpggo-756a7-default-rtdb.firebaseio.com",
            projectId: "rpggo-756a7",
            storageBucket: "rpggo-756a7.firebasestorage.app",
            messagingSenderId: "640446076493",
            appId: "1:640446076493:web:d220244451bf1a3e006e04"
        };

        let db = null, fbConnected = false;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            db.ref('.info/connected').on('value', s => {
                fbConnected = s.val() === true;
                document.getElementById('fbDot').classList.toggle('connected', fbConnected);
                document.getElementById('fbText').textContent = fbConnected ? '‚úì' : '‚úó';
                if (fbConnected) loadFromFirebase();
            });
        } catch(e) { console.error(e); }

        // ==================== DATA ====================
        const customData = { weapons: [], armors: [], items: [], enemies: [], pets: [], npcs: [] };

        const BASE_RACES = [
            { name: 'Humano', bonus: { health: 1 }, icon: 'üßë', desc: '+1 HP' },
            { name: 'Elfo', bonus: { precision: 1 }, icon: 'üßù', desc: '+1 Precisi√≥n' },
            { name: 'Enano', bonus: { armor: 1 }, icon: 'üßî', desc: '+1 Armadura' },
            { name: 'Orco', bonus: { damage: 1 }, icon: 'üëπ', desc: '+1 Da√±o' },
            { name: 'Mediano', bonus: { evasion: 1 }, icon: 'üßí', desc: '+1 Evasi√≥n' }
        ];

        const BASE_WEAPONS = [
            { id: 'bw1', name: 'Daga', damage: '1d4', icon: 'üó°Ô∏è', value: 10, rarity: 'common', desc: 'Una daga oxidada pero afilada. Perfecta para ataques r√°pidos.' },
            { id: 'bw2', name: 'Espada corta', damage: '1d6', icon: '‚öîÔ∏è', value: 20, rarity: 'common', desc: 'Espada de hoja equilibrada, el arma est√°ndar de todo aventurero.' },
            { id: 'bw3', name: 'Hacha de mano', damage: '1d6', icon: 'ü™ì', value: 20, rarity: 'common', desc: 'Hacha ligera que puede lanzarse o usarse en combate cercano.' },
            { id: 'bw4', name: 'Bast√≥n', damage: '1d4', icon: 'ü™Ñ', value: 10, rarity: 'common', desc: 'Bast√≥n de madera reforzada con punta de hierro.' }
        ];

        const BASE_ARMORS = [
            { id: 'ba1', name: 'T√∫nica de cuero', defense: 1, icon: 'ü¶∫', value: 15, rarity: 'common', desc: 'Cuero curtido que ofrece protecci√≥n b√°sica.' },
            { id: 'ba2', name: 'Cuero reforzado', defense: 2, icon: 'ü¶∫', value: 30, rarity: 'common', desc: 'Cuero con placas de metal cosidas.' },
            { id: 'ba3', name: 'Cota de malla', defense: 3, icon: '‚õìÔ∏è', value: 75, rarity: 'rare', desc: 'Anillos de acero entrelazados. Pesada pero resistente.' },
            { id: 'ba4', name: 'T√∫nica de tela', defense: 0, icon: 'üëï', value: 5, rarity: 'common', desc: 'Simple ropa de viaje. No ofrece protecci√≥n.' }
        ];

        const BASE_ITEMS = [
            { id: 'bi1', name: 'Poci√≥n menor', type: 'potion', effect: '1d8', icon: 'üß™', value: 10, rarity: 'common', desc: 'Un l√≠quido rojizo que restaura 1d8 puntos de salud.' },
            { id: 'bi2', name: 'Poci√≥n de man√°', type: 'potion', effect: '1d4', icon: 'üíß', value: 10, rarity: 'common', desc: 'Esencia azulada que restaura energ√≠a m√°gica.' },
            { id: 'bi3', name: 'Ant√≠doto', type: 'antidote', icon: 'üíä', value: 15, rarity: 'common', desc: 'Contraveneno que purifica la sangre.' },
            { id: 'bi4', name: 'Bomba de humo', type: 'escape', icon: 'üí®', value: 25, rarity: 'common', desc: 'Permite escapar del combate al instante.' },
            { id: 'bi5', name: 'Pergamino', type: 'scroll', icon: 'üìú', value: 20, rarity: 'common', desc: 'Pergamino con inscripciones arcanas.' },
            { id: 'bi6', name: 'Linterna', type: 'tool', icon: 'üî¶', value: 15, rarity: 'common', desc: 'Ilumina lugares oscuros.' },
            { id: 'bi7', name: 'Carne', type: 'food', effect: '1d4', icon: 'ü•©', value: 5, rarity: 'common', desc: 'Carne fresca. Restaura salud y sirve para domesticar.' }
        ];

        const BASE_ENEMIES = [
            { id: 'be1', name: 'Rata Gigante', health: 10, damage: '1d4', difficulty: 6, icon: 'üêÄ', loot: [5, 10], drops: ['bi1'], habitat: 'dungeon', desc: 'El sonido de garras raspando piedra te alerta. Una rata del tama√±o de un perro emerge de las sombras, sus ojos rojos brillando con hambre primaria. Sus dientes amarillentos gotean saliva mientras se prepara para atacar.' },
            { id: 'be2', name: 'Goblin', health: 15, damage: '1d6', difficulty: 8, icon: 'üë∫', loot: [8, 15], drops: ['bi1', 'bw1'], habitat: 'forest', desc: 'Un crujido de ramas rompe el silencio del bosque. Un goblin escu√°lido salta desde los arbustos, blandiendo una daga oxidada. Su risa aguda y maliciosa resuena entre los √°rboles mientras adopta una postura amenazante.' },
            { id: 'be3', name: 'Esqueleto', health: 20, damage: '1d6', difficulty: 10, icon: 'üíÄ', loot: [10, 25], drops: ['bi1'], habitat: 'ruins', desc: 'Los huesos crujen y se recomponen ante tus ojos. Un esqueleto antiguo se alza de su tumba olvidada, sus cuencas vac√≠as brillando con una luz antinatural. Empu√±a un arma oxidada con determinaci√≥n sobrenatural.' },
            { id: 'be4', name: 'Orco Guerrero', health: 35, damage: '1d8', difficulty: 12, icon: 'üëπ', loot: [20, 40], drops: ['bw2'], habitat: 'mountain', desc: 'Un gru√±ido gutural anuncia su presencia. Un orco musculoso, cubierto de cicatrices de batalla, bloquea el camino. Su hacha de guerra, manchada con sangre seca, descansa sobre su hombro mientras te eval√∫a como presa.' },
            { id: 'be5', name: 'Troll', health: 50, damage: '2d6', difficulty: 14, icon: 'üßå', loot: [40, 80], drops: ['ba2'], habitat: 'swamp', desc: 'El suelo tiembla con cada paso. Un troll gigantesco emerge del pantano, su piel verde cubierta de musgo y lodo. El hedor a putrefacci√≥n te golpea mientras la criatura ruge, mostrando colmillos del tama√±o de dagas.' },
            { id: 'be6', name: 'Drag√≥n Joven', health: 80, damage: '2d8', difficulty: 17, effect: 'fire', icon: 'üêâ', loot: [100, 200], drops: [], habitat: 'mountain', desc: 'Un rugido ensordecedor hace eco en las monta√±as. El drag√≥n desciende en espiral, sus escamas brillando como rub√≠es bajo el sol. Llamas danzan entre sus fauces mientras aterriza, agrietando la roca bajo sus garras.' }
        ];

        const BASE_PETS = [
            { id: 'bp1', name: 'Lobo', health: 20, damage: '1d6', difficulty: 24, icon: 'üê∫', desc: 'Un lobo solitario te observa desde la maleza, sus ojos ambarinos evalu√°ndote con cautela.' },
            { id: 'bp2', name: 'Oso', health: 35, damage: '1d8', difficulty: 30, icon: 'üêª', desc: 'Un oso pardo gru√±e suavemente, olfateando el aire en tu direcci√≥n.' },
            { id: 'bp3', name: '√Åguila', health: 15, damage: '1d4', difficulty: 24, icon: 'ü¶Ö', desc: 'Un √°guila majestuosa planea en c√≠rculos sobre ti, su mirada penetrante.' },
            { id: 'bp4', name: 'Tigre', health: 30, damage: '2d6', difficulty: 60, icon: 'üêØ', desc: 'Un tigre descansa entre las sombras, su pelaje rayado camufl√°ndolo perfectamente.' }
        ];

        const BASE_NPCS = [
            { id: 'bn1', name: 'Grimbold', role: 'blacksmith', icon: 'üßî', location: 'Herrer√≠a', dialogue: '"¬°Ah, un cliente! Mis armas son las mejores del reino, forjadas con fuego de drag√≥n."', sells: ['bw1', 'bw2', 'bw3'] },
            { id: 'bn2', name: 'Elara', role: 'alchemist', icon: 'üßô‚Äç‚ôÄÔ∏è', location: 'Botica', dialogue: '"Bienvenido a mi humilde establecimiento. Mis pociones pueden curar... o matar."', sells: ['bi1', 'bi2', 'bi3'] },
            { id: 'bn3', name: 'Tobias', role: 'innkeeper', icon: 'üßë‚Äçüç≥', location: 'Taberna El Jabal√≠ Dorado', dialogue: '"¬°Si√©ntate, amigo! Una cerveza fr√≠a y un plato caliente curan el alma del aventurero."', sells: ['bi7'] }
        ];

        const TRAPS = [
            { name: 'Trampa de p√∫as', damage: '1d6', effect: 'bleed', detectDiff: 10, dodgeDiff: 12, narrative: 'Un ligero clic resuena bajo tu pie. El suelo cede revelando un foso lleno de p√∫as oxidadas, dispuestas en √°ngulos mortales. El mecanismo, aunque antiguo, sigue siendo letal.' },
            { name: 'Dardo venenoso', damage: '1d4', effect: 'poison', detectDiff: 12, dodgeDiff: 10, narrative: 'Un destello met√°lico en la pared capta tu atenci√≥n. Peque√±os orificios ocultos entre las piedras esconden dardos impregnados de un l√≠quido verdoso. Un paso en falso activar√≠a el resorte.' },
            { name: 'Foso oculto', damage: '2d6', effect: null, detectDiff: 8, dodgeDiff: 14, narrative: 'Las tablas del suelo crujen de forma sospechosa. Debajo, un foso profundo lleno de escombros puntiagudos y huesos de v√≠ctimas anteriores espera su pr√≥xima presa.' },
            { name: 'Runa explosiva', damage: '2d8', effect: 'fire', detectDiff: 14, dodgeDiff: 12, narrative: 'S√≠mbolos arcanos grabados en el suelo comienzan a brillar con una luz p√∫rpura amenazante. La runa m√°gica pulsa con energ√≠a destructiva, acumulando poder para detonar.' }
        ];

        const LOCATIONS = {
            danger: [
                { name: 'Bosque Sombr√≠o', habitat: 'forest', narratives: [
                    'Los √°rboles centenarios se alzan como gigantes silenciosos, sus ramas entrelazadas formando un dosel que apenas deja pasar la luz. El aire est√° cargado de humedad y el olor a hojas en descomposici√≥n.',
                    'Un sendero apenas visible serpentea entre helechos gigantes y ra√≠ces retorcidas. Los sonidos del bosque ‚Äîcrujidos, aleteos, susurros‚Äî te mantienen alerta.',
                    'La niebla se arrastra entre los troncos como dedos fantasmales. Cada sombra parece moverse, cada silencio parece una amenaza contenida.'
                ]},
                { name: 'Ruinas Antiguas', habitat: 'ruins', narratives: [
                    'Columnas rotas y arcos derrumbados cuentan la historia de una civilizaci√≥n olvidada. Las inscripciones en las paredes, erosionadas por el tiempo, guardan secretos indescifrables.',
                    'El viento silba entre las piedras ca√≠das, creando melod√≠as fantasmales. Fragmentos de mosaicos coloridos asoman bajo capas de polvo y escombros.',
                    'Una escalera de caracol desciende hacia la oscuridad. El eco de tus pasos resuena en c√°maras que no han conocido la luz del sol en siglos.'
                ]},
                { name: 'Pantano Maldito', habitat: 'swamp', narratives: [
                    'El agua estancada burbujea con gases nocivos, liberando un hedor que quema la garganta. √Årboles muertos se alzan como espectros sobre el lodo.',
                    'Cada paso es una lucha contra el barro que succiona tus botas. Insectos zumban alrededor mientras luces fantasmales danzan sobre las aguas turbias.',
                    'Un puente de madera podrida cruza un tramo de agua negra. Algo se mueve bajo la superficie, creando ondas que no presagian nada bueno.'
                ]},
                { name: 'Caverna Profunda', habitat: 'dungeon', narratives: [
                    'La oscuridad es casi absoluta. El goteo constante del agua crea un ritmo hipn√≥tico mientras estalactitas brillan con minerales desconocidos.',
                    'El t√∫nel se estrecha, oblig√°ndote a agacharte. Marcas de garras en las paredes sugieren que no eres el √∫nico que ha pasado por aqu√≠.',
                    'Una c√°mara natural se abre ante ti, iluminada por hongos bioluminiscentes. Sus esporas flotan en el aire como peque√±as estrellas azuladas.'
                ]},
                { name: 'Paso de Monta√±a', habitat: 'mountain', narratives: [
                    'El viento a√∫lla entre los picos nevados, cortando como cuchillos de hielo. El sendero serpentea al borde de precipicios vertiginosos.',
                    'Rocas sueltas amenazan con ceder bajo tus pies. A lo lejos, el rugido de una avalancha recuerda la fragilidad de la vida en estas alturas.',
                    'Una cueva natural ofrece refugio temporal del clima inclemente. Huesos ro√≠dos cerca de la entrada sugieren que algo m√°s la considera su hogar.'
                ]}
            ],
            safe: [
                { name: 'Claro del Bosque', narratives: [
                    'Un rayo de sol ilumina un peque√±o claro donde flores silvestres danzan con la brisa. El canto de los p√°jaros y el murmullo de un arroyo cercano ofrecen paz.',
                    '√Årboles frutales rodean este oasis de tranquilidad. El aroma dulce de las frutas maduras llena el aire.'
                ]},
                { name: 'Refugio de Piedra', narratives: [
                    'Una peque√±a cueva natural ofrece protecci√≥n perfecta. Restos de fogatas anteriores indican que otros viajeros han descansado aqu√≠ con seguridad.',
                    'Las paredes de piedra, lisas por el paso del tiempo, irradian un calor reconfortante. Este lugar parece bendecido contra el mal.'
                ]}
            ]
        };

        const EXPLORATION_INTROS = [
            'Te adentras en lo desconocido, cada paso resonando con determinaci√≥n...',
            'El camino se bifurca ante ti. Siguiendo tu instinto, eliges la senda menos transitada...',
            'Una brisa cargada de presagios acaricia tu rostro mientras avanzas...',
            'El terreno se vuelve m√°s agreste, se√±ales de peligro se hacen evidentes...',
            'Tus sentidos se agudizan mientras exploras este territorio hostil...',
            'Las sombras parecen alargarse a tu paso, como si el lugar mismo te observara...'
        ];

        function getAllWeapons() { return [...BASE_WEAPONS, ...customData.weapons]; }
        function getAllArmors() { return [...BASE_ARMORS, ...customData.armors]; }
        function getAllItems() { return [...BASE_ITEMS, ...customData.items]; }
        function getAllEnemies() { return [...BASE_ENEMIES, ...customData.enemies]; }
        function getAllPets() { return [...BASE_PETS, ...customData.pets]; }
        function getAllNpcs() { return [...BASE_NPCS, ...customData.npcs]; }

        function findItem(id) {
            return getAllWeapons().find(x => x.id === id) || getAllArmors().find(x => x.id === id) || getAllItems().find(x => x.id === id);
        }

        function getSprite(item) {
            if (item?.sprite) return `<img src="${item.sprite}" alt="${item.name}">`;
            return item?.icon || 'üì¶';
        }

        // ==================== GAME STATE ====================
        let game = { player: null, inCombat: false, enemy: null, turn: 0, location: { name: 'Pueblo', type: 'safe' } };

        // ==================== UTILITIES ====================
        function roll(n) { if (typeof n === 'number') return n; const m = String(n).match(/(\d+)?d(\d+)([+-]\d+)?/i); if (!m) return parseInt(n) || 0; let t = parseInt(m[3]) || 0; for (let i = 0; i < (parseInt(m[1]) || 1); i++) t += Math.floor(Math.random() * parseInt(m[2])) + 1; return Math.max(1, t); }
        function d20() { return Math.floor(Math.random() * 20) + 1; }
        function dX(x) { return Math.floor(Math.random() * x) + 1; }
        function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function hpClass(pct) { return pct > 60 ? 'hp-high' : pct > 30 ? 'hp-medium' : pct > 15 ? 'hp-low' : 'hp-critical'; }
        function toast(msg, type = 'info') { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg; document.getElementById('toasts').appendChild(t); setTimeout(() => t.remove(), 3000); }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        async function showDice(result, sides = 20, crit = false) {
            const d = document.getElementById('diceDisplay');
            document.getElementById('diceLabel').textContent = `D${sides}`;
            document.getElementById('diceResult').textContent = result;
            document.getElementById('diceResult').classList.toggle('crit', crit);
            d.classList.add('active');
            await new Promise(r => setTimeout(r, 600));
            d.classList.remove('active');
        }

        // ==================== STORY ====================
        function addStory(txt, type = '') { const c = document.getElementById('storyContent'); const d = document.createElement('div'); d.className = 'story-entry ' + (type ? 'story-' + type : ''); d.innerHTML = txt; c.appendChild(d); c.scrollTop = c.scrollHeight; }
        function clearCombatLog() { document.getElementById('combatLogContent').innerHTML = ''; }
        function addTurnHeader(n) { document.getElementById('combatLogContent').innerHTML += `<div class="log-turn-header">‚ïê TURNO ${n} ‚ïê</div>`; }
        function addLogSection(title, entries, type = '') { let h = `<div class="log-section ${type}"><div style="font-size:0.6rem;color:var(--text-dim);">${title}</div>`; entries.forEach(e => h += `<div class="log-entry ${e.cls||''}">${e.text}</div>`); document.getElementById('combatLogContent').innerHTML += h + '</div>'; document.getElementById('combatLogContent').scrollTop = 99999; }

        // ==================== UI ====================
        function updateUI() {
            const p = game.player; if (!p) return;
            document.getElementById('charAvatar').textContent = p.race.icon;
            document.getElementById('charName').textContent = p.name;
            document.getElementById('charRace').textContent = `${p.race.name} (${p.race.desc})`;
            const pct = (p.hp / p.maxHp) * 100;
            document.getElementById('hpDisplay').textContent = `${p.hp} / ${p.maxHp}`;
            document.getElementById('hpBar').style.width = pct + '%';
            document.getElementById('hpBar').className = 'bar-inner ' + hpClass(pct);
            document.getElementById('statArm').textContent = p.totalArmor();
            document.getElementById('statEva').textContent = p.race.bonus.evasion || 0;
            document.getElementById('statPrec').textContent = p.race.bonus.precision || 0;
            document.getElementById('statDmg').textContent = p.race.bonus.damage || 0;
            document.getElementById('weaponIcon').innerHTML = getSprite(p.weapon);
            document.getElementById('weaponName').textContent = p.weapon.name;
            document.getElementById('weaponStats').textContent = `Da√±o: ${p.weapon.damage}`;
            document.getElementById('armorIcon').innerHTML = getSprite(p.armor);
            document.getElementById('armorName').textContent = p.armor.name;
            document.getElementById('armorStats').textContent = `Def: ${p.armor.defense}`;
            document.getElementById('goldAmt').textContent = p.gold;
            document.getElementById('silverAmt').textContent = p.silver;
            const locBadge = document.getElementById('locationBadge');
            locBadge.className = 'location-badge ' + (game.location.type === 'safe' ? 'safe' : 'danger');
            locBadge.textContent = `üìç ${game.location.name}`;
            const canEquip = !game.inCombat && game.location.type === 'safe';
            document.getElementById('weaponSlot').classList.toggle('disabled', !canEquip);
            document.getElementById('armorSlot').classList.toggle('disabled', !canEquip);
            const petSec = document.getElementById('petSection');
            if (p.pet) { petSec.style.display = 'block'; const pp = (p.pet.hp / p.pet.maxHp) * 100; document.getElementById('petDisplay').innerHTML = `<div style="display:flex;gap:0.3rem;align-items:center;background:var(--bg-dark);padding:0.25rem;border-radius:3px;border:1px solid var(--green);"><span style="font-size:1.2rem;">${getSprite(p.pet)}</span><div style="flex:1;"><div style="color:var(--green-bright);font-size:0.7rem;">${p.pet.name}</div><div class="hp-bar-container" style="height:6px;"><div class="hp-bar-fill ${hpClass(pp)}" style="width:${pp}%"></div></div><div style="font-size:0.55rem;color:var(--text-dim);">${p.pet.hp}/${p.pet.maxHp}</div></div></div>`; } else { petSec.style.display = 'none'; }
        }

        function updateCombatUI() {
            const p = game.player, e = game.enemy;
            document.getElementById('turnNumber').textContent = game.turn;
            document.getElementById('pSprite').innerHTML = getSprite({ icon: p.race.icon });
            document.getElementById('pCombatName').textContent = p.name;
            document.getElementById('pCombatDmg').textContent = p.weapon.damage;
            document.getElementById('pCombatDef').textContent = p.totalArmor();
            const pp = (p.hp / p.maxHp) * 100;
            document.getElementById('pHpText').textContent = `${p.hp}/${p.maxHp}`;
            document.getElementById('pHpBar').style.width = pp + '%';
            document.getElementById('pHpBar').className = 'hp-bar-fill ' + hpClass(pp);
            document.getElementById('pEffects').innerHTML = p.effects.map(ef => `<span class="effect-tag eff-${ef.type}">${ef.type} ${ef.turns}t</span>`).join('');
            document.getElementById('eSprite').innerHTML = getSprite(e);
            document.getElementById('eCombatName').textContent = e.name;
            document.getElementById('eCombatDmg').textContent = e.damage;
            document.getElementById('eCombatDiff').textContent = e.difficulty;
            const ep = (e.hp / e.maxHp) * 100;
            document.getElementById('eHpText').textContent = `${e.hp}/${e.maxHp}`;
            document.getElementById('eHpBar').style.width = ep + '%';
            document.getElementById('eHpBar').className = 'hp-bar-fill ' + hpClass(ep);
            document.getElementById('eEffects').innerHTML = (e.effects || []).map(ef => `<span class="effect-tag eff-${ef.type}">${ef.type} ${ef.turns}t</span>`).join('');
            const ca = document.getElementById('combatActions'); ca.innerHTML = '';
            [{ text: '‚öîÔ∏è Atacar', fn: playerAttack, cls: 'primary' }, { text: 'üéí Item', fn: () => { renderInventory(); openModal('inventoryModal'); } }, { text: 'üõ°Ô∏è Defender', fn: playerDefend }, { text: 'üí® Huir', fn: attemptFlee, cls: 'danger' }].forEach(a => { const b = document.createElement('button'); b.className = 'action-btn ' + (a.cls || ''); b.textContent = a.text; b.onclick = a.fn; ca.appendChild(b); });
        }

        // ==================== EQUIPMENT ====================
        function handleEquipClick(slot) {
            if (game.inCombat) { toast('No puedes cambiar equipo en combate', 'error'); return; }
            if (game.location.type !== 'safe') { toast('Solo en zona segura', 'error'); return; }
            showItemDetail(slot === 'weapon' ? game.player.weapon : game.player.armor, 'equipped-' + slot);
        }

        function showItemDetail(item, context = 'inventory') {
            if (!item) return;
            document.getElementById('detailIcon').innerHTML = getSprite(item);
            document.getElementById('detailName').textContent = item.name;
            document.getElementById('detailType').textContent = item.damage ? 'Arma' : item.defense !== undefined ? 'Armadura' : item.type || 'Item';
            document.getElementById('detailDesc').textContent = item.desc || 'Sin descripci√≥n.';
            let stats = '';
            if (item.damage) stats += `<div class="item-stat"><div class="item-stat-label">Da√±o</div><div class="item-stat-value">${item.damage}</div></div>`;
            if (item.defense !== undefined) stats += `<div class="item-stat"><div class="item-stat-label">Defensa</div><div class="item-stat-value">${item.defense}</div></div>`;
            if (item.effect && (item.type === 'potion' || item.type === 'food')) stats += `<div class="item-stat"><div class="item-stat-label">Cura</div><div class="item-stat-value">${item.effect}</div></div>`;
            if (item.value) stats += `<div class="item-stat"><div class="item-stat-label">Valor</div><div class="item-stat-value">${item.value} MP</div></div>`;
            document.getElementById('detailStats').innerHTML = stats;
            let actions = '';
            const canEquip = !game.inCombat && game.location.type === 'safe';
            if (context.startsWith('equipped-')) { if (canEquip) actions += `<button class="action-btn danger" onclick="unequipItem('${context.split('-')[1]}')">‚ùå Desequipar</button>`; else actions += `<div style="font-size:0.75rem;color:var(--text-dim);">Solo en zona segura</div>`; }
            else { if (item.damage && canEquip) actions += `<button class="action-btn primary" onclick="equipItem('${item.uid}','weapon')">‚öîÔ∏è Equipar</button>`; if (item.defense !== undefined && canEquip) actions += `<button class="action-btn primary" onclick="equipItem('${item.uid}','armor')">üõ°Ô∏è Equipar</button>`; if (item.type === 'potion' || item.type === 'food') actions += `<button class="action-btn primary" onclick="useItem('${item.uid}')">‚ú® Usar</button>`; if (item.type === 'antidote') actions += `<button class="action-btn primary" onclick="useItem('${item.uid}')">üíä Usar</button>`; if (item.type === 'escape' && game.inCombat) actions += `<button class="action-btn primary" onclick="useItem('${item.uid}')">üí® Usar</button>`; if (item.type === 'backpack') actions += `<button class="action-btn primary" onclick="useItem('${item.uid}')">üéí Usar</button>`; }
            actions += `<button class="action-btn" onclick="closeModal('itemDetailModal')">Cerrar</button>`;
            document.getElementById('detailActions').innerHTML = actions;
            openModal('itemDetailModal');
        }

        function equipItem(uid, type) {
            const p = game.player, item = p.inventory.find(i => i.uid === uid); if (!item) return;
            closeModal('itemDetailModal');
            if (type === 'weapon') { if (p.weapon.uid) p.inventory.push(p.weapon); p.weapon = item; } else { if (p.armor.uid) p.inventory.push(p.armor); p.armor = item; }
            p.inventory = p.inventory.filter(i => i.uid !== uid);
            addStory(`Te equipas con <strong>${item.name}</strong>.`, 'system');
            toast('Equipado', 'success');
            updateUI(); renderInventory();
        }

        function unequipItem(type) {
            const p = game.player; if (p.inventory.length >= p.maxSlots) { toast('Inventario lleno', 'error'); return; }
            closeModal('itemDetailModal');
            if (type === 'weapon') { p.inventory.push(p.weapon); p.weapon = { id: 'fist', name: 'Pu√±os', damage: '1d2', icon: '‚úä', value: 0, desc: 'Tus propios pu√±os.' }; }
            else { p.inventory.push(p.armor); p.armor = { id: 'none', name: 'Sin armadura', defense: 0, icon: 'üë§', value: 0, desc: 'Sin protecci√≥n.' }; }
            addStory('Guardas tu equipo en el inventario.', 'system');
            toast('Desequipado', 'info'); updateUI();
        }

        function useItem(uid) {
            const p = game.player, item = p.inventory.find(i => i.uid === uid); if (!item) return;
            closeModal('itemDetailModal'); closeModal('inventoryModal');
            if (item.type === 'potion' || item.type === 'food') { const heal = roll(item.effect || '1d4'); const actual = Math.min(heal, p.maxHp - p.hp); p.hp += actual; addStory(`Usas ${item.name}: <span style="color:var(--green-bright);">+${actual} HP</span>`, 'system'); p.inventory = p.inventory.filter(i => i.uid !== uid); }
            else if (item.type === 'antidote') { p.effects = p.effects.filter(e => e.type !== 'poison'); addStory(`Usas ${item.name}: Veneno curado`, 'system'); p.inventory = p.inventory.filter(i => i.uid !== uid); }
            else if (item.type === 'escape' && game.inCombat) { p.inventory = p.inventory.filter(i => i.uid !== uid); addStory('Lanzas una bomba de humo y escapas entre la confusi√≥n.', 'narrative'); endCombatEscape(); return; }
            else if (item.type === 'backpack') { const slots = parseInt(item.effect) || 5; p.maxSlots += slots; addStory(`+${slots} espacios de inventario`, 'system'); p.inventory = p.inventory.filter(i => i.uid !== uid); }
            updateUI(); if (game.inCombat) updateCombatUI();
        }

        function renderInventory() {
            const p = game.player;
            document.getElementById('invInfo').textContent = `${p.inventory.length} / ${p.maxSlots} espacios`;
            const grid = document.getElementById('invGrid'); grid.innerHTML = '';
            p.inventory.forEach(item => { const slot = document.createElement('div'); slot.className = `inv-slot rarity-${item.rarity || 'common'}`; slot.innerHTML = `<div class="inv-slot-icon">${getSprite(item)}</div><div class="inv-slot-name">${item.name}</div>`; slot.onclick = () => showItemDetail(item, game.inCombat ? 'combat' : 'inventory'); grid.appendChild(slot); });
            for (let i = p.inventory.length; i < p.maxSlots; i++) { const slot = document.createElement('div'); slot.className = 'inv-slot'; slot.innerHTML = '<div class="inv-slot-empty">vac√≠o</div>'; grid.appendChild(slot); }
        }

        // ==================== EXPLORATION ====================
        function explore() {
            addStory(pick(EXPLORATION_INTROS), 'narrative');
            setActions([{ text: '...', disabled: true }]);
            
            setTimeout(() => {
                const isDanger = Math.random() < 0.7;
                const locGroup = isDanger ? pick(LOCATIONS.danger) : pick(LOCATIONS.safe);
                game.location = { name: locGroup.name, type: isDanger ? 'danger' : 'safe', habitat: locGroup.habitat };
                
                addStory(`<strong>${locGroup.name}</strong>`, 'narrative');
                addStory(pick(locGroup.narratives), 'narrative');
                updateUI();

                setTimeout(() => {
                    if (!isDanger) { triggerSafeEvent(); return; }
                    const r = dX(100);
                    if (r <= 50) triggerEnemyEncounter();
                    else if (r <= 70) triggerTrap();
                    else if (r <= 85) triggerTreasure();
                    else if (r <= 95) triggerPetEncounter();
                    else triggerSafeEvent();
                }, 1500);
            }, 1000);
        }

        function triggerEnemyEncounter() {
            const enemies = getAllEnemies();
            const habitat = game.location.habitat;
            const pool = enemies.filter(e => e.habitat === habitat || e.habitat === 'any' || !e.habitat);
            const enemy = pick(pool.length > 0 ? pool : enemies);
            
            addStory(enemy.desc || `Un ${enemy.name} aparece ante ti.`, 'narrative');
            
            setTimeout(() => {
                addStory(`<strong>¬°${enemy.name} se prepara para atacar!</strong>`, 'combat');
                setActions([
                    { text: '‚öîÔ∏è ¬°Luchar!', fn: () => startCombat(enemy), cls: 'primary' },
                    { text: 'üí® Huir', fn: () => attemptFleeBeforeCombat(enemy), cls: 'danger' }
                ]);
            }, 800);
        }

        async function attemptFleeBeforeCombat(enemy) {
            addStory('Intentas escapar antes de que el enemigo te alcance...', 'narrative');
            const fleeRoll = d20();
            await showDice(fleeRoll);
            addStory(`Tirada de huida: <strong>${fleeRoll}</strong> vs 14`, 'system');
            if (fleeRoll >= 14) {
                addStory('¬°Logras escapar justo a tiempo! El enemigo te pierde de vista entre las sombras.', 'narrative');
                game.location = { name: 'Sendero', type: 'safe' };
                updateUI(); showExploreActions();
            } else {
                addStory('¬°No logras escapar! El enemigo te bloquea el paso. ¬°El combate es inevitable!', 'combat');
                startCombat(enemy);
            }
        }

        async function triggerTrap() {
            const trap = pick(TRAPS);
            addStory('Algo no est√° bien. Tus instintos de aventurero se activan...', 'narrative');
            
            setTimeout(async () => {
                addStory(`<strong>¬°Trampa detectada!</strong>`, 'trap');
                addStory(trap.narrative, 'trap');
                addStory(`<em>Es una ${trap.name}. Puedes intentar detectarla a tiempo (D20 ‚â• ${trap.detectDiff}).</em>`, 'system');
                
                const detectRoll = d20();
                await showDice(detectRoll);
                addStory(`Tirada de percepci√≥n: <strong>${detectRoll}</strong> vs ${trap.detectDiff}`, 'system');

                if (detectRoll >= trap.detectDiff) {
                    addStory('¬°Detectas la trampa justo a tiempo! Puedes intentar esquivarla o desactivarla.', 'system');
                    setActions([
                        { text: 'üèÉ Esquivar', fn: () => attemptDodgeTrap(trap), cls: 'primary' },
                        { text: 'üîß Desactivar', fn: () => attemptDisableTrap(trap) }
                    ]);
                } else {
                    addStory('No notas el peligro hasta que es demasiado tarde...', 'trap');
                    await applyTrapDamage(trap, false);
                }
            }, 1000);
        }

        async function attemptDodgeTrap(trap) {
            addStory('Te lanzas a un lado intentando evitar la trampa...', 'narrative');
            const dodgeRoll = d20();
            const evasion = game.player.race.bonus.evasion || 0;
            const total = dodgeRoll + evasion;
            await showDice(dodgeRoll);
            addStory(`Tirada de esquive: <strong>${dodgeRoll}</strong>${evasion ? ` +${evasion}` : ''} = ${total} vs ${trap.dodgeDiff}`, 'system');
            if (total >= trap.dodgeDiff) { addStory('¬°Te apartas justo a tiempo! La trampa se activa inofensivamente.', 'loot'); showExploreActions(); }
            else { addStory('No logras evitarla por completo...', 'trap'); await applyTrapDamage(trap, true); }
        }

        async function attemptDisableTrap(trap) {
            addStory('Con manos firmes, intentas desactivar el mecanismo...', 'narrative');
            const disableRoll = d20();
            await showDice(disableRoll);
            addStory(`Tirada de desactivaci√≥n: <strong>${disableRoll}</strong> vs 15`, 'system');
            if (disableRoll >= 15) { const r = dX(15) + 5; game.player.silver += r; addStory(`¬°√âxito! Desactivas la trampa y encuentras ${r} MP entre sus componentes.`, 'loot'); }
            else if (disableRoll >= 10) { addStory('El mecanismo se resiste... decides apartarte con cuidado.', 'system'); }
            else { addStory('¬°El mecanismo se activa accidentalmente!', 'trap'); await applyTrapDamage(trap, false); return; }
            updateUI(); showExploreActions();
        }

        async function applyTrapDamage(trap, reduced) {
            let dmg = roll(trap.damage); if (reduced) dmg = Math.ceil(dmg * 0.5);
            const armor = Math.floor(game.player.totalArmor() / 2);
            const finalDmg = Math.max(1, dmg - armor);
            game.player.hp -= finalDmg;
            addStory(`La ${trap.name} te causa <span style="color:var(--red-bright);">${finalDmg} de da√±o</span>${armor > 0 ? ` (${armor} absorbido)` : ''}.`, 'combat');
            if (trap.effect) { applyEffect(game.player, trap.effect); addStory(`Sufres: <span style="color:var(--purple-bright);">${trap.effect}</span>`, 'system'); }
            updateUI();
            if (game.player.hp <= 0) { addStory('<strong style="color:var(--red-bright);">La trampa acaba con tu vida...</strong>', 'combat'); setActions([{ text: 'üîÑ Nuevo Personaje', fn: startNewGame, cls: 'primary' }]); }
            else showExploreActions();
        }

        function triggerTreasure() {
            const narratives = [
                'Algo brilla entre los escombros, llamando tu atenci√≥n. Te acercas con cautela...',
                'Un cofre olvidado yace medio enterrado en el suelo. Las bisagras crujen cuando lo abres...',
                'Encuentras los restos de un viajero menos afortunado. Entre sus pertenencias hay algo de valor...'
            ];
            addStory(pick(narratives), 'narrative');
            setTimeout(() => {
                const mp = dX(30) + 10;
                game.player.silver += mp;
                while (game.player.silver >= 99) { game.player.silver -= 99; game.player.gold++; }
                addStory(`¬°Encuentras <strong>${mp} MP</strong>!`, 'loot');
                if (Math.random() < 0.3 && game.player.inventory.length < game.player.maxSlots) {
                    const item = pick(getAllItems());
                    game.player.inventory.push({ ...item, uid: Date.now() });
                    addStory(`Tambi√©n encuentras: <strong>${item.name}</strong>`, 'loot');
                }
                updateUI(); showExploreActions();
            }, 1000);
        }

        function triggerPetEncounter() {
            if (game.player.pet) { triggerSafeEvent(); return; }
            const pets = getAllPets();
            const pet = pick(pets);
            addStory('Un movimiento entre las sombras capta tu atenci√≥n...', 'narrative');
            setTimeout(() => {
                addStory(pet.desc || `Un ${pet.name} te observa con curiosidad.`, 'narrative');
                addStory(`Es un <strong>${pet.name}</strong>. Parece salvaje pero no hostil. Podr√≠as intentar domesticarlo.`, 'system');
                const hasMeat = game.player.inventory.some(i => i.type === 'food');
                setActions([
                    { text: 'ü•© Domesticar', fn: () => attemptTame(pet), disabled: !hasMeat, cls: hasMeat ? 'primary' : '' },
                    { text: '‚öîÔ∏è Cazar', fn: () => startCombat({ ...pet, health: pet.health, difficulty: 10, loot: [5, 15], drops: ['bi7'], desc: `El ${pet.name} se da cuenta de tus intenciones y se prepara para defenderse.` }) },
                    { text: 'üö∂ Dejar', fn: () => { addStory('Te alejas silenciosamente, dejando a la criatura en paz.', 'narrative'); showExploreActions(); } }
                ]);
            }, 1000);
        }

        async function attemptTame(pet) {
            const p = game.player;
            const meatIdx = p.inventory.findIndex(i => i.type === 'food');
            if (meatIdx !== -1) p.inventory.splice(meatIdx, 1);
            addStory(`Te acercas lentamente, extendiendo la mano con un trozo de carne...`, 'narrative');
            addStory(`El ${pet.name} olfatea el aire, evaluando si eres una amenaza o un amigo potencial.`, 'narrative');
            const tameRoll = dX(pet.difficulty);
            const threshold = Math.ceil(pet.difficulty * 0.6);
            await showDice(tameRoll, pet.difficulty, tameRoll >= threshold);
            addStory(`Tirada de domesticaci√≥n D${pet.difficulty}: <strong>${tameRoll}</strong> (necesitas ${threshold}+)`, 'system');
            if (tameRoll >= threshold) {
                p.pet = { ...pet, hp: pet.health, maxHp: pet.health };
                addStory(`El ${pet.name} acepta la ofrenda y se acerca a ti con confianza. <strong style="color:var(--green-bright);">¬°Has ganado un compa√±ero leal!</strong>`, 'loot');
                toast('Compa√±ero obtenido', 'success');
            } else {
                addStory(`El ${pet.name} toma la comida pero retrocede, desapareciendo entre las sombras. No conf√≠a en ti... todav√≠a.`, 'narrative');
            }
            updateUI(); showExploreActions();
        }

        function triggerSafeEvent() {
            addStory('Encuentras un lugar tranquilo donde el peligro parece distante. Es un buen momento para descansar.', 'narrative');
            game.location = { name: 'Refugio', type: 'safe' };
            const heal = Math.floor(game.player.maxHp * 0.3);
            game.player.hp = Math.min(game.player.maxHp, game.player.hp + heal);
            game.player.effects = [];
            addStory(`Descansas y recuperas fuerzas. <span style="color:var(--green-bright);">+${heal} HP</span>. Estados curados.`, 'system');
            addStory('<em>Est√°s en zona segura. Puedes cambiar tu equipamiento.</em>', 'system');
            updateUI(); showExploreActions();
        }

        // ==================== COMBAT ====================
        function startCombat(enemy) {
            game.inCombat = true;
            game.enemy = { ...enemy, hp: enemy.health, maxHp: enemy.health, effects: [] };
            game.turn = 1;
            document.getElementById('combatArena').classList.add('active');
            clearCombatLog();
            addTurnHeader(1);
            updateCombatUI();
            updateUI();
            document.getElementById('actionsGrid').innerHTML = '<span style="color:var(--text-dim)">En combate...</span>';
        }

        async function playerAttack() {
            const p = game.player, e = game.enemy;
            const attackRoll = d20(), precision = p.race.bonus.precision || 0, total = attackRoll + precision, isCrit = attackRoll === 20;
            await showDice(attackRoll, 20, isCrit);
            const logs = [];
            logs.push({ text: `üé≤ D20 = <span class="log-dice">${attackRoll}</span>${precision ? ` +${precision}` : ''} = ${total} vs ${e.difficulty}` });
            if (attackRoll === 1) { logs.push({ text: `<span class="log-miss">¬°PIFIA!</span>` }); }
            else if (total >= e.difficulty) {
                let dmg = roll(p.weapon.damage) + (p.race.bonus.damage || 0);
                if (isCrit) { dmg *= 2; logs.push({ text: `<span class="log-crit">¬°CR√çTICO! √ó2</span>` }); }
                e.hp -= dmg;
                logs.push({ text: `<span class="log-damage">${dmg} da√±o</span>` });
                if (p.weapon.effect) { applyEffect(e, p.weapon.effect); }
                if (p.pet) { const pd = roll(p.pet.damage); e.hp -= pd; logs.push({ text: `${p.pet.icon} ${p.pet.name}: ${pd}` }); }
                if (e.hp <= 0) { addLogSection(`‚öîÔ∏è ${p.name}`, logs, 'player-action'); endCombat(true); return; }
            } else { logs.push({ text: `<span class="log-miss">Fallo</span>` }); }
            addLogSection(`‚öîÔ∏è ${p.name}`, logs, 'player-action');
            updateCombatUI();
            await enemyTurn();
        }

        function playerDefend() {
            game.player.defending = true;
            addLogSection(`üõ°Ô∏è ${game.player.name}`, [{ text: 'Postura defensiva: +4 evasi√≥n' }], 'player-action');
            enemyTurn();
        }

        async function attemptFlee() {
            const fleeRoll = d20();
            await showDice(fleeRoll);
            if (fleeRoll >= 12) { addLogSection(`üèÉ Huida`, [{ text: `${fleeRoll} ‚â• 12 - ¬°Escape!`, cls: 'log-heal' }], 'player-action'); addStory('Logras escapar del combate.', 'system'); endCombatEscape(); }
            else { addLogSection(`üèÉ Huida`, [{ text: `${fleeRoll} < 12 - Fallido`, cls: 'log-miss' }], 'player-action'); await enemyTurn(); }
        }

        async function enemyTurn() {
            const p = game.player, e = game.enemy;
            processEffects(e); updateCombatUI(); if (e.hp <= 0) { endCombat(true); return; }
            const logs = [];
            const dodgeRoll = d20(), evasion = (p.race.bonus.evasion || 0) + (p.defending ? 4 : 0), totalDodge = dodgeRoll + evasion;
            logs.push({ text: `üé≤ Esquive: D20 = ${dodgeRoll}${evasion ? ` +${evasion}` : ''} = ${totalDodge} vs 12` });
            if (totalDodge >= 12) { logs.push({ text: `<span class="log-heal">¬°Esquivado!</span>` }); }
            else {
                let dmg = roll(e.damage);
                if (Math.random() < 0.1) { dmg = Math.ceil(dmg * 1.25); logs.push({ text: `<span class="log-crit">Cr√≠tico enemigo</span>` }); }
                const armor = p.totalArmor(), final = Math.max(1, dmg - armor);
                p.hp -= final;
                logs.push({ text: `<span class="log-damage">${final} da√±o</span> (${dmg}-${armor})` });
                if (e.effect) applyEffect(p, e.effect);
            }
            addLogSection(`üëπ ${e.name}`, logs, 'enemy-action');
            processEffects(p);
            p.defending = false;
            game.turn++;
            updateCombatUI(); updateUI();
            if (p.hp <= 0) endCombat(false);
            else addTurnHeader(game.turn);
        }

        function applyEffect(target, type) {
            const data = { bleed: { dmg: 1, turns: 3, max: 3 }, poison: { dmg: 2, turns: 2, max: 2 }, fire: { dmg: '1d4', turns: 2, max: 1 } };
            const eff = data[type]; if (!eff) return;
            if (!target.effects) target.effects = [];
            const existing = target.effects.find(e => e.type === type);
            if (existing) { if (existing.stacks < eff.max) existing.stacks++; existing.turns = eff.turns; }
            else target.effects.push({ type, dmg: eff.dmg, turns: eff.turns, stacks: 1, maxStacks: eff.max });
        }

        function processEffects(target) {
            if (!target.effects) return;
            let total = 0;
            const expired = [];
            target.effects.forEach((eff, i) => { const dmg = (typeof eff.dmg === 'string' ? roll(eff.dmg) : eff.dmg) * eff.stacks; total += dmg; eff.turns--; if (eff.turns <= 0) expired.push(i); });
            expired.reverse().forEach(i => target.effects.splice(i, 1));
            if (total > 0) target.hp -= total;
        }

        function endCombatEscape() {
            document.getElementById('combatArena').classList.remove('active');
            game.inCombat = false;
            game.enemy = null;
            game.location = { name: 'Sendero', type: 'safe' };
            updateUI(); showExploreActions();
        }

        function endCombat(victory) {
            document.getElementById('combatArena').classList.remove('active');
            game.inCombat = false;
            if (victory) {
                const e = game.enemy;
                addStory(`El ${e.name} cae derrotado. <strong style="color:var(--green-bright);">¬°Victoria!</strong>`, 'loot');
                if (e.loot) { const mp = dX(e.loot[1] - e.loot[0]) + e.loot[0]; game.player.silver += mp; while (game.player.silver >= 99) { game.player.silver -= 99; game.player.gold++; } addStory(`Obtienes <strong>${mp} MP</strong>`, 'loot'); }
                if (e.drops) { e.drops.forEach(dropId => { if (Math.random() < 0.3 && game.player.inventory.length < game.player.maxSlots) { const item = findItem(dropId); if (item) { game.player.inventory.push({ ...item, uid: Date.now() + Math.random() }); addStory(`Encuentras: <strong>${item.name}</strong>`, 'loot'); } } }); }
                game.location = { name: 'Campo de batalla', type: 'safe' };
            } else {
                addStory('<strong style="color:var(--red-bright);">Has ca√≠do en batalla...</strong>', 'combat');
                setActions([{ text: 'üîÑ Nuevo Personaje', fn: startNewGame, cls: 'primary' }]);
                return;
            }
            game.enemy = null;
            updateUI(); showExploreActions();
        }

        // ==================== TOWN ====================
        function visitTown() {
            game.location = { name: 'Pueblo', type: 'safe' };
            updateUI();
            addStory('Llegas al pueblo. Los aldeanos van y vienen por sus asuntos. Varias tiendas y establecimientos ofrecen sus servicios.', 'narrative');
            const npcs = getAllNpcs();
            const roleNames = { merchant: 'Comerciante', blacksmith: 'Herrero', alchemist: 'Alquimista', innkeeper: 'Tabernero', baker: 'Panadero', healer: 'Curandero', guard: 'Guardia', questgiver: 'Misiones', villager: 'Aldeano' };
            let html = '<div style="display:grid;gap:0.35rem;">';
            npcs.forEach(npc => { html += `<div class="item-card" onclick="interactNpc('${npc.id}')" style="cursor:pointer;"><span class="item-card-icon">${getSprite(npc)}</span><div class="item-card-info"><div class="item-card-name">${npc.name}</div><div class="item-card-stats">${roleNames[npc.role] || npc.role} - ${npc.location || 'Plaza'}</div></div></div>`; });
            html += '</div>';
            document.getElementById('townContent').innerHTML = html;
            openModal('townModal');
        }

        function interactNpc(npcId) {
            const npc = getAllNpcs().find(n => n.id === npcId); if (!npc) return;
            closeModal('townModal');
            addStory(`Te acercas a <strong>${npc.name}</strong>.`, 'dialogue');
            addStory(`"${npc.dialogue || '¬°Saludos, viajero!'}"`, 'dialogue');
            if (npc.sells && npc.sells.length > 0) { setTimeout(() => openShop(npc), 500); }
            else if (npc.role === 'healer') {
                const cost = 10;
                if (game.player.silver >= cost) { game.player.silver -= cost; game.player.hp = game.player.maxHp; game.player.effects = []; addStory(`El curandero restaura tu salud completamente. (-${cost} MP)`, 'system'); }
                else addStory('"No tienes suficiente dinero para mis servicios."', 'dialogue');
                updateUI();
            } else if (npc.role === 'innkeeper') {
                const cost = 5;
                if (game.player.silver >= cost) { game.player.silver -= cost; const heal = Math.floor(game.player.maxHp * 0.5); game.player.hp = Math.min(game.player.maxHp, game.player.hp + heal); addStory(`Descansas en la taberna. +${heal} HP (-${cost} MP)`, 'system'); }
                updateUI();
            }
        }

        function openShop(npc) {
            document.getElementById('shopTitle').textContent = `üè™ ${npc.name}`;
            let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">';
            html += '<div><h4 style="color:var(--gold);margin-bottom:0.4rem;font-size:0.8rem;">En venta</h4><div style="display:grid;gap:0.25rem;">';
            (npc.sells || []).forEach(itemId => { const item = findItem(itemId); if (item) { const canBuy = game.player.silver >= item.value && game.player.inventory.length < game.player.maxSlots; html += `<div class="item-card" style="opacity:${canBuy ? 1 : 0.5}"><span class="item-card-icon">${getSprite(item)}</span><div class="item-card-info"><div class="item-card-name">${item.name}</div><div class="item-card-stats">${item.value} MP</div></div><button class="action-btn" onclick="buyItem('${item.id}')" ${canBuy ? '' : 'disabled'}>Comprar</button></div>`; } });
            html += '</div></div>';
            html += '<div><h4 style="color:var(--gold);margin-bottom:0.4rem;font-size:0.8rem;">Vender</h4><div style="display:grid;gap:0.25rem;">';
            game.player.inventory.forEach(item => { const sellPrice = Math.floor((item.value || 10) * 0.5); html += `<div class="item-card"><span class="item-card-icon">${getSprite(item)}</span><div class="item-card-info"><div class="item-card-name">${item.name}</div><div class="item-card-stats">${sellPrice} MP</div></div><button class="action-btn" onclick="sellItem('${item.uid}', ${sellPrice})">Vender</button></div>`; });
            html += '</div></div></div>';
            html += `<div style="text-align:center;margin-top:0.5rem;color:var(--text-dim);font-size:0.75rem;">Tu dinero: ${game.player.gold} MO ${game.player.silver} MP</div>`;
            document.getElementById('shopContent').innerHTML = html;
            openModal('shopModal');
        }

        function buyItem(itemId) {
            const item = findItem(itemId); if (!item || game.player.silver < item.value || game.player.inventory.length >= game.player.maxSlots) return;
            game.player.silver -= item.value;
            game.player.inventory.push({ ...item, uid: Date.now() });
            addStory(`Compras: ${item.name} (-${item.value} MP)`, 'system');
            toast('Comprado', 'success'); updateUI();
            const npc = getAllNpcs().find(n => document.getElementById('shopTitle').textContent.includes(n.name));
            if (npc) openShop(npc);
        }

        function sellItem(uid, price) {
            const item = game.player.inventory.find(i => i.uid === uid); if (!item) return;
            game.player.inventory = game.player.inventory.filter(i => i.uid !== uid);
            game.player.silver += price;
            while (game.player.silver >= 99) { game.player.silver -= 99; game.player.gold++; }
            addStory(`Vendes: ${item.name} (+${price} MP)`, 'system');
            toast('Vendido', 'success'); updateUI();
            const npc = getAllNpcs().find(n => document.getElementById('shopTitle').textContent.includes(n.name));
            if (npc) openShop(npc);
        }

        // ==================== ACTIONS ====================
        function setActions(acts) {
            const g = document.getElementById('actionsGrid'); g.innerHTML = '';
            acts.forEach(a => { const b = document.createElement('button'); b.className = 'action-btn ' + (a.cls || ''); b.textContent = a.text; b.disabled = a.disabled; b.onclick = a.fn; g.appendChild(b); });
        }

        function showExploreActions() {
            setActions([
                { text: 'üó∫Ô∏è Explorar', fn: explore, cls: 'primary' },
                { text: 'üèòÔ∏è Pueblo', fn: visitTown },
                { text: 'üéí Inventario', fn: () => { renderInventory(); openModal('inventoryModal'); } },
                { text: 'üíæ Guardar', fn: saveGame }
            ]);
        }

        // ==================== CHARACTER ====================
        class Player {
            constructor() {
                this.name = pick(['Aldric', 'Brynn', 'Cedric', 'Dara', 'Freya', 'Gideon', 'Kira', 'Mira', 'Orion', 'Sera', 'Theron', 'Lyra', 'Magnus', 'Elena']);
                this.race = BASE_RACES[dX(5) - 1];
                this.weapon = { ...BASE_WEAPONS[dX(4) - 1], uid: Date.now() };
                this.armor = { ...BASE_ARMORS[dX(4) - 1], uid: Date.now() + 1 };
                const startItem = { ...BASE_ITEMS[dX(6) - 1], uid: Date.now() + 2 };
                this.maxHp = 20 + (this.race.bonus.health || 0);
                this.hp = this.maxHp;
                this.gold = 0;
                this.silver = 20;
                this.inventory = [startItem];
                this.maxSlots = 10;
                this.effects = [];
                this.pet = null;
                this.defending = false;
            }
            totalArmor() { return (this.armor?.defense || 0) + (this.race.bonus.armor || 0); }
        }

        // ==================== SAVE/LOAD ====================
        function saveGame() {
            const data = { player: game.player, location: game.location, custom: customData, timestamp: Date.now() };
            if (db && fbConnected) db.ref('saveData').set(data);
            localStorage.setItem('rpgSave', JSON.stringify(data));
            toast('Guardado', 'success');
        }

        function loadFromFirebase() {
            if (!db) return;
            db.ref('gameData').once('value').then(snap => {
                const data = snap.val();
                if (data) { ['weapons', 'armors', 'items', 'enemies', 'pets', 'npcs'].forEach(k => { if (data[k]) customData[k] = data[k]; }); renderAllLists(); updateDropSelects(); }
            });
        }

        function loadFromLocal() {
            ['weapons', 'armors', 'items', 'enemies', 'pets', 'npcs'].forEach(k => { const d = localStorage.getItem('rpg_' + k); if (d) customData[k] = JSON.parse(d); });
        }

        function startNewGame() {
            game = { player: new Player(), inCombat: false, enemy: null, turn: 0, location: { name: 'Pueblo', type: 'safe' } };
            document.getElementById('storyContent').innerHTML = '';
            document.getElementById('combatArena').classList.remove('active');
            addStory('<strong style="font-size:1rem;color:var(--gold);">‚öîÔ∏è Nueva Aventura ‚öîÔ∏è</strong>', '');
            addStory(`Eres <strong>${game.player.name}</strong>, un ${game.player.race.name} ${game.player.race.icon} que busca fortuna y gloria en las tierras salvajes.`, 'narrative');
            addStory(`Comienzas tu viaje en el pueblo, equipado con ${game.player.weapon.name} y ${game.player.armor.name}. Tienes ${game.player.silver} monedas de plata y un ${game.player.inventory[0]?.name} en tu mochila.`, 'system');
            addStory('<em>El mundo te espera. ¬øQu√© aventuras te depara el destino?</em>', 'narrative');
            updateUI(); showExploreActions();
        }

        // ==================== TABS ====================
        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function switchEditorTab(tab) {
            document.querySelectorAll('.editor-tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.editor-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Editor').classList.add('active');
            if (tab === 'enemies' || tab === 'npcs') updateDropSelects();
        }

        // ==================== EDITOR ====================
        let editingId = null;

        function saveToStorage(type) {
            if (db && fbConnected) db.ref('gameData/' + type).set(customData[type]);
            localStorage.setItem('rpg_' + type, JSON.stringify(customData[type]));
        }

        function clearForm(type) {
            editingId = null;
            const fields = {
                weapon: ['wName', 'wDamage', 'wIcon', 'wSprite', 'wValue', 'wDesc'],
                armor: ['aName', 'aDefense', 'aIcon', 'aSprite', 'aValue', 'aDesc'],
                item: ['iName', 'iIcon', 'iSprite', 'iEffect', 'iValue', 'iDesc'],
                enemy: ['enName', 'enHealth', 'enDamage', 'enIcon', 'enSprite', 'enLootMin', 'enLootMax', 'enDesc'],
                pet: ['petName', 'petHealth', 'petDamage', 'petIcon', 'petSprite', 'petDesc'],
                npc: ['npcName', 'npcIcon', 'npcSprite', 'npcLocation', 'npcDialogue']
            };
            (fields[type] || []).forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        }

        function saveWeapon() {
            const w = { id: editingId || 'cw_' + Date.now(), name: document.getElementById('wName').value, damage: document.getElementById('wDamage').value, icon: document.getElementById('wIcon').value || '‚öîÔ∏è', sprite: document.getElementById('wSprite').value || '', rarity: document.getElementById('wRarity').value, value: parseInt(document.getElementById('wValue').value) || 10, effect: document.getElementById('wEffect').value || null, desc: document.getElementById('wDesc').value || 'Arma personalizada.' };
            if (!w.name || !w.damage) { toast('Faltan campos', 'error'); return; }
            if (editingId) { const idx = customData.weapons.findIndex(x => x.id === editingId); if (idx >= 0) customData.weapons[idx] = w; }
            else customData.weapons.push(w);
            saveToStorage('weapons'); renderWeaponsList(); updateDropSelects(); clearForm('weapon'); toast('Guardado', 'success');
        }

        function editWeapon(id) { const w = customData.weapons.find(x => x.id === id); if (!w) return; editingId = id; document.getElementById('wName').value = w.name; document.getElementById('wDamage').value = w.damage; document.getElementById('wIcon').value = w.icon || ''; document.getElementById('wSprite').value = w.sprite || ''; document.getElementById('wRarity').value = w.rarity || 'common'; document.getElementById('wValue').value = w.value || ''; document.getElementById('wEffect').value = w.effect || ''; document.getElementById('wDesc').value = w.desc || ''; }
        function deleteWeapon(id) { customData.weapons = customData.weapons.filter(x => x.id !== id); saveToStorage('weapons'); renderWeaponsList(); updateDropSelects(); toast('Eliminado', 'info'); }

        function saveArmor() {
            const a = { id: editingId || 'ca_' + Date.now(), name: document.getElementById('aName').value, defense: parseInt(document.getElementById('aDefense').value) || 0, icon: document.getElementById('aIcon').value || 'üõ°Ô∏è', sprite: document.getElementById('aSprite').value || '', rarity: document.getElementById('aRarity').value, value: parseInt(document.getElementById('aValue').value) || 10, desc: document.getElementById('aDesc').value || 'Armadura personalizada.' };
            if (!a.name) { toast('Falta nombre', 'error'); return; }
            if (editingId) { const idx = customData.armors.findIndex(x => x.id === editingId); if (idx >= 0) customData.armors[idx] = a; }
            else customData.armors.push(a);
            saveToStorage('armors'); renderArmorsList(); updateDropSelects(); clearForm('armor'); toast('Guardado', 'success');
        }

        function editArmor(id) { const a = customData.armors.find(x => x.id === id); if (!a) return; editingId = id; document.getElementById('aName').value = a.name; document.getElementById('aDefense').value = a.defense || ''; document.getElementById('aIcon').value = a.icon || ''; document.getElementById('aSprite').value = a.sprite || ''; document.getElementById('aRarity').value = a.rarity || 'common'; document.getElementById('aValue').value = a.value || ''; document.getElementById('aDesc').value = a.desc || ''; }
        function deleteArmor(id) { customData.armors = customData.armors.filter(x => x.id !== id); saveToStorage('armors'); renderArmorsList(); updateDropSelects(); toast('Eliminado', 'info'); }

        function saveItem() {
            const i = { id: editingId || 'ci_' + Date.now(), name: document.getElementById('iName').value, type: document.getElementById('iType').value, icon: document.getElementById('iIcon').value || 'üì¶', sprite: document.getElementById('iSprite').value || '', effect: document.getElementById('iEffect').value, value: parseInt(document.getElementById('iValue').value) || 10, desc: document.getElementById('iDesc').value || 'Item personalizado.', rarity: 'common' };
            if (!i.name) { toast('Falta nombre', 'error'); return; }
            if (editingId) { const idx = customData.items.findIndex(x => x.id === editingId); if (idx >= 0) customData.items[idx] = i; }
            else customData.items.push(i);
            saveToStorage('items'); renderItemsList(); updateDropSelects(); clearForm('item'); toast('Guardado', 'success');
        }

        function editItem(id) { const i = customData.items.find(x => x.id === id); if (!i) return; editingId = id; document.getElementById('iName').value = i.name; document.getElementById('iType').value = i.type || 'potion'; document.getElementById('iIcon').value = i.icon || ''; document.getElementById('iSprite').value = i.sprite || ''; document.getElementById('iEffect').value = i.effect || ''; document.getElementById('iValue').value = i.value || ''; document.getElementById('iDesc').value = i.desc || ''; }
        function deleteItem(id) { customData.items = customData.items.filter(x => x.id !== id); saveToStorage('items'); renderItemsList(); updateDropSelects(); toast('Eliminado', 'info'); }

        function saveEnemy() {
            const drops = Array.from(document.querySelectorAll('#enDropsSelect input:checked')).map(c => c.value);
            const e = { id: editingId || 'ce_' + Date.now(), name: document.getElementById('enName').value, health: parseInt(document.getElementById('enHealth').value) || 20, damage: document.getElementById('enDamage').value || '1d6', difficulty: parseInt(document.getElementById('enDiff').value) || 10, icon: document.getElementById('enIcon').value || 'üëπ', sprite: document.getElementById('enSprite').value || '', effect: document.getElementById('enEffect').value || null, habitat: document.getElementById('enHabitat').value || 'any', loot: [parseInt(document.getElementById('enLootMin').value) || 5, parseInt(document.getElementById('enLootMax').value) || 20], drops: drops, desc: document.getElementById('enDesc').value || 'Un enemigo aparece.' };
            if (!e.name) { toast('Falta nombre', 'error'); return; }
            if (editingId) { const idx = customData.enemies.findIndex(x => x.id === editingId); if (idx >= 0) customData.enemies[idx] = e; }
            else customData.enemies.push(e);
            saveToStorage('enemies'); renderEnemiesList(); clearForm('enemy'); toast('Guardado', 'success');
        }

        function editEnemy(id) { const e = customData.enemies.find(x => x.id === id); if (!e) return; editingId = id; document.getElementById('enName').value = e.name; document.getElementById('enHealth').value = e.health || ''; document.getElementById('enDamage').value = e.damage || ''; document.getElementById('enDiff').value = e.difficulty || '10'; document.getElementById('enIcon').value = e.icon || ''; document.getElementById('enSprite').value = e.sprite || ''; document.getElementById('enEffect').value = e.effect || ''; document.getElementById('enHabitat').value = e.habitat || 'any'; document.getElementById('enLootMin').value = e.loot?.[0] || ''; document.getElementById('enLootMax').value = e.loot?.[1] || ''; document.getElementById('enDesc').value = e.desc || ''; document.querySelectorAll('#enDropsSelect input').forEach(c => c.checked = (e.drops || []).includes(c.value)); }
        function deleteEnemy(id) { customData.enemies = customData.enemies.filter(x => x.id !== id); saveToStorage('enemies'); renderEnemiesList(); toast('Eliminado', 'info'); }

        function savePet() {
            const p = { id: editingId || 'cp_' + Date.now(), name: document.getElementById('petName').value, health: parseInt(document.getElementById('petHealth').value) || 20, damage: document.getElementById('petDamage').value || '1d4', difficulty: parseInt(document.getElementById('petDiff').value) || 24, icon: document.getElementById('petIcon').value || 'üê∫', sprite: document.getElementById('petSprite').value || '', desc: document.getElementById('petDesc').value || 'Una criatura salvaje.' };
            if (!p.name) { toast('Falta nombre', 'error'); return; }
            if (editingId) { const idx = customData.pets.findIndex(x => x.id === editingId); if (idx >= 0) customData.pets[idx] = p; }
            else customData.pets.push(p);
            saveToStorage('pets'); renderPetsList(); clearForm('pet'); toast('Guardado', 'success');
        }

        function editPet(id) { const p = customData.pets.find(x => x.id === id); if (!p) return; editingId = id; document.getElementById('petName').value = p.name; document.getElementById('petHealth').value = p.health || ''; document.getElementById('petDamage').value = p.damage || ''; document.getElementById('petDiff').value = p.difficulty || '24'; document.getElementById('petIcon').value = p.icon || ''; document.getElementById('petSprite').value = p.sprite || ''; document.getElementById('petDesc').value = p.desc || ''; }
        function deletePet(id) { customData.pets = customData.pets.filter(x => x.id !== id); saveToStorage('pets'); renderPetsList(); toast('Eliminado', 'info'); }

        function saveNpc() {
            const sells = Array.from(document.querySelectorAll('#npcShopSelect input:checked')).map(c => c.value);
            const n = { id: editingId || 'cn_' + Date.now(), name: document.getElementById('npcName').value, role: document.getElementById('npcRole').value, icon: document.getElementById('npcIcon').value || 'üßî', sprite: document.getElementById('npcSprite').value || '', location: document.getElementById('npcLocation').value || '', dialogue: document.getElementById('npcDialogue').value || '', sells: sells };
            if (!n.name) { toast('Falta nombre', 'error'); return; }
            if (editingId) { const idx = customData.npcs.findIndex(x => x.id === editingId); if (idx >= 0) customData.npcs[idx] = n; }
            else customData.npcs.push(n);
            saveToStorage('npcs'); renderNpcsList(); clearForm('npc'); toast('Guardado', 'success');
        }

        function editNpc(id) { const n = customData.npcs.find(x => x.id === id); if (!n) return; editingId = id; document.getElementById('npcName').value = n.name; document.getElementById('npcRole').value = n.role || 'merchant'; document.getElementById('npcIcon').value = n.icon || ''; document.getElementById('npcSprite').value = n.sprite || ''; document.getElementById('npcLocation').value = n.location || ''; document.getElementById('npcDialogue').value = n.dialogue || ''; updateDropSelects(); setTimeout(() => { document.querySelectorAll('#npcShopSelect input').forEach(c => c.checked = (n.sells || []).includes(c.value)); }, 100); }
        function deleteNpc(id) { customData.npcs = customData.npcs.filter(x => x.id !== id); saveToStorage('npcs'); renderNpcsList(); toast('Eliminado', 'info'); }

        function renderAllLists() { renderWeaponsList(); renderArmorsList(); renderItemsList(); renderEnemiesList(); renderPetsList(); renderNpcsList(); }

        function renderWeaponsList() { const all = [...BASE_WEAPONS, ...customData.weapons]; document.getElementById('weaponsList').innerHTML = all.map(w => `<div class="item-card"><span class="item-card-icon">${getSprite(w)}</span><div class="item-card-info"><div class="item-card-name">${w.name}</div><div class="item-card-stats">${w.damage} | ${w.value}MP ${w.id.startsWith('bw') ? '(base)' : ''}</div></div>${w.id.startsWith('cw') ? `<div class="item-card-actions"><button class="icon-btn" onclick="editWeapon('${w.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="deleteWeapon('${w.id}')">üóëÔ∏è</button></div>` : ''}</div>`).join(''); }
        function renderArmorsList() { const all = [...BASE_ARMORS, ...customData.armors]; document.getElementById('armorsList').innerHTML = all.map(a => `<div class="item-card"><span class="item-card-icon">${getSprite(a)}</span><div class="item-card-info"><div class="item-card-name">${a.name}</div><div class="item-card-stats">Def:${a.defense} | ${a.value}MP ${a.id.startsWith('ba') ? '(base)' : ''}</div></div>${a.id.startsWith('ca') ? `<div class="item-card-actions"><button class="icon-btn" onclick="editArmor('${a.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="deleteArmor('${a.id}')">üóëÔ∏è</button></div>` : ''}</div>`).join(''); }
        function renderItemsList() { const all = [...BASE_ITEMS, ...customData.items]; document.getElementById('itemsList').innerHTML = all.map(i => `<div class="item-card"><span class="item-card-icon">${getSprite(i)}</span><div class="item-card-info"><div class="item-card-name">${i.name}</div><div class="item-card-stats">${i.type} | ${i.value}MP ${i.id.startsWith('bi') ? '(base)' : ''}</div></div>${i.id.startsWith('ci') ? `<div class="item-card-actions"><button class="icon-btn" onclick="editItem('${i.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="deleteItem('${i.id}')">üóëÔ∏è</button></div>` : ''}</div>`).join(''); }
        function renderEnemiesList() { const all = [...BASE_ENEMIES, ...customData.enemies]; document.getElementById('enemiesList').innerHTML = all.map(e => `<div class="item-card"><span class="item-card-icon">${getSprite(e)}</span><div class="item-card-info"><div class="item-card-name">${e.name}</div><div class="item-card-stats">HP:${e.health} | ${e.damage} | Dif:${e.difficulty} ${e.id.startsWith('be') ? '(base)' : ''}</div></div>${e.id.startsWith('ce') ? `<div class="item-card-actions"><button class="icon-btn" onclick="editEnemy('${e.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="deleteEnemy('${e.id}')">üóëÔ∏è</button></div>` : ''}</div>`).join(''); }
        function renderPetsList() { const all = [...BASE_PETS, ...customData.pets]; document.getElementById('petsList').innerHTML = all.map(p => `<div class="item-card"><span class="item-card-icon">${getSprite(p)}</span><div class="item-card-info"><div class="item-card-name">${p.name}</div><div class="item-card-stats">HP:${p.health} | ${p.damage} | D${p.difficulty} ${p.id.startsWith('bp') ? '(base)' : ''}</div></div>${p.id.startsWith('cp') ? `<div class="item-card-actions"><button class="icon-btn" onclick="editPet('${p.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="deletePet('${p.id}')">üóëÔ∏è</button></div>` : ''}</div>`).join(''); }
        function renderNpcsList() { const roleNames = { merchant: 'Comerciante', blacksmith: 'Herrero', alchemist: 'Alquimista', innkeeper: 'Tabernero', baker: 'Panadero', healer: 'Curandero', guard: 'Guardia', questgiver: 'Misiones', villager: 'Aldeano' }; const all = [...BASE_NPCS, ...customData.npcs]; document.getElementById('npcsList').innerHTML = all.map(n => `<div class="item-card"><span class="item-card-icon">${getSprite(n)}</span><div class="item-card-info"><div class="item-card-name">${n.name}</div><div class="item-card-stats">${roleNames[n.role] || n.role} ${n.id.startsWith('bn') ? '(base)' : ''}</div></div>${n.id.startsWith('cn') ? `<div class="item-card-actions"><button class="icon-btn" onclick="editNpc('${n.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="deleteNpc('${n.id}')">üóëÔ∏è</button></div>` : ''}</div>`).join(''); }

        function updateDropSelects() {
            const all = [...getAllWeapons(), ...getAllArmors(), ...getAllItems()];
            document.getElementById('enDropsSelect').innerHTML = all.map(it => `<label><input type="checkbox" value="${it.id}"> ${it.icon} ${it.name}</label>`).join('');
            document.getElementById('npcShopSelect').innerHTML = all.map(it => `<label><input type="checkbox" value="${it.id}"> ${it.icon} ${it.name}</label>`).join('');
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocal();
            renderAllLists();
            updateDropSelects();
            const saved = localStorage.getItem('rpgSave');
            if (saved) {
                addStory('<span style="color:var(--gold);">Aventuras de Acero y Runas</span>', '');
                addStory('Partida guardada encontrada.', 'system');
                setActions([
                    { text: 'üÜï Nuevo', fn: startNewGame, cls: 'primary' },
                    { text: 'üìÇ Continuar', fn: () => { const data = JSON.parse(saved); if (data.player) { game.player = Object.assign(new Player(), data.player); if (data.location) game.location = data.location; updateUI(); showExploreActions(); addStory('Partida cargada. Tu aventura contin√∫a...', 'system'); } } }
                ]);
            } else startNewGame();
        });
    </script>
</body>
</html>
