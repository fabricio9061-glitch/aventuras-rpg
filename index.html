<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventuras de Acero y Runas</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root{--bg-dark:#0a0908;--bg-panel:#1a1614;--bg-light:#2a2320;--bg-input:#151210;--gold:#d4a437;--gold-dim:#a67c00;--gold-bright:#ffd700;--red:#8b0000;--red-bright:#dc143c;--green:#2d5a27;--green-bright:#4caf50;--blue:#1e3a5f;--blue-bright:#4a9eff;--purple:#9c27b0;--orange:#ff6b35;--text:#e8dcc4;--text-dim:#8a8078;--border:#3d3530}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Crimson Text',Georgia,serif;background:var(--bg-dark);color:var(--text);min-height:100vh}
        ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--gold-dim);border-radius:3px}
        .hidden{display:none!important}
        
        /* Navigation */
        .main-nav{display:flex;justify-content:center;background:var(--bg-panel);border-bottom:2px solid var(--gold-dim);position:sticky;top:0;z-index:100;padding:.25rem;gap:.25rem;flex-wrap:wrap}
        .nav-btn{font-family:'Cinzel',serif;font-size:.75rem;padding:.4rem 1rem;background:transparent;border:1px solid transparent;color:var(--text-dim);cursor:pointer;border-radius:3px;transition:all .2s}
        .nav-btn:hover{color:var(--gold);border-color:var(--gold-dim)}
        .nav-btn.active{color:var(--gold-bright);background:rgba(212,164,55,.15);border-color:var(--gold-dim)}
        
        .status-bar{position:fixed;top:0;right:0;display:flex;align-items:center;gap:.5rem;padding:.25rem .5rem;background:var(--bg-panel);border-bottom-left-radius:6px;font-size:.65rem;z-index:200}
        .status-dot{width:8px;height:8px;border-radius:50%;background:var(--red)}.status-dot.connected{background:var(--green-bright)}
        
        .tab-content{display:none;min-height:calc(100vh - 50px)}.tab-content.active{display:flex;flex-direction:column}
        
        /* Game Layout - RESTRUCTURED: Actions TOP, Chronicles BOTTOM */
        .game-wrapper{display:flex;flex-direction:column;height:calc(100vh - 50px);max-width:1200px;margin:0 auto;padding:.5rem;gap:.5rem}
        .game-top{display:grid;grid-template-columns:260px 1fr;gap:.5rem;flex-shrink:0}
        .game-bottom{flex:1;min-height:180px;overflow:hidden}
        
        .panel{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;overflow:hidden}
        .panel-header{background:var(--bg-light);padding:.4rem .6rem;border-bottom:1px solid var(--border);font-family:'Cinzel',serif;font-size:.7rem;color:var(--gold);text-transform:uppercase;letter-spacing:.05em}
        .panel-body{padding:.5rem}
        
        /* Character Panel */
        .char-panel{display:flex;flex-direction:column}
        .char-header{display:flex;align-items:center;gap:.5rem;padding:.5rem;background:var(--bg-dark);border-bottom:1px solid var(--border)}
        .char-avatar{width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--bg-light);border:2px solid var(--gold-dim);border-radius:6px;font-size:1.6rem}
        .char-avatar img{width:100%;height:100%;object-fit:contain}
        .char-name{font-family:'Cinzel',serif;font-size:.95rem;color:var(--gold-bright)}
        .char-race{font-size:.65rem;color:var(--text-dim)}
        .char-body{padding:.5rem;display:flex;flex-direction:column;gap:.35rem}
        
        .hp-container{background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;height:18px;position:relative;overflow:hidden}
        .hp-fill{height:100%;transition:width .4s;background:linear-gradient(180deg,var(--green-bright),var(--green))}
        .hp-fill.medium{background:linear-gradient(180deg,var(--gold-bright),var(--gold-dim))}
        .hp-fill.low{background:linear-gradient(180deg,var(--orange),#cc4400)}
        .hp-fill.critical{background:linear-gradient(180deg,var(--red-bright),var(--red));animation:pulse 1s infinite}
        @keyframes pulse{50%{opacity:.7}}
        .hp-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:bold;color:white;text-shadow:1px 1px 2px black}
        
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:.2rem}
        .stat-item{display:flex;justify-content:space-between;padding:.15rem .3rem;background:var(--bg-light);border-radius:3px;font-size:.6rem}
        .stat-label{color:var(--text-dim)}.stat-value{color:var(--gold);font-weight:bold}
        
        .equip-slot{display:flex;align-items:center;gap:.35rem;padding:.25rem;background:var(--bg-light);border:1px solid transparent;border-radius:4px;cursor:pointer;transition:all .2s}
        .equip-slot:hover:not(.disabled){border-color:var(--gold-dim);background:var(--bg-dark)}
        .equip-slot.disabled{opacity:.5;cursor:not-allowed}
        .equip-icon{width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
        .equip-icon img{width:100%;height:100%;object-fit:contain}
        .equip-name{font-size:.7rem}.equip-stats{font-size:.55rem;color:var(--text-dim)}
        
        .currency-row{display:flex;justify-content:center;gap:1rem;padding:.25rem;background:var(--bg-dark);border-radius:4px;font-size:.75rem}
        .coin-gold{color:var(--gold-bright)}.coin-silver{color:#c0c0c0}
        
        .location-badge{text-align:center;padding:.2rem;border-radius:4px;font-size:.65rem;border:1px solid var(--border)}
        .location-badge.safe{background:rgba(45,90,39,.3);border-color:var(--green);color:var(--green-bright)}
        .location-badge.danger{background:rgba(139,0,0,.3);border-color:var(--red);color:var(--red-bright)}
        
        /* Main Area */
        .main-area{display:flex;flex-direction:column;gap:.5rem}
        .actions-panel .panel-body{display:flex;flex-wrap:wrap;gap:.35rem;justify-content:center}
        
        /* Combat */
        .combat-arena{background:linear-gradient(180deg,rgba(139,0,0,.2),transparent);border:2px solid var(--red)}
        .combat-arena .panel-header{background:linear-gradient(180deg,rgba(139,0,0,.4),var(--bg-panel));color:var(--red-bright)}
        .combat-grid{display:grid;grid-template-columns:1fr auto 1fr;gap:.5rem;align-items:center;padding:.5rem}
        .combatant{background:var(--bg-dark);border:2px solid var(--border);border-radius:6px;padding:.4rem;text-align:center}
        .combatant.player{border-color:var(--gold-dim)}.combatant.enemy{border-color:var(--red)}
        .combatant-sprite{font-size:2.2rem;margin-bottom:.2rem}
        .combatant-sprite img{width:56px;height:56px;object-fit:contain}
        .combatant-name{font-family:'Cinzel',serif;font-size:.8rem;margin-bottom:.2rem}
        .combatant-stats{font-size:.6rem;color:var(--text-dim);margin-bottom:.3rem}
        .vs-divider{font-size:1.3rem;color:var(--gold)}
        .combat-actions{display:flex;flex-wrap:wrap;justify-content:center;gap:.35rem;padding:.5rem;border-top:1px solid var(--border)}
        .combat-log{max-height:100px;overflow-y:auto;padding:.4rem;background:var(--bg-dark);border-top:1px solid var(--border);font-size:.7rem}
        .log-entry{padding:.1rem 0;border-bottom:1px dashed rgba(255,255,255,.1)}
        .log-player{color:var(--gold)}.log-enemy{color:var(--red-bright)}.log-damage{color:var(--orange)}.log-heal{color:var(--green-bright)}.log-miss{color:var(--text-dim);font-style:italic}.log-crit{color:var(--gold-bright);font-weight:bold}
        .effects-row{display:flex;flex-wrap:wrap;justify-content:center;gap:.15rem;margin-top:.2rem;min-height:16px}
        .effect-tag{font-size:.5rem;padding:.08rem .2rem;border-radius:3px}
        .eff-bleed{background:rgba(139,0,0,.6);border:1px solid var(--red)}.eff-poison{background:rgba(0,100,0,.6);border:1px solid var(--green-bright)}.eff-fire{background:rgba(255,100,0,.5);border:1px solid orange}
        
        /* Chronicles - BOTTOM with auto-scroll */
        .chronicles-panel{display:flex;flex-direction:column;height:100%}
        .chronicles-content{flex:1;overflow-y:auto;padding:.5rem;display:flex;flex-direction:column;gap:.35rem}
        .story-entry{padding:.4rem;border-radius:4px;animation:fadeIn .3s;font-size:.8rem;line-height:1.5}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1}}
        .story-narrative{background:linear-gradient(135deg,rgba(30,25,22,.95),rgba(45,38,33,.8));border-left:3px solid var(--gold-dim);font-style:italic}
        .story-combat{background:rgba(139,0,0,.15);border-left:3px solid var(--red)}
        .story-loot{background:rgba(212,164,55,.15);border-left:3px solid var(--gold)}
        .story-system{background:rgba(74,158,255,.1);border-left:3px solid var(--blue-bright);font-size:.75rem}
        .story-trap{background:rgba(255,107,53,.15);border-left:3px solid var(--orange)}
        .story-dialogue{background:rgba(156,39,176,.1);border-left:3px solid var(--purple)}
        
        /* Buttons */
        .btn{font-family:'Cinzel',serif;font-size:.68rem;padding:.35rem .7rem;background:var(--bg-light);border:1px solid var(--gold-dim);color:var(--gold);cursor:pointer;border-radius:4px;transition:all .2s;white-space:nowrap}
        .btn:hover:not(:disabled){background:var(--gold-dim);color:var(--bg-dark);transform:translateY(-1px)}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .btn-primary{background:var(--gold-dim);color:var(--bg-dark)}
        .btn-danger{border-color:var(--red);color:var(--red-bright)}.btn-danger:hover:not(:disabled){background:var(--red);color:white}
        .btn-sm{font-size:.6rem;padding:.2rem .4rem}
        
        /* Modals */
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:500;justify-content:center;align-items:center;padding:1rem;overflow-y:auto}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-panel);border:2px solid var(--gold-dim);border-radius:8px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:modalIn .2s}
        @keyframes modalIn{from{opacity:0;transform:scale(.95)}}
        .modal-lg{max-width:800px}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:.6rem .8rem;background:var(--bg-light);border-bottom:1px solid var(--border)}
        .modal-title{font-family:'Cinzel',serif;font-size:.9rem;color:var(--gold)}
        .modal-close{background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer}.modal-close:hover{color:var(--gold)}
        .modal-body{padding:.8rem}
        
        .item-detail{text-align:center}
        .item-detail-icon{font-size:3rem;margin-bottom:.4rem}
        .item-detail-icon img{width:64px;height:64px;object-fit:contain}
        .item-detail-name{font-family:'Cinzel',serif;font-size:1.1rem;color:var(--gold-bright)}
        .item-detail-type{color:var(--text-dim);font-size:.75rem;margin-bottom:.5rem}
        .item-detail-desc{background:var(--bg-dark);padding:.5rem;border-radius:4px;text-align:left;margin-bottom:.5rem;font-size:.8rem}
        .item-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:.4rem;margin-bottom:.5rem}
        .item-stat-box{background:var(--bg-light);padding:.4rem;border-radius:4px}
        .item-stat-label{font-size:.55rem;color:var(--text-dim);text-transform:uppercase}
        .item-stat-value{font-size:.9rem;color:var(--gold);font-family:'Cinzel',serif}
        .item-actions{display:flex;flex-wrap:wrap;justify-content:center;gap:.4rem}
        
        .inventory-info{text-align:center;padding:.4rem;color:var(--text-dim);font-size:.75rem;border-bottom:1px solid var(--border)}
        .inventory-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:.3rem;padding:.6rem}
        .inv-slot{aspect-ratio:1;background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;padding:.15rem}
        .inv-slot:hover{border-color:var(--gold-dim);transform:scale(1.05)}
        .inv-slot.empty{cursor:default}.inv-slot.empty:hover{transform:none;border-color:var(--border)}
        .inv-slot-icon{font-size:1.3rem}.inv-slot-icon img{width:28px;height:28px;object-fit:contain}
        .inv-slot-name{font-size:.45rem;text-align:center;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
        .rarity-common{border-color:#555}.rarity-rare{border-color:var(--blue-bright)}.rarity-epic{border-color:var(--purple)}.rarity-legendary{border-color:var(--gold-bright);box-shadow:0 0 6px rgba(255,215,0,.4)}
        
        /* Editor */
        .editor-container{max-width:1000px;margin:0 auto;padding:.8rem}
        .editor-tabs{display:flex;flex-wrap:wrap;gap:.2rem;background:var(--bg-panel);padding:.4rem;border-radius:6px;margin-bottom:.6rem}
        .editor-tab{padding:.35rem .7rem;background:transparent;border:1px solid var(--border);color:var(--text-dim);cursor:pointer;font-family:'Cinzel',serif;font-size:.65rem;border-radius:4px;transition:all .2s}
        .editor-tab:hover{border-color:var(--gold-dim);color:var(--gold)}
        .editor-tab.active{background:var(--gold-dim);color:var(--bg-dark);border-color:var(--gold)}
        .editor-section{display:none;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:.8rem}
        .editor-section.active{display:block}
        .editor-section h3{font-family:'Cinzel',serif;color:var(--gold);font-size:.9rem;margin-bottom:.6rem;padding-bottom:.4rem;border-bottom:1px solid var(--border)}
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.6rem;margin-bottom:.6rem}
        .form-group{display:flex;flex-direction:column;gap:.2rem}
        .form-group label{font-size:.6rem;color:var(--text-dim);text-transform:uppercase}
        .form-group input,.form-group select,.form-group textarea{background:var(--bg-input);border:1px solid var(--border);padding:.4rem;color:var(--text);font-size:.75rem;border-radius:4px;font-family:inherit}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--gold-dim)}
        .form-group textarea{resize:vertical;min-height:50px}
        .form-actions{display:flex;gap:.4rem;justify-content:flex-end;padding-top:.6rem;border-top:1px solid var(--border);margin-top:.6rem}
        .multi-select{background:var(--bg-input);border:1px solid var(--border);border-radius:4px;padding:.4rem;max-height:90px;overflow-y:auto;font-size:.7rem}
        .multi-select label{display:flex;align-items:center;gap:.3rem;padding:.15rem;cursor:pointer}
        .items-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.4rem;margin-top:.8rem;max-height:260px;overflow-y:auto;padding:.2rem}
        .item-card{background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;padding:.4rem;display:flex;align-items:center;gap:.4rem;cursor:pointer;transition:all .2s}
        .item-card:hover{border-color:var(--gold-dim)}
        .item-card-icon{font-size:1.2rem;width:28px;text-align:center}.item-card-icon img{width:28px;height:28px;object-fit:contain}
        .item-card-info{flex:1;min-width:0}
        .item-card-name{font-size:.75rem;color:var(--gold);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .item-card-stats{font-size:.6rem;color:var(--text-dim)}
        .item-card-actions{display:flex;gap:.2rem}
        .icon-btn{background:none;border:1px solid var(--border);color:var(--text-dim);padding:.15rem .25rem;cursor:pointer;font-size:.55rem;border-radius:3px;transition:all .2s}
        .icon-btn:hover{border-color:var(--gold-dim);color:var(--gold)}
        .icon-btn.delete:hover{border-color:var(--red);color:var(--red-bright)}
        
        /* Rules */
        .rules-container{max-width:950px;margin:0 auto;padding:.8rem}
        .rules-header{text-align:center;margin-bottom:.8rem}
        .rules-header h2{font-family:'Cinzel',serif;color:var(--gold);font-size:1.3rem}
        .rules-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:.6rem}
        .rules-card{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:.6rem}
        .rules-card h4{font-family:'Cinzel',serif;color:var(--gold);font-size:.85rem;margin-bottom:.4rem;padding-bottom:.3rem;border-bottom:1px solid var(--border)}
        .rules-card p,.rules-card li{font-size:.75rem;margin-bottom:.2rem}
        .rules-card ul{padding-left:1rem}
        .rules-table{width:100%;border-collapse:collapse;font-size:.7rem;margin:.4rem 0}
        .rules-table th,.rules-table td{border:1px solid var(--border);padding:.25rem .4rem;text-align:left}
        .rules-table th{background:var(--bg-light);color:var(--gold)}
        .rules-highlight{background:var(--bg-dark);border-left:3px solid var(--gold);padding:.4rem;margin:.4rem 0;font-size:.75rem}
        
        /* Toast & Dice */
        .toast-container{position:fixed;top:2.5rem;right:.8rem;z-index:1000;display:flex;flex-direction:column;gap:.4rem}
        .toast{padding:.4rem .8rem;border-radius:4px;font-size:.75rem;animation:toastIn .3s,toastOut .3s 2.5s forwards}
        @keyframes toastIn{from{transform:translateX(100%);opacity:0}}@keyframes toastOut{to{transform:translateX(100%);opacity:0}}
        .toast.success{background:var(--green)}.toast.error{background:var(--red)}.toast.info{background:var(--blue)}
        .dice-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:600;justify-content:center;align-items:center}
        .dice-overlay.active{display:flex}
        .dice-display{background:var(--bg-panel);border:2px solid var(--gold-dim);border-radius:12px;padding:1.2rem 1.8rem;text-align:center}
        .dice-icon{font-size:2.5rem;animation:diceRoll .4s}
        @keyframes diceRoll{0%{transform:rotate(0) scale(.5)}50%{transform:rotate(180deg) scale(1.2)}100%{transform:rotate(360deg) scale(1)}}
        .dice-label{font-size:.75rem;color:var(--text-dim)}
        .dice-result{font-family:'Cinzel',serif;font-size:1.8rem;color:var(--gold-bright)}
        .dice-result.crit{color:var(--red-bright);text-shadow:0 0 10px var(--red)}
        
        @media(max-width:800px){.game-top{grid-template-columns:1fr}.char-panel{order:2}.main-area{order:1}.inventory-grid{grid-template-columns:repeat(4,1fr)}.combat-grid{grid-template-columns:1fr}.vs-divider{padding:.2rem 0}.rules-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="status-bar"><div class="status-dot" id="fbStatus"></div><span id="fbStatusText">...</span></div>
    <nav class="main-nav">
        <button class="nav-btn active" data-tab="game">‚öîÔ∏è Juego</button>
        <button class="nav-btn" data-tab="rules">üìú Reglas</button>
        <button class="nav-btn" data-tab="editor">üõ†Ô∏è Editor</button>
    </nav>

    <!-- GAME TAB -->
    <div class="tab-content active" id="tab-game">
        <div class="game-wrapper">
            <div class="game-top">
                <div class="panel char-panel">
                    <div class="char-header">
                        <div class="char-avatar" id="charAvatar">üßô</div>
                        <div><div class="char-name" id="charName">---</div><div class="char-race" id="charRace">---</div></div>
                    </div>
                    <div class="char-body">
                        <div class="hp-container"><div class="hp-fill" id="hpFill"></div><div class="hp-text" id="hpText">0/0</div></div>
                        <div class="location-badge safe" id="locationBadge">üìç Pueblo</div>
                        <div class="stats-grid">
                            <div class="stat-item"><span class="stat-label">Armadura</span><span class="stat-value" id="statArmor">0</span></div>
                            <div class="stat-item"><span class="stat-label">Evasi√≥n</span><span class="stat-value" id="statEvasion">0</span></div>
                            <div class="stat-item"><span class="stat-label">Precisi√≥n</span><span class="stat-value" id="statPrecision">0</span></div>
                            <div class="stat-item"><span class="stat-label">Da√±o+</span><span class="stat-value" id="statDamage">0</span></div>
                        </div>
                        <div class="equip-slot" id="weaponSlot"><div class="equip-icon" id="weaponIcon">‚öîÔ∏è</div><div><div class="equip-name" id="weaponName">---</div><div class="equip-stats" id="weaponStats">---</div></div></div>
                        <div class="equip-slot" id="armorSlot"><div class="equip-icon" id="armorIcon">üõ°Ô∏è</div><div><div class="equip-name" id="armorName">---</div><div class="equip-stats" id="armorStats">---</div></div></div>
                        <div class="currency-row"><span><span class="coin-gold">‚óè</span> <span id="goldAmount">0</span> MO</span><span><span class="coin-silver">‚óè</span> <span id="silverAmount">0</span> MP</span></div>
                    </div>
                </div>
                <div class="main-area">
                    <div class="panel combat-arena hidden" id="combatArena">
                        <div class="panel-header" style="display:flex;justify-content:space-between"><span>‚öîÔ∏è COMBATE</span><span>Turno <span id="turnCounter">1</span></span></div>
                        <div class="combat-grid">
                            <div class="combatant player">
                                <div class="combatant-sprite" id="playerSprite">üßô</div>
                                <div class="combatant-name" id="playerCombatName">Jugador</div>
                                <div class="combatant-stats">‚öîÔ∏è <span id="playerCombatDmg">1d4</span> | üõ°Ô∏è <span id="playerCombatDef">0</span></div>
                                <div class="hp-container"><div class="hp-fill" id="playerCombatHpFill"></div><div class="hp-text" id="playerCombatHpText">20/20</div></div>
                                <div class="effects-row" id="playerEffects"></div>
                            </div>
                            <div class="vs-divider">‚öî</div>
                            <div class="combatant enemy">
                                <div class="combatant-sprite" id="enemySprite">üëπ</div>
                                <div class="combatant-name" id="enemyCombatName">Enemigo</div>
                                <div class="combatant-stats">‚öîÔ∏è <span id="enemyCombatDmg">1d6</span> | Dif: <span id="enemyCombatDiff">10</span></div>
                                <div class="hp-container"><div class="hp-fill" id="enemyCombatHpFill"></div><div class="hp-text" id="enemyCombatHpText">30/30</div></div>
                                <div class="effects-row" id="enemyEffects"></div>
                            </div>
                        </div>
                        <div class="combat-actions" id="combatActions"></div>
                        <div class="combat-log" id="combatLog"></div>
                    </div>
                    <div class="panel actions-panel"><div class="panel-header">üéÆ Acciones</div><div class="panel-body" id="actionsContainer"></div></div>
                </div>
            </div>
            <div class="game-bottom">
                <div class="panel chronicles-panel"><div class="panel-header">üìñ Cr√≥nicas</div><div class="chronicles-content" id="chroniclesContent"></div></div>
            </div>
        </div>
    </div>

    <!-- RULES TAB -->
    <div class="tab-content" id="tab-rules">
        <div class="rules-container">
            <div class="rules-header"><h2>üìú Reglas Completas</h2></div>
            <div class="rules-grid">
                <div class="rules-card"><h4>üé≠ 1. Creaci√≥n</h4><p><strong>Razas:</strong> Humano (+1HP), Elfo (+1Prec), Enano (+1Arm), Orco (+1Da√±o), Mediano (+1Eva)</p><p><strong>Inicio:</strong> 20 MP, 10 espacios</p></div>
                <div class="rules-card"><h4>‚öîÔ∏è 2. Combate</h4><div class="rules-highlight"><strong>Atacar:</strong> D20+prec ‚â• dificultad<br><strong>Cr√≠tico (20):</strong> √ó2 da√±o<br><strong>Esquivar:</strong> D20+eva ‚â• 12</div></div>
                <div class="rules-card"><h4>ü©∏ 3. Efectos</h4><table class="rules-table"><tr><th>Efecto</th><th>Da√±o</th><th>Turnos</th></tr><tr><td>Sangrado</td><td>1</td><td>3</td></tr><tr><td>Veneno</td><td>2</td><td>2</td></tr><tr><td>Fuego</td><td>1d4</td><td>2</td></tr></table></div>
                <div class="rules-card"><h4>ü™§ 4. Trampas</h4><div class="rules-highlight"><strong>Detectar:</strong> D20 ‚â• dif<br><strong>Esquivar:</strong> D20+eva ‚â• 12<br><strong>Desactivar:</strong> D20 ‚â• 15</div></div>
                <div class="rules-card"><h4>üéí 5. Equipo</h4><div class="rules-highlight">‚ö†Ô∏è Solo cambiar en <strong>zonas seguras</strong></div><p>Mochilas: +5/+10/+20 espacios</p></div>
                <div class="rules-card"><h4>üí∞ 6. Econom√≠a</h4><div class="rules-highlight"><strong>99 MP = 1 MO</strong></div><p>Vender: 50% valor</p></div>
                <div class="rules-card"><h4>üê∫ 7. Domesticar</h4><p>Usa carne. Dados: D24/D30/D60/D100. √âxito: ‚â•60%</p></div>
                <div class="rules-card"><h4>‚ò†Ô∏è 8. Muerte</h4><div class="rules-highlight" style="border-color:var(--red)">HP=0: -50% monedas, pierdes items no equipados</div></div>
                <div class="rules-card"><h4>üó∫Ô∏è 9. Exploraci√≥n</h4><ul><li>50% Enemigo</li><li>20% Trampa</li><li>15% Tesoro</li><li>10% Animal</li><li>5% Descanso</li></ul></div>
                <div class="rules-card"><h4>üèòÔ∏è 10. Pueblo</h4><p>Herrero, Alquimista, Tabernero (5MP +50%HP), Curandero (10MP full)</p></div>
            </div>
        </div>
    </div>

    <!-- EDITOR TAB -->
    <div class="tab-content" id="tab-editor">
        <div class="editor-container">
            <div class="editor-tabs">
                <button class="editor-tab active" data-editor="races">üë§ Razas</button>
                <button class="editor-tab" data-editor="weapons">‚öîÔ∏è Armas</button>
                <button class="editor-tab" data-editor="armors">üõ°Ô∏è Armaduras</button>
                <button class="editor-tab" data-editor="items">üéí Items</button>
                <button class="editor-tab" data-editor="enemies">üëπ Enemigos</button>
                <button class="editor-tab" data-editor="pets">üê∫ Mascotas</button>
                <button class="editor-tab" data-editor="npcs">üßî NPCs</button>
            </div>
            
            <div class="editor-section active" id="editor-races">
                <h3>üë§ Editor de Razas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="race-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="race-name"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="race-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="race-sprite"></div>
                    <div class="form-group"><label>+HP</label><input type="number" id="race-hp"></div>
                    <div class="form-group"><label>+Armadura</label><input type="number" id="race-armor"></div>
                    <div class="form-group"><label>+Evasi√≥n</label><input type="number" id="race-evasion"></div>
                    <div class="form-group"><label>+Precisi√≥n</label><input type="number" id="race-precision"></div>
                    <div class="form-group"><label>+Da√±o</label><input type="number" id="race-damage"></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="race-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('race')">üÜï Nuevo</button><button class="btn btn-primary" onclick="Editor.saveRace()">üíæ Guardar</button></div>
                <div class="items-list" id="races-list"></div>
            </div>

            <div class="editor-section" id="editor-weapons">
                <h3>‚öîÔ∏è Editor de Armas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="weapon-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="weapon-name"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="weapon-damage" placeholder="1d8"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="weapon-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="weapon-sprite"></div>
                    <div class="form-group"><label>Rareza</label><select id="weapon-rarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="weapon-value"></div>
                    <div class="form-group"><label>Efecto</label><select id="weapon-effect"><option value="">Ninguno</option><option value="bleed">Sangrado</option><option value="poison">Veneno</option><option value="fire">Fuego</option></select></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="weapon-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('weapon')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveWeapon()">üíæ</button></div>
                <div class="items-list" id="weapons-list"></div>
            </div>

            <div class="editor-section" id="editor-armors">
                <h3>üõ°Ô∏è Editor de Armaduras</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="armor-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="armor-name"></div>
                    <div class="form-group"><label>Defensa</label><input type="number" id="armor-defense"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="armor-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="armor-sprite"></div>
                    <div class="form-group"><label>Rareza</label><select id="armor-rarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="armor-value"></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="armor-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('armor')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveArmor()">üíæ</button></div>
                <div class="items-list" id="armors-list"></div>
            </div>

            <div class="editor-section" id="editor-items">
                <h3>üéí Editor de Items</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="item-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="item-name"></div>
                    <div class="form-group"><label>Tipo</label><select id="item-type"><option value="potion">Poci√≥n</option><option value="food">Comida</option><option value="antidote">Ant√≠doto</option><option value="escape">Escape</option><option value="backpack">Mochila</option><option value="misc">Otro</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="item-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="item-sprite"></div>
                    <div class="form-group"><label>Efecto</label><input type="text" id="item-effect" placeholder="1d8"></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="item-value"></div>
                    <div class="form-group"><label>Rareza</label><select id="item-rarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="item-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('item')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveItem()">üíæ</button></div>
                <div class="items-list" id="items-list"></div>
            </div>

            <div class="editor-section" id="editor-enemies">
                <h3>üëπ Editor de Enemigos</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="enemy-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="enemy-name"></div>
                    <div class="form-group"><label>Salud</label><input type="number" id="enemy-health"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="enemy-damage"></div>
                    <div class="form-group"><label>Dificultad</label><input type="number" id="enemy-difficulty" min="1" max="20"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="enemy-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="enemy-sprite"></div>
                    <div class="form-group"><label>Efecto</label><select id="enemy-effect"><option value="">Ninguno</option><option value="bleed">Sangrado</option><option value="poison">Veneno</option><option value="fire">Fuego</option></select></div>
                    <div class="form-group"><label>H√°bitat</label><select id="enemy-habitat"><option value="any">Cualquiera</option><option value="forest">Bosque</option><option value="dungeon">Mazmorra</option><option value="mountain">Monta√±a</option><option value="swamp">Pantano</option><option value="ruins">Ruinas</option></select></div>
                    <div class="form-group"><label>Loot Min</label><input type="number" id="enemy-loot-min"></div>
                    <div class="form-group"><label>Loot Max</label><input type="number" id="enemy-loot-max"></div>
                </div>
                <div class="form-group"><label>Narrativa</label><textarea id="enemy-desc"></textarea></div>
                <div class="form-group"><label>Drops</label><div class="multi-select" id="enemy-drops"></div></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('enemy')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveEnemy()">üíæ</button></div>
                <div class="items-list" id="enemies-list"></div>
            </div>

            <div class="editor-section" id="editor-pets">
                <h3>üê∫ Editor de Mascotas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="pet-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="pet-name"></div>
                    <div class="form-group"><label>Salud</label><input type="number" id="pet-health"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="pet-damage"></div>
                    <div class="form-group"><label>Dado domesticar</label><input type="number" id="pet-difficulty"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="pet-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="pet-sprite"></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="pet-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('pet')">üÜï</button><button class="btn btn-primary" onclick="Editor.savePet()">üíæ</button></div>
                <div class="items-list" id="pets-list"></div>
            </div>

            <div class="editor-section" id="editor-npcs">
                <h3>üßî Editor de NPCs</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="npc-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="npc-name"></div>
                    <div class="form-group"><label>Rol</label><select id="npc-role"><option value="merchant">Comerciante</option><option value="blacksmith">Herrero</option><option value="alchemist">Alquimista</option><option value="innkeeper">Tabernero</option><option value="healer">Curandero</option><option value="guard">Guardia</option><option value="villager">Aldeano</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="npc-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="npc-sprite"></div>
                    <div class="form-group"><label>Ubicaci√≥n</label><input type="text" id="npc-location"></div>
                </div>
                <div class="form-group"><label>Di√°logo</label><textarea id="npc-dialogue"></textarea></div>
                <div class="form-group"><label>Vende</label><div class="multi-select" id="npc-sells"></div></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('npc')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveNpc()">üíæ</button></div>
                <div class="items-list" id="npcs-list"></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="inventoryModal">
        <div class="modal modal-lg"><div class="modal-header"><span class="modal-title">üéí Inventario</span><button class="modal-close" data-close="inventoryModal">&times;</button></div>
        <div class="inventory-info" id="inventoryInfo">0/10</div><div class="inventory-grid" id="inventoryGrid"></div></div>
    </div>
    <div class="modal-overlay" id="itemDetailModal">
        <div class="modal"><div class="modal-header"><span class="modal-title">Detalles</span><button class="modal-close" data-close="itemDetailModal">&times;</button></div>
        <div class="modal-body"><div class="item-detail"><div class="item-detail-icon" id="detailIcon">üì¶</div><div class="item-detail-name" id="detailName">Item</div><div class="item-detail-type" id="detailType">Tipo</div><div class="item-detail-desc" id="detailDesc">...</div><div class="item-stats-grid" id="detailStats"></div><div class="item-actions" id="detailActions"></div></div></div></div>
    </div>
    <div class="modal-overlay" id="townModal">
        <div class="modal"><div class="modal-header"><span class="modal-title">üèòÔ∏è Pueblo</span><button class="modal-close" data-close="townModal">&times;</button></div><div class="modal-body" id="townContent"></div></div>
    </div>
    <div class="modal-overlay" id="shopModal">
        <div class="modal modal-lg"><div class="modal-header"><span class="modal-title" id="shopTitle">üè™ Tienda</span><button class="modal-close" data-close="shopModal">&times;</button></div><div class="modal-body" id="shopContent"></div></div>
    </div>
    <div class="dice-overlay" id="diceOverlay"><div class="dice-display"><div class="dice-icon">üé≤</div><div class="dice-label" id="diceLabel">D20</div><div class="dice-result" id="diceResult">--</div></div></div>
    <div class="toast-container" id="toastContainer"></div>

    <script>
    const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
    const roll=d=>{if(typeof d==='number')return d;const m=String(d).match(/(\d+)?d(\d+)([+-]\d+)?/i);if(!m)return parseInt(d)||0;let t=parseInt(m[3])||0;for(let i=0;i<(parseInt(m[1])||1);i++)t+=Math.floor(Math.random()*parseInt(m[2]))+1;return Math.max(1,t)};
    const d20=()=>Math.floor(Math.random()*20)+1;
    const dX=x=>Math.floor(Math.random()*x)+1;
    const pick=a=>a[Math.floor(Math.random()*a.length)];
    const hpClass=p=>p>60?'':p>30?'medium':p>15?'low':'critical';
    const sprite=i=>i?.sprite?`<img src="${i.sprite}">`:(i?.icon||'üì¶');
    const genId=p=>`${p}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;
    const toast=(m,t='info')=>{const e=document.createElement('div');e.className=`toast ${t}`;e.textContent=m;$('#toastContainer').appendChild(e);setTimeout(()=>e.remove(),3000)};
    const openModal=id=>$(`#${id}`).classList.add('active');
    const closeModal=id=>$(`#${id}`).classList.remove('active');
    const showDice=async(r,s=20,c=false)=>{$('#diceLabel').textContent=`D${s}`;$('#diceResult').textContent=r;$('#diceResult').classList.toggle('crit',c);$('#diceOverlay').classList.add('active');await new Promise(r=>setTimeout(r,600));$('#diceOverlay').classList.remove('active')};
    const scrollChron=()=>{const c=$('#chroniclesContent');c.scrollTop=c.scrollHeight};

    // Data
    const Data={
        races:[{id:'human',name:'Humano',icon:'üßë',bonus:{health:1}},{id:'elf',name:'Elfo',icon:'üßù',bonus:{precision:1}},{id:'dwarf',name:'Enano',icon:'üßî',bonus:{armor:1}},{id:'orc',name:'Orco',icon:'üëπ',bonus:{damage:1}},{id:'halfling',name:'Mediano',icon:'üßí',bonus:{evasion:1}}],
        weapons:[{id:'w1',name:'Daga',damage:'1d4',icon:'üó°Ô∏è',value:10,rarity:'common'},{id:'w2',name:'Espada',damage:'1d6',icon:'‚öîÔ∏è',value:20,rarity:'common'},{id:'w3',name:'Hacha',damage:'1d6',icon:'ü™ì',value:20,rarity:'common'},{id:'w4',name:'Bast√≥n',damage:'1d4',icon:'ü™Ñ',value:10,rarity:'common'}],
        armors:[{id:'a1',name:'T√∫nica cuero',defense:1,icon:'ü¶∫',value:15,rarity:'common'},{id:'a2',name:'Cuero reforzado',defense:2,icon:'ü¶∫',value:30,rarity:'common'},{id:'a3',name:'Cota malla',defense:3,icon:'‚õìÔ∏è',value:75,rarity:'rare'},{id:'a4',name:'T√∫nica tela',defense:0,icon:'üëï',value:5,rarity:'common'}],
        items:[{id:'i1',name:'Poci√≥n',type:'potion',effect:'1d8',icon:'üß™',value:10,rarity:'common'},{id:'i2',name:'Ant√≠doto',type:'antidote',icon:'üíä',value:15,rarity:'common'},{id:'i3',name:'Bomba humo',type:'escape',icon:'üí®',value:25,rarity:'common'},{id:'i4',name:'Carne',type:'food',effect:'1d4',icon:'ü•©',value:5,rarity:'common'}],
        enemies:[{id:'e1',name:'Rata',health:10,damage:'1d4',difficulty:6,icon:'üêÄ',loot:[5,10],drops:['i1'],habitat:'dungeon',desc:'Una rata enorme.'},{id:'e2',name:'Goblin',health:15,damage:'1d6',difficulty:8,icon:'üë∫',loot:[8,15],drops:['i1','w1'],habitat:'forest',desc:'Un goblin escu√°lido.'},{id:'e3',name:'Esqueleto',health:20,damage:'1d6',difficulty:10,icon:'üíÄ',loot:[10,25],drops:['i1'],habitat:'ruins',desc:'Huesos que se alzan.'},{id:'e4',name:'Orco',health:35,damage:'1d8',difficulty:12,icon:'üëπ',loot:[20,40],drops:['w2'],habitat:'mountain',desc:'Un orco musculoso.'},{id:'e5',name:'Troll',health:50,damage:'2d6',difficulty:14,icon:'üßå',loot:[40,80],drops:['a2'],habitat:'swamp',desc:'El troll emerge.'}],
        pets:[{id:'p1',name:'Lobo',health:20,damage:'1d6',difficulty:24,icon:'üê∫'},{id:'p2',name:'Oso',health:35,damage:'1d8',difficulty:30,icon:'üêª'},{id:'p3',name:'√Åguila',health:15,damage:'1d4',difficulty:24,icon:'ü¶Ö'}],
        npcs:[{id:'n1',name:'Grimbold',role:'blacksmith',icon:'üßî',dialogue:'¬°Mis armas son las mejores!',sells:['w1','w2','w3']},{id:'n2',name:'Elara',role:'alchemist',icon:'üßô‚Äç‚ôÄÔ∏è',dialogue:'Mis pociones curan...',sells:['i1','i2']},{id:'n3',name:'Tobias',role:'innkeeper',icon:'üßë‚Äçüç≥',dialogue:'¬°Cerveza fr√≠a!',sells:['i4']}],
        traps:[{name:'P√∫as',damage:'1d6',effect:'bleed',detectDiff:10,dodgeDiff:12},{name:'Dardo',damage:'1d4',effect:'poison',detectDiff:12,dodgeDiff:10},{name:'Foso',damage:'2d6',effect:null,detectDiff:8,dodgeDiff:14},{name:'Runa',damage:'2d8',effect:'fire',detectDiff:14,dodgeDiff:12}],
        locations:{danger:[{name:'Bosque Sombr√≠o',habitat:'forest'},{name:'Ruinas',habitat:'ruins'},{name:'Pantano',habitat:'swamp'},{name:'Caverna',habitat:'dungeon'},{name:'Monta√±a',habitat:'mountain'}],safe:[{name:'Claro'},{name:'Refugio'}]},
        find(t,id){return this[t]?.find(x=>x.id===id)},
        findItem(id){return this.find('weapons',id)||this.find('armors',id)||this.find('items',id)},
        save(){localStorage.setItem('rpg_data',JSON.stringify({races:this.races,weapons:this.weapons,armors:this.armors,items:this.items,enemies:this.enemies,pets:this.pets,npcs:this.npcs}));if(FB.db&&FB.ok)FB.db.ref('gameData').set({races:this.races,weapons:this.weapons,armors:this.armors,items:this.items,enemies:this.enemies,pets:this.pets,npcs:this.npcs})},
        load(){const s=localStorage.getItem('rpg_data');if(s)try{Object.assign(this,JSON.parse(s))}catch(e){}}
    };

    // Firebase
    const FB={db:null,ok:false,init(){try{firebase.initializeApp({apiKey:"AIzaSyAV4eSg9QjyE08zwtFsvjAomuMYVcNik9k",databaseURL:"https://rpggo-756a7-default-rtdb.firebaseio.com",projectId:"rpggo-756a7"});this.db=firebase.database();this.db.ref('.info/connected').on('value',s=>{this.ok=s.val()===true;$('#fbStatus').classList.toggle('connected',this.ok);$('#fbStatusText').textContent=this.ok?'‚úì':'‚úó';if(this.ok)this.load()})}catch(e){}},load(){if(!this.db)return;this.db.ref('gameData').once('value').then(s=>{const d=s.val();if(d){Object.keys(d).forEach(k=>{if(Data[k])Data[k]=d[k]});Editor.renderAll()}})}};

    // Game State
    let G={p:null,combat:false,enemy:null,turn:0,loc:{name:'Pueblo',type:'safe'},item:null};

    const Story={add(t,c=''){const e=document.createElement('div');e.className=`story-entry ${c?'story-'+c:''}`;e.innerHTML=t;$('#chroniclesContent').appendChild(e);setTimeout(scrollChron,50)},clear(){$('#chroniclesContent').innerHTML=''}};

    const Game={
        init(){this.load()||this.new()},
        new(){
            const race=pick(Data.races),weapon={...pick(Data.weapons.slice(0,4)),uid:genId('i')},armor={...pick(Data.armors.slice(0,4)),uid:genId('i')},item={...pick(Data.items),uid:genId('i')};
            G.p={name:pick(['Aldric','Brynn','Cedric','Dara','Freya','Gideon','Kira','Mira']),race,maxHp:20+(race.bonus.health||0),hp:20+(race.bonus.health||0),weapon,armor,inv:[item],maxSlots:10,gold:0,silver:20,effects:[],pet:null,defending:false};
            G.combat=false;G.enemy=null;G.turn=0;G.loc={name:'Pueblo',type:'safe'};
            Story.clear();Story.add(`<strong style="color:var(--gold)">‚öîÔ∏è Nueva Aventura ‚öîÔ∏è</strong>`);
            Story.add(`Eres <strong>${G.p.name}</strong>, ${race.name} ${race.icon}.`,'narrative');
            Story.add(`Equipado: ${weapon.name}, ${armor.name}. ${G.p.silver} MP.`,'system');
            this.updateUI();this.exploreActions()
        },
        save(){localStorage.setItem('rpg_save',JSON.stringify({p:G.p,loc:G.loc}));toast('Guardado','success')},
        load(){const s=localStorage.getItem('rpg_save');if(!s)return false;try{const d=JSON.parse(s);G.p=d.p;G.loc=d.loc||{name:'Pueblo',type:'safe'};G.combat=false;Story.add('Partida cargada.','system');this.updateUI();this.exploreActions();return true}catch(e){return false}},
        updateUI(){
            const p=G.p;if(!p)return;
            $('#charAvatar').innerHTML=p.race.sprite?`<img src="${p.race.sprite}">`:p.race.icon;
            $('#charName').textContent=p.name;$('#charRace').textContent=`${p.race.name} (+${Object.entries(p.race.bonus).filter(([k,v])=>v).map(([k,v])=>`${v}${k[0].toUpperCase()}`).join('')||'?'})`;
            const hp=(p.hp/p.maxHp)*100;$('#hpFill').style.width=hp+'%';$('#hpFill').className=`hp-fill ${hpClass(hp)}`;$('#hpText').textContent=`${p.hp}/${p.maxHp}`;
            $('#locationBadge').textContent=`üìç ${G.loc.name}`;$('#locationBadge').className=`location-badge ${G.loc.type}`;
            $('#statArmor').textContent=this.armor();$('#statEvasion').textContent=p.race.bonus.evasion||0;$('#statPrecision').textContent=p.race.bonus.precision||0;$('#statDamage').textContent=p.race.bonus.damage||0;
            $('#weaponIcon').innerHTML=sprite(p.weapon);$('#weaponName').textContent=p.weapon?.name||'Pu√±os';$('#weaponStats').textContent=`Da√±o: ${p.weapon?.damage||'1d2'}`;
            $('#armorIcon').innerHTML=sprite(p.armor);$('#armorName').textContent=p.armor?.name||'Sin armadura';$('#armorStats').textContent=`Def: ${p.armor?.defense||0}`;
            $('#goldAmount').textContent=p.gold;$('#silverAmount').textContent=p.silver;
            const canEq=!G.combat&&G.loc.type==='safe';$('#weaponSlot').classList.toggle('disabled',!canEq);$('#armorSlot').classList.toggle('disabled',!canEq)
        },
        armor(){return(G.p.armor?.defense||0)+(G.p.race.bonus.armor||0)},
        setActions(acts){const c=$('#actionsContainer');c.innerHTML='';acts.forEach(a=>{const b=document.createElement('button');b.className=`btn ${a.cls||''}`;b.textContent=a.text;b.disabled=a.disabled||false;b.onclick=a.fn;c.appendChild(b)})},
        exploreActions(){this.setActions([{text:'üó∫Ô∏è Explorar',fn:()=>Explore.start(),cls:'btn-primary'},{text:'üèòÔ∏è Pueblo',fn:()=>Town.visit()},{text:'üéí Inventario',fn:()=>Inv.open()},{text:'üíæ Guardar',fn:()=>this.save()}])}
    };

    const Explore={
        start(){
            Story.add(pick(['Te adentras en lo desconocido...','El camino se bifurca...','Una brisa cargada de presagios...']),'narrative');
            Game.setActions([{text:'...',disabled:true}]);
            setTimeout(()=>{
                const danger=Math.random()<0.7;const loc=pick(danger?Data.locations.danger:Data.locations.safe);
                G.loc={name:loc.name,type:danger?'danger':'safe',habitat:loc.habitat};
                Story.add(`<strong>${loc.name}</strong>`,'narrative');Game.updateUI();
                setTimeout(()=>{if(!danger){this.safe();return}const r=dX(100);if(r<=50)this.enemy();else if(r<=70)this.trap();else if(r<=85)this.treasure();else if(r<=95)this.pet();else this.safe()},1000)
            },800)
        },
        enemy(){
            const pool=Data.enemies.filter(e=>e.habitat===G.loc.habitat||e.habitat==='any'||!e.habitat);
            const en=pick(pool.length?pool:Data.enemies);
            Story.add(en.desc||`Un ${en.name} aparece.`,'narrative');
            setTimeout(()=>{Story.add(`<strong>¬°${en.name} ataca!</strong>`,'combat');Game.setActions([{text:'‚öîÔ∏è Luchar',fn:()=>Combat.start(en),cls:'btn-primary'},{text:'üí® Huir',fn:()=>this.flee(en),cls:'btn-danger'}])},600)
        },
        async flee(en){const r=d20();await showDice(r,20,r>=14);Story.add(`Huida: ${r} vs 14`,'system');if(r>=14){Story.add('¬°Escapas!','narrative');G.loc={name:'Sendero',type:'safe'};Game.updateUI();Game.exploreActions()}else{Story.add('¬°No escapas!','combat');Combat.start(en)}},
        async trap(){
            const trap=pick(Data.traps);Story.add('Algo no est√° bien...','narrative');
            setTimeout(async()=>{Story.add(`<strong>¬°Trampa!</strong> ${trap.name}`,'trap');const det=d20();await showDice(det,20,det>=trap.detectDiff);Story.add(`Percepci√≥n: ${det} vs ${trap.detectDiff}`,'system');
            if(det>=trap.detectDiff){Story.add('¬°La detectas!','system');Game.setActions([{text:'üèÉ Esquivar',fn:async()=>{const r=d20()+(G.p.race.bonus.evasion||0);await showDice(r,20,r>=trap.dodgeDiff);Story.add(`Esquive: ${r} vs ${trap.dodgeDiff}`,'system');if(r>=trap.dodgeDiff){Story.add('¬°Te apartas!','loot');Game.exploreActions()}else{this.trapDmg(trap,true)}},cls:'btn-primary'},{text:'üîß Desactivar',fn:async()=>{const r=d20();await showDice(r,20,r>=15);Story.add(`Desactivar: ${r} vs 15`,'system');if(r>=15){const mp=dX(15)+5;G.p.silver+=mp;Story.add(`+${mp} MP`,'loot')}else if(r>=10){Story.add('Te apartas.','system')}else{Story.add('¬°Activas la trampa!','trap');this.trapDmg(trap,false);return}Game.updateUI();Game.exploreActions()}}])}else{Story.add('No la ves...','trap');this.trapDmg(trap,false)}},800)
        },
        trapDmg(trap,reduced){let dmg=roll(trap.damage);if(reduced)dmg=Math.ceil(dmg*0.5);const arm=Math.floor(Game.armor()/2);const f=Math.max(1,dmg-arm);G.p.hp-=f;Story.add(`${trap.name}: <span style="color:var(--red-bright)">${f} da√±o</span>`,'combat');if(trap.effect)Combat.applyEff(G.p,trap.effect);Game.updateUI();if(G.p.hp<=0){Story.add('<strong style="color:var(--red-bright)">Has muerto...</strong>','combat');Game.setActions([{text:'üîÑ Nuevo',fn:()=>Game.new(),cls:'btn-primary'}])}else Game.exploreActions()},
        treasure(){Story.add('¬°Algo brilla!','narrative');setTimeout(()=>{const mp=dX(30)+10;G.p.silver+=mp;while(G.p.silver>=99){G.p.silver-=99;G.p.gold++}Story.add(`+${mp} MP`,'loot');if(Math.random()<0.3&&G.p.inv.length<G.p.maxSlots){const it={...pick(Data.items),uid:genId('i')};G.p.inv.push(it);Story.add(`+${it.name}`,'loot')}Game.updateUI();Game.exploreActions()},800)},
        pet(){if(G.p.pet){this.safe();return}const pet=pick(Data.pets);Story.add(`Un ${pet.name} aparece.`,'narrative');const meat=G.p.inv.some(i=>i.type==='food');Game.setActions([{text:'ü•© Domesticar',fn:async()=>{const idx=G.p.inv.findIndex(i=>i.type==='food');if(idx>=0)G.p.inv.splice(idx,1);Story.add(`Ofreces comida...`,'narrative');const r=dX(pet.difficulty);const th=Math.ceil(pet.difficulty*0.6);await showDice(r,pet.difficulty,r>=th);Story.add(`D${pet.difficulty}: ${r} (necesitas ${th}+)`,'system');if(r>=th){G.p.pet={...pet,hp:pet.health,maxHp:pet.health};Story.add(`<strong style="color:var(--green-bright)">¬°${pet.name} es tu compa√±ero!</strong>`,'loot');toast('Compa√±ero','success')}else{Story.add(`Se aleja.`,'narrative')}Game.updateUI();Game.exploreActions()},disabled:!meat,cls:meat?'btn-primary':''},{text:'‚öîÔ∏è Cazar',fn:()=>Combat.start({...pet,health:pet.health,difficulty:10,loot:[5,15],drops:['i4']})},{text:'üö∂ Dejar',fn:()=>{Story.add('Te alejas.','narrative');Game.exploreActions()}}])},
        safe(){Story.add('Encuentras un lugar tranquilo.','narrative');G.loc={name:'Refugio',type:'safe'};const h=Math.floor(G.p.maxHp*0.3);G.p.hp=Math.min(G.p.maxHp,G.p.hp+h);G.p.effects=[];Story.add(`<span style="color:var(--green-bright)">+${h} HP</span>. Zona segura.`,'system');Game.updateUI();Game.exploreActions()}
    };

    const Combat={
        start(en){G.combat=true;G.enemy={...en,hp:en.health,maxHp:en.health,effects:[]};G.turn=1;$('#combatArena').classList.remove('hidden');$('#combatLog').innerHTML='';this.updateUI();Game.updateUI();Game.setActions([{text:'En combate...',disabled:true}])},
        updateUI(){
            const p=G.p,e=G.enemy;$('#turnCounter').textContent=G.turn;
            $('#playerSprite').innerHTML=sprite({icon:p.race.icon,sprite:p.race.sprite});$('#playerCombatName').textContent=p.name;$('#playerCombatDmg').textContent=p.weapon?.damage||'1d2';$('#playerCombatDef').textContent=Game.armor();
            const pp=(p.hp/p.maxHp)*100;$('#playerCombatHpFill').style.width=pp+'%';$('#playerCombatHpFill').className=`hp-fill ${hpClass(pp)}`;$('#playerCombatHpText').textContent=`${p.hp}/${p.maxHp}`;
            $('#playerEffects').innerHTML=p.effects.map(ef=>`<span class="effect-tag eff-${ef.type}">${ef.type} ${ef.turns}</span>`).join('');
            $('#enemySprite').innerHTML=sprite(e);$('#enemyCombatName').textContent=e.name;$('#enemyCombatDmg').textContent=e.damage;$('#enemyCombatDiff').textContent=e.difficulty;
            const ep=(e.hp/e.maxHp)*100;$('#enemyCombatHpFill').style.width=ep+'%';$('#enemyCombatHpFill').className=`hp-fill ${hpClass(ep)}`;$('#enemyCombatHpText').textContent=`${e.hp}/${e.maxHp}`;
            $('#enemyEffects').innerHTML=(e.effects||[]).map(ef=>`<span class="effect-tag eff-${ef.type}">${ef.type} ${ef.turns}</span>`).join('');
            const ca=$('#combatActions');ca.innerHTML='';[{text:'‚öîÔ∏è Atacar',fn:()=>this.attack(),cls:'btn-primary'},{text:'üéí Item',fn:()=>Inv.open()},{text:'üõ°Ô∏è Defender',fn:()=>this.defend()},{text:'üí® Huir',fn:()=>this.flee(),cls:'btn-danger'}].forEach(a=>{const b=document.createElement('button');b.className=`btn ${a.cls||''}`;b.textContent=a.text;b.onclick=a.fn;ca.appendChild(b)})
        },
        log(t,c=''){$('#combatLog').innerHTML+=`<div class="log-entry ${c}">${t}</div>`;$('#combatLog').scrollTop=999999},
        async attack(){
            const p=G.p,e=G.enemy,r=d20(),prec=p.race.bonus.precision||0,total=r+prec,crit=r===20;
            await showDice(r,20,crit);this.log(`<span class="log-player">${p.name}</span>: ${r}${prec?`+${prec}`:''}=${total} vs ${e.difficulty}`);
            if(r===1){this.log('<span class="log-miss">¬°Pifia!</span>')}
            else if(total>=e.difficulty){let dmg=roll(p.weapon?.damage||'1d2')+(p.race.bonus.damage||0);if(crit){dmg*=2;this.log('<span class="log-crit">¬°CR√çTICO!</span>')}e.hp-=dmg;this.log(`<span class="log-damage">${dmg} da√±o</span>`);if(p.weapon?.effect)this.applyEff(e,p.weapon.effect);if(p.pet){const pd=roll(p.pet.damage);e.hp-=pd;this.log(`${p.pet.icon}: ${pd}`)}if(e.hp<=0){this.victory();return}}
            else{this.log('<span class="log-miss">Fallo</span>')}this.updateUI();await this.enemyTurn()
        },
        defend(){G.p.defending=true;this.log(`<span class="log-player">${G.p.name}</span> defiende (+4 eva)`);this.enemyTurn()},
        async flee(){const r=d20();await showDice(r,20,r>=12);if(r>=12){this.log(`Huida: ${r} <span class="log-heal">¬°Escape!</span>`);this.escape()}else{this.log(`Huida: ${r} <span class="log-miss">Fallido</span>`);await this.enemyTurn()}},
        async enemyTurn(){
            const p=G.p,e=G.enemy;this.processEff(e);this.updateUI();if(e.hp<=0){this.victory();return}
            const dr=d20(),eva=(p.race.bonus.evasion||0)+(p.defending?4:0),td=dr+eva;
            this.log(`<span class="log-enemy">${e.name}</span> ataca`);this.log(`Esquive: ${dr}${eva?`+${eva}`:''}=${td} vs 12`);
            if(td>=12){this.log('<span class="log-heal">¬°Esquivado!</span>')}
            else{let dmg=roll(e.damage);const crit=Math.random()<0.1;if(crit){dmg=Math.ceil(dmg*1.25);this.log('<span class="log-crit">Cr√≠tico!</span>')}const arm=Game.armor();const f=Math.max(1,dmg-arm);p.hp-=f;this.log(`<span class="log-damage">${f} da√±o</span>`);if(e.effect)this.applyEff(p,e.effect)}
            this.processEff(p);p.defending=false;G.turn++;this.updateUI();Game.updateUI();if(p.hp<=0)this.defeat()
        },
        applyEff(t,type){const effs={bleed:{dmg:1,turns:3,max:3},poison:{dmg:2,turns:2,max:2},fire:{dmg:'1d4',turns:2,max:1}};const ef=effs[type];if(!ef)return;if(!t.effects)t.effects=[];const ex=t.effects.find(e=>e.type===type);if(ex){if(ex.stacks<ef.max)ex.stacks++;ex.turns=ef.turns}else t.effects.push({type,dmg:ef.dmg,turns:ef.turns,stacks:1})},
        processEff(t){if(!t.effects?.length)return;let d=0;t.effects.forEach(ef=>{d+=(typeof ef.dmg==='string'?roll(ef.dmg):ef.dmg)*(ef.stacks||1);ef.turns--});t.effects=t.effects.filter(e=>e.turns>0);if(d>0)t.hp-=d},
        victory(){const e=G.enemy;$('#combatArena').classList.add('hidden');G.combat=false;Story.add(`<strong style="color:var(--green-bright)">¬°Victoria!</strong> vs ${e.name}`,'loot');if(e.loot){const mp=dX(e.loot[1]-e.loot[0])+e.loot[0];G.p.silver+=mp;while(G.p.silver>=99){G.p.silver-=99;G.p.gold++}Story.add(`+${mp} MP`,'loot')}if(e.drops)e.drops.forEach(did=>{if(Math.random()<0.3&&G.p.inv.length<G.p.maxSlots){const it=Data.findItem(did);if(it){G.p.inv.push({...it,uid:genId('i')});Story.add(`+${it.name}`,'loot')}}});G.loc={name:'Campo',type:'safe'};G.enemy=null;Game.updateUI();Game.exploreActions()},
        defeat(){$('#combatArena').classList.add('hidden');G.combat=false;Story.add('<strong style="color:var(--red-bright)">Has ca√≠do...</strong>','combat');Game.setActions([{text:'üîÑ Nuevo',fn:()=>Game.new(),cls:'btn-primary'}])},
        escape(){$('#combatArena').classList.add('hidden');G.combat=false;G.enemy=null;G.loc={name:'Sendero',type:'safe'};Story.add('Escapas.','system');Game.updateUI();Game.exploreActions()}
    };

    const Inv={
        open(){this.render();openModal('inventoryModal')},
        render(){$('#inventoryInfo').textContent=`${G.p.inv.length}/${G.p.maxSlots}`;const g=$('#inventoryGrid');g.innerHTML='';G.p.inv.forEach(it=>{const s=document.createElement('div');s.className=`inv-slot rarity-${it.rarity||'common'}`;s.innerHTML=`<div class="inv-slot-icon">${sprite(it)}</div><div class="inv-slot-name">${it.name}</div>`;s.onclick=()=>this.detail(it,'inv');g.appendChild(s)});for(let i=G.p.inv.length;i<G.p.maxSlots;i++){const s=document.createElement('div');s.className='inv-slot empty';s.innerHTML='<div class="inv-slot-name" style="color:var(--text-dim)">vac√≠o</div>';g.appendChild(s)}},
        detail(it,ctx){
            G.item=it;$('#detailIcon').innerHTML=sprite(it);$('#detailName').textContent=it.name;$('#detailType').textContent=it.damage?'Arma':it.defense!==undefined?'Armadura':it.type||'Item';$('#detailDesc').textContent=it.desc||'Sin descripci√≥n.';
            let st='';if(it.damage)st+=`<div class="item-stat-box"><div class="item-stat-label">Da√±o</div><div class="item-stat-value">${it.damage}</div></div>`;if(it.defense!==undefined)st+=`<div class="item-stat-box"><div class="item-stat-label">Def</div><div class="item-stat-value">${it.defense}</div></div>`;if(it.effect&&(it.type==='potion'||it.type==='food'))st+=`<div class="item-stat-box"><div class="item-stat-label">Cura</div><div class="item-stat-value">${it.effect}</div></div>`;if(it.value)st+=`<div class="item-stat-box"><div class="item-stat-label">Valor</div><div class="item-stat-value">${it.value}MP</div></div>`;$('#detailStats').innerHTML=st;
            const canEq=!G.combat&&G.loc.type==='safe';let acts='';
            if(ctx.startsWith('eq-')){if(canEq)acts=`<button class="btn btn-danger" onclick="Inv.unequip('${ctx.split('-')[1]}')">‚ùå Desequipar</button>`;else acts='<span style="color:var(--text-dim)">Solo zona segura</span>'}
            else{if(it.damage&&canEq)acts+=`<button class="btn btn-primary" onclick="Inv.equip('weapon')">‚öîÔ∏è Equipar</button>`;if(it.defense!==undefined&&canEq)acts+=`<button class="btn btn-primary" onclick="Inv.equip('armor')">üõ°Ô∏è Equipar</button>`;if(it.type==='potion'||it.type==='food')acts+=`<button class="btn btn-primary" onclick="Inv.use()">‚ú® Usar</button>`;if(it.type==='antidote')acts+=`<button class="btn btn-primary" onclick="Inv.use()">üíä Usar</button>`;if(it.type==='escape'&&G.combat)acts+=`<button class="btn btn-primary" onclick="Inv.use()">üí® Usar</button>`;if(it.type==='backpack')acts+=`<button class="btn btn-primary" onclick="Inv.use()">üéí Usar</button>`}
            acts+=`<button class="btn" onclick="closeModal('itemDetailModal')">Cerrar</button>`;$('#detailActions').innerHTML=acts;openModal('itemDetailModal')
        },
        equip(slot){const it=G.item;if(!it?.uid)return;closeModal('itemDetailModal');if(slot==='weapon'){if(G.p.weapon?.uid)G.p.inv.push(G.p.weapon);G.p.weapon=it}else{if(G.p.armor?.uid)G.p.inv.push(G.p.armor);G.p.armor=it}G.p.inv=G.p.inv.filter(i=>i.uid!==it.uid);Story.add(`Equipas ${it.name}.`,'system');toast('Equipado','success');Game.updateUI();this.render()},
        unequip(slot){if(G.p.inv.length>=G.p.maxSlots){toast('Inventario lleno','error');return}closeModal('itemDetailModal');if(slot==='weapon'){if(G.p.weapon?.uid)G.p.inv.push(G.p.weapon);G.p.weapon={name:'Pu√±os',damage:'1d2',icon:'‚úä'}}else{if(G.p.armor?.uid)G.p.inv.push(G.p.armor);G.p.armor={name:'Sin armadura',defense:0,icon:'üë§'}}Story.add('Guardas tu equipo.','system');toast('Desequipado','info');Game.updateUI()},
        use(){const it=G.item;if(!it?.uid)return;closeModal('itemDetailModal');closeModal('inventoryModal');if(it.type==='potion'||it.type==='food'){const h=roll(it.effect||'1d4');const a=Math.min(h,G.p.maxHp-G.p.hp);G.p.hp+=a;Story.add(`${it.name}: <span style="color:var(--green-bright)">+${a} HP</span>`,'system')}else if(it.type==='antidote'){G.p.effects=G.p.effects.filter(e=>e.type!=='poison');Story.add('Veneno curado.','system')}else if(it.type==='escape'&&G.combat){G.p.inv=G.p.inv.filter(i=>i.uid!==it.uid);Story.add('¬°Bomba de humo!','narrative');Combat.escape();return}else if(it.type==='backpack'){const s=parseInt(it.effect)||5;G.p.maxSlots+=s;Story.add(`+${s} espacios.`,'system')}G.p.inv=G.p.inv.filter(i=>i.uid!==it.uid);Game.updateUI();if(G.combat)Combat.updateUI()}
    };

    const Town={
        npc:null,
        visit(){G.loc={name:'Pueblo',type:'safe'};Game.updateUI();Story.add('Llegas al pueblo.','narrative');const roles={merchant:'Comerciante',blacksmith:'Herrero',alchemist:'Alquimista',innkeeper:'Tabernero',healer:'Curandero',guard:'Guardia',villager:'Aldeano'};let h='<div style="display:grid;gap:.4rem">';Data.npcs.forEach(n=>{h+=`<div class="item-card" onclick="Town.interact('${n.id}')"><span class="item-card-icon">${sprite(n)}</span><div class="item-card-info"><div class="item-card-name">${n.name}</div><div class="item-card-stats">${roles[n.role]||n.role}</div></div></div>`});h+='</div>';$('#townContent').innerHTML=h;openModal('townModal')},
        interact(id){const n=Data.find('npcs',id);if(!n)return;closeModal('townModal');this.npc=n;Story.add(`<strong>${n.name}</strong>: "${n.dialogue||'¬°Saludos!'}"`,`dialogue`);if(n.sells?.length)setTimeout(()=>this.shop(n),400);else if(n.role==='healer'){if(G.p.silver>=10){G.p.silver-=10;G.p.hp=G.p.maxHp;G.p.effects=[];Story.add('Curaci√≥n. (-10MP)','system')}else Story.add('"No tienes dinero."','dialogue');Game.updateUI()}else if(n.role==='innkeeper'){if(G.p.silver>=5){G.p.silver-=5;const h=Math.floor(G.p.maxHp*0.5);G.p.hp=Math.min(G.p.maxHp,G.p.hp+h);Story.add(`Descansas. +${h}HP (-5MP)`,'system')}Game.updateUI()}},
        shop(n){$('#shopTitle').textContent=`üè™ ${n.name}`;let h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:.8rem"><div><h4 style="color:var(--gold);margin-bottom:.4rem">En venta</h4><div style="display:grid;gap:.2rem;max-height:180px;overflow-y:auto">';(n.sells||[]).forEach(iid=>{const it=Data.findItem(iid);if(it){const can=G.p.silver>=it.value&&G.p.inv.length<G.p.maxSlots;h+=`<div class="item-card" style="opacity:${can?1:.5}"><span class="item-card-icon">${sprite(it)}</span><div class="item-card-info"><div class="item-card-name">${it.name}</div><div class="item-card-stats">${it.value}MP</div></div><button class="btn btn-sm" onclick="Town.buy('${it.id}')" ${can?'':'disabled'}>Comprar</button></div>`}});h+='</div></div><div><h4 style="color:var(--gold);margin-bottom:.4rem">Vender</h4><div style="display:grid;gap:.2rem;max-height:180px;overflow-y:auto">';G.p.inv.forEach(it=>{const sp=Math.floor((it.value||10)*0.5);h+=`<div class="item-card"><span class="item-card-icon">${sprite(it)}</span><div class="item-card-info"><div class="item-card-name">${it.name}</div><div class="item-card-stats">${sp}MP</div></div><button class="btn btn-sm" onclick="Town.sell('${it.uid}',${sp})">Vender</button></div>`});h+=`</div></div></div><div style="text-align:center;margin-top:.6rem;color:var(--text-dim)">${G.p.gold}MO ${G.p.silver}MP</div>`;$('#shopContent').innerHTML=h;openModal('shopModal')},
        buy(iid){const it=Data.findItem(iid);if(!it||G.p.silver<it.value||G.p.inv.length>=G.p.maxSlots)return;G.p.silver-=it.value;G.p.inv.push({...it,uid:genId('i')});Story.add(`Compras ${it.name}`,'system');toast('Comprado','success');Game.updateUI();if(this.npc)this.shop(this.npc)},
        sell(uid,price){const it=G.p.inv.find(i=>i.uid===uid);if(!it)return;G.p.inv=G.p.inv.filter(i=>i.uid!==uid);G.p.silver+=price;while(G.p.silver>=99){G.p.silver-=99;G.p.gold++}Story.add(`Vendes ${it.name}`,'system');toast('Vendido','success');Game.updateUI();if(this.npc)this.shop(this.npc)}
    };

    const Editor={
        clear(t){const f={race:['race-id','race-name','race-icon','race-sprite','race-hp','race-armor','race-evasion','race-precision','race-damage','race-desc'],weapon:['weapon-id','weapon-name','weapon-damage','weapon-icon','weapon-sprite','weapon-value','weapon-desc'],armor:['armor-id','armor-name','armor-defense','armor-icon','armor-sprite','armor-value','armor-desc'],item:['item-id','item-name','item-icon','item-sprite','item-effect','item-value','item-desc'],enemy:['enemy-id','enemy-name','enemy-health','enemy-damage','enemy-difficulty','enemy-icon','enemy-sprite','enemy-loot-min','enemy-loot-max','enemy-desc'],pet:['pet-id','pet-name','pet-health','pet-damage','pet-difficulty','pet-icon','pet-sprite','pet-desc'],npc:['npc-id','npc-name','npc-icon','npc-sprite','npc-location','npc-dialogue']};(f[t]||[]).forEach(id=>{const e=$(`#${id}`);if(e)e.value=''})},
        saveRace(){const r={id:$('#race-id').value||genId('race'),name:$('#race-name').value,icon:$('#race-icon').value||'üë§',sprite:$('#race-sprite').value||'',bonus:{health:parseInt($('#race-hp').value)||0,armor:parseInt($('#race-armor').value)||0,evasion:parseInt($('#race-evasion').value)||0,precision:parseInt($('#race-precision').value)||0,damage:parseInt($('#race-damage').value)||0},desc:$('#race-desc').value||''};if(!r.name){toast('Falta nombre','error');return}const i=Data.races.findIndex(x=>x.id===r.id);if(i>=0)Data.races[i]=r;else Data.races.push(r);Data.save();this.renderRaces();this.clear('race');toast('Guardado','success')},
        editRace(id){const r=Data.find('races',id);if(!r)return;$('#race-id').value=r.id;$('#race-name').value=r.name;$('#race-icon').value=r.icon||'';$('#race-sprite').value=r.sprite||'';$('#race-hp').value=r.bonus?.health||'';$('#race-armor').value=r.bonus?.armor||'';$('#race-evasion').value=r.bonus?.evasion||'';$('#race-precision').value=r.bonus?.precision||'';$('#race-damage').value=r.bonus?.damage||'';$('#race-desc').value=r.desc||''},
        deleteRace(id){if(!confirm('¬øEliminar?'))return;Data.races=Data.races.filter(r=>r.id!==id);Data.save();this.renderRaces();toast('Eliminado','info')},
        saveWeapon(){const w={id:$('#weapon-id').value||genId('w'),name:$('#weapon-name').value,damage:$('#weapon-damage').value||'1d4',icon:$('#weapon-icon').value||'‚öîÔ∏è',sprite:$('#weapon-sprite').value||'',rarity:$('#weapon-rarity').value,value:parseInt($('#weapon-value').value)||10,effect:$('#weapon-effect').value||null,desc:$('#weapon-desc').value||''};if(!w.name){toast('Falta nombre','error');return}const i=Data.weapons.findIndex(x=>x.id===w.id);if(i>=0)Data.weapons[i]=w;else Data.weapons.push(w);Data.save();this.renderWeapons();this.updateDrops();this.clear('weapon');toast('Guardado','success')},
        saveArmor(){const a={id:$('#armor-id').value||genId('a'),name:$('#armor-name').value,defense:parseInt($('#armor-defense').value)||0,icon:$('#armor-icon').value||'üõ°Ô∏è',sprite:$('#armor-sprite').value||'',rarity:$('#armor-rarity').value,value:parseInt($('#armor-value').value)||10,desc:$('#armor-desc').value||''};if(!a.name){toast('Falta nombre','error');return}const i=Data.armors.findIndex(x=>x.id===a.id);if(i>=0)Data.armors[i]=a;else Data.armors.push(a);Data.save();this.renderArmors();this.updateDrops();this.clear('armor');toast('Guardado','success')},
        saveItem(){const it={id:$('#item-id').value||genId('i'),name:$('#item-name').value,type:$('#item-type').value,icon:$('#item-icon').value||'üì¶',sprite:$('#item-sprite').value||'',effect:$('#item-effect').value||'',value:parseInt($('#item-value').value)||10,rarity:$('#item-rarity').value,desc:$('#item-desc').value||''};if(!it.name){toast('Falta nombre','error');return}const i=Data.items.findIndex(x=>x.id===it.id);if(i>=0)Data.items[i]=it;else Data.items.push(it);Data.save();this.renderItems();this.updateDrops();this.clear('item');toast('Guardado','success')},
        saveEnemy(){const drops=Array.from($$('#enemy-drops input:checked')).map(c=>c.value);const e={id:$('#enemy-id').value||genId('e'),name:$('#enemy-name').value,health:parseInt($('#enemy-health').value)||20,damage:$('#enemy-damage').value||'1d6',difficulty:parseInt($('#enemy-difficulty').value)||10,icon:$('#enemy-icon').value||'üëπ',sprite:$('#enemy-sprite').value||'',effect:$('#enemy-effect').value||null,habitat:$('#enemy-habitat').value||'any',loot:[parseInt($('#enemy-loot-min').value)||5,parseInt($('#enemy-loot-max').value)||20],drops,desc:$('#enemy-desc').value||''};if(!e.name){toast('Falta nombre','error');return}const i=Data.enemies.findIndex(x=>x.id===e.id);if(i>=0)Data.enemies[i]=e;else Data.enemies.push(e);Data.save();this.renderEnemies();this.clear('enemy');toast('Guardado','success')},
        savePet(){const p={id:$('#pet-id').value||genId('p'),name:$('#pet-name').value,health:parseInt($('#pet-health').value)||20,damage:$('#pet-damage').value||'1d4',difficulty:parseInt($('#pet-difficulty').value)||24,icon:$('#pet-icon').value||'üê∫',sprite:$('#pet-sprite').value||'',desc:$('#pet-desc').value||''};if(!p.name){toast('Falta nombre','error');return}const i=Data.pets.findIndex(x=>x.id===p.id);if(i>=0)Data.pets[i]=p;else Data.pets.push(p);Data.save();this.renderPets();this.clear('pet');toast('Guardado','success')},
        saveNpc(){const sells=Array.from($$('#npc-sells input:checked')).map(c=>c.value);const n={id:$('#npc-id').value||genId('n'),name:$('#npc-name').value,role:$('#npc-role').value,icon:$('#npc-icon').value||'üßî',sprite:$('#npc-sprite').value||'',location:$('#npc-location').value||'',dialogue:$('#npc-dialogue').value||'',sells};if(!n.name){toast('Falta nombre','error');return}const i=Data.npcs.findIndex(x=>x.id===n.id);if(i>=0)Data.npcs[i]=n;else Data.npcs.push(n);Data.save();this.renderNpcs();this.clear('npc');toast('Guardado','success')},
        edit(t,p,id){const it=Data.find(t,id);if(!it)return;Object.keys(it).forEach(k=>{const e=$(`#${p}-${k}`);if(e)e.value=it[k]||''})},
        del(t,id){if(!confirm('¬øEliminar?'))return;Data[t]=Data[t].filter(x=>x.id!==id);Data.save();this.renderAll();toast('Eliminado','info')},
        renderAll(){this.renderRaces();this.renderWeapons();this.renderArmors();this.renderItems();this.renderEnemies();this.renderPets();this.renderNpcs();this.updateDrops()},
        renderRaces(){$('#races-list').innerHTML=Data.races.map(r=>`<div class="item-card" onclick="Editor.editRace('${r.id}')"><span class="item-card-icon">${sprite(r)}</span><div class="item-card-info"><div class="item-card-name">${r.name}</div><div class="item-card-stats">${Object.entries(r.bonus||{}).filter(([k,v])=>v).map(([k,v])=>`+${v}${k[0].toUpperCase()}`).join(' ')||'-'}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editRace('${r.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.deleteRace('${r.id}')">üóëÔ∏è</button></div></div>`).join('')},
        renderWeapons(){$('#weapons-list').innerHTML=Data.weapons.map(w=>`<div class="item-card" onclick="Editor.edit('weapons','weapon','${w.id}')"><span class="item-card-icon">${sprite(w)}</span><div class="item-card-info"><div class="item-card-name">${w.name}</div><div class="item-card-stats">${w.damage}|${w.value}MP</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.edit('weapons','weapon','${w.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('weapons','${w.id}')">üóëÔ∏è</button></div></div>`).join('')},
        renderArmors(){$('#armors-list').innerHTML=Data.armors.map(a=>`<div class="item-card" onclick="Editor.edit('armors','armor','${a.id}')"><span class="item-card-icon">${sprite(a)}</span><div class="item-card-info"><div class="item-card-name">${a.name}</div><div class="item-card-stats">Def:${a.defense}|${a.value}MP</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.edit('armors','armor','${a.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('armors','${a.id}')">üóëÔ∏è</button></div></div>`).join('')},
        renderItems(){$('#items-list').innerHTML=Data.items.map(i=>`<div class="item-card" onclick="Editor.edit('items','item','${i.id}')"><span class="item-card-icon">${sprite(i)}</span><div class="item-card-info"><div class="item-card-name">${i.name}</div><div class="item-card-stats">${i.type}|${i.value}MP</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.edit('items','item','${i.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('items','${i.id}')">üóëÔ∏è</button></div></div>`).join('')},
        renderEnemies(){$('#enemies-list').innerHTML=Data.enemies.map(e=>`<div class="item-card" onclick="Editor.editEnemy('${e.id}')"><span class="item-card-icon">${sprite(e)}</span><div class="item-card-info"><div class="item-card-name">${e.name}</div><div class="item-card-stats">HP:${e.health}|${e.damage}|Dif:${e.difficulty}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editEnemy('${e.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('enemies','${e.id}')">üóëÔ∏è</button></div></div>`).join('')},
        editEnemy(id){const e=Data.find('enemies',id);if(!e)return;$('#enemy-id').value=e.id;$('#enemy-name').value=e.name;$('#enemy-health').value=e.health||'';$('#enemy-damage').value=e.damage||'';$('#enemy-difficulty').value=e.difficulty||'';$('#enemy-icon').value=e.icon||'';$('#enemy-sprite').value=e.sprite||'';$('#enemy-effect').value=e.effect||'';$('#enemy-habitat').value=e.habitat||'any';$('#enemy-loot-min').value=e.loot?.[0]||'';$('#enemy-loot-max').value=e.loot?.[1]||'';$('#enemy-desc').value=e.desc||'';setTimeout(()=>$$('#enemy-drops input').forEach(c=>c.checked=(e.drops||[]).includes(c.value)),50)},
        renderPets(){$('#pets-list').innerHTML=Data.pets.map(p=>`<div class="item-card" onclick="Editor.edit('pets','pet','${p.id}')"><span class="item-card-icon">${sprite(p)}</span><div class="item-card-info"><div class="item-card-name">${p.name}</div><div class="item-card-stats">HP:${p.health}|${p.damage}|D${p.difficulty}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.edit('pets','pet','${p.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('pets','${p.id}')">üóëÔ∏è</button></div></div>`).join('')},
        renderNpcs(){const roles={merchant:'Comerciante',blacksmith:'Herrero',alchemist:'Alquimista',innkeeper:'Tabernero',healer:'Curandero',guard:'Guardia',villager:'Aldeano'};$('#npcs-list').innerHTML=Data.npcs.map(n=>`<div class="item-card" onclick="Editor.editNpc('${n.id}')"><span class="item-card-icon">${sprite(n)}</span><div class="item-card-info"><div class="item-card-name">${n.name}</div><div class="item-card-stats">${roles[n.role]||n.role}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editNpc('${n.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('npcs','${n.id}')">üóëÔ∏è</button></div></div>`).join('')},
        editNpc(id){const n=Data.find('npcs',id);if(!n)return;$('#npc-id').value=n.id;$('#npc-name').value=n.name;$('#npc-role').value=n.role||'merchant';$('#npc-icon').value=n.icon||'';$('#npc-sprite').value=n.sprite||'';$('#npc-location').value=n.location||'';$('#npc-dialogue').value=n.dialogue||'';setTimeout(()=>$$('#npc-sells input').forEach(c=>c.checked=(n.sells||[]).includes(c.value)),50)},
        updateDrops(){const all=[...Data.weapons,...Data.armors,...Data.items];const h=all.map(it=>`<label><input type="checkbox" value="${it.id}"> ${it.icon||'üì¶'} ${it.name}</label>`).join('');$('#enemy-drops').innerHTML=h;$('#npc-sells').innerHTML=h}
    };

    // INIT
    document.addEventListener('DOMContentLoaded',()=>{
        FB.init();Data.load();Editor.renderAll();Game.init();
        $$('.nav-btn').forEach(b=>b.addEventListener('click',()=>{$$('.nav-btn').forEach(x=>x.classList.remove('active'));$$('.tab-content').forEach(x=>x.classList.remove('active'));b.classList.add('active');$(`#tab-${b.dataset.tab}`).classList.add('active')}));
        $$('.editor-tab').forEach(t=>t.addEventListener('click',()=>{$$('.editor-tab').forEach(x=>x.classList.remove('active'));$$('.editor-section').forEach(x=>x.classList.remove('active'));t.classList.add('active');$(`#editor-${t.dataset.editor}`).classList.add('active');if(t.dataset.editor==='enemies'||t.dataset.editor==='npcs')Editor.updateDrops()}));
        $$('.modal-close').forEach(b=>b.addEventListener('click',()=>closeModal(b.dataset.close)));
        $$('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')}));
        $('#weaponSlot').addEventListener('click',()=>{if(G.combat||G.loc.type!=='safe'){toast('Solo zona segura','error');return}if(G.p.weapon?.uid)Inv.detail(G.p.weapon,'eq-weapon')});
        $('#armorSlot').addEventListener('click',()=>{if(G.combat||G.loc.type!=='safe'){toast('Solo zona segura','error');return}if(G.p.armor?.uid)Inv.detail(G.p.armor,'eq-armor')});
    });
    </script>
</body>
</html>
