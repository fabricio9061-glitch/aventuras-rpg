<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventuras de Acero y Runas</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        :root{--bg-dark:#0a0908;--bg-panel:#1a1614;--bg-light:#2a2320;--bg-input:#151210;--gold:#d4a437;--gold-dim:#a67c00;--gold-bright:#ffd700;--red:#8b0000;--red-bright:#dc143c;--green:#2d5a27;--green-bright:#4caf50;--blue:#1e3a5f;--blue-bright:#4a9eff;--purple:#9c27b0;--orange:#ff6b35;--cyan:#00bcd4;--text:#e8dcc4;--text-dim:#8a8078;--border:#3d3530}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Crimson Text',Georgia,serif;background:var(--bg-dark);color:var(--text);min-height:100vh;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
        ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--gold-dim);border-radius:3px}
        .hidden{display:none!important}
        
        .auth-screen,.char-create{position:fixed;inset:0;background:var(--bg-dark);z-index:9999;display:flex;align-items:flex-start;justify-content:center;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch}
        .auth-box,.create-box{background:var(--bg-panel);border:2px solid var(--gold-dim);border-radius:12px;padding:2rem;width:100%;max-width:400px;margin:auto}
        .auth-logo,.create-logo{text-align:center;margin-bottom:1.5rem}
        .auth-logo h1,.create-logo h1{font-family:'Cinzel',serif;color:var(--gold-bright);font-size:1.5rem;margin-bottom:.5rem}
        .auth-logo p,.create-logo p{color:var(--text-dim);font-size:.85rem}
        .auth-form{display:flex;flex-direction:column;gap:.8rem}
        .auth-input,.create-input{background:var(--bg-input);border:1px solid var(--border);padding:.7rem;color:var(--text);font-size:1rem;border-radius:6px;width:100%}
        .auth-input:focus,.create-input:focus{outline:none;border-color:var(--gold-dim)}
        .auth-btn,.create-btn{font-family:'Cinzel',serif;padding:.7rem;background:var(--gold-dim);border:none;color:var(--bg-dark);cursor:pointer;border-radius:6px;font-size:1rem;font-weight:600;margin-top:.5rem;width:100%}
        .auth-btn:hover,.create-btn:hover{background:var(--gold-bright)}
        .auth-btn:active,.create-btn:active{transform:scale(.97);opacity:.9}
        .auth-btn:disabled{opacity:.5;cursor:not-allowed}
        .auth-divider{text-align:center;color:var(--text-dim);font-size:.8rem;margin:.8rem 0}
        .auth-link{color:var(--gold);cursor:pointer;text-decoration:underline;font-size:.85rem}
        .auth-link:hover{color:var(--gold-bright)}
        .auth-guest{background:transparent;border:1px solid var(--gold-dim);color:var(--gold)}
        .auth-guest:hover{background:rgba(212,164,55,.1)}
        .create-section{margin-bottom:1rem}
        .create-section label{display:block;font-size:.75rem;color:var(--text-dim);text-transform:uppercase;margin-bottom:.5rem;letter-spacing:.05em}
        .race-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.5rem}
        .race-option{background:var(--bg-light);border:2px solid var(--border);border-radius:8px;padding:.7rem;text-align:center;cursor:pointer;transition:all .2s}
        .race-option:hover{border-color:var(--gold-dim)}
        .race-option:active{transform:scale(.97)}
        .race-option.selected{border-color:var(--gold-bright);background:rgba(212,164,55,.1)}
        .race-option-icon{font-size:2rem;margin-bottom:.3rem;width:50px;height:50px;display:flex;align-items:center;justify-content:center;margin:0 auto .3rem}
        .race-option-icon img{max-width:50px;max-height:50px;object-fit:contain}
        .race-option-name{font-family:'Cinzel',serif;font-size:.85rem;color:var(--gold)}
        .race-option-stats{font-size:.7rem;color:var(--text-dim)}
        .user-info{display:flex;align-items:center;gap:.5rem;font-size:.75rem}
        .logout-btn{background:none;border:1px solid var(--border);color:var(--text-dim);padding:.2rem .5rem;border-radius:3px;cursor:pointer;font-size:.65rem}
        .logout-btn:hover{border-color:var(--gold-dim);color:var(--gold)}
        
        .main-nav{display:flex;justify-content:center;background:var(--bg-panel);border-bottom:2px solid var(--gold-dim);position:sticky;top:0;z-index:100;padding:.25rem;gap:.25rem;flex-wrap:wrap}
        .nav-btn{font-family:'Cinzel',serif;font-size:.75rem;padding:.4rem 1rem;background:transparent;border:1px solid transparent;color:var(--text-dim);cursor:pointer;border-radius:3px;transition:all .2s}
        .nav-btn:hover{color:var(--gold);border-color:var(--gold-dim)}
        .nav-btn:active{transform:scale(.95)}
        .nav-btn.active{color:var(--gold-bright);background:rgba(212,164,55,.15);border-color:var(--gold-dim)}
        
        .status-bar{position:fixed;top:0;right:0;display:flex;align-items:center;gap:.5rem;padding:.25rem .5rem;background:var(--bg-panel);border-bottom-left-radius:6px;font-size:.65rem;z-index:200}
        .status-dot{width:8px;height:8px;border-radius:50%;background:var(--red)}.status-dot.connected{background:var(--green-bright)}
        
        .tab-content{display:none;min-height:calc(100vh - 50px)}.tab-content.active{display:flex;flex-direction:column}
        
        .game-wrapper{display:flex;flex-direction:column;height:calc(100vh - 50px);max-width:1400px;margin:0 auto;padding:.5rem;gap:.5rem}
        .game-top{display:grid;grid-template-columns:260px 1fr;gap:.5rem;flex-shrink:0}
        .game-bottom{flex:1;min-height:200px;overflow:hidden}
        
        .panel{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;overflow:hidden}
        .panel-header{background:var(--bg-light);padding:.4rem .6rem;border-bottom:1px solid var(--border);font-family:'Cinzel',serif;font-size:.7rem;color:var(--gold);text-transform:uppercase;letter-spacing:.05em;display:flex;justify-content:space-between;align-items:center}
        .panel-body{padding:.5rem}
        
        /* Character Panel - hidden during combat */
        .char-panel{display:flex;flex-direction:column}
        .char-panel.in-combat .char-hp-section{display:none}
        .char-header{display:flex;align-items:center;gap:.5rem;padding:.5rem;background:var(--bg-dark);border-bottom:1px solid var(--border)}
        .char-avatar{width:48px;height:48px;display:flex;align-items:center;justify-content:center;background:var(--bg-light);border:2px solid var(--gold-dim);border-radius:6px;font-size:1.8rem}
        .char-avatar img{width:100%;height:100%;object-fit:contain}
        .char-name{font-family:'Cinzel',serif;font-size:1rem;color:var(--gold-bright)}
        .char-race{font-size:.65rem;color:var(--text-dim)}
        .char-body{padding:.5rem;display:flex;flex-direction:column;gap:.4rem}
        
        .hp-container{background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;height:20px;position:relative;overflow:hidden}
        .hp-fill{height:100%;transition:width .3s ease;background:linear-gradient(180deg,var(--green-bright),var(--green))}
        .hp-fill.medium{background:linear-gradient(180deg,var(--gold-bright),var(--gold-dim))}
        .hp-fill.low{background:linear-gradient(180deg,var(--orange),#cc4400)}
        .hp-fill.critical{background:linear-gradient(180deg,var(--red-bright),var(--red));animation:pulse 1s infinite}
        @keyframes pulse{50%{opacity:.7}}
        .hp-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:bold;color:white;text-shadow:1px 1px 2px black}
        
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:.25rem}
        .stat-item{display:flex;justify-content:space-between;padding:.2rem .35rem;background:var(--bg-light);border-radius:3px;font-size:.65rem}
        .stat-label{color:var(--text-dim)}.stat-value{color:var(--gold);font-weight:bold}
        
        .equip-slot{display:flex;align-items:center;gap:.4rem;padding:.3rem;background:var(--bg-light);border:1px solid transparent;border-radius:4px;cursor:pointer;transition:all .2s}
        .equip-slot:hover:not(.disabled){border-color:var(--gold-dim);background:var(--bg-dark)}
        .equip-slot.disabled{opacity:.5;cursor:not-allowed}
        .equip-icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .equip-icon img{width:100%;height:100%;object-fit:contain}
        .equip-name{font-size:.75rem}.equip-stats{font-size:.6rem;color:var(--text-dim)}
        
        .currency-row{display:flex;justify-content:center;gap:1rem;padding:.3rem;background:var(--bg-dark);border-radius:4px;font-size:.8rem}
        .coin-gold{color:var(--gold-bright)}.coin-silver{color:#c0c0c0}
        
        .region-badge{text-align:center;padding:.35rem;border-radius:4px;font-size:.7rem;border:1px solid var(--border);cursor:pointer;transition:all .2s}
        .region-badge:hover{border-color:var(--gold-dim)}
        .region-badge.safe{background:rgba(45,90,39,.3);border-color:var(--green);color:var(--green-bright)}
        .region-badge.danger{background:rgba(139,0,0,.3);border-color:var(--red);color:var(--red-bright)}
        .region-badge .region-icon{font-size:1rem;margin-right:.3rem}
        .region-badge .region-name{font-weight:bold}
        
        .main-area{display:flex;flex-direction:column;gap:.5rem}
        /* Hide actions panel during combat */
        .actions-panel.in-combat{display:none}
        .actions-panel .panel-body{display:flex;flex-wrap:wrap;gap:.4rem;justify-content:center}
        
        /* Combat Arena */
        .combat-arena{background:linear-gradient(180deg,rgba(139,0,0,.2),transparent);border:2px solid var(--red)}
        .combat-arena .panel-header{background:linear-gradient(180deg,rgba(139,0,0,.4),var(--bg-panel));color:var(--red-bright)}
        .combat-grid{display:flex;gap:.5rem;align-items:start;padding:.5rem;flex-wrap:wrap;justify-content:center}
        .combatant{background:var(--bg-dark);border:2px solid var(--border);border-radius:6px;padding:.4rem;text-align:center;min-width:110px;max-width:140px;flex:0 0 auto;position:relative}
        .combatant.player{border-color:var(--gold-dim);order:-1}
        .combatant.enemy{border-color:var(--red)}
        .combatant.pet{border-color:var(--cyan);order:-1}
        .combatant.dead{opacity:.4;filter:grayscale(1)}
        .combatant.active{box-shadow:0 0 12px var(--gold-bright);border-color:var(--gold-bright)}
        .combatant-order{position:absolute;top:-8px;right:-8px;background:var(--gold);color:var(--bg-dark);width:20px;height:20px;border-radius:50%;font-size:.6rem;font-weight:bold;display:flex;align-items:center;justify-content:center}
        .combatant-sprite{font-size:2rem;margin-bottom:.2rem}
        .combatant-sprite img{width:48px;height:48px;object-fit:contain}
        .combatant-name{font-family:'Cinzel',serif;font-size:.7rem;margin-bottom:.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .combatant-stats{font-size:.5rem;color:var(--text-dim);margin-bottom:.2rem}
        .combatant .hp-container{height:14px}
        .combatant .hp-text{font-size:.55rem}
        .combat-vs{font-size:1.2rem;color:var(--gold);align-self:center;padding:0 .3rem}
        .combat-actions{display:flex;flex-wrap:wrap;justify-content:center;gap:.4rem;padding:.5rem;border-top:1px solid var(--border)}
        
        /* Combat Log */
        .combat-log{max-height:180px;overflow-y:auto;padding:.5rem;background:var(--bg-dark);border-top:1px solid var(--border);font-size:.7rem}
        .log-entry{padding:.12rem 0;border-bottom:1px dashed rgba(255,255,255,.05)}
        .log-entry:last-child{border-bottom:none}
        .log-player{color:var(--gold)}.log-enemy{color:var(--red-bright)}.log-pet{color:var(--cyan)}.log-damage{color:var(--orange)}.log-heal{color:var(--green-bright)}.log-miss{color:var(--text-dim);font-style:italic}.log-crit{color:var(--gold-bright);font-weight:bold}
        .log-calc{background:var(--bg-panel);padding:.2rem .4rem;border-radius:3px;margin:.15rem 0;font-family:'Consolas',monospace;font-size:.65rem;border-left:3px solid var(--orange)}
        .log-calc.blocked{border-left-color:var(--blue-bright)}
        .log-turn{background:linear-gradient(90deg,transparent,var(--bg-light),transparent);color:var(--gold);padding:.25rem .5rem;margin:.3rem -.5rem;text-align:center;font-family:'Cinzel',serif;font-size:.68rem;letter-spacing:.1em}
        .log-order{display:flex;flex-wrap:wrap;gap:.2rem;justify-content:center;margin:.2rem 0}
        .log-order-tag{background:var(--bg-light);padding:.1rem .3rem;border-radius:3px;font-size:.55rem}
        .log-order-tag.player{border:1px solid var(--gold-dim);color:var(--gold)}
        .log-order-tag.enemy{border:1px solid var(--red);color:var(--red-bright)}
        .log-order-tag.pet{border:1px solid var(--cyan);color:var(--cyan)}
        
        .effects-row{display:flex;flex-wrap:wrap;justify-content:center;gap:.1rem;margin-top:.15rem;min-height:12px}
        .effect-tag{font-size:.45rem;padding:.05rem .15rem;border-radius:3px}
        .eff-bleed{background:rgba(139,0,0,.6);border:1px solid var(--red)}.eff-poison{background:rgba(0,100,0,.6);border:1px solid var(--green-bright)}.eff-fire{background:rgba(255,100,0,.5);border:1px solid orange}
        
        .chronicles-panel{display:flex;flex-direction:column;height:100%}
        .chronicles-content{flex:1;overflow-y:auto;padding:.5rem;display:flex;flex-direction:column;gap:.4rem}
        .story-entry{padding:.5rem;border-radius:4px;animation:fadeIn .3s;font-size:.85rem;line-height:1.6}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1}}
        .story-narrative{background:linear-gradient(135deg,rgba(30,25,22,.95),rgba(45,38,33,.8));border-left:3px solid var(--gold-dim);font-style:italic}
        .story-combat{background:rgba(139,0,0,.15);border-left:3px solid var(--red)}
        .story-loot{background:rgba(212,164,55,.15);border-left:3px solid var(--gold)}
        .story-system{background:rgba(74,158,255,.1);border-left:3px solid var(--blue-bright);font-size:.8rem}
        .story-trap{background:rgba(255,107,53,.15);border-left:3px solid var(--orange)}
        .story-dialogue{background:rgba(156,39,176,.1);border-left:3px solid var(--purple)}
        .story-region{background:rgba(0,188,212,.1);border-left:3px solid var(--cyan)}
        .story-travel{background:rgba(100,100,100,.2);border-left:3px solid var(--text-dim);font-style:italic}
        
        .btn{font-family:'Cinzel',serif;font-size:.7rem;padding:.4rem .8rem;background:var(--bg-light);border:1px solid var(--gold-dim);color:var(--gold);cursor:pointer;border-radius:4px;transition:all .2s;white-space:nowrap}
        .btn:hover:not(:disabled){background:var(--gold-dim);color:var(--bg-dark);transform:translateY(-1px)}
        .btn:active:not(:disabled){transform:scale(.95);opacity:.9}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .btn-primary{background:var(--gold-dim);color:var(--bg-dark)}
        .btn-danger{border-color:var(--red);color:var(--red-bright)}.btn-danger:hover:not(:disabled){background:var(--red);color:white}
        .btn-sm{font-size:.6rem;padding:.25rem .5rem}
        
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:500;justify-content:center;align-items:center;padding:1rem;overflow-y:auto}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-panel);border:2px solid var(--gold-dim);border-radius:8px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:modalIn .2s}
        @keyframes modalIn{from{opacity:0;transform:scale(.95)}}
        .modal-lg{max-width:800px}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:.6rem .8rem;background:var(--bg-light);border-bottom:1px solid var(--border)}
        .modal-title{font-family:'Cinzel',serif;font-size:.9rem;color:var(--gold)}
        .modal-close{background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer}.modal-close:hover{color:var(--gold)}
        .modal-body{padding:.8rem}
        
        .item-detail{text-align:center}
        .item-detail-icon{font-size:3.5rem;margin-bottom:.5rem}
        .item-detail-icon img{width:72px;height:72px;object-fit:contain}
        .item-detail-name{font-family:'Cinzel',serif;font-size:1.1rem;color:var(--gold-bright)}
        .item-detail-type{color:var(--text-dim);font-size:.75rem;margin-bottom:.5rem}
        .item-detail-desc{background:var(--bg-dark);padding:.6rem;border-radius:4px;text-align:left;margin-bottom:.6rem;font-size:.8rem}
        .item-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:.4rem;margin-bottom:.6rem}
        .item-stat-box{background:var(--bg-light);padding:.4rem;border-radius:4px}
        .item-stat-label{font-size:.55rem;color:var(--text-dim);text-transform:uppercase}
        .item-stat-value{font-size:.95rem;color:var(--gold);font-family:'Cinzel',serif}
        .item-actions{display:flex;flex-wrap:wrap;justify-content:center;gap:.4rem}
        
        .inventory-info{text-align:center;padding:.4rem;color:var(--text-dim);font-size:.75rem;border-bottom:1px solid var(--border)}
        .inventory-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:.35rem;padding:.6rem}
        .inv-slot{aspect-ratio:1;background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;padding:.15rem}
        .inv-slot:hover{border-color:var(--gold-dim);transform:scale(1.05)}
        .inv-slot.empty{cursor:default}.inv-slot.empty:hover{transform:none;border-color:var(--border)}
        .inv-slot-icon{font-size:1.4rem}.inv-slot-icon img{width:32px;height:32px;object-fit:contain}
        .inv-slot-name{font-size:.5rem;text-align:center;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
        .rarity-common{border-color:#555}.rarity-rare{border-color:var(--blue-bright)}.rarity-epic{border-color:var(--purple)}.rarity-legendary{border-color:var(--gold-bright);box-shadow:0 0 8px rgba(255,215,0,.4)}
        
        /* Travel Map */
        .travel-map{display:flex;flex-direction:column;gap:.5rem}
        .travel-current{text-align:center;padding:.5rem;background:var(--bg-dark);border-radius:6px;margin-bottom:.5rem}
        .travel-current-icon{font-size:2rem}
        .travel-current-name{font-family:'Cinzel',serif;color:var(--gold-bright);font-size:1rem}
        .travel-current-progress{font-size:.65rem;color:var(--text-dim);margin-top:.2rem}
        .travel-routes{display:flex;flex-direction:column;gap:.4rem}
        .travel-route{background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;padding:.5rem;display:flex;align-items:center;gap:.5rem;cursor:pointer;transition:all .2s}
        .travel-route:hover:not(.locked){border-color:var(--gold-dim);transform:translateX(4px)}
        .travel-route.locked{opacity:.5;cursor:not-allowed}
        .travel-route.locked:hover{transform:none}
        .travel-route-icon{font-size:1.5rem;width:40px;text-align:center}
        .travel-route-info{flex:1}
        .travel-route-name{font-family:'Cinzel',serif;color:var(--gold);font-size:.8rem}
        .travel-route-desc{font-size:.6rem;color:var(--text-dim)}
        .travel-route-req{font-size:.55rem;color:var(--red-bright);margin-top:.15rem}
        .travel-route-steps{font-size:.6rem;color:var(--cyan);margin-top:.1rem}
        .travel-route-arrow{color:var(--gold-dim);font-size:1.2rem}
        .travel-progress-bar{height:4px;background:var(--bg-panel);border-radius:2px;margin-top:.3rem;overflow:hidden}
        .travel-progress-fill{height:100%;background:var(--gold);transition:width .3s}
        
        .editor-container{max-width:1100px;margin:0 auto;padding:.8rem}
        .editor-tabs{display:flex;flex-wrap:wrap;gap:.25rem;background:var(--bg-panel);padding:.4rem;border-radius:6px;margin-bottom:.6rem}
        .editor-tab{padding:.4rem .8rem;background:transparent;border:1px solid var(--border);color:var(--text-dim);cursor:pointer;font-family:'Cinzel',serif;font-size:.65rem;border-radius:4px;transition:all .2s}
        .editor-tab:hover{border-color:var(--gold-dim);color:var(--gold)}
        .editor-tab.active{background:var(--gold-dim);color:var(--bg-dark);border-color:var(--gold)}
        .editor-section{display:none;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:.8rem}
        .editor-section.active{display:block}
        .editor-section h3{font-family:'Cinzel',serif;color:var(--gold);font-size:.95rem;margin-bottom:.6rem;padding-bottom:.4rem;border-bottom:1px solid var(--border)}
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:.5rem;margin-bottom:.5rem}
        .form-group{display:flex;flex-direction:column;gap:.15rem}
        .form-group label{font-size:.55rem;color:var(--text-dim);text-transform:uppercase}
        .form-group input,.form-group select,.form-group textarea{background:var(--bg-input);border:1px solid var(--border);padding:.4rem;color:var(--text);font-size:.7rem;border-radius:4px;font-family:inherit}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--gold-dim)}
        .form-group textarea{resize:vertical;min-height:50px}
        .form-actions{display:flex;gap:.4rem;justify-content:flex-end;padding-top:.5rem;border-top:1px solid var(--border);margin-top:.5rem}
        .multi-select{background:var(--bg-input);border:1px solid var(--border);border-radius:4px;padding:.3rem;max-height:80px;overflow-y:auto;font-size:.65rem}
        .multi-select label{display:flex;align-items:center;gap:.25rem;padding:.1rem;cursor:pointer}
        .multi-select label:hover{background:var(--bg-light)}
        .items-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:.35rem;margin-top:.6rem;max-height:250px;overflow-y:auto;padding:.15rem}
        .item-card{background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;padding:.4rem;display:flex;align-items:center;gap:.35rem;cursor:pointer;transition:all .2s}
        .item-card:hover{border-color:var(--gold-dim)}
        .item-card-icon{font-size:1.2rem;width:28px;text-align:center}.item-card-icon img{width:28px;height:28px;object-fit:contain}
        .item-card-info{flex:1;min-width:0}
        .item-card-name{font-size:.7rem;color:var(--gold);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .item-card-stats{font-size:.55rem;color:var(--text-dim)}
        .item-card-actions{display:flex;gap:.15rem}
        .icon-btn{background:none;border:1px solid var(--border);color:var(--text-dim);padding:.12rem .2rem;cursor:pointer;font-size:.5rem;border-radius:3px;transition:all .2s}
        .icon-btn:hover{border-color:var(--gold-dim);color:var(--gold)}
        .icon-btn.delete:hover{border-color:var(--red);color:var(--red-bright)}
        
        .rules-container{max-width:1000px;margin:0 auto;padding:.8rem}
        .rules-header{text-align:center;margin-bottom:.8rem}
        .rules-header h2{font-family:'Cinzel',serif;color:var(--gold);font-size:1.4rem}
        .rules-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(270px,1fr));gap:.5rem}
        .rules-card{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:.6rem}
        .rules-card h4{font-family:'Cinzel',serif;color:var(--gold);font-size:.8rem;margin-bottom:.35rem;padding-bottom:.25rem;border-bottom:1px solid var(--border)}
        .rules-card p,.rules-card li{font-size:.7rem;margin-bottom:.15rem}
        .rules-card ul{padding-left:1rem}
        .rules-table{width:100%;border-collapse:collapse;font-size:.65rem;margin:.3rem 0}
        .rules-table th,.rules-table td{border:1px solid var(--border);padding:.2rem .3rem;text-align:left}
        .rules-table th{background:var(--bg-light);color:var(--gold)}
        .rules-highlight{background:var(--bg-dark);border-left:3px solid var(--gold);padding:.35rem;margin:.3rem 0;font-size:.7rem}
        
        .toast-container{position:fixed;top:2.5rem;right:.8rem;z-index:1000;display:flex;flex-direction:column;gap:.4rem}
        .toast{padding:.4rem .8rem;border-radius:4px;font-size:.75rem;animation:toastIn .3s,toastOut .3s 2.5s forwards;color:white}
        @keyframes toastIn{from{transform:translateX(100%);opacity:0}}@keyframes toastOut{to{transform:translateX(100%);opacity:0}}
        .toast.success{background:var(--green)}.toast.error{background:var(--red)}.toast.info{background:var(--blue)}
        .dice-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:600;justify-content:center;align-items:center}
        .dice-overlay.active{display:flex}
        .dice-display{background:var(--bg-panel);border:2px solid var(--gold-dim);border-radius:12px;padding:1.5rem 2rem;text-align:center}
        .dice-icon{font-size:3rem;animation:diceRoll .4s}
        @keyframes diceRoll{0%{transform:rotate(0) scale(.5)}50%{transform:rotate(180deg) scale(1.2)}100%{transform:rotate(360deg) scale(1)}}
        .dice-label{font-size:.8rem;color:var(--text-dim)}
        .dice-result{font-family:'Cinzel',serif;font-size:2rem;color:var(--gold-bright)}
        .dice-result.crit{color:var(--red-bright);text-shadow:0 0 10px var(--red)}
        
        @media(min-width:1000px){
            html{font-size:18px}
            .game-wrapper{padding:1rem;gap:1rem}
            .char-avatar{width:64px;height:64px;font-size:2.4rem}
            .char-name{font-size:1.3rem}
            .char-race{font-size:.8rem}
            .hp-text{font-size:.85rem}
            .stat-item{font-size:.8rem;padding:.3rem .5rem}
            .equip-item{padding:.5rem}
            .equip-icon{width:36px;height:36px;font-size:1.5rem}
            .equip-name{font-size:.9rem}
            .equip-stats{font-size:.75rem}
            .currency-row{font-size:1rem;padding:.5rem}
            .region-badge{font-size:.85rem;padding:.5rem}
            .story-entry{font-size:1rem;padding:.7rem}
            .btn{font-size:.85rem;padding:.5rem 1rem}
            .nav-btn{font-size:.9rem;padding:.5rem 1.2rem}
            .panel-header{font-size:.85rem;padding:.5rem .8rem}
            .combatant{min-width:140px;max-width:180px;padding:.6rem}
            .combatant-sprite{font-size:2.8rem}
            .combatant-name{font-size:.85rem}
            .combatant-stats{font-size:.65rem}
            .combatant .hp-text{font-size:.7rem}
            .combat-log{font-size:.85rem}
            .modal{max-width:600px}
            .modal-lg{max-width:900px}
            .modal-title{font-size:1.1rem}
            .inv-slot{width:70px;height:70px}
            .inv-slot-icon{font-size:1.8rem}
            .inv-slot-name{font-size:.65rem}
        }
        @media(max-width:850px){
            .game-top{grid-template-columns:1fr}
            .char-panel{order:2}
            .main-area{order:1}
            .inventory-grid{grid-template-columns:repeat(4,1fr)}
            .combatant{min-width:90px;max-width:110px}
            .rules-grid{grid-template-columns:1fr}
        }
        @media(max-width:500px){
            html{font-size:14px}
            body{-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;overscroll-behavior:none}
            .main-nav{padding:.2rem;gap:.15rem}
            .nav-btn{font-size:.65rem;padding:.35rem .6rem}
            .status-bar{font-size:.55rem;padding:.15rem .3rem}
            .game-wrapper{padding:.3rem;gap:.3rem}
            .panel{border-radius:6px}
            .panel-header{padding:.3rem .5rem;font-size:.65rem}
            .char-header{padding:.4rem;gap:.4rem}
            .char-avatar{width:40px;height:40px;font-size:1.5rem;border-radius:4px}
            .char-name{font-size:.9rem}
            .char-race{font-size:.6rem}
            .hp-container{height:14px;border-radius:3px}
            .hp-text{font-size:.6rem}
            .stats-grid{gap:.15rem;padding:.3rem}
            .stat-item{padding:.15rem .25rem;font-size:.6rem;border-radius:2px}
            .equip-row{gap:.3rem;padding:.3rem}
            .equip-slot{padding:.3rem;border-radius:4px;gap:.3rem}
            .equip-icon{width:24px;height:24px;font-size:1rem}
            .equip-name{font-size:.65rem}
            .equip-stats{font-size:.55rem}
            .currency-row{padding:.25rem;font-size:.7rem;gap:.6rem;border-radius:3px}
            .region-badge{padding:.3rem;font-size:.6rem;border-radius:3px}
            .region-badge .region-icon{font-size:.85rem}
            .story-panel{min-height:120px}
            .story-content{padding:.3rem}
            .story-entry{padding:.35rem;font-size:.75rem;line-height:1.4;border-radius:3px}
            .actions-container{padding:.3rem;gap:.25rem}
            .btn{font-size:.65rem;padding:.4rem .6rem;border-radius:4px;min-height:36px}
            .combat-arena{border-radius:6px}
            .combat-header{padding:.3rem .5rem}
            .combat-grid{padding:.4rem;gap:.3rem}
            .combatant{min-width:70px;max-width:85px;padding:.3rem;border-radius:4px}
            .combatant-order{width:16px;height:16px;font-size:.5rem;top:-5px;right:-5px}
            .combatant-sprite{font-size:1.5rem;margin-bottom:.1rem}
            .combatant-sprite img{width:32px;height:32px}
            .combatant-name{font-size:.55rem}
            .combatant-stats{font-size:.45rem}
            .combatant .hp-container{height:10px}
            .combatant .hp-text{font-size:.45rem}
            .combat-vs{font-size:.9rem;padding:0 .2rem}
            .combat-log{max-height:100px;padding:.3rem;font-size:.6rem}
            .log-entry{padding:.1rem 0}
            .log-calc{padding:.15rem .25rem;font-size:.55rem}
            .log-turn{padding:.2rem;font-size:.55rem}
            .effect-tag{font-size:.4rem;padding:.02rem .1rem}
            .modal{border-radius:8px;margin:.5rem;max-height:85vh}
            .modal-header{padding:.4rem .6rem}
            .modal-title{font-size:.8rem}
            .modal-close{font-size:1.1rem}
            .modal-body{padding:.5rem}
            .inventory-grid{grid-template-columns:repeat(4,1fr);gap:.25rem;padding:.3rem}
            .inv-slot{width:auto;height:auto;aspect-ratio:1;padding:.25rem;border-radius:4px}
            .inv-slot-icon{font-size:1.2rem}
            .inv-slot-icon img{width:28px;height:28px}
            .inv-slot-name{font-size:.45rem}
            .item-detail-icon{font-size:2.5rem}
            .item-detail-icon img{width:50px;height:50px}
            .item-detail-name{font-size:1rem}
            .item-stats-grid{gap:.3rem}
            .item-stat-box{padding:.3rem}
            .item-actions{gap:.25rem}
            .item-actions .btn{flex:1;min-width:0}
            .region-selector{gap:.3rem}
            .region-card{padding:.4rem;border-radius:4px}
            .region-card-icon{font-size:1.3rem}
            .region-card-name{font-size:.7rem}
            .region-card-type{font-size:.5rem}
            .auth-box,.create-box{padding:1.2rem;border-radius:8px;max-width:95vw}
            .auth-logo h1,.create-logo h1{font-size:1.2rem}
            .auth-logo p,.create-logo p{font-size:.75rem}
            .auth-input,.create-input{padding:.6rem;font-size:.9rem}
            .auth-btn,.create-btn{padding:.6rem;font-size:.9rem}
            .race-grid{grid-template-columns:repeat(3,1fr);gap:.3rem}
            .race-option{padding:.4rem;border-radius:6px}
            .race-option-icon{width:36px;height:36px;font-size:1.5rem}
            .race-option-icon img{max-width:36px;max-height:36px}
            .race-option-name{font-size:.7rem}
            .race-option-stats{font-size:.55rem}
            .create-section label{font-size:.55rem}
            .user-info{font-size:.6rem}
            .logout-btn{font-size:.55rem;padding:.15rem .35rem}
            .item-card{padding:.35rem;border-radius:4px}
            .item-card-icon{font-size:1rem;width:24px}
            .item-card-icon img{width:24px;height:24px}
            .item-card-name{font-size:.65rem}
            .item-card-stats{font-size:.5rem}
            .npc-card{padding:.4rem}
            .npc-icon{font-size:1.5rem}
            .npc-name{font-size:.75rem}
            .toast{font-size:.7rem;padding:.4rem .8rem;border-radius:4px}
        }
        @media(max-width:350px){
            html{font-size:12px}
            .race-grid{grid-template-columns:repeat(2,1fr)}
            .inventory-grid{grid-template-columns:repeat(3,1fr)}
            .combatant{min-width:60px;max-width:70px}
            .btn{font-size:.6rem;padding:.35rem .5rem}
        }
    </style>
</head>
<body>
    <div class="auth-screen" id="authScreen">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>‚öîÔ∏è Aventuras de Acero y Runas</h1>
                <p>Ingresa para guardar tu progreso</p>
            </div>
            <div class="auth-form" id="loginForm">
                <input type="email" class="auth-input" id="authEmail" placeholder="Correo electr√≥nico">
                <input type="password" class="auth-input" id="authPass" placeholder="Contrase√±a">
                <button class="auth-btn" onclick="Auth.login()">üîì Iniciar Sesi√≥n</button>
                <div class="auth-divider">‚Äî o ‚Äî</div>
                <button class="auth-btn auth-guest" onclick="Auth.guest()">üë§ Jugar como Invitado</button>
                <p style="text-align:center;margin-top:.8rem">
                    <span class="auth-link" onclick="Auth.showRegister()">Crear cuenta nueva</span>
                </p>
            </div>
            <div class="auth-form hidden" id="registerForm">
                <input type="email" class="auth-input" id="regEmail" placeholder="Correo electr√≥nico">
                <input type="password" class="auth-input" id="regPass" placeholder="Contrase√±a (m√≠n. 6 caracteres)">
                <button class="auth-btn" onclick="Auth.register()">üìù Crear Cuenta</button>
                <p style="text-align:center;margin-top:.8rem">
                    <span class="auth-link" onclick="Auth.showLogin()">Ya tengo cuenta</span>
                </p>
            </div>
            <p style="text-align:center;margin-top:1rem">
                <a href="#" onclick="clearAll();return false" style="color:var(--text-dim);font-size:.75rem">üîÑ Limpiar sesi√≥n</a>
            </p>
        </div>
    </div>

    <div class="char-create hidden" id="charCreate">
        <div class="create-box">
            <div class="create-logo">
                <h1>‚öîÔ∏è Crear Personaje</h1>
                <p>Elige tu nombre y raza</p>
            </div>
            <div class="create-section">
                <label>Nombre del H√©roe</label>
                <input type="text" class="create-input" id="heroName" placeholder="Escribe tu nombre..." maxlength="20">
            </div>
            <div class="create-section">
                <label>Elige tu Raza</label>
                <div class="race-grid" id="raceGrid"></div>
            </div>
            <button class="create-btn" onclick="Game.createChar()">‚öîÔ∏è Comenzar Aventura</button>
        </div>
    </div>

    <div class="status-bar"><div class="user-info" id="userInfo"></div><div class="status-dot" id="fbStatus"></div><span id="fbStatusText">...</span></div>
    <nav class="main-nav">
        <button class="nav-btn active" data-tab="game">‚öîÔ∏è Juego</button>
        <button class="nav-btn" data-tab="rules">üìú Reglas</button>
        <button class="nav-btn" data-tab="editor">üõ†Ô∏è Editor</button>
    </nav>

    <div class="tab-content active" id="tab-game">
        <div class="game-wrapper">
            <div class="game-top">
                <div class="panel char-panel" id="charPanel">
                    <div class="char-header">
                        <div class="char-avatar" id="charAvatar">üßô</div>
                        <div><div class="char-name" id="charName">---</div><div class="char-race" id="charRace">---</div></div>
                    </div>
                    <div class="char-body">
                        <div class="char-hp-section">
                            <div class="hp-container"><div class="hp-fill" id="hpFill"></div><div class="hp-text" id="hpText">0/0</div></div>
                        </div>
                        <div class="region-badge safe" id="regionBadge" onclick="Regions.openSelector()">
                            <span class="region-icon">üèòÔ∏è</span><span class="region-name">Pueblo</span>
                            <div style="font-size:.5rem;color:var(--text-dim)">Click para viajar</div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item"><span class="stat-label">Armadura</span><span class="stat-value" id="statArmor">0</span></div>
                            <div class="stat-item"><span class="stat-label">Evasi√≥n</span><span class="stat-value" id="statEvasion">0</span></div>
                            <div class="stat-item"><span class="stat-label">Precisi√≥n</span><span class="stat-value" id="statPrecision">0</span></div>
                            <div class="stat-item"><span class="stat-label">Velocidad</span><span class="stat-value" id="statSpeed">0</span></div>
                        </div>
                        <div class="equip-slot" id="weaponSlot"><div class="equip-icon" id="weaponIcon">‚öîÔ∏è</div><div><div class="equip-name" id="weaponName">---</div><div class="equip-stats" id="weaponStats">---</div></div></div>
                        <div class="equip-slot" id="armorSlot"><div class="equip-icon" id="armorIcon">üõ°Ô∏è</div><div><div class="equip-name" id="armorName">---</div><div class="equip-stats" id="armorStats">---</div></div></div>
                        <div class="currency-row"><span><span class="coin-gold">‚óè</span> <span id="goldAmount">0</span> MO</span><span><span class="coin-silver">‚óè</span> <span id="silverAmount">0</span> MP</span></div>
                    </div>
                </div>
                <div class="main-area">
                    <div class="panel combat-arena hidden" id="combatArena">
                        <div class="panel-header"><span>‚öîÔ∏è COMBATE</span><span>Turno <span id="turnCounter">1</span></span></div>
                        <div class="combat-grid" id="combatGrid"></div>
                        <div class="combat-actions" id="combatActions"></div>
                        <div class="combat-log" id="combatLog"></div>
                    </div>
                    <div class="panel actions-panel" id="actionsPanel"><div class="panel-header">üéÆ Acciones</div><div class="panel-body" id="actionsContainer"></div></div>
                </div>
            </div>
            <div class="game-bottom">
                <div class="panel chronicles-panel"><div class="panel-header">üìñ Cr√≥nicas</div><div class="chronicles-content" id="chroniclesContent"></div></div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="tab-rules">
        <div class="rules-container">
            <div class="rules-header"><h2>üìú Reglas del Juego</h2></div>
            <div class="rules-grid">
                <div class="rules-card"><h4>‚öîÔ∏è C√°lculo de Da√±o</h4>
                    <div class="rules-highlight"><strong>F√≥rmula:</strong><br>Da√±o Final = Da√±o Base ‚àí Armadura<br>(m√≠nimo 0 si armadura ‚â• da√±o)</div>
                    <p><strong>Ejemplo:</strong> Da√±o 7 ‚àí Armadura 2 = 5 final</p>
                    <p><strong>Bloqueo:</strong> Da√±o 3 ‚àí Armadura 3 = 0</p>
                </div>
                <div class="rules-card"><h4>‚ö° Velocidad e Iniciativa</h4>
                    <div class="rules-highlight">Mayor velocidad = act√∫a primero<br>Empate: D20 de iniciativa</div>
                    <p>Cada turno incluye TODAS las acciones ordenadas por velocidad.</p>
                </div>
                <div class="rules-card"><h4>üé≤ Tiradas de Ataque</h4>
                    <div class="rules-highlight">D20 + Precisi√≥n ‚â• Dificultad<br>Cr√≠tico (20): Da√±o √ó2<br>Pifia (1): Fallo autom√°tico</div>
                </div>
                <div class="rules-card"><h4>üó∫Ô∏è Sistema de Viaje</h4>
                    <div class="rules-highlight">Las regiones est√°n conectadas por rutas</div>
                    <p>‚Ä¢ Debes completar encuentros para desbloquear rutas</p>
                    <p>‚Ä¢ Viajar toma tiempo (pasos)</p>
                    <p>‚Ä¢ M√°s lejos del pueblo = m√°s dif√≠cil volver</p>
                </div>
                <div class="rules-card"><h4>üëπ Grupos de Enemigos</h4>
                    <p>Criaturas pueden aparecer en grupo:</p>
                    <ul><li>Lobos, ratas: manadas (2-6)</li><li>Goblins, esqueletos: patrullas</li><li>Trolls, osos: solitarios</li></ul>
                </div>
                <div class="rules-card"><h4>üí∞ Econom√≠a</h4>
                    <div class="rules-highlight">99 MP = 1 MO</div>
                    <p>Vender items: 50% del valor</p>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="tab-editor">
        <div class="editor-container">
            <div class="editor-tabs">
                <button class="editor-tab active" data-editor="regions">üó∫Ô∏è Regiones</button>
                <button class="editor-tab" data-editor="races">üë§ Razas</button>
                <button class="editor-tab" data-editor="weapons">‚öîÔ∏è Armas</button>
                <button class="editor-tab" data-editor="armors">üõ°Ô∏è Armaduras</button>
                <button class="editor-tab" data-editor="items">üéí Items</button>
                <button class="editor-tab" data-editor="enemies">üëπ Enemigos</button>
                <button class="editor-tab" data-editor="pets">üê∫ Mascotas</button>
                <button class="editor-tab" data-editor="npcs">üßî NPCs</button>
            </div>
            
            <div class="editor-section active" id="editor-regions">
                <h3>üó∫Ô∏è Regiones</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="region-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="region-name"></div>
                    <div class="form-group"><label>Icono</label><input type="text" id="region-icon" maxlength="2"></div>
                    <div class="form-group"><label>Tipo</label><select id="region-type"><option value="safe">Segura</option><option value="danger">Peligrosa</option></select></div>
                    <div class="form-group"><label>Distancia (desde pueblo)</label><input type="number" id="region-distance" min="0" placeholder="0"></div>
                    <div class="form-group"><label>Encuentros para desbloquear</label><input type="number" id="region-reqEncounters" min="0" placeholder="0"></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><input type="text" id="region-desc"></div>
                <div class="form-group"><label>Conecta con (IDs separados por coma)</label><input type="text" id="region-connections" placeholder="pueblo,bosque"></div>
                <div class="form-group"><label>Narrativas (una por l√≠nea)</label><textarea id="region-narratives" rows="2"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('region')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveRegion()">üíæ</button></div>
                <div class="items-list" id="regions-list"></div>
            </div>

            <div class="editor-section" id="editor-races">
                <h3>üë§ Razas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="race-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="race-name"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="race-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="race-sprite"></div>
                    <div class="form-group"><label>+HP</label><input type="number" id="race-hp"></div>
                    <div class="form-group"><label>+Armadura</label><input type="number" id="race-armor"></div>
                    <div class="form-group"><label>+Velocidad</label><input type="number" id="race-speed"></div>
                    <div class="form-group"><label>+Precisi√≥n</label><input type="number" id="race-precision"></div>
                    <div class="form-group"><label>+Da√±o</label><input type="number" id="race-damage"></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="race-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('race')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveRace()">üíæ</button></div>
                <div class="items-list" id="races-list"></div>
            </div>

            <div class="editor-section" id="editor-weapons">
                <h3>‚öîÔ∏è Armas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="weapon-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="weapon-name"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="weapon-damage" placeholder="1d8"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="weapon-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="weapon-sprite"></div>
                    <div class="form-group"><label>Rareza</label><select id="weapon-rarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="weapon-value"></div>
                    <div class="form-group"><label>Efecto</label><select id="weapon-effect"><option value="">Ninguno</option><option value="bleed">Sangrado</option><option value="poison">Veneno</option><option value="fire">Fuego</option></select></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="weapon-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('weapon')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveWeapon()">üíæ</button></div>
                <div class="items-list" id="weapons-list"></div>
            </div>

            <div class="editor-section" id="editor-armors">
                <h3>üõ°Ô∏è Armaduras</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="armor-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="armor-name"></div>
                    <div class="form-group"><label>Defensa</label><input type="number" id="armor-defense"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="armor-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="armor-sprite"></div>
                    <div class="form-group"><label>Rareza</label><select id="armor-rarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="armor-value"></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="armor-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('armor')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveArmor()">üíæ</button></div>
                <div class="items-list" id="armors-list"></div>
            </div>

            <div class="editor-section" id="editor-items">
                <h3>üéí Items</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="item-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="item-name"></div>
                    <div class="form-group"><label>Tipo</label><select id="item-type"><option value="potion">Poci√≥n</option><option value="food">Comida</option><option value="antidote">Ant√≠doto</option><option value="escape">Escape</option><option value="backpack">Mochila</option><option value="misc">Otro</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="item-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="item-sprite"></div>
                    <div class="form-group"><label>Efecto</label><input type="text" id="item-effect" placeholder="1d8"></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="item-value"></div>
                    <div class="form-group"><label>Rareza</label><select id="item-rarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="item-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('item')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveItem()">üíæ</button></div>
                <div class="items-list" id="items-list"></div>
            </div>

            <div class="editor-section" id="editor-enemies">
                <h3>üëπ Enemigos</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="enemy-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="enemy-name"></div>
                    <div class="form-group"><label>Salud</label><input type="number" id="enemy-health"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="enemy-damage" placeholder="1d6"></div>
                    <div class="form-group"><label>Dificultad</label><input type="number" id="enemy-difficulty" min="1" max="20"></div>
                    <div class="form-group"><label>Armadura</label><input type="number" id="enemy-armor"></div>
                    <div class="form-group"><label>‚ö°Velocidad</label><input type="number" id="enemy-speed" placeholder="10"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="enemy-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="enemy-sprite"></div>
                    <div class="form-group"><label>Efecto</label><select id="enemy-effect"><option value="">Ninguno</option><option value="bleed">Sangrado</option><option value="poison">Veneno</option><option value="fire">Fuego</option></select></div>
                    <div class="form-group"><label>Loot Min</label><input type="number" id="enemy-loot-min"></div>
                    <div class="form-group"><label>Loot Max</label><input type="number" id="enemy-loot-max"></div>
                </div>
                <div style="background:var(--bg-dark);padding:.4rem;border-radius:4px;margin-bottom:.5rem">
                    <div style="font-size:.65rem;color:var(--gold);margin-bottom:.3rem">üë• Configuraci√≥n de Grupo</div>
                    <div class="form-grid">
                        <div class="form-group"><label>¬øGrupo?</label><select id="enemy-canGroup"><option value="false">No</option><option value="true">S√≠</option></select></div>
                        <div class="form-group"><label>M√≠n</label><input type="number" id="enemy-groupMin" placeholder="2" min="2"></div>
                        <div class="form-group"><label>M√°x</label><input type="number" id="enemy-groupMax" placeholder="4" min="2"></div>
                        <div class="form-group"><label>%Prob</label><input type="number" id="enemy-groupChance" placeholder="30" min="0" max="100"></div>
                    </div>
                </div>
                <div class="form-group"><label>Narrativa</label><textarea id="enemy-desc"></textarea></div>
                <div class="form-group"><label>Regiones</label><div class="multi-select" id="enemy-regions"></div></div>
                <div class="form-group"><label>Drops</label><div class="multi-select" id="enemy-drops"></div></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('enemy')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveEnemy()">üíæ</button></div>
                <div class="items-list" id="enemies-list"></div>
            </div>

            <div class="editor-section" id="editor-pets">
                <h3>üê∫ Mascotas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="pet-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="pet-name"></div>
                    <div class="form-group"><label>Salud</label><input type="number" id="pet-health"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="pet-damage"></div>
                    <div class="form-group"><label>‚ö°Velocidad</label><input type="number" id="pet-speed" placeholder="12"></div>
                    <div class="form-group"><label>Dado domesticar</label><input type="number" id="pet-difficulty"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="pet-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="pet-sprite"></div>
                </div>
                <div class="form-group"><label>Regiones</label><div class="multi-select" id="pet-regions"></div></div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="pet-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('pet')">üÜï</button><button class="btn btn-primary" onclick="Editor.savePet()">üíæ</button></div>
                <div class="items-list" id="pets-list"></div>
            </div>

            <div class="editor-section" id="editor-npcs">
                <h3>üßî NPCs</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="npc-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="npc-name"></div>
                    <div class="form-group"><label>Rol</label><select id="npc-role"><option value="merchant">Comerciante</option><option value="blacksmith">Herrero</option><option value="alchemist">Alquimista</option><option value="innkeeper">Tabernero</option><option value="healer">Curandero</option><option value="guard">Guardia</option><option value="villager">Aldeano</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="npc-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="npc-sprite"></div>
                    <div class="form-group"><label>Regi√≥n</label><select id="npc-region"></select></div>
                </div>
                <div class="form-group"><label>Di√°logo</label><textarea id="npc-dialogue"></textarea></div>
                <div class="form-group"><label>Vende</label><div class="multi-select" id="npc-sells"></div></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('npc')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveNpc()">üíæ</button></div>
                <div class="items-list" id="npcs-list"></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="inventoryModal"><div class="modal modal-lg"><div class="modal-header"><span class="modal-title">üéí Inventario</span><button class="modal-close" data-close="inventoryModal">&times;</button></div><div class="inventory-info" id="inventoryInfo">0/10</div><div class="inventory-grid" id="inventoryGrid"></div></div></div>
    <div class="modal-overlay" id="itemDetailModal"><div class="modal"><div class="modal-header"><span class="modal-title">Detalles</span><button class="modal-close" data-close="itemDetailModal">&times;</button></div><div class="modal-body"><div class="item-detail"><div class="item-detail-icon" id="detailIcon">üì¶</div><div class="item-detail-name" id="detailName">Item</div><div class="item-detail-type" id="detailType">Tipo</div><div class="item-detail-desc" id="detailDesc">...</div><div class="item-stats-grid" id="detailStats"></div><div class="item-actions" id="detailActions"></div></div></div></div></div>
    <div class="modal-overlay" id="regionModal"><div class="modal modal-lg"><div class="modal-header"><span class="modal-title">üó∫Ô∏è Mapa de Viaje</span><button class="modal-close" data-close="regionModal">&times;</button></div><div class="modal-body"><div class="travel-map" id="travelMap"></div></div></div></div>
    <div class="modal-overlay" id="townModal"><div class="modal"><div class="modal-header"><span class="modal-title" id="townTitle">üèòÔ∏è</span><button class="modal-close" data-close="townModal">&times;</button></div><div class="modal-body" id="townContent"></div></div></div>
    <div class="modal-overlay" id="shopModal"><div class="modal modal-lg"><div class="modal-header"><span class="modal-title" id="shopTitle">üè™</span><button class="modal-close" data-close="shopModal">&times;</button></div><div class="modal-body" id="shopContent"></div></div></div>
    <div class="dice-overlay" id="diceOverlay"><div class="dice-display"><div class="dice-icon">üé≤</div><div class="dice-label" id="diceLabel">D20</div><div class="dice-result" id="diceResult">--</div></div></div>
    <div class="toast-container" id="toastContainer"></div>

<script>
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const roll=d=>{if(typeof d==='number')return d;const m=String(d).match(/(\d+)?d(\d+)([+-]\d+)?/i);if(!m)return parseInt(d)||0;let t=parseInt(m[3])||0;for(let i=0;i<(parseInt(m[1])||1);i++)t+=Math.floor(Math.random()*parseInt(m[2]))+1;return t};
const rollDetailed=d=>{if(typeof d==='number')return{total:d,rolls:[d],dice:d};const m=String(d).match(/(\d+)?d(\d+)([+-]\d+)?/i);if(!m)return{total:parseInt(d)||0,rolls:[],dice:d};const count=parseInt(m[1])||1,sides=parseInt(m[2]),mod=parseInt(m[3])||0;const rolls=[];for(let i=0;i<count;i++)rolls.push(Math.floor(Math.random()*sides)+1);return{total:rolls.reduce((a,b)=>a+b,0)+mod,rolls,dice:d,mod}};
const d20=()=>Math.floor(Math.random()*20)+1,dX=x=>Math.floor(Math.random()*x)+1,pick=a=>a.length?a[Math.floor(Math.random()*a.length)]:null;
const hpClass=p=>p>60?'':p>30?'medium':p>15?'low':'critical';
const sprite=i=>i?.sprite?`<img src="${i.sprite}">`:(i?.icon||'üì¶');
const genId=p=>`${p}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;
const toast=(m,t='info')=>{const e=document.createElement('div');e.className=`toast ${t}`;e.textContent=m;$('#toastContainer').appendChild(e);setTimeout(()=>e.remove(),3000)};
const openModal=id=>$(`#${id}`).classList.add('active'),closeModal=id=>$(`#${id}`).classList.remove('active'),closeAllModals=()=>$$('.modal-overlay').forEach(m=>m.classList.remove('active'));
const showDice=async(r,s=20,c=false)=>{$('#diceLabel').textContent=`D${s}`;$('#diceResult').textContent=r;$('#diceResult').classList.toggle('crit',c);$('#diceOverlay').classList.add('active');await new Promise(r=>setTimeout(r,450));$('#diceOverlay').classList.remove('active')};
const scrollChron=()=>{const c=$('#chroniclesContent');c.scrollTop=c.scrollHeight};
const delay=ms=>new Promise(r=>setTimeout(r,ms));

const Data={
    regions:[
        {id:'pueblo',name:'Pueblo Inicio',icon:'üèòÔ∏è',type:'safe',desc:'Pueblo tranquilo.',distance:0,reqEncounters:0,connections:['bosque','camino'],narratives:['El sol brilla.','Aldeanos pasean.']},
        {id:'camino',name:'Camino Real',icon:'üõ§Ô∏è',type:'danger',desc:'Ruta principal entre regiones.',distance:1,reqEncounters:0,connections:['pueblo','bosque','mazmorra'],narratives:['El camino se extiende.','Huellas en el polvo.']},
        {id:'bosque',name:'Bosque Sombr√≠o',icon:'üå≤',type:'danger',desc:'Bosque lleno de criaturas.',distance:1,reqEncounters:0,connections:['pueblo','camino','pantano','montana'],narratives:['Los √°rboles se alzan.','Senderos oscuros.']},
        {id:'mazmorra',name:'Mazmorras',icon:'üèöÔ∏è',type:'danger',desc:'Ruinas subterr√°neas.',distance:2,reqEncounters:3,connections:['camino'],narratives:['Eco de pasos.','Aire h√∫medo.']},
        {id:'montana',name:'Monta√±as',icon:'‚õ∞Ô∏è',type:'danger',desc:'Cumbres heladas.',distance:2,reqEncounters:5,connections:['bosque'],narratives:['Viento aullador.','Caminos peligrosos.']},
        {id:'pantano',name:'Pantano',icon:'üåø',type:'danger',desc:'Aguas ponzo√±osas.',distance:2,reqEncounters:4,connections:['bosque','mar'],narratives:['Gases burbujeantes.','Niebla espesa.']},
        {id:'mar',name:'Alta Mar',icon:'üåä',type:'danger',desc:'Aguas profundas.',distance:3,reqEncounters:8,connections:['pantano'],narratives:['Olas mecen.','Algo bajo el agua.']},
        {id:'desierto',name:'Desierto',icon:'üèúÔ∏è',type:'danger',desc:'Dunas ardientes.',distance:3,reqEncounters:10,connections:['montana'],narratives:['Calor sofocante.','Arena movediza.']}
    ],
    races:[{id:'human',name:'Humano',icon:'üßë',bonus:{health:2,speed:10}},{id:'elf',name:'Elfo',icon:'üßù',bonus:{precision:2,speed:14}},{id:'dwarf',name:'Enano',icon:'üßî',bonus:{armor:2,speed:8}},{id:'orc',name:'Orco',icon:'üëπ',bonus:{damage:2,speed:10}},{id:'halfling',name:'Mediano',icon:'üßí',bonus:{speed:16,precision:1}}],
    weapons:[{id:'w1',name:'Daga',damage:'1d4',icon:'üó°Ô∏è',value:10,rarity:'common'},{id:'w2',name:'Espada',damage:'1d6',icon:'‚öîÔ∏è',value:20,rarity:'common'},{id:'w3',name:'Hacha',damage:'1d6',icon:'ü™ì',value:20,rarity:'common'},{id:'w4',name:'Bast√≥n',damage:'1d4',icon:'ü™Ñ',value:10,rarity:'common'},{id:'w5',name:'Espada Larga',damage:'1d8',icon:'‚öîÔ∏è',value:50,rarity:'rare'}],
    armors:[{id:'a1',name:'Cuero',defense:1,icon:'ü¶∫',value:15,rarity:'common'},{id:'a2',name:'Cuero reforzado',defense:2,icon:'ü¶∫',value:30,rarity:'common'},{id:'a3',name:'Cota malla',defense:3,icon:'‚õìÔ∏è',value:75,rarity:'rare'},{id:'a4',name:'T√∫nica',defense:0,icon:'üëï',value:5,rarity:'common'},{id:'a5',name:'Placas',defense:5,icon:'üõ°Ô∏è',value:150,rarity:'epic'}],
    items:[{id:'i1',name:'Poci√≥n menor',type:'potion',effect:'1d8',icon:'üß™',value:10,rarity:'common'},{id:'i2',name:'Ant√≠doto',type:'antidote',icon:'üíä',value:15,rarity:'common'},{id:'i3',name:'Bomba humo',type:'escape',icon:'üí®',value:25,rarity:'common'},{id:'i4',name:'Carne',type:'food',effect:'1d4',icon:'ü•©',value:5,rarity:'common'},{id:'i5',name:'Poci√≥n mayor',type:'potion',effect:'2d8',icon:'üß™',value:35,rarity:'rare'}],
    enemies:[
        {id:'e1',name:'Rata',health:8,damage:'1d4',difficulty:6,armor:0,speed:12,icon:'üêÄ',loot:[5,10],drops:['i1'],regions:['mazmorra','camino'],canGroup:true,groupMin:2,groupMax:5,groupChance:50,desc:'Ratas gigantes.'},
        {id:'e2',name:'Goblin',health:12,damage:'1d6',difficulty:8,armor:0,speed:11,icon:'üë∫',loot:[8,15],drops:['i1','w1'],regions:['bosque','mazmorra','camino'],canGroup:true,groupMin:2,groupMax:4,groupChance:35,desc:'Goblins hostiles.'},
        {id:'e3',name:'Esqueleto',health:15,damage:'1d6',difficulty:10,armor:1,speed:8,icon:'üíÄ',loot:[10,25],drops:['i1'],regions:['mazmorra'],canGroup:true,groupMin:2,groupMax:3,groupChance:30,desc:'Huesos reanimados.'},
        {id:'e4',name:'Orco',health:30,damage:'1d8',difficulty:12,armor:2,speed:9,icon:'üëπ',loot:[20,40],drops:['w2'],regions:['bosque','montana'],canGroup:false,desc:'Orco guerrero.'},
        {id:'e5',name:'Troll',health:45,damage:'2d6',difficulty:14,armor:3,speed:7,icon:'üßå',loot:[40,80],drops:['a2'],regions:['pantano'],canGroup:false,desc:'Troll del pantano.'},
        {id:'e6',name:'Sirena',health:25,damage:'1d8',difficulty:12,armor:0,speed:13,icon:'üßú‚Äç‚ôÄÔ∏è',loot:[30,60],drops:['i5'],regions:['mar'],canGroup:false,effect:'poison',desc:'Sirena letal.'},
        {id:'e7',name:'Kraken',health:50,damage:'2d8',difficulty:15,armor:3,speed:6,icon:'ü¶ë',loot:[60,120],regions:['mar'],canGroup:false,desc:'Tent√°culos emergen.'},
        {id:'e8',name:'Escorpi√≥n',health:20,damage:'1d6',difficulty:10,armor:2,speed:10,icon:'ü¶Ç',loot:[15,30],drops:['i2'],regions:['desierto'],canGroup:true,groupMin:2,groupMax:3,groupChance:25,effect:'poison',desc:'Escorpi√≥n venenoso.'},
        {id:'e9',name:'Lobo',health:14,damage:'1d6',difficulty:9,armor:0,speed:14,icon:'üê∫',loot:[8,16],drops:['i4'],regions:['bosque','montana','camino'],canGroup:true,groupMin:3,groupMax:6,groupChance:60,desc:'Manada de lobos.'},
        {id:'e10',name:'Yeti',health:40,damage:'2d6',difficulty:14,armor:2,speed:10,icon:'‚ùÑÔ∏è',loot:[40,80],drops:['a3'],regions:['montana'],canGroup:false,desc:'Yeti furioso.'},
        {id:'e11',name:'Bandido',health:18,damage:'1d6',difficulty:9,armor:1,speed:11,icon:'ü•∑',loot:[15,35],drops:['w1','i1'],regions:['camino'],canGroup:true,groupMin:2,groupMax:4,groupChance:40,desc:'Bandidos del camino.'}
    ],
    pets:[{id:'p1',name:'Lobo',health:20,damage:'1d6',speed:14,difficulty:24,icon:'üê∫',regions:['bosque','montana']},{id:'p2',name:'Oso',health:35,damage:'1d8',speed:10,difficulty:30,icon:'üêª',regions:['bosque','montana']},{id:'p3',name:'√Åguila',health:15,damage:'1d4',speed:18,difficulty:24,icon:'ü¶Ö',regions:['montana']}],
    npcs:[{id:'n1',name:'Grimbold',role:'blacksmith',icon:'üßî',region:'pueblo',dialogue:'¬°Mis armas son las mejores!',sells:['w1','w2','w3','w5']},{id:'n2',name:'Elara',role:'alchemist',icon:'üßô‚Äç‚ôÄÔ∏è',region:'pueblo',dialogue:'Pociones de calidad.',sells:['i1','i2','i5']},{id:'n3',name:'Tobias',role:'innkeeper',icon:'üßë‚Äçüç≥',region:'pueblo',dialogue:'¬°Si√©ntate, amigo!',sells:['i4']},{id:'n4',name:'Clara',role:'healer',icon:'üë©‚Äç‚öïÔ∏è',region:'pueblo',dialogue:'Puedo curarte por 10 MP.',sells:[]}],
    traps:[{name:'P√∫as',damage:'1d6',effect:'bleed',detectDiff:10,dodgeDiff:12},{name:'Dardo',damage:'1d4',effect:'poison',detectDiff:12,dodgeDiff:10},{name:'Foso',damage:'2d6',detectDiff:8,dodgeDiff:14}],
    find(t,id){return this[t]?.find(x=>x.id===id)},
    findItem(id){return this.find('weapons',id)||this.find('armors',id)||this.find('items',id)},
    getRegion(id){return this.regions.find(r=>r.id===id)||this.regions[0]},
    getEnemiesForRegion(rid){return this.enemies.filter(e=>(e.regions||[]).includes(rid))},
    getPetsForRegion(rid){return this.pets.filter(p=>!p.regions||p.regions.length===0||(p.regions||[]).includes(rid))},
    getNpcsForRegion(rid){return this.npcs.filter(n=>n.region===rid)},
    getConnectedRegions(rid){const r=this.getRegion(rid);return(r.connections||[]).map(c=>this.getRegion(c)).filter(x=>x)},
    save(){const d={regions:this.regions,races:this.races,weapons:this.weapons,armors:this.armors,items:this.items,enemies:this.enemies,pets:this.pets,npcs:this.npcs};localStorage.setItem('rpg_data',JSON.stringify(d));if(FB.db&&FB.ok)FB.db.ref('gameData').set(d)},
    load(){const s=localStorage.getItem('rpg_data');if(s)try{const d=JSON.parse(s);Object.keys(d).forEach(k=>{if(this[k])this[k]=d[k]})}catch(e){}}
};

let domReady=false;
const clearAll=()=>{localStorage.clear();try{firebase.auth().signOut()}catch(e){}location.reload()};

const Auth={
    user:null,
    showRegister(){$('#loginForm').classList.add('hidden');$('#registerForm').classList.remove('hidden')},
    showLogin(){$('#registerForm').classList.add('hidden');$('#loginForm').classList.remove('hidden')},
    async login(){
        const email=$('#authEmail').value.trim(),pass=$('#authPass').value;
        if(!email||!pass){toast('Completa todos los campos','error');return}
        try{
            const r=await firebase.auth().signInWithEmailAndPassword(email,pass);
            this.user=r.user;this.onAuth();
        }catch(e){toast(e.message,'error')}
    },
    async register(){
        const email=$('#regEmail').value.trim(),pass=$('#regPass').value;
        if(!email||!pass){toast('Completa todos los campos','error');return}
        if(pass.length<6){toast('La contrase√±a debe tener al menos 6 caracteres','error');return}
        try{
            const r=await firebase.auth().createUserWithEmailAndPassword(email,pass);
            this.user=r.user;this.onAuth();
        }catch(e){toast(e.message,'error')}
    },
    guest(){this.user={guest:true,email:'Invitado'};this.onAuth()},
    onAuth(){
        const doInit=()=>{
            $('#authScreen').classList.add('hidden');
            $('#authScreen').style.display='none';
            $('#userInfo').innerHTML=`<span>üë§ ${(this.user?.email||'').split('@')[0]||'Invitado'}</span><button class="logout-btn" onclick="Auth.logout()">Salir</button>`;
            Game.init();
        };
        if(domReady){doInit()}else{document.addEventListener('DOMContentLoaded',doInit)}
    },
    logout(){
        this.user=null;
        G.p=null;G.combat=false;G.enemies=[];
        try{firebase.auth().signOut()}catch(e){}
        closeAllModals();
        $('#authScreen').classList.remove('hidden');
        $('#authScreen').style.display='flex';
        $('#charCreate').classList.add('hidden');
        $('#charCreate').style.display='none';
        $('#combatArena').classList.add('hidden');
        $('#userInfo').innerHTML='';
        Story.clear();
    }
};

const FB={db:null,ok:false,init(){
    try{
        firebase.initializeApp({apiKey:"AIzaSyAV4eSg9QjyE08zwtFsvjAomuMYVcNik9k",databaseURL:"https://rpggo-756a7-default-rtdb.firebaseio.com",projectId:"rpggo-756a7",authDomain:"rpggo-756a7.firebaseapp.com"});
        this.db=firebase.database();
        this.db.ref('.info/connected').on('value',s=>{
            this.ok=s.val()===true;
            $('#fbStatus').classList.toggle('connected',this.ok);
            $('#fbStatusText').textContent=this.ok?'‚úì':'‚úó';
            if(this.ok)this.load();
        });
        firebase.auth().onAuthStateChanged(u=>{
            if(u){
                u.getIdToken(true).then(()=>{Auth.user=u;Auth.onAuth()}).catch(e=>{
                    Auth.user=null;
                    firebase.auth().signOut().then(()=>{
                        $('#authScreen').classList.remove('hidden');
                        $('#authScreen').style.display='flex';
                    });
                });
            }else if(!Auth.user){
                $('#authScreen').classList.remove('hidden');
                $('#authScreen').style.display='flex';
            }
        });
    }catch(e){console.error('Firebase init:',e)}
},
load(){
    if(!this.db)return;
    this.db.ref('gameData').once('value').then(s=>{
        const d=s.val();
        if(d){
            console.log('Firebase data loaded:',Object.keys(d));
            Object.keys(d).forEach(k=>{if(Data[k])Data[k]=d[k]});
            Editor.renderAll();
        }
    }).catch(e=>console.error('Firebase load error:',e));
}};

let G={p:null,combat:false,enemies:[],turn:0,region:null,item:null,turnOrder:[],currentActor:0,regionProgress:{},traveling:null};

const Story={add(t,c=''){const e=document.createElement('div');e.className=`story-entry ${c?'story-'+c:''}`;e.innerHTML=t;$('#chroniclesContent').appendChild(e);setTimeout(scrollChron,50)},clear(){$('#chroniclesContent').innerHTML=''}};

// ==================== REGIONS WITH TRAVEL SYSTEM ====================
const Regions={
    openSelector(){
        if(!G.region){toast('No hay regi√≥n','error');return}
        if(G.combat){toast('No en combate','error');return}
        const map=$('#travelMap');
        const current=G.region;
        const progress=G.regionProgress[current.id]||{encounters:0};
        
        // Current location
        let h=`<div class="travel-current">
            <div class="travel-current-icon">${current.icon}</div>
            <div class="travel-current-name">${current.name}</div>
            <div class="travel-current-progress">üìç Ubicaci√≥n actual ‚Ä¢ ${progress.encounters} encuentros completados</div>
        </div>`;
        
        // Available routes
        h+=`<div style="font-family:'Cinzel',serif;color:var(--gold);font-size:.8rem;margin-bottom:.3rem">üõ§Ô∏è Rutas disponibles:</div>`;
        h+=`<div class="travel-routes">`;
        
        const connected=Data.getConnectedRegions(current.id);
        connected.forEach(dest=>{
            const destProgress=G.regionProgress[dest.id]||{encounters:0,unlocked:dest.reqEncounters===0};
            const isUnlocked=dest.reqEncounters===0||progress.encounters>=dest.reqEncounters;
            const steps=Math.abs(dest.distance-current.distance)+1;
            
            h+=`<div class="travel-route ${isUnlocked?'':'locked'}" onclick="${isUnlocked?`Regions.startTravel('${dest.id}')`:''}">
                <div class="travel-route-icon">${dest.icon}</div>
                <div class="travel-route-info">
                    <div class="travel-route-name">${dest.name}</div>
                    <div class="travel-route-desc">${dest.desc}</div>
                    ${!isUnlocked?`<div class="travel-route-req">üîí Necesitas ${dest.reqEncounters} encuentros (tienes ${progress.encounters})</div>`:''}
                    <div class="travel-route-steps">üö∂ ${steps} ${steps===1?'paso':'pasos'} de viaje</div>
                    ${dest.type==='danger'?`<div style="font-size:.55rem;color:var(--red-bright)">‚ö†Ô∏è Zona peligrosa</div>`:''}
                </div>
                <div class="travel-route-arrow">${isUnlocked?'‚Üí':'üîí'}</div>
            </div>`;
        });
        
        h+=`</div>`;
        map.innerHTML=h;
        openModal('regionModal');
    },
    
    startTravel(destId){
        closeModal('regionModal');
        const dest=Data.getRegion(destId);
        const current=G.region;
        const steps=Math.abs(dest.distance-current.distance)+1;
        
        G.traveling={dest,steps,current:0};
        Story.add(`<strong>üö∂ Iniciando viaje a ${dest.name}...</strong>`,'travel');
        this.travelStep();
    },
    
    travelStep(){
        const t=G.traveling;
        if(!t)return;
        
        t.current++;
        const progress=(t.current/t.steps)*100;
        
        Story.add(`Paso ${t.current}/${t.steps} hacia ${t.dest.icon} ${t.dest.name}...`,'travel');
        
        // Chance of encounter during travel (30%)
        if(t.dest.type==='danger'&&Math.random()<0.3){
            Story.add('¬°Algo te intercepta en el camino!','combat');
            // Use enemies from either current region or destination
            const pool=[...Data.getEnemiesForRegion(G.region.id),...Data.getEnemiesForRegion(t.dest.id)];
            if(pool.length>0){
                const template=pick(pool);
                let count=1;
                if(template.canGroup&&Math.random()*100<(template.groupChance||0)*0.5){
                    count=Math.floor(Math.random()*2)+2; // Smaller groups during travel
                }
                const enemies=[];
                for(let i=0;i<count;i++){
                    enemies.push({...template,uid:genId('e'),hp:template.health,maxHp:template.health,effects:[],name:count>1?`${template.name} ${String.fromCharCode(65+i)}`:template.name});
                }
                Game.setActions([
                    {text:'‚öîÔ∏è Luchar',fn:()=>Combat.start(enemies,true),cls:'btn-primary'},
                    {text:'üí® Huir',fn:()=>{
                        Story.add('Retrocedes al lugar anterior.','system');
                        G.traveling=null;
                        Game.exploreActions();
                    },cls:'btn-danger'}
                ]);
                return;
            }
        }
        
        // Continue or arrive
        if(t.current>=t.steps){
            this.arriveAt(t.dest);
        }else{
            Game.setActions([{text:`üö∂ Continuar (${t.current}/${t.steps})`,fn:()=>this.travelStep(),cls:'btn-primary'}]);
        }
    },
    
    continueTravelAfterCombat(){
        if(!G.traveling){Game.exploreActions();return}
        Story.add('Contin√∫as tu viaje...','travel');
        if(G.traveling.current>=G.traveling.steps){
            this.arriveAt(G.traveling.dest);
        }else{
            Game.setActions([{text:`üö∂ Continuar (${G.traveling.current}/${G.traveling.steps})`,fn:()=>this.travelStep(),cls:'btn-primary'}]);
        }
    },
    
    arriveAt(dest){
        G.traveling=null;
        G.region=dest;
        if(!G.regionProgress[dest.id])G.regionProgress[dest.id]={encounters:0};
        
        Story.add(`<strong>üìç Has llegado a ${dest.icon} ${dest.name}</strong>`,'region');
        Story.add(dest.desc,'narrative');
        Game.updateUI();
        
        if(dest.type==='safe'){
            const npcs=Data.getNpcsForRegion(dest.id);
            if(npcs.length>0){
                Story.add(`Hay ${npcs.length} personas aqu√≠.`,'system');
            }
        }else{
            Story.add('Zona peligrosa. ¬°Prep√°rate!','system');
        }
        Game.exploreActions();
    }
};

const Game={
    selectedRace:null,
    init(){if(!this.load())this.showCreate()},
    showCreate(){
        $('#authScreen').classList.add('hidden');
        $('#authScreen').style.display='none';
        const el=$('#charCreate');
        el.classList.remove('hidden');
        el.style.display='flex';
        $('#raceGrid').innerHTML=Data.races.map(r=>`<div class="race-option" data-id="${r.id}" onclick="Game.selectRace('${r.id}')"><div class="race-option-icon">${sprite(r)}</div><div class="race-option-name">${r.name}</div><div class="race-option-stats">HP+${r.bonus.health||0} ‚ö°${r.bonus.speed||10}</div></div>`).join('');
        this.selectRace(Data.races[0].id);
    },
    selectRace(id){
        this.selectedRace=Data.races.find(r=>r.id===id);
        $$('.race-option').forEach(o=>o.classList.toggle('selected',o.dataset.id===id));
    },
    createChar(){
        const name=$('#heroName').value.trim()||pick(['Aldric','Brynn','Cedric','Dara','Freya','Kira','Theron']);
        const race=this.selectedRace||pick(Data.races);
        $('#charCreate').classList.add('hidden');
        $('#charCreate').style.display='none';
        const weapon={...Data.weapons[0],uid:genId('i')};
        const armor={...Data.armors[0],uid:genId('i')};
        const baseSpeed=race.bonus.speed||10;
        G.p={name,race,maxHp:20+(race.bonus.health||0),hp:20+(race.bonus.health||0),speed:baseSpeed,weapon,armor,inv:[{...Data.items[0],uid:genId('i')}],maxSlots:10,gold:0,silver:25,effects:[],pet:null,defending:false};
        G.combat=false;G.enemies=[];G.turn=0;
        G.region=Data.getRegion('pueblo');
        G.regionProgress={pueblo:{encounters:0}};
        G.traveling=null;
        Story.clear();
        Story.add(`<strong style="color:var(--gold);font-size:1.1rem">‚öîÔ∏è Aventuras de Acero y Runas ‚öîÔ∏è</strong>`);
        Story.add(`Eres <strong>${G.p.name}</strong>, ${race.name} ${race.icon}`,'narrative');
        Story.add(`üíÄ MODO HARDCORE: Si mueres, pierdes todo.`,'system');
        this.updateUI();this.exploreActions();
    },
    newGame(){if(!confirm('¬øCrear nuevo personaje? Se perder√° el progreso actual.'))return;this.deleteSave();G.p=null;G.combat=false;G.enemies=[];Story.clear();this.showCreate()},
    deleteSave(){localStorage.removeItem('rpg_save')},
    save(){localStorage.setItem('rpg_save',JSON.stringify({p:G.p,region:G.region,regionProgress:G.regionProgress}));toast('Guardado','success')},
    load(){const s=localStorage.getItem('rpg_save');if(!s)return false;try{const d=JSON.parse(s);if(!d||!d.p||!d.p.name||!d.p.race){console.log('Invalid save');return false}G.p=d.p;G.region=d.region?Data.getRegion(d.region.id):Data.getRegion('pueblo');G.regionProgress=d.regionProgress||{};G.combat=false;G.traveling=null;Story.add('Partida cargada.','system');this.updateUI();this.exploreActions();return true}catch(e){console.error('Load error:',e);return false}},
    updateUI(){
        const p=G.p;if(!p)return;
        $('#charAvatar').innerHTML=p.race.sprite?`<img src="${p.race.sprite}">`:p.race.icon;
        $('#charName').textContent=p.name;
        $('#charRace').textContent=p.race.name;
        const hp=(p.hp/p.maxHp)*100;
        $('#hpFill').style.width=hp+'%';$('#hpFill').className=`hp-fill ${hpClass(hp)}`;$('#hpText').textContent=`${p.hp}/${p.maxHp}`;
        const rb=$('#regionBadge');rb.className=`region-badge ${G.region.type}`;
        rb.innerHTML=`<span class="region-icon">${G.region.icon}</span><span class="region-name">${G.region.name}</span><div style="font-size:.5rem;color:var(--text-dim)">Click para viajar</div>`;
        $('#statArmor').textContent=this.armor();
        $('#statEvasion').textContent=p.race.bonus.evasion||0;
        $('#statPrecision').textContent=p.race.bonus.precision||0;
        $('#statSpeed').textContent=p.speed;
        $('#weaponIcon').innerHTML=sprite(p.weapon);$('#weaponName').textContent=p.weapon?.name||'Pu√±os';$('#weaponStats').textContent=`${p.weapon?.damage||'1d2'}`;
        $('#armorIcon').innerHTML=sprite(p.armor);$('#armorName').textContent=p.armor?.name||'Sin armadura';$('#armorStats').textContent=`Def:${p.armor?.defense||0}`;
        $('#goldAmount').textContent=p.gold;$('#silverAmount').textContent=p.silver;
        const canEq=!G.combat&&G.region.type==='safe';
        $('#weaponSlot').classList.toggle('disabled',!canEq);$('#armorSlot').classList.toggle('disabled',!canEq);
        // Toggle combat mode classes
        $('#charPanel').classList.toggle('in-combat',G.combat);
        $('#actionsPanel').classList.toggle('in-combat',G.combat);
    },
    armor(){if(!G.p)return 0;return(G.p.armor?.defense||0)+(G.p.race?.bonus?.armor||0)},
    setActions(acts){const c=$('#actionsContainer');c.innerHTML='';acts.forEach(a=>{const b=document.createElement('button');b.className=`btn ${a.cls||''}`;b.textContent=a.text;b.disabled=a.disabled||false;b.onclick=a.fn;c.appendChild(b)})},
    exploreActions(){
        if(!G.p||!G.region)return;
        const actions=[{text:'üó∫Ô∏è Viajar',fn:()=>Regions.openSelector()}];
        if(G.region.type==='danger'){
            actions.unshift({text:'‚öîÔ∏è Explorar',fn:()=>Explore.start(),cls:'btn-primary'});
        }else{
            const npcs=Data.getNpcsForRegion(G.region.id);
            if(npcs.length>0)actions.push({text:'üèòÔ∏è NPCs',fn:()=>Town.visit(G.region)});
        }
        actions.push({text:'üéí Inventario',fn:()=>Inv.open()},{text:'üíæ Guardar',fn:()=>this.save()},{text:'üîÑ Nueva',fn:()=>this.newGame(),cls:'btn-danger'});
        this.setActions(actions);
    }
};

const Explore={
    start(){if(G.region.type==='safe'){toast('Zona segura','info');return}Story.add(pick(G.region.narratives)||'Exploras...','narrative');Game.setActions([{text:'...',disabled:true}]);setTimeout(()=>{const r=dX(100);if(r<=55)this.enemy();else if(r<=75)this.trap();else if(r<=88)this.treasure();else if(r<=96)this.pet();else this.safe()},800)},
    enemy(){const pool=Data.getEnemiesForRegion(G.region.id);if(pool.length===0){Story.add('Nada aqu√≠...','system');Game.exploreActions();return}const template=pick(pool);let count=1;if(template.canGroup&&Math.random()*100<(template.groupChance||0)){const min=template.groupMin||2,max=template.groupMax||4;count=Math.floor(Math.random()*(max-min+1))+min}const enemies=[];for(let i=0;i<count;i++){enemies.push({...template,uid:genId('e'),hp:template.health,maxHp:template.health,effects:[],name:count>1?`${template.name} ${String.fromCharCode(65+i)}`:template.name})}if(count>1)Story.add(`¬°${count} ${template.name}s aparecen!`,'narrative');else Story.add(template.desc||`Un ${template.name} aparece.`,'narrative');setTimeout(()=>{Story.add(`<strong>¬°Combate!</strong>`,'combat');Game.setActions([{text:`‚öîÔ∏è Luchar (${count})`,fn:()=>Combat.start(enemies),cls:'btn-primary'},{text:'üí® Huir',fn:()=>this.flee(enemies),cls:'btn-danger'}])},600)},
    async flee(enemies){const r=d20();await showDice(r,20,r>=14);Story.add(`Huida: D20=${r} vs 14`,'system');if(r>=14){Story.add('¬°Escapas!','narrative');Game.exploreActions()}else{Story.add('¬°No escapas!','combat');Combat.start(enemies)}},
    async trap(){const trap=pick(Data.traps);Story.add('Sientes peligro...','narrative');setTimeout(async()=>{Story.add(`<strong>¬°Trampa!</strong> ${trap.name}`,'trap');const det=d20();await showDice(det,20,det>=trap.detectDiff);Story.add(`Percepci√≥n: D20=${det} vs ${trap.detectDiff}`,'system');if(det>=trap.detectDiff){Story.add('¬°La detectas!','system');Game.setActions([{text:'üèÉ Esquivar',fn:async()=>{const r=d20();await showDice(r,20,r>=trap.dodgeDiff);if(r>=trap.dodgeDiff){Story.add('¬°Esquivado!','loot');Game.exploreActions()}else this.trapDmg(trap,true)},cls:'btn-primary'},{text:'üîß Desactivar',fn:async()=>{const r=d20();await showDice(r,20,r>=15);if(r>=15){const mp=dX(15)+5;G.p.silver+=mp;Story.add(`¬°√âxito! +${mp} MP`,'loot')}else if(r>=10)Story.add('No funciona.','system');else{Story.add('¬°La activas!','trap');this.trapDmg(trap,false);return}Game.updateUI();Game.exploreActions()}}])}else{Story.add('No la detectas...','trap');this.trapDmg(trap,false)}},800)},
    trapDmg(trap,reduced){let dmg=roll(trap.damage);if(reduced)dmg=Math.ceil(dmg*0.5);const arm=Math.floor(Game.armor()/2);const final=Math.max(0,dmg-arm);Story.add(`${trap.name}: ${dmg} ‚àí ${arm} arm = <strong>${final} da√±o</strong>${final===0?' (bloqueado)':''}`,'system');if(final>0)G.p.hp-=final;if(trap.effect)Combat.applyEff(G.p,trap.effect);Game.updateUI();if(G.p.hp<=0){Story.add('<strong style="color:var(--red-bright)">üíÄ Has muerto...</strong>','combat');Story.add('Tu aventura termina aqu√≠.','system');Game.deleteSave();Game.setActions([{text:'üîÑ Nueva Partida',fn:()=>{G.p=null;Story.clear();Game.showCreate()},cls:'btn-primary'}])}else Game.exploreActions()},
    treasure(){Story.add('¬°Algo brilla!','narrative');setTimeout(()=>{const mp=dX(30)+10;G.p.silver+=mp;while(G.p.silver>=99){G.p.silver-=99;G.p.gold++}Story.add(`+${mp} MP`,'loot');if(Math.random()<0.3&&G.p.inv.length<G.p.maxSlots){const it={...pick(Data.items),uid:genId('i')};G.p.inv.push(it);Story.add(`Tambi√©n: ${it.icon} ${it.name}`,'loot')}Game.updateUI();Game.exploreActions()},800)},
    pet(){if(G.p.pet){this.safe();return}const pool=Data.getPetsForRegion(G.region.id);if(pool.length===0){this.treasure();return}const pet=pick(pool);Story.add(`${pet.icon} Un ${pet.name} aparece.`,'narrative');const meat=G.p.inv.some(i=>i.type==='food');Game.setActions([{text:'ü•© Domesticar',fn:async()=>{const idx=G.p.inv.findIndex(i=>i.type==='food');if(idx>=0)G.p.inv.splice(idx,1);const r=dX(pet.difficulty),th=Math.ceil(pet.difficulty*0.6);await showDice(r,pet.difficulty,r>=th);if(r>=th){G.p.pet={...pet,hp:pet.health,maxHp:pet.health};Story.add(`<strong style="color:var(--green-bright)">¬°${pet.name} es tu compa√±ero!</strong>`,'loot');toast('¬°Compa√±ero!','success')}else Story.add(`El ${pet.name} se aleja.`,'narrative');Game.updateUI();Game.exploreActions()},disabled:!meat,cls:meat?'btn-primary':''},{text:'‚öîÔ∏è Cazar',fn:()=>Combat.start([{...pet,uid:genId('e'),hp:pet.health,maxHp:pet.health,difficulty:10,armor:0,loot:[5,15],drops:['i4'],effects:[]}])},{text:'üö∂ Dejar',fn:()=>{Story.add('Te alejas.','narrative');Game.exploreActions()}}])},
    safe(){Story.add('Lugar tranquilo.','narrative');const h=Math.floor(G.p.maxHp*0.3);G.p.hp=Math.min(G.p.maxHp,G.p.hp+h);G.p.effects=[];Story.add(`<span style="color:var(--green-bright)">+${h} HP</span>. Curado.`,'system');Game.updateUI();Game.exploreActions()}
};

const Combat={
    duringTravel:false,
    start(enemies,duringTravel=false){
        this.duringTravel=duringTravel;
        G.combat=true;G.enemies=enemies;G.turn=0;G.p.defending=false;
        $('#combatArena').classList.remove('hidden');
        $('#combatLog').innerHTML='';
        Game.updateUI(); // This will hide HP bar and actions panel
        this.newTurn();
    },
    calcTurnOrder(){const combatants=[];combatants.push({type:'player',entity:G.p,speed:G.p.speed,init:d20()});if(G.p.pet&&G.p.pet.hp>0)combatants.push({type:'pet',entity:G.p.pet,speed:G.p.pet.speed||12,init:d20()});G.enemies.filter(e=>e.hp>0).forEach(e=>{combatants.push({type:'enemy',entity:e,speed:e.speed||10,init:d20()})});combatants.sort((a,b)=>{if(b.speed!==a.speed)return b.speed-a.speed;return b.init-a.init});return combatants},
    newTurn(){G.turn++;G.p.defending=false;G.turnOrder=this.calcTurnOrder();G.currentActor=0;this.log(`<div class="log-turn">‚ïê‚ïê TURNO ${G.turn} ‚ïê‚ïê</div>`);let orderHtml='<div class="log-order">';G.turnOrder.forEach((c,i)=>{const cls=c.type==='player'?'player':c.type==='pet'?'pet':'enemy';orderHtml+=`<span class="log-order-tag ${cls}">${i+1}.${c.entity.name} ‚ö°${c.speed}</span>`});orderHtml+='</div>';this.log(orderHtml);this.updateUI();this.nextActor()},
    async nextActor(){const aliveEnemies=G.enemies.filter(e=>e.hp>0);if(aliveEnemies.length===0){this.victory();return}if(G.p.hp<=0){this.defeat();return}while(G.currentActor<G.turnOrder.length){const actor=G.turnOrder[G.currentActor];if((actor.type==='player'&&G.p.hp>0)||(actor.type==='pet'&&G.p.pet?.hp>0)||(actor.type==='enemy'&&actor.entity.hp>0))break;G.currentActor++}if(G.currentActor>=G.turnOrder.length){this.processAllEffects();await delay(300);this.newTurn();return}const actor=G.turnOrder[G.currentActor];this.highlightActor(actor);if(actor.type==='player')this.showPlayerActions();else if(actor.type==='pet')await this.petAction();else await this.enemyAction(actor.entity)},
    highlightActor(actor){$$('.combatant').forEach(c=>c.classList.remove('active'));const el=actor.type==='player'?$(`.combatant.player`):actor.type==='pet'?$(`.combatant.pet`):$(`[data-uid="${actor.entity.uid}"]`);if(el)el.classList.add('active')},
    showPlayerActions(){const ca=$('#combatActions');ca.innerHTML='';const aliveEnemies=G.enemies.filter(e=>e.hp>0);if(aliveEnemies.length>1){ca.innerHTML=`<div style="width:100%;text-align:center;font-size:.65rem;color:var(--text-dim);margin-bottom:.2rem">Objetivo:</div>`;const targetDiv=document.createElement('div');targetDiv.className='target-select';aliveEnemies.forEach(e=>{const btn=document.createElement('button');btn.className='target-btn';btn.innerHTML=`${e.icon} ${e.name}`;btn.onclick=()=>this.playerAttack(e);targetDiv.appendChild(btn)});ca.appendChild(targetDiv)}else{const atk=document.createElement('button');atk.className='btn btn-primary';atk.textContent='‚öîÔ∏è Atacar';atk.onclick=()=>this.playerAttack(aliveEnemies[0]);ca.appendChild(atk)}[{text:'üõ°Ô∏è Defender',fn:()=>this.playerDefend()},{text:'üéí Item',fn:()=>Inv.open()},{text:'üí® Huir',fn:()=>this.playerFlee(),cls:'btn-danger'}].forEach(a=>{const b=document.createElement('button');b.className=`btn ${a.cls||''}`;b.textContent=a.text;b.onclick=a.fn;ca.appendChild(b)})},
    async playerAttack(target){const p=G.p;const atkRoll=d20();const prec=p.race.bonus.precision||0;const total=atkRoll+prec;const isCrit=atkRoll===20;const isPifia=atkRoll===1;await showDice(atkRoll,20,isCrit);this.log(`<span class="log-player">${p.name}</span> ‚Üí <span class="log-enemy">${target.name}</span>`);this.log(`‚îå Ataque: D20=<strong>${atkRoll}</strong>${prec?`+${prec}`:''} = ${total} vs ${target.difficulty}`);if(isPifia){this.log(`‚îî <span class="log-miss">¬°PIFIA! Fallo autom√°tico</span>`)}else if(total>=target.difficulty||isCrit){const dmgRoll=rollDetailed(p.weapon?.damage||'1d2');const bonus=p.race.bonus.damage||0;let baseDmg=dmgRoll.total+bonus;this.log(`‚îú Da√±o: ${dmgRoll.dice}=[${dmgRoll.rolls}]${bonus?`+${bonus}`:''} = ${baseDmg}`);if(isCrit){baseDmg*=2;this.log(`‚îú <span class="log-crit">¬°CR√çTICO! x2 = ${baseDmg}</span>`)}const armor=target.armor||0;const finalDmg=Math.max(0,baseDmg-armor);if(finalDmg>0){this.log(`<div class="log-calc">‚öîÔ∏è ${baseDmg} ‚àí ${armor} arm = <strong>${finalDmg}</strong></div>`);target.hp-=finalDmg;this.log(`‚îî <span class="log-damage">${target.name} -${finalDmg} HP (${Math.max(0,target.hp)}/${target.maxHp})</span>`)}else{this.log(`<div class="log-calc blocked">üõ°Ô∏è ${baseDmg} ‚àí ${armor} arm = 0 BLOQUEADO</div>`);this.log(`‚îî <span class="log-miss">${target.name} bloquea</span>`)}if(p.weapon?.effect&&finalDmg>0)this.applyEff(target,p.weapon.effect);if(target.hp<=0)this.log(`<span class="log-damage">üíÄ ${target.name} derrotado!</span>`)}else{this.log(`‚îî <span class="log-miss">Falla</span>`)}this.updateUI();G.currentActor++;await delay(350);this.nextActor()},
    playerDefend(){G.p.defending=true;this.log(`<span class="log-player">${G.p.name}</span> defiende <span class="log-heal">+4 Eva</span>`);G.currentActor++;this.updateUI();this.nextActor()},
    async playerFlee(){const r=d20();await showDice(r,20,r>=12);this.log(`Huida: D20=${r} vs 12`);if(r>=12){this.log('<span class="log-heal">¬°Escape!</span>');this.escape()}else{this.log('<span class="log-miss">¬°No escapas!</span>');G.currentActor++;await delay(300);this.nextActor()}},
    async petAction(){const pet=G.p.pet;const aliveEnemies=G.enemies.filter(e=>e.hp>0);if(aliveEnemies.length===0)return;const target=pick(aliveEnemies);const dmgRoll=rollDetailed(pet.damage);const baseDmg=dmgRoll.total;const armor=target.armor||0;const finalDmg=Math.max(0,baseDmg-armor);this.log(`<span class="log-pet">${pet.icon} ${pet.name}</span> ‚Üí <span class="log-enemy">${target.name}</span>`);this.log(`‚îú Da√±o: ${dmgRoll.dice}=[${dmgRoll.rolls}] = ${baseDmg}`);if(finalDmg>0){this.log(`<div class="log-calc">‚öîÔ∏è ${baseDmg} ‚àí ${armor} = ${finalDmg}</div>`);target.hp-=finalDmg;this.log(`‚îî <span class="log-damage">${target.name} -${finalDmg} (${Math.max(0,target.hp)}/${target.maxHp})</span>`);if(target.hp<=0)this.log(`<span class="log-damage">üíÄ ${target.name} derrotado!</span>`)}else{this.log(`<div class="log-calc blocked">üõ°Ô∏è ${baseDmg} ‚àí ${armor} = 0 BLOQUEADO</div>`)}this.updateUI();G.currentActor++;await delay(350);this.nextActor()},
    async enemyAction(enemy){const p=G.p;const evaBonus=(p.race.bonus.evasion||0)+(p.defending?4:0);const dodgeRoll=d20();const dodgeTotal=dodgeRoll+evaBonus;this.log(`<span class="log-enemy">${enemy.name}</span> ‚Üí <span class="log-player">${p.name}</span>`);this.log(`‚îå Esquive: D20=${dodgeRoll}${evaBonus?`+${evaBonus}`:''} = ${dodgeTotal} vs 12`);if(dodgeTotal>=12){this.log(`‚îî <span class="log-heal">¬°Esquivado!</span>`)}else{const dmgRoll=rollDetailed(enemy.damage);let baseDmg=dmgRoll.total;const isCrit=Math.random()<0.1;this.log(`‚îú Da√±o: ${dmgRoll.dice}=[${dmgRoll.rolls}] = ${baseDmg}`);if(isCrit){baseDmg=Math.ceil(baseDmg*1.25);this.log(`‚îú <span class="log-crit">¬°Cr√≠tico! x1.25 = ${baseDmg}</span>`)}const playerArmor=Game.armor();const finalDmg=Math.max(0,baseDmg-playerArmor);if(finalDmg>0){this.log(`<div class="log-calc">‚öîÔ∏è ${baseDmg} ‚àí ${playerArmor} arm = ${finalDmg}</div>`);p.hp-=finalDmg;this.log(`‚îî <span class="log-damage">${p.name} -${finalDmg} HP (${Math.max(0,p.hp)}/${p.maxHp})</span>`);if(enemy.effect)this.applyEff(p,enemy.effect)}else{this.log(`<div class="log-calc blocked">üõ°Ô∏è ${baseDmg} ‚àí ${playerArmor} = 0 BLOQUEADO</div>`);this.log(`‚îî <span class="log-heal">${p.name} bloquea</span>`)}}this.updateUI();Game.updateUI();G.currentActor++;if(p.hp<=0){this.defeat();return}await delay(350);this.nextActor()},
    applyEff(t,type){const effs={bleed:{dmg:1,turns:3},poison:{dmg:2,turns:2},fire:{dmg:'1d4',turns:2}};const ef=effs[type];if(!ef)return;if(!t.effects)t.effects=[];const ex=t.effects.find(e=>e.type===type);if(ex)ex.turns=ef.turns;else t.effects.push({type,dmg:ef.dmg,turns:ef.turns});this.log(`<span style="color:var(--orange)">‚ö° ${type.toUpperCase()} ‚Üí ${t.name}</span>`)},
    processAllEffects(){this.processEff(G.p);if(G.p.pet)this.processEff(G.p.pet);G.enemies.forEach(e=>this.processEff(e));this.updateUI();Game.updateUI()},
    processEff(t){if(!t.effects?.length||t.hp<=0)return;let total=0;t.effects.forEach(ef=>{const d=typeof ef.dmg==='string'?roll(ef.dmg):ef.dmg;total+=d;ef.turns--});t.effects=t.effects.filter(e=>e.turns>0);if(total>0){t.hp=Math.max(0,t.hp-total);this.log(`<span style="color:var(--orange)">üî• ${t.name} -${total} efectos (HP:${t.hp})</span>`)}},
    victory(){
        $('#combatArena').classList.add('hidden');
        G.combat=false;
        // Increment encounter count for current region
        if(!G.regionProgress[G.region.id])G.regionProgress[G.region.id]={encounters:0};
        G.regionProgress[G.region.id].encounters++;
        
        let totalLoot=0;
        G.enemies.forEach(e=>{if(e.loot){const mp=dX(e.loot[1]-e.loot[0])+e.loot[0];totalLoot+=mp}if(e.drops)e.drops.forEach(did=>{if(Math.random()<0.3&&G.p.inv.length<G.p.maxSlots){const it=Data.findItem(did);if(it){G.p.inv.push({...it,uid:genId('i')});Story.add(`Encuentras: ${it.icon} ${it.name}`,'loot')}}})});
        G.p.silver+=totalLoot;while(G.p.silver>=99){G.p.silver-=99;G.p.gold++}
        Story.add(`<strong style="color:var(--green-bright)">üéâ ¬°Victoria!</strong> +${totalLoot} MP`,'loot');
        Story.add(`üìä Encuentros en ${G.region.name}: ${G.regionProgress[G.region.id].encounters}`,'system');
        G.enemies=[];
        Game.updateUI();
        
        // If traveling, continue journey
        if(this.duringTravel){
            this.duringTravel=false;
            Regions.continueTravelAfterCombat();
        }else{
            Game.exploreActions();
        }
    },
    defeat(){$('#combatArena').classList.add('hidden');G.combat=false;this.duringTravel=false;G.traveling=null;Story.add('<strong style="color:var(--red-bright)">üíÄ Has muerto...</strong>','combat');Story.add('Tu aventura termina aqu√≠.','system');Game.deleteSave();Game.setActions([{text:'üîÑ Nueva Partida',fn:()=>{G.p=null;Story.clear();Game.showCreate()},cls:'btn-primary'}])},
    escape(){$('#combatArena').classList.add('hidden');G.combat=false;G.enemies=[];Story.add('Escapas.','system');Game.updateUI();if(this.duringTravel){this.duringTravel=false;G.traveling=null;Story.add('Vuelves al punto de partida.','travel')}Game.exploreActions()},
    log(t){$('#combatLog').innerHTML+=`<div class="log-entry">${t}</div>`;$('#combatLog').scrollTop=999999},
    updateUI(){if(!G.p)return;const grid=$('#combatGrid');grid.innerHTML='';const pDiv=document.createElement('div');pDiv.className=`combatant player ${G.p.hp<=0?'dead':''}`;const pHpPct=(G.p.hp/G.p.maxHp)*100;pDiv.innerHTML=`<div class="combatant-order">‚ö°${G.p.speed}</div><div class="combatant-sprite">${sprite({icon:G.p.race.icon,sprite:G.p.race.sprite})}</div><div class="combatant-name">${G.p.name}</div><div class="combatant-stats">‚öîÔ∏è${G.p.weapon?.damage||'1d2'} üõ°Ô∏è${Game.armor()}</div><div class="hp-container"><div class="hp-fill ${hpClass(pHpPct)}" style="width:${pHpPct}%"></div><div class="hp-text">${G.p.hp}/${G.p.maxHp}</div></div><div class="effects-row">${(G.p.effects||[]).map(e=>`<span class="effect-tag eff-${e.type}">${e.type}${e.turns}</span>`).join('')}</div>`;grid.appendChild(pDiv);if(G.p.pet&&G.p.pet.hp>0){const petDiv=document.createElement('div');petDiv.className='combatant pet';const petHpPct=(G.p.pet.hp/G.p.pet.maxHp)*100;petDiv.innerHTML=`<div class="combatant-order">‚ö°${G.p.pet.speed||12}</div><div class="combatant-sprite">${G.p.pet.icon}</div><div class="combatant-name">${G.p.pet.name}</div><div class="combatant-stats">‚öîÔ∏è${G.p.pet.damage}</div><div class="hp-container"><div class="hp-fill" style="width:${petHpPct}%"></div><div class="hp-text">${G.p.pet.hp}/${G.p.pet.maxHp}</div></div>`;grid.appendChild(petDiv)}const vs=document.createElement('div');vs.className='combat-vs';vs.textContent='‚öî';grid.appendChild(vs);G.enemies.forEach(e=>{const eDiv=document.createElement('div');eDiv.className=`combatant enemy ${e.hp<=0?'dead':''}`;eDiv.dataset.uid=e.uid;const eHpPct=(e.hp/e.maxHp)*100;eDiv.innerHTML=`<div class="combatant-order">‚ö°${e.speed||10}</div><div class="combatant-sprite">${sprite(e)}</div><div class="combatant-name">${e.name}</div><div class="combatant-stats">‚öîÔ∏è${e.damage} üõ°Ô∏è${e.armor||0}</div><div class="hp-container"><div class="hp-fill ${hpClass(eHpPct)}" style="width:${eHpPct}%"></div><div class="hp-text">${Math.max(0,e.hp)}/${e.maxHp}</div></div><div class="effects-row">${(e.effects||[]).map(ef=>`<span class="effect-tag eff-${ef.type}">${ef.type}${ef.turns}</span>`).join('')}</div>`;grid.appendChild(eDiv)});$('#turnCounter').textContent=G.turn}
};

const Inv={
    open(){if(!G.p)return;this.render();openModal('inventoryModal')},
    render(){if(!G.p)return;$('#inventoryInfo').textContent=`${G.p.inv.length}/${G.p.maxSlots}`;const g=$('#inventoryGrid');g.innerHTML='';G.p.inv.forEach(it=>{const s=document.createElement('div');s.className=`inv-slot rarity-${it.rarity||'common'}`;s.innerHTML=`<div class="inv-slot-icon">${sprite(it)}</div><div class="inv-slot-name">${it.name}</div>`;s.onclick=()=>this.detail(it,'inv');g.appendChild(s)});for(let i=G.p.inv.length;i<G.p.maxSlots;i++){const s=document.createElement('div');s.className='inv-slot empty';s.innerHTML='<div class="inv-slot-name" style="color:var(--text-dim)">vac√≠o</div>';g.appendChild(s)}},
    detail(it,ctx){G.item=it;$('#detailIcon').innerHTML=sprite(it);$('#detailName').textContent=it.name;$('#detailType').textContent=it.damage?'Arma':it.defense!==undefined?'Armadura':it.type||'Item';$('#detailDesc').textContent=it.desc||'Sin descripci√≥n.';let st='';if(it.damage)st+=`<div class="item-stat-box"><div class="item-stat-label">Da√±o</div><div class="item-stat-value">${it.damage}</div></div>`;if(it.defense!==undefined)st+=`<div class="item-stat-box"><div class="item-stat-label">Defensa</div><div class="item-stat-value">${it.defense}</div></div>`;if(it.effect&&(it.type==='potion'||it.type==='food'))st+=`<div class="item-stat-box"><div class="item-stat-label">Cura</div><div class="item-stat-value">${it.effect}</div></div>`;if(it.value)st+=`<div class="item-stat-box"><div class="item-stat-label">Valor</div><div class="item-stat-value">${it.value}MP</div></div>`;$('#detailStats').innerHTML=st;const canEq=!G.combat&&G.region.type==='safe';let acts='';if(ctx.startsWith('eq-')){if(canEq)acts=`<button class="btn btn-danger" onclick="Inv.unequip('${ctx.split('-')[1]}')">‚ùå Quitar</button>`;else acts='<span style="color:var(--text-dim)">Solo zona segura</span>'}else{if(it.damage&&canEq)acts+=`<button class="btn btn-primary" onclick="Inv.equip('weapon')">‚öîÔ∏è Equipar</button>`;if(it.defense!==undefined&&canEq)acts+=`<button class="btn btn-primary" onclick="Inv.equip('armor')">üõ°Ô∏è Equipar</button>`;if(it.type==='potion'||it.type==='food')acts+=`<button class="btn btn-primary" onclick="Inv.use()">‚ú® Usar</button>`;if(it.type==='antidote')acts+=`<button class="btn btn-primary" onclick="Inv.use()">üíä Usar</button>`;if(it.type==='escape'&&G.combat)acts+=`<button class="btn btn-primary" onclick="Inv.use()">üí® Usar</button>`;if(it.type==='backpack')acts+=`<button class="btn btn-primary" onclick="Inv.use()">üéí Usar</button>`}acts+=`<button class="btn" onclick="closeModal('itemDetailModal')">Cerrar</button>`;$('#detailActions').innerHTML=acts;openModal('itemDetailModal')},
    equip(slot){const it=G.item;if(!it?.uid)return;closeModal('itemDetailModal');if(slot==='weapon'){if(G.p.weapon?.uid)G.p.inv.push(G.p.weapon);G.p.weapon=it}else{if(G.p.armor?.uid)G.p.inv.push(G.p.armor);G.p.armor=it}G.p.inv=G.p.inv.filter(i=>i.uid!==it.uid);toast('Equipado','success');Game.updateUI();this.render()},
    unequip(slot){if(G.p.inv.length>=G.p.maxSlots){toast('Inventario lleno','error');return}closeModal('itemDetailModal');if(slot==='weapon'){if(G.p.weapon?.uid)G.p.inv.push(G.p.weapon);G.p.weapon={name:'Pu√±os',damage:'1d2',icon:'‚úä'}}else{if(G.p.armor?.uid)G.p.inv.push(G.p.armor);G.p.armor={name:'Sin armadura',defense:0,icon:'üë§'}}toast('Desequipado','info');Game.updateUI()},
    use(){const it=G.item;if(!it?.uid)return;closeModal('itemDetailModal');closeModal('inventoryModal');if(it.type==='potion'||it.type==='food'){const h=roll(it.effect||'1d4');const a=Math.min(h,G.p.maxHp-G.p.hp);G.p.hp+=a;Story.add(`${it.icon} ${it.name}: <span style="color:var(--green-bright)">+${a} HP</span>`,'system');if(G.combat)Combat.log(`<span class="log-heal">${G.p.name} usa ${it.name}: +${a} HP</span>`)}else if(it.type==='antidote'){G.p.effects=G.p.effects.filter(e=>e.type!=='poison');Story.add('Veneno curado.','system')}else if(it.type==='escape'&&G.combat){G.p.inv=G.p.inv.filter(i=>i.uid!==it.uid);Story.add('¬°Bomba de humo!','narrative');Combat.escape();return}else if(it.type==='backpack'){const s=parseInt(it.effect)||5;G.p.maxSlots+=s;Story.add(`+${s} espacios.`,'system')}G.p.inv=G.p.inv.filter(i=>i.uid!==it.uid);Game.updateUI();if(G.combat){Combat.updateUI();G.currentActor++;Combat.nextActor()}}
};

const Town={
    npc:null,
    visit(region){
        const npcs=Data.getNpcsForRegion(region.id);
        if(npcs.length===0){toast('No hay NPCs aqu√≠','info');return}
        $('#townTitle').textContent=`${region.icon} ${region.name}`;
        const roles={merchant:'Comerciante',blacksmith:'Herrero',alchemist:'Alquimista',innkeeper:'Tabernero',healer:'Curandero',guard:'Guardia',villager:'Aldeano'};
        let h='<div style="display:grid;gap:.4rem">';
        npcs.forEach(n=>{
            h+=`<div class="item-card" onclick="Town.interact('${n.id}')">
                <span class="item-card-icon">${sprite(n)}</span>
                <div class="item-card-info">
                    <div class="item-card-name">${n.name}</div>
                    <div class="item-card-stats">${roles[n.role]||n.role}</div>
                </div>
            </div>`;
        });
        h+='</div>';
        $('#townContent').innerHTML=h;
        openModal('townModal');
    },
    interact(id){
        const n=Data.find('npcs',id);
        if(!n)return;
        closeModal('townModal');
        this.npc=n;
        Story.add(`<strong>${n.name}</strong>: "${n.dialogue||'¬°Saludos!'}"`,`dialogue`);
        
        if(n.sells?.length>0){
            setTimeout(()=>this.shop(n),400);
        }else if(n.role==='healer'){
            if(G.p.silver>=10){
                G.p.silver-=10;
                G.p.hp=G.p.maxHp;
                G.p.effects=[];
                Story.add('Curaci√≥n completa. (-10 MP)','system');
            }else{
                Story.add('"No tienes suficiente dinero."','dialogue');
            }
            Game.updateUI();
        }else if(n.role==='innkeeper'){
            if(G.p.silver>=5){
                G.p.silver-=5;
                const h=Math.floor(G.p.maxHp*0.5);
                G.p.hp=Math.min(G.p.maxHp,G.p.hp+h);
                Story.add(`Descansas. +${h} HP (-5 MP)`,'system');
            }else{
                Story.add('"No tienes dinero para una habitaci√≥n."','dialogue');
            }
            Game.updateUI();
        }else{
            Story.add('No tiene nada que ofrecerte por ahora.','system');
        }
    },
    shop(n){$('#shopTitle').textContent=`üè™ ${n.name}`;let h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:.8rem"><div><h4 style="color:var(--gold);margin-bottom:.4rem;font-size:.75rem">En venta</h4><div style="display:grid;gap:.25rem;max-height:180px;overflow-y:auto">';(n.sells||[]).forEach(iid=>{const it=Data.findItem(iid);if(it){const can=G.p.silver>=it.value&&G.p.inv.length<G.p.maxSlots;h+=`<div class="item-card" style="opacity:${can?1:.5}"><span class="item-card-icon">${sprite(it)}</span><div class="item-card-info"><div class="item-card-name">${it.name}</div><div class="item-card-stats">${it.value} MP</div></div><button class="btn btn-sm" onclick="Town.buy('${it.id}')" ${can?'':'disabled'}>Comprar</button></div>`}});h+='</div></div><div><h4 style="color:var(--gold);margin-bottom:.4rem;font-size:.75rem">Vender</h4><div style="display:grid;gap:.25rem;max-height:180px;overflow-y:auto">';G.p.inv.forEach(it=>{const sp=Math.floor((it.value||10)*0.5);h+=`<div class="item-card"><span class="item-card-icon">${sprite(it)}</span><div class="item-card-info"><div class="item-card-name">${it.name}</div><div class="item-card-stats">${sp} MP</div></div><button class="btn btn-sm" onclick="Town.sell('${it.uid}',${sp})">Vender</button></div>`});h+=`</div></div></div><div style="text-align:center;margin-top:.6rem;color:var(--text-dim);font-size:.7rem">üí∞ ${G.p.gold} MO ${G.p.silver} MP</div>`;$('#shopContent').innerHTML=h;openModal('shopModal')},
    buy(iid){const it=Data.findItem(iid);if(!it||G.p.silver<it.value||G.p.inv.length>=G.p.maxSlots)return;G.p.silver-=it.value;G.p.inv.push({...it,uid:genId('i')});toast('Comprado','success');Game.updateUI();if(this.npc)this.shop(this.npc)},
    sell(uid,price){const it=G.p.inv.find(i=>i.uid===uid);if(!it)return;G.p.inv=G.p.inv.filter(i=>i.uid!==uid);G.p.silver+=price;while(G.p.silver>=99){G.p.silver-=99;G.p.gold++}toast('Vendido','success');Game.updateUI();if(this.npc)this.shop(this.npc)}
};

const Editor={
    clear(t){const fields={region:['region-id','region-name','region-icon','region-desc','region-narratives','region-distance','region-reqEncounters','region-connections'],race:['race-id','race-name','race-icon','race-sprite','race-hp','race-armor','race-speed','race-precision','race-damage','race-desc'],weapon:['weapon-id','weapon-name','weapon-damage','weapon-icon','weapon-sprite','weapon-value','weapon-desc'],armor:['armor-id','armor-name','armor-defense','armor-icon','armor-sprite','armor-value','armor-desc'],item:['item-id','item-name','item-icon','item-sprite','item-effect','item-value','item-desc'],enemy:['enemy-id','enemy-name','enemy-health','enemy-damage','enemy-difficulty','enemy-armor','enemy-speed','enemy-icon','enemy-sprite','enemy-loot-min','enemy-loot-max','enemy-desc','enemy-groupMin','enemy-groupMax','enemy-groupChance'],pet:['pet-id','pet-name','pet-health','pet-damage','pet-speed','pet-difficulty','pet-icon','pet-sprite','pet-desc'],npc:['npc-id','npc-name','npc-icon','npc-sprite','npc-dialogue']};(fields[t]||[]).forEach(id=>{const e=$(`#${id}`);if(e)e.value=''});$$('.multi-select input').forEach(c=>c.checked=false);if(t==='enemy')$('#enemy-canGroup').value='false'},
    saveRegion(){const narratives=$('#region-narratives').value.split('\n').filter(n=>n.trim());const connections=$('#region-connections').value.split(',').map(c=>c.trim()).filter(c=>c);const r={id:$('#region-id').value||genId('reg'),name:$('#region-name').value,icon:$('#region-icon').value||'üó∫Ô∏è',type:$('#region-type').value,desc:$('#region-desc').value||'',distance:parseInt($('#region-distance').value)||0,reqEncounters:parseInt($('#region-reqEncounters').value)||0,connections,narratives};if(!r.name){toast('Falta nombre','error');return}const i=Data.regions.findIndex(x=>x.id===r.id);if(i>=0)Data.regions[i]=r;else Data.regions.push(r);Data.save();this.renderRegions();this.updateSelects();this.clear('region');toast('Guardado','success')},
    editRegion(id){const r=Data.find('regions',id);if(!r)return;$('#region-id').value=r.id;$('#region-name').value=r.name;$('#region-icon').value=r.icon||'';$('#region-type').value=r.type||'danger';$('#region-desc').value=r.desc||'';$('#region-distance').value=r.distance||0;$('#region-reqEncounters').value=r.reqEncounters||0;$('#region-connections').value=(r.connections||[]).join(',');$('#region-narratives').value=(r.narratives||[]).join('\n')},
    deleteRegion(id){if(!confirm('¬øEliminar?'))return;Data.regions=Data.regions.filter(r=>r.id!==id);Data.save();this.renderRegions();this.updateSelects();toast('Eliminado','info')},
    saveRace(){const r={id:$('#race-id').value||genId('race'),name:$('#race-name').value,icon:$('#race-icon').value||'üë§',sprite:$('#race-sprite').value||'',bonus:{health:parseInt($('#race-hp').value)||0,armor:parseInt($('#race-armor').value)||0,speed:parseInt($('#race-speed').value)||10,precision:parseInt($('#race-precision').value)||0,damage:parseInt($('#race-damage').value)||0},desc:$('#race-desc').value||''};if(!r.name){toast('Falta nombre','error');return}const i=Data.races.findIndex(x=>x.id===r.id);if(i>=0)Data.races[i]=r;else Data.races.push(r);Data.save();this.renderRaces();this.clear('race');toast('Guardado','success')},
    editRace(id){const r=Data.find('races',id);if(!r)return;$('#race-id').value=r.id;$('#race-name').value=r.name;$('#race-icon').value=r.icon||'';$('#race-sprite').value=r.sprite||'';$('#race-hp').value=r.bonus?.health||'';$('#race-armor').value=r.bonus?.armor||'';$('#race-speed').value=r.bonus?.speed||'';$('#race-precision').value=r.bonus?.precision||'';$('#race-damage').value=r.bonus?.damage||'';$('#race-desc').value=r.desc||''},
    deleteRace(id){if(!confirm('¬øEliminar?'))return;Data.races=Data.races.filter(r=>r.id!==id);Data.save();this.renderRaces();toast('Eliminado','info')},
    saveWeapon(){const w={id:$('#weapon-id').value||genId('w'),name:$('#weapon-name').value,damage:$('#weapon-damage').value||'1d4',icon:$('#weapon-icon').value||'‚öîÔ∏è',sprite:$('#weapon-sprite').value||'',rarity:$('#weapon-rarity').value,value:parseInt($('#weapon-value').value)||10,effect:$('#weapon-effect').value||null,desc:$('#weapon-desc').value||''};if(!w.name){toast('Falta nombre','error');return}const i=Data.weapons.findIndex(x=>x.id===w.id);if(i>=0)Data.weapons[i]=w;else Data.weapons.push(w);Data.save();this.renderWeapons();this.updateSelects();this.clear('weapon');toast('Guardado','success')},
    saveArmor(){const a={id:$('#armor-id').value||genId('a'),name:$('#armor-name').value,defense:parseInt($('#armor-defense').value)||0,icon:$('#armor-icon').value||'üõ°Ô∏è',sprite:$('#armor-sprite').value||'',rarity:$('#armor-rarity').value,value:parseInt($('#armor-value').value)||10,desc:$('#armor-desc').value||''};if(!a.name){toast('Falta nombre','error');return}const i=Data.armors.findIndex(x=>x.id===a.id);if(i>=0)Data.armors[i]=a;else Data.armors.push(a);Data.save();this.renderArmors();this.updateSelects();this.clear('armor');toast('Guardado','success')},
    saveItem(){const it={id:$('#item-id').value||genId('i'),name:$('#item-name').value,type:$('#item-type').value,icon:$('#item-icon').value||'üì¶',sprite:$('#item-sprite').value||'',effect:$('#item-effect').value||'',value:parseInt($('#item-value').value)||10,rarity:$('#item-rarity').value,desc:$('#item-desc').value||''};if(!it.name){toast('Falta nombre','error');return}const i=Data.items.findIndex(x=>x.id===it.id);if(i>=0)Data.items[i]=it;else Data.items.push(it);Data.save();this.renderItems();this.updateSelects();this.clear('item');toast('Guardado','success')},
    saveEnemy(){const regions=Array.from($$('#enemy-regions input:checked')).map(c=>c.value);const drops=Array.from($$('#enemy-drops input:checked')).map(c=>c.value);if(regions.length===0){toast('Selecciona regi√≥n','error');return}const canGroup=$('#enemy-canGroup').value==='true';const e={id:$('#enemy-id').value||genId('e'),name:$('#enemy-name').value,health:parseInt($('#enemy-health').value)||20,damage:$('#enemy-damage').value||'1d6',difficulty:parseInt($('#enemy-difficulty').value)||10,armor:parseInt($('#enemy-armor').value)||0,speed:parseInt($('#enemy-speed').value)||10,icon:$('#enemy-icon').value||'üëπ',sprite:$('#enemy-sprite').value||'',effect:$('#enemy-effect').value||null,loot:[parseInt($('#enemy-loot-min').value)||5,parseInt($('#enemy-loot-max').value)||20],regions,drops,desc:$('#enemy-desc').value||'',canGroup,groupMin:parseInt($('#enemy-groupMin').value)||2,groupMax:parseInt($('#enemy-groupMax').value)||4,groupChance:parseInt($('#enemy-groupChance').value)||30};if(!e.name){toast('Falta nombre','error');return}const i=Data.enemies.findIndex(x=>x.id===e.id);if(i>=0)Data.enemies[i]=e;else Data.enemies.push(e);Data.save();this.renderEnemies();this.clear('enemy');toast('Guardado','success')},
    editEnemy(id){const e=Data.find('enemies',id);if(!e)return;$('#enemy-id').value=e.id;$('#enemy-name').value=e.name;$('#enemy-health').value=e.health||'';$('#enemy-damage').value=e.damage||'';$('#enemy-difficulty').value=e.difficulty||'';$('#enemy-armor').value=e.armor||'';$('#enemy-speed').value=e.speed||'';$('#enemy-icon').value=e.icon||'';$('#enemy-sprite').value=e.sprite||'';$('#enemy-effect').value=e.effect||'';$('#enemy-loot-min').value=e.loot?.[0]||'';$('#enemy-loot-max').value=e.loot?.[1]||'';$('#enemy-desc').value=e.desc||'';$('#enemy-canGroup').value=e.canGroup?'true':'false';$('#enemy-groupMin').value=e.groupMin||'';$('#enemy-groupMax').value=e.groupMax||'';$('#enemy-groupChance').value=e.groupChance||'';setTimeout(()=>{$$('#enemy-regions input').forEach(c=>c.checked=(e.regions||[]).includes(c.value));$$('#enemy-drops input').forEach(c=>c.checked=(e.drops||[]).includes(c.value))},50)},
    savePet(){const regions=Array.from($$('#pet-regions input:checked')).map(c=>c.value);const p={id:$('#pet-id').value||genId('p'),name:$('#pet-name').value,health:parseInt($('#pet-health').value)||20,damage:$('#pet-damage').value||'1d4',speed:parseInt($('#pet-speed').value)||12,difficulty:parseInt($('#pet-difficulty').value)||24,icon:$('#pet-icon').value||'üê∫',sprite:$('#pet-sprite').value||'',regions,desc:$('#pet-desc').value||''};if(!p.name){toast('Falta nombre','error');return}const i=Data.pets.findIndex(x=>x.id===p.id);if(i>=0)Data.pets[i]=p;else Data.pets.push(p);Data.save();this.renderPets();this.clear('pet');toast('Guardado','success')},
    editPet(id){const p=Data.find('pets',id);if(!p)return;$('#pet-id').value=p.id;$('#pet-name').value=p.name;$('#pet-health').value=p.health||'';$('#pet-damage').value=p.damage||'';$('#pet-speed').value=p.speed||'';$('#pet-difficulty').value=p.difficulty||'';$('#pet-icon').value=p.icon||'';$('#pet-sprite').value=p.sprite||'';$('#pet-desc').value=p.desc||'';setTimeout(()=>$$('#pet-regions input').forEach(c=>c.checked=(p.regions||[]).includes(c.value)),50)},
    saveNpc(){const sells=Array.from($$('#npc-sells input:checked')).map(c=>c.value);const n={id:$('#npc-id').value||genId('n'),name:$('#npc-name').value,role:$('#npc-role').value,icon:$('#npc-icon').value||'üßî',sprite:$('#npc-sprite').value||'',region:$('#npc-region').value,dialogue:$('#npc-dialogue').value||'',sells};if(!n.name){toast('Falta nombre','error');return}const i=Data.npcs.findIndex(x=>x.id===n.id);if(i>=0)Data.npcs[i]=n;else Data.npcs.push(n);Data.save();this.renderNpcs();this.clear('npc');toast('Guardado','success')},
    editNpc(id){const n=Data.find('npcs',id);if(!n)return;$('#npc-id').value=n.id;$('#npc-name').value=n.name;$('#npc-role').value=n.role||'merchant';$('#npc-icon').value=n.icon||'';$('#npc-sprite').value=n.sprite||'';$('#npc-region').value=n.region||'';$('#npc-dialogue').value=n.dialogue||'';setTimeout(()=>$$('#npc-sells input').forEach(c=>c.checked=(n.sells||[]).includes(c.value)),50)},
    edit(t,p,id){const it=Data.find(t,id);if(!it)return;Object.keys(it).forEach(k=>{const e=$(`#${p}-${k}`);if(e)e.value=it[k]||''})},
    del(t,id){if(!confirm('¬øEliminar?'))return;Data[t]=Data[t].filter(x=>x.id!==id);Data.save();this.renderAll();toast('Eliminado','info')},
    renderAll(){this.renderRegions();this.renderRaces();this.renderWeapons();this.renderArmors();this.renderItems();this.renderEnemies();this.renderPets();this.renderNpcs();this.updateSelects()},
    renderRegions(){$('#regions-list').innerHTML=Data.regions.map(r=>`<div class="item-card" onclick="Editor.editRegion('${r.id}')"><span class="item-card-icon">${r.icon}</span><div class="item-card-info"><div class="item-card-name">${r.name}</div><div class="item-card-stats">${r.type==='safe'?'üè†':'‚ö†Ô∏è'} Dist:${r.distance||0} Req:${r.reqEncounters||0}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editRegion('${r.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.deleteRegion('${r.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderRaces(){$('#races-list').innerHTML=Data.races.map(r=>`<div class="item-card" onclick="Editor.editRace('${r.id}')"><span class="item-card-icon">${sprite(r)}</span><div class="item-card-info"><div class="item-card-name">${r.name}</div><div class="item-card-stats">‚ö°${r.bonus?.speed||10}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editRace('${r.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.deleteRace('${r.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderWeapons(){$('#weapons-list').innerHTML=Data.weapons.map(w=>`<div class="item-card" onclick="Editor.edit('weapons','weapon','${w.id}')"><span class="item-card-icon">${sprite(w)}</span><div class="item-card-info"><div class="item-card-name">${w.name}</div><div class="item-card-stats">${w.damage}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.edit('weapons','weapon','${w.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('weapons','${w.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderArmors(){$('#armors-list').innerHTML=Data.armors.map(a=>`<div class="item-card" onclick="Editor.edit('armors','armor','${a.id}')"><span class="item-card-icon">${sprite(a)}</span><div class="item-card-info"><div class="item-card-name">${a.name}</div><div class="item-card-stats">Def:${a.defense}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.edit('armors','armor','${a.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('armors','${a.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderItems(){$('#items-list').innerHTML=Data.items.map(i=>`<div class="item-card" onclick="Editor.edit('items','item','${i.id}')"><span class="item-card-icon">${sprite(i)}</span><div class="item-card-info"><div class="item-card-name">${i.name}</div><div class="item-card-stats">${i.type}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.edit('items','item','${i.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('items','${i.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderEnemies(){$('#enemies-list').innerHTML=Data.enemies.map(e=>`<div class="item-card" onclick="Editor.editEnemy('${e.id}')"><span class="item-card-icon">${sprite(e)}</span><div class="item-card-info"><div class="item-card-name">${e.name}</div><div class="item-card-stats">HP:${e.health} ‚ö°${e.speed||10} ${e.canGroup?'üë•':'üë§'}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editEnemy('${e.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('enemies','${e.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderPets(){$('#pets-list').innerHTML=Data.pets.map(p=>`<div class="item-card" onclick="Editor.editPet('${p.id}')"><span class="item-card-icon">${sprite(p)}</span><div class="item-card-info"><div class="item-card-name">${p.name}</div><div class="item-card-stats">‚ö°${p.speed||12}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editPet('${p.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('pets','${p.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderNpcs(){const roles={merchant:'Comerciante',blacksmith:'Herrero',alchemist:'Alquimista',innkeeper:'Tabernero',healer:'Curandero',guard:'Guardia',villager:'Aldeano'};$('#npcs-list').innerHTML=Data.npcs.map(n=>`<div class="item-card" onclick="Editor.editNpc('${n.id}')"><span class="item-card-icon">${sprite(n)}</span><div class="item-card-info"><div class="item-card-name">${n.name}</div><div class="item-card-stats">${roles[n.role]||n.role}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editNpc('${n.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('npcs','${n.id}')">üóëÔ∏è</button></div></div>`).join('')},
    updateSelects(){const dangerRegions=Data.regions.filter(r=>r.type==='danger');const regHtml=dangerRegions.map(r=>`<label><input type="checkbox" value="${r.id}"> ${r.icon} ${r.name}</label>`).join('');$('#enemy-regions').innerHTML=regHtml;$('#pet-regions').innerHTML=regHtml;const safeRegions=Data.regions.filter(r=>r.type==='safe');$('#npc-region').innerHTML=safeRegions.map(r=>`<option value="${r.id}">${r.icon} ${r.name}</option>`).join('');const allItems=[...Data.weapons,...Data.armors,...Data.items];const itemsHtml=allItems.map(it=>`<label><input type="checkbox" value="${it.id}"> ${it.icon||'üì¶'} ${it.name}</label>`).join('');$('#enemy-drops').innerHTML=itemsHtml;$('#npc-sells').innerHTML=itemsHtml}
};

document.addEventListener('DOMContentLoaded',()=>{
    domReady=true;
    Data.load();Editor.renderAll();FB.init();
    $$('.nav-btn').forEach(b=>b.addEventListener('click',()=>{$$('.nav-btn').forEach(x=>x.classList.remove('active'));$$('.tab-content').forEach(x=>x.classList.remove('active'));b.classList.add('active');$(`#tab-${b.dataset.tab}`).classList.add('active')}));
    $$('.editor-tab').forEach(t=>t.addEventListener('click',()=>{$$('.editor-tab').forEach(x=>x.classList.remove('active'));$$('.editor-section').forEach(x=>x.classList.remove('active'));t.classList.add('active');$(`#editor-${t.dataset.editor}`).classList.add('active');Editor.updateSelects()}));
    $$('.modal-close').forEach(b=>b.addEventListener('click',()=>closeModal(b.dataset.close)));
    $$('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')}));
    $('#weaponSlot').addEventListener('click',()=>{if(!G.p||!G.region)return;if(G.combat||G.region.type!=='safe'){toast('Solo zona segura','error');return}if(G.p.weapon?.uid)Inv.detail(G.p.weapon,'eq-weapon')});
    $('#armorSlot').addEventListener('click',()=>{if(!G.p||!G.region)return;if(G.combat||G.region.type!=='safe'){toast('Solo zona segura','error');return}if(G.p.armor?.uid)Inv.detail(G.p.armor,'eq-armor')});
});
</script>
</body>
</html>
