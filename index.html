<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventuras de Acero y Runas v6</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root{--bg-dark:#0a0908;--bg-panel:#1a1614;--bg-light:#2a2320;--bg-input:#151210;--gold:#d4a437;--gold-dim:#a67c00;--gold-bright:#ffd700;--red:#8b0000;--red-bright:#dc143c;--green:#2d5a27;--green-bright:#4caf50;--blue:#1e3a5f;--blue-bright:#4a9eff;--purple:#9c27b0;--orange:#ff6b35;--cyan:#00bcd4;--text:#e8dcc4;--text-dim:#8a8078;--border:#3d3530}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Crimson Text',Georgia,serif;background:var(--bg-dark);color:var(--text);min-height:100vh}
        ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:var(--gold-dim);border-radius:3px}
        .hidden{display:none!important}
        
        .main-nav{display:flex;justify-content:center;background:var(--bg-panel);border-bottom:2px solid var(--gold-dim);position:sticky;top:0;z-index:100;padding:.3rem;gap:.3rem;flex-wrap:wrap}
        .nav-btn{font-family:'Cinzel',serif;font-size:.75rem;padding:.4rem 1rem;background:transparent;border:1px solid transparent;color:var(--text-dim);cursor:pointer;border-radius:3px;transition:all .2s}
        .nav-btn:hover{color:var(--gold);border-color:var(--gold-dim)}
        .nav-btn.active{color:var(--gold-bright);background:rgba(212,164,55,.15);border-color:var(--gold-dim)}
        
        .status-bar{position:fixed;top:0;right:0;display:flex;align-items:center;gap:.5rem;padding:.3rem .6rem;background:var(--bg-panel);border-bottom-left-radius:6px;font-size:.65rem;z-index:200}
        .status-dot{width:8px;height:8px;border-radius:50%;background:var(--red)}.status-dot.connected{background:var(--green-bright)}
        
        .tab-content{display:none;min-height:calc(100vh - 50px)}.tab-content.active{display:flex;flex-direction:column}
        
        .game-wrapper{display:flex;flex-direction:column;height:calc(100vh - 50px);max-width:1400px;margin:0 auto;padding:.5rem;gap:.5rem}
        .game-top{display:grid;grid-template-columns:280px 1fr;gap:.5rem;flex-shrink:0}
        .game-bottom{flex:1;min-height:200px;overflow:hidden}
        
        .panel{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;overflow:hidden}
        .panel-header{background:var(--bg-light);padding:.4rem .6rem;border-bottom:1px solid var(--border);font-family:'Cinzel',serif;font-size:.7rem;color:var(--gold);text-transform:uppercase;letter-spacing:.05em;display:flex;justify-content:space-between;align-items:center}
        .panel-body{padding:.5rem}
        
        .char-panel{display:flex;flex-direction:column}
        .char-header{display:flex;align-items:center;gap:.5rem;padding:.5rem;background:var(--bg-dark);border-bottom:1px solid var(--border)}
        .char-avatar{width:50px;height:50px;display:flex;align-items:center;justify-content:center;background:var(--bg-light);border:2px solid var(--gold-dim);border-radius:6px;font-size:1.8rem}
        .char-avatar img{width:100%;height:100%;object-fit:contain}
        .char-name{font-family:'Cinzel',serif;font-size:1rem;color:var(--gold-bright)}
        .char-race{font-size:.65rem;color:var(--text-dim)}
        .char-body{padding:.5rem;display:flex;flex-direction:column;gap:.4rem}
        
        .hp-container{background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;height:22px;position:relative;overflow:hidden}
        .hp-fill{height:100%;transition:width .3s ease;background:linear-gradient(180deg,var(--green-bright),var(--green))}
        .hp-fill.medium{background:linear-gradient(180deg,var(--gold-bright),var(--gold-dim))}
        .hp-fill.low{background:linear-gradient(180deg,var(--orange),#cc4400)}
        .hp-fill.critical{background:linear-gradient(180deg,var(--red-bright),var(--red));animation:pulse 1s infinite}
        @keyframes pulse{50%{opacity:.7}}
        .hp-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:bold;color:white;text-shadow:1px 1px 2px black}
        
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:.25rem}
        .stat-item{display:flex;justify-content:space-between;padding:.2rem .35rem;background:var(--bg-light);border-radius:3px;font-size:.65rem}
        .stat-label{color:var(--text-dim)}.stat-value{color:var(--gold);font-weight:bold}
        
        .equip-slot{display:flex;align-items:center;gap:.4rem;padding:.3rem;background:var(--bg-light);border:1px solid transparent;border-radius:4px;cursor:pointer;transition:all .2s}
        .equip-slot:hover:not(.disabled){border-color:var(--gold-dim);background:var(--bg-dark)}
        .equip-slot.disabled{opacity:.5;cursor:not-allowed}
        .equip-icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}
        .equip-icon img{width:100%;height:100%;object-fit:contain}
        .equip-name{font-size:.75rem}.equip-stats{font-size:.6rem;color:var(--text-dim)}
        
        .currency-row{display:flex;justify-content:center;gap:1rem;padding:.3rem;background:var(--bg-dark);border-radius:4px;font-size:.8rem}
        .coin-gold{color:var(--gold-bright)}.coin-silver{color:#c0c0c0}
        
        .region-badge{text-align:center;padding:.35rem;border-radius:4px;font-size:.7rem;border:1px solid var(--border);cursor:pointer;transition:all .2s}
        .region-badge:hover{border-color:var(--gold-dim)}
        .region-badge.safe{background:rgba(45,90,39,.3);border-color:var(--green);color:var(--green-bright)}
        .region-badge.danger{background:rgba(139,0,0,.3);border-color:var(--red);color:var(--red-bright)}
        
        .main-area{display:flex;flex-direction:column;gap:.5rem;min-height:300px}
        .actions-panel .panel-body{display:flex;flex-wrap:wrap;gap:.4rem;justify-content:center}
        
        /* Combat Arena - Multi-enemy support */
        .combat-arena{background:linear-gradient(180deg,rgba(139,0,0,.15),transparent);border:2px solid var(--red)}
        .combat-arena .panel-header{background:linear-gradient(180deg,rgba(139,0,0,.3),var(--bg-panel));color:var(--red-bright)}
        .combat-container{padding:.5rem}
        .combat-entities{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-bottom:.5rem}
        .combatant{background:var(--bg-dark);border:2px solid var(--border);border-radius:6px;padding:.4rem;text-align:center;min-width:120px;max-width:150px;flex:1}
        .combatant.player{border-color:var(--gold-dim);order:-1}
        .combatant.pet{border-color:var(--green);order:0}
        .combatant.enemy{border-color:var(--red)}
        .combatant.dead{opacity:.4;filter:grayscale(1)}
        .combatant.active{box-shadow:0 0 10px var(--gold-bright)}
        .combatant-sprite{font-size:2rem;margin-bottom:.2rem}
        .combatant-sprite img{width:48px;height:48px;object-fit:contain}
        .combatant-name{font-family:'Cinzel',serif;font-size:.75rem;margin-bottom:.15rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .combatant-stats{font-size:.55rem;color:var(--text-dim);margin-bottom:.25rem}
        .combatant-speed{font-size:.5rem;color:var(--cyan)}
        .combatant .hp-container{height:16px}
        .combatant .hp-text{font-size:.6rem}
        .effects-row{display:flex;flex-wrap:wrap;justify-content:center;gap:.15rem;margin-top:.2rem;min-height:14px}
        .effect-tag{font-size:.5rem;padding:.08rem .2rem;border-radius:3px}
        .eff-bleed{background:rgba(139,0,0,.6);border:1px solid var(--red)}
        .eff-poison{background:rgba(0,100,0,.6);border:1px solid var(--green-bright)}
        .eff-fire{background:rgba(255,100,0,.5);border:1px solid orange}
        
        .combat-actions{display:flex;flex-wrap:wrap;justify-content:center;gap:.4rem;padding:.5rem;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
        .target-select{background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:.3rem;border-radius:4px;font-size:.7rem}
        
        /* Combat Log - Enhanced */
        .combat-log{max-height:200px;overflow-y:auto;padding:.5rem;background:var(--bg-dark);font-size:.75rem}
        .log-entry{padding:.15rem 0;border-bottom:1px dashed rgba(255,255,255,.08)}
        .log-entry:last-child{border-bottom:none}
        .log-turn-header{background:linear-gradient(90deg,transparent,var(--gold-dim),transparent);color:var(--bg-dark);padding:.3rem;margin:.4rem -.5rem;text-align:center;font-family:'Cinzel',serif;font-size:.7rem;font-weight:bold}
        .log-initiative{background:var(--bg-panel);padding:.2rem .4rem;margin:.2rem 0;border-radius:3px;font-size:.65rem;color:var(--cyan)}
        .log-action{margin:.2rem 0;padding:.2rem .4rem;border-left:2px solid var(--border);background:rgba(0,0,0,.2)}
        .log-action.player-action{border-color:var(--gold)}
        .log-action.enemy-action{border-color:var(--red)}
        .log-action.pet-action{border-color:var(--green)}
        .log-calc{background:var(--bg-panel);padding:.25rem .5rem;border-radius:3px;margin:.15rem 0;font-family:monospace;font-size:.68rem;border-left:3px solid var(--orange)}
        .log-result{font-weight:bold;padding:.1rem .3rem;border-radius:3px;display:inline-block;margin:.1rem 0}
        .log-hit{background:rgba(255,107,53,.3);color:var(--orange)}
        .log-miss{background:rgba(128,128,128,.3);color:var(--text-dim)}
        .log-crit{background:rgba(255,215,0,.3);color:var(--gold-bright)}
        .log-block{background:rgba(74,158,255,.3);color:var(--blue-bright)}
        .log-damage{color:var(--red-bright)}
        .log-heal{color:var(--green-bright)}
        .log-effect{color:var(--orange)}
        .log-death{color:var(--red-bright);font-weight:bold;text-align:center;padding:.3rem;background:rgba(139,0,0,.2);border-radius:3px;margin:.2rem 0}
        
        .chronicles-panel{display:flex;flex-direction:column;height:100%}
        .chronicles-content{flex:1;overflow-y:auto;padding:.5rem;display:flex;flex-direction:column;gap:.4rem}
        .story-entry{padding:.5rem;border-radius:4px;animation:fadeIn .3s;font-size:.85rem;line-height:1.6}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1}}
        .story-narrative{background:linear-gradient(135deg,rgba(30,25,22,.95),rgba(45,38,33,.8));border-left:3px solid var(--gold-dim);font-style:italic}
        .story-combat{background:rgba(139,0,0,.15);border-left:3px solid var(--red)}
        .story-loot{background:rgba(212,164,55,.15);border-left:3px solid var(--gold)}
        .story-system{background:rgba(74,158,255,.1);border-left:3px solid var(--blue-bright);font-size:.8rem}
        .story-trap{background:rgba(255,107,53,.15);border-left:3px solid var(--orange)}
        .story-dialogue{background:rgba(156,39,176,.1);border-left:3px solid var(--purple)}
        .story-region{background:rgba(0,188,212,.1);border-left:3px solid var(--cyan)}
        
        .btn{font-family:'Cinzel',serif;font-size:.7rem;padding:.4rem .8rem;background:var(--bg-light);border:1px solid var(--gold-dim);color:var(--gold);cursor:pointer;border-radius:4px;transition:all .2s;white-space:nowrap}
        .btn:hover:not(:disabled){background:var(--gold-dim);color:var(--bg-dark);transform:translateY(-1px)}
        .btn:disabled{opacity:.5;cursor:not-allowed}
        .btn-primary{background:var(--gold-dim);color:var(--bg-dark)}
        .btn-danger{border-color:var(--red);color:var(--red-bright)}.btn-danger:hover:not(:disabled){background:var(--red);color:white}
        .btn-sm{font-size:.6rem;padding:.25rem .5rem}
        
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:500;justify-content:center;align-items:center;padding:1rem;overflow-y:auto}
        .modal-overlay.active{display:flex}
        .modal{background:var(--bg-panel);border:2px solid var(--gold-dim);border-radius:8px;width:100%;max-width:550px;max-height:90vh;overflow-y:auto;animation:modalIn .2s}
        @keyframes modalIn{from{opacity:0;transform:scale(.95)}}
        .modal-lg{max-width:850px}
        .modal-header{display:flex;justify-content:space-between;align-items:center;padding:.6rem .8rem;background:var(--bg-light);border-bottom:1px solid var(--border)}
        .modal-title{font-family:'Cinzel',serif;font-size:.9rem;color:var(--gold)}
        .modal-close{background:none;border:none;color:var(--text-dim);font-size:1.3rem;cursor:pointer}.modal-close:hover{color:var(--gold)}
        .modal-body{padding:.8rem}
        
        .item-detail{text-align:center}
        .item-detail-icon{font-size:3.5rem;margin-bottom:.5rem}
        .item-detail-icon img{width:72px;height:72px;object-fit:contain}
        .item-detail-name{font-family:'Cinzel',serif;font-size:1.1rem;color:var(--gold-bright)}
        .item-detail-type{color:var(--text-dim);font-size:.75rem;margin-bottom:.5rem}
        .item-detail-desc{background:var(--bg-dark);padding:.6rem;border-radius:4px;text-align:left;margin-bottom:.6rem;font-size:.8rem}
        .item-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:.4rem;margin-bottom:.6rem}
        .item-stat-box{background:var(--bg-light);padding:.4rem;border-radius:4px}
        .item-stat-label{font-size:.55rem;color:var(--text-dim);text-transform:uppercase}
        .item-stat-value{font-size:.95rem;color:var(--gold);font-family:'Cinzel',serif}
        .item-actions{display:flex;flex-wrap:wrap;justify-content:center;gap:.4rem}
        
        .inventory-info{text-align:center;padding:.4rem;color:var(--text-dim);font-size:.75rem;border-bottom:1px solid var(--border)}
        .inventory-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:.35rem;padding:.6rem}
        .inv-slot{aspect-ratio:1;background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;padding:.15rem}
        .inv-slot:hover{border-color:var(--gold-dim);transform:scale(1.05)}
        .inv-slot.empty{cursor:default}.inv-slot.empty:hover{transform:none;border-color:var(--border)}
        .inv-slot-icon{font-size:1.4rem}.inv-slot-icon img{width:32px;height:32px;object-fit:contain}
        .inv-slot-name{font-size:.5rem;text-align:center;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%}
        .rarity-common{border-color:#555}.rarity-rare{border-color:var(--blue-bright)}.rarity-epic{border-color:var(--purple)}.rarity-legendary{border-color:var(--gold-bright);box-shadow:0 0 8px rgba(255,215,0,.4)}
        
        .regions-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:.5rem}
        .region-card{background:var(--bg-dark);border:2px solid var(--border);border-radius:6px;padding:.6rem;cursor:pointer;transition:all .2s;text-align:center}
        .region-card:hover{border-color:var(--gold-dim);transform:translateY(-2px)}
        .region-card.safe{border-color:var(--green)}.region-card.danger{border-color:var(--red)}
        .region-card.current{border-color:var(--gold-bright);box-shadow:0 0 10px rgba(255,215,0,.3)}
        .region-card-icon{font-size:1.8rem;margin-bottom:.2rem}
        .region-card-name{font-family:'Cinzel',serif;font-size:.8rem;color:var(--gold)}
        .region-card-type{font-size:.6rem;color:var(--text-dim)}
        
        .editor-container{max-width:1100px;margin:0 auto;padding:.8rem}
        .editor-tabs{display:flex;flex-wrap:wrap;gap:.25rem;background:var(--bg-panel);padding:.4rem;border-radius:6px;margin-bottom:.6rem}
        .editor-tab{padding:.4rem .8rem;background:transparent;border:1px solid var(--border);color:var(--text-dim);cursor:pointer;font-family:'Cinzel',serif;font-size:.65rem;border-radius:4px;transition:all .2s}
        .editor-tab:hover{border-color:var(--gold-dim);color:var(--gold)}
        .editor-tab.active{background:var(--gold-dim);color:var(--bg-dark);border-color:var(--gold)}
        .editor-section{display:none;background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:.8rem}
        .editor-section.active{display:block}
        .editor-section h3{font-family:'Cinzel',serif;color:var(--gold);font-size:.95rem;margin-bottom:.6rem;padding-bottom:.4rem;border-bottom:1px solid var(--border)}
        .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.5rem;margin-bottom:.6rem}
        .form-group{display:flex;flex-direction:column;gap:.2rem}
        .form-group label{font-size:.6rem;color:var(--text-dim);text-transform:uppercase}
        .form-group input,.form-group select,.form-group textarea{background:var(--bg-input);border:1px solid var(--border);padding:.4rem;color:var(--text);font-size:.75rem;border-radius:4px;font-family:inherit}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:var(--gold-dim)}
        .form-group textarea{resize:vertical;min-height:50px}
        .form-actions{display:flex;gap:.4rem;justify-content:flex-end;padding-top:.6rem;border-top:1px solid var(--border);margin-top:.6rem}
        .form-row{display:flex;gap:.5rem;align-items:end}
        .form-row .form-group{flex:1}
        .multi-select{background:var(--bg-input);border:1px solid var(--border);border-radius:4px;padding:.4rem;max-height:100px;overflow-y:auto;font-size:.7rem}
        .multi-select label{display:flex;align-items:center;gap:.3rem;padding:.15rem;cursor:pointer}
        .multi-select label:hover{background:var(--bg-light)}
        .items-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.4rem;margin-top:.8rem;max-height:260px;overflow-y:auto;padding:.2rem}
        .item-card{background:var(--bg-dark);border:1px solid var(--border);border-radius:4px;padding:.4rem;display:flex;align-items:center;gap:.4rem;cursor:pointer;transition:all .2s}
        .item-card:hover{border-color:var(--gold-dim)}
        .item-card-icon{font-size:1.2rem;width:28px;text-align:center}.item-card-icon img{width:28px;height:28px;object-fit:contain}
        .item-card-info{flex:1;min-width:0}
        .item-card-name{font-size:.72rem;color:var(--gold);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .item-card-stats{font-size:.58rem;color:var(--text-dim)}
        .item-card-actions{display:flex;gap:.2rem}
        .icon-btn{background:none;border:1px solid var(--border);color:var(--text-dim);padding:.15rem .25rem;cursor:pointer;font-size:.55rem;border-radius:3px;transition:all .2s}
        .icon-btn:hover{border-color:var(--gold-dim);color:var(--gold)}
        .icon-btn.delete:hover{border-color:var(--red);color:var(--red-bright)}
        
        .rules-container{max-width:1000px;margin:0 auto;padding:.8rem}
        .rules-header{text-align:center;margin-bottom:.8rem}
        .rules-header h2{font-family:'Cinzel',serif;color:var(--gold);font-size:1.3rem}
        .rules-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:.6rem}
        .rules-card{background:var(--bg-panel);border:1px solid var(--border);border-radius:6px;padding:.6rem}
        .rules-card h4{font-family:'Cinzel',serif;color:var(--gold);font-size:.82rem;margin-bottom:.4rem;padding-bottom:.3rem;border-bottom:1px solid var(--border)}
        .rules-card p,.rules-card li{font-size:.73rem;margin-bottom:.2rem}
        .rules-card ul{padding-left:1rem}
        .rules-table{width:100%;border-collapse:collapse;font-size:.68rem;margin:.4rem 0}
        .rules-table th,.rules-table td{border:1px solid var(--border);padding:.25rem .4rem;text-align:left}
        .rules-table th{background:var(--bg-light);color:var(--gold)}
        .rules-highlight{background:var(--bg-dark);border-left:3px solid var(--gold);padding:.4rem;margin:.4rem 0;font-size:.73rem}
        
        .toast-container{position:fixed;top:2.5rem;right:.8rem;z-index:1000;display:flex;flex-direction:column;gap:.4rem}
        .toast{padding:.4rem .8rem;border-radius:4px;font-size:.75rem;animation:toastIn .3s,toastOut .3s 2.5s forwards;color:white}
        @keyframes toastIn{from{transform:translateX(100%);opacity:0}}@keyframes toastOut{to{transform:translateX(100%);opacity:0}}
        .toast.success{background:var(--green)}.toast.error{background:var(--red)}.toast.info{background:var(--blue)}
        
        .dice-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:600;justify-content:center;align-items:center}
        .dice-overlay.active{display:flex}
        .dice-display{background:var(--bg-panel);border:2px solid var(--gold-dim);border-radius:12px;padding:1.2rem 1.8rem;text-align:center}
        .dice-icon{font-size:2.5rem;animation:diceRoll .4s}
        @keyframes diceRoll{0%{transform:rotate(0) scale(.5)}50%{transform:rotate(180deg) scale(1.2)}100%{transform:rotate(360deg) scale(1)}}
        .dice-label{font-size:.75rem;color:var(--text-dim)}
        .dice-result{font-family:'Cinzel',serif;font-size:1.8rem;color:var(--gold-bright)}
        .dice-result.crit{color:var(--red-bright);text-shadow:0 0 10px var(--red)}
        
        @media(max-width:850px){.game-top{grid-template-columns:1fr}.char-panel{order:2}.main-area{order:1}.inventory-grid{grid-template-columns:repeat(4,1fr)}.rules-grid{grid-template-columns:1fr}.regions-grid{grid-template-columns:1fr 1fr}}
    </style>
</head>
<body>
    <div class="status-bar"><div class="status-dot" id="fbStatus"></div><span id="fbStatusText">...</span></div>
    <nav class="main-nav">
        <button class="nav-btn active" data-tab="game">‚öîÔ∏è Juego</button>
        <button class="nav-btn" data-tab="rules">üìú Reglas</button>
        <button class="nav-btn" data-tab="editor">üõ†Ô∏è Editor</button>
    </nav>

    <div class="tab-content active" id="tab-game">
        <div class="game-wrapper">
            <div class="game-top">
                <div class="panel char-panel">
                    <div class="char-header">
                        <div class="char-avatar" id="charAvatar">üßô</div>
                        <div><div class="char-name" id="charName">---</div><div class="char-race" id="charRace">---</div></div>
                    </div>
                    <div class="char-body">
                        <div class="hp-container"><div class="hp-fill" id="hpFill"></div><div class="hp-text" id="hpText">0/0</div></div>
                        <div class="region-badge safe" id="regionBadge" onclick="Regions.openSelector()">
                            <span>üèòÔ∏è Pueblo</span>
                            <div style="font-size:.55rem;color:var(--text-dim)">Click para viajar</div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item"><span class="stat-label">Armadura</span><span class="stat-value" id="statArmor">0</span></div>
                            <div class="stat-item"><span class="stat-label">Evasi√≥n</span><span class="stat-value" id="statEvasion">0</span></div>
                            <div class="stat-item"><span class="stat-label">Precisi√≥n</span><span class="stat-value" id="statPrecision">0</span></div>
                            <div class="stat-item"><span class="stat-label">Velocidad</span><span class="stat-value" id="statSpeed">0</span></div>
                        </div>
                        <div class="equip-slot" id="weaponSlot"><div class="equip-icon" id="weaponIcon">‚öîÔ∏è</div><div><div class="equip-name" id="weaponName">---</div><div class="equip-stats" id="weaponStats">---</div></div></div>
                        <div class="equip-slot" id="armorSlot"><div class="equip-icon" id="armorIcon">üõ°Ô∏è</div><div><div class="equip-name" id="armorName">---</div><div class="equip-stats" id="armorStats">---</div></div></div>
                        <div class="currency-row"><span><span class="coin-gold">‚óè</span> <span id="goldAmount">0</span> MO</span><span><span class="coin-silver">‚óè</span> <span id="silverAmount">0</span> MP</span></div>
                    </div>
                </div>
                <div class="main-area">
                    <div class="panel combat-arena hidden" id="combatArena">
                        <div class="panel-header"><span>‚öîÔ∏è COMBATE</span><span>Turno <span id="turnCounter">1</span></span></div>
                        <div class="combat-container">
                            <div class="combat-entities" id="combatEntities"></div>
                            <div class="combat-actions" id="combatActions"></div>
                            <div class="combat-log" id="combatLog"></div>
                        </div>
                    </div>
                    <div class="panel actions-panel"><div class="panel-header">üéÆ Acciones</div><div class="panel-body" id="actionsContainer"></div></div>
                </div>
            </div>
            <div class="game-bottom">
                <div class="panel chronicles-panel"><div class="panel-header">üìñ Cr√≥nicas</div><div class="chronicles-content" id="chroniclesContent"></div></div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="tab-rules">
        <div class="rules-container">
            <div class="rules-header"><h2>üìú Sistema de Combate</h2></div>
            <div class="rules-grid">
                <div class="rules-card"><h4>‚ö° Velocidad e Iniciativa</h4>
                    <p>Cada entidad tiene un atributo de <strong>Velocidad</strong>.</p>
                    <p>Al inicio de cada turno, se ordena por velocidad (mayor primero).</p>
                    <p>En caso de empate, se realiza tirada de iniciativa D20.</p>
                    <div class="rules-highlight">Velocidad alta = actuar primero</div>
                </div>
                <div class="rules-card"><h4>üéØ Tirada de Ataque</h4>
                    <div class="rules-highlight">D20 + Precisi√≥n ‚â• Dificultad del objetivo</div>
                    <p><strong>Cr√≠tico (20):</strong> Da√±o √ó2</p>
                    <p><strong>Pifia (1):</strong> Fallo autom√°tico</p>
                </div>
                <div class="rules-card"><h4>‚öîÔ∏è C√°lculo de Da√±o</h4>
                    <div class="rules-highlight">
                        <strong>1.</strong> Tirar dado de da√±o del arma (ej: 1d8 ‚Üí 5)<br>
                        <strong>2.</strong> Sumar bono de da√±o (ej: +1 ‚Üí 6)<br>
                        <strong>3.</strong> Si cr√≠tico: √ó2 (ej: 6√ó2 = 12)<br>
                        <strong>4.</strong> Restar armadura enemiga (ej: 12‚àí3 = 9)<br>
                        <strong>5.</strong> Si resultado ‚â§ 0: Da√±o = 0 (bloqueado)
                    </div>
                </div>
                <div class="rules-card"><h4>üõ°Ô∏è Defensa</h4>
                    <p><strong>Esquivar:</strong> D20 + Evasi√≥n ‚â• 12</p>
                    <p><strong>Defender:</strong> +4 Evasi√≥n temporal</p>
                    <p><strong>Armadura:</strong> Reduce da√±o recibido</p>
                    <p>Si da√±o ‚â§ armadura ‚Üí 0 da√±o (bloqueado)</p>
                </div>
                <div class="rules-card"><h4>üë• Encuentros Grupales</h4>
                    <p>Algunos enemigos pueden aparecer en grupo.</p>
                    <p>Configurable: probabilidad, m√≠nimo y m√°ximo.</p>
                    <p>Cada enemigo act√∫a seg√∫n su velocidad.</p>
                    <div class="rules-highlight">Ejemplo: 2-5 lobos (30% probabilidad)</div>
                </div>
                <div class="rules-card"><h4>üîÑ Estructura del Turno</h4>
                    <p><strong>1.</strong> Calcular orden de iniciativa</p>
                    <p><strong>2.</strong> Cada entidad act√∫a en orden</p>
                    <p><strong>3.</strong> Procesar efectos de estado</p>
                    <p><strong>4.</strong> Avanzar al siguiente turno</p>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content" id="tab-editor">
        <div class="editor-container">
            <div class="editor-tabs">
                <button class="editor-tab active" data-editor="regions">üó∫Ô∏è Regiones</button>
                <button class="editor-tab" data-editor="races">üë§ Razas</button>
                <button class="editor-tab" data-editor="weapons">‚öîÔ∏è Armas</button>
                <button class="editor-tab" data-editor="armors">üõ°Ô∏è Armaduras</button>
                <button class="editor-tab" data-editor="items">üéí Items</button>
                <button class="editor-tab" data-editor="enemies">üëπ Enemigos</button>
                <button class="editor-tab" data-editor="pets">üê∫ Mascotas</button>
                <button class="editor-tab" data-editor="npcs">üßî NPCs</button>
            </div>
            
            <!-- REGIONS -->
            <div class="editor-section active" id="editor-regions">
                <h3>üó∫Ô∏è Editor de Regiones</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="region-id" placeholder="bosque_oscuro"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="region-name" placeholder="Bosque Oscuro"></div>
                    <div class="form-group"><label>Icono</label><input type="text" id="region-icon" placeholder="üå≤" maxlength="2"></div>
                    <div class="form-group"><label>Tipo</label><select id="region-type"><option value="safe">Segura</option><option value="danger">Peligrosa</option></select></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><input type="text" id="region-desc"></div>
                <div class="form-group"><label>Narrativas (una por l√≠nea)</label><textarea id="region-narratives" rows="3"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('region')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveRegion()">üíæ</button></div>
                <div class="items-list" id="regions-list"></div>
            </div>

            <!-- RACES -->
            <div class="editor-section" id="editor-races">
                <h3>üë§ Editor de Razas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="race-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="race-name"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="race-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="race-sprite"></div>
                    <div class="form-group"><label>+HP</label><input type="number" id="race-hp"></div>
                    <div class="form-group"><label>+Armadura</label><input type="number" id="race-armor"></div>
                    <div class="form-group"><label>+Evasi√≥n</label><input type="number" id="race-evasion"></div>
                    <div class="form-group"><label>+Precisi√≥n</label><input type="number" id="race-precision"></div>
                    <div class="form-group"><label>+Da√±o</label><input type="number" id="race-damage"></div>
                    <div class="form-group"><label>+Velocidad</label><input type="number" id="race-speed"></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="race-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('race')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveRace()">üíæ</button></div>
                <div class="items-list" id="races-list"></div>
            </div>

            <!-- WEAPONS -->
            <div class="editor-section" id="editor-weapons">
                <h3>‚öîÔ∏è Editor de Armas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="weapon-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="weapon-name"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="weapon-damage" placeholder="1d8"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="weapon-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="weapon-sprite"></div>
                    <div class="form-group"><label>Rareza</label><select id="weapon-rarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="weapon-value"></div>
                    <div class="form-group"><label>Efecto</label><select id="weapon-effect"><option value="">Ninguno</option><option value="bleed">Sangrado</option><option value="poison">Veneno</option><option value="fire">Fuego</option></select></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="weapon-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('weapon')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveWeapon()">üíæ</button></div>
                <div class="items-list" id="weapons-list"></div>
            </div>

            <!-- ARMORS -->
            <div class="editor-section" id="editor-armors">
                <h3>üõ°Ô∏è Editor de Armaduras</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="armor-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="armor-name"></div>
                    <div class="form-group"><label>Defensa</label><input type="number" id="armor-defense"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="armor-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="armor-sprite"></div>
                    <div class="form-group"><label>Rareza</label><select id="armor-rarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="armor-value"></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="armor-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('armor')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveArmor()">üíæ</button></div>
                <div class="items-list" id="armors-list"></div>
            </div>

            <!-- ITEMS -->
            <div class="editor-section" id="editor-items">
                <h3>üéí Editor de Items</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="item-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="item-name"></div>
                    <div class="form-group"><label>Tipo</label><select id="item-type"><option value="potion">Poci√≥n</option><option value="food">Comida</option><option value="antidote">Ant√≠doto</option><option value="escape">Escape</option><option value="backpack">Mochila</option><option value="misc">Otro</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="item-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="item-sprite"></div>
                    <div class="form-group"><label>Efecto</label><input type="text" id="item-effect" placeholder="1d8"></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="item-value"></div>
                    <div class="form-group"><label>Rareza</label><select id="item-rarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="item-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('item')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveItem()">üíæ</button></div>
                <div class="items-list" id="items-list"></div>
            </div>

            <!-- ENEMIES - Enhanced with group settings -->
            <div class="editor-section" id="editor-enemies">
                <h3>üëπ Editor de Enemigos</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="enemy-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="enemy-name"></div>
                    <div class="form-group"><label>Salud</label><input type="number" id="enemy-health"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="enemy-damage" placeholder="1d6"></div>
                    <div class="form-group"><label>Dificultad (1-20)</label><input type="number" id="enemy-difficulty" min="1" max="20"></div>
                    <div class="form-group"><label>Armadura</label><input type="number" id="enemy-armor" placeholder="0"></div>
                    <div class="form-group"><label>Velocidad</label><input type="number" id="enemy-speed" placeholder="10"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="enemy-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="enemy-sprite"></div>
                    <div class="form-group"><label>Efecto ataque</label><select id="enemy-effect"><option value="">Ninguno</option><option value="bleed">Sangrado</option><option value="poison">Veneno</option><option value="fire">Fuego</option></select></div>
                    <div class="form-group"><label>Loot Min MP</label><input type="number" id="enemy-loot-min"></div>
                    <div class="form-group"><label>Loot Max MP</label><input type="number" id="enemy-loot-max"></div>
                </div>
                <h4 style="color:var(--cyan);font-size:.75rem;margin:.5rem 0">üë• Configuraci√≥n de Grupo</h4>
                <div class="form-grid">
                    <div class="form-group"><label>¬øPuede aparecer en grupo?</label><select id="enemy-canGroup"><option value="false">No</option><option value="true">S√≠</option></select></div>
                    <div class="form-group"><label>M√≠nimo en grupo</label><input type="number" id="enemy-groupMin" min="2" placeholder="2"></div>
                    <div class="form-group"><label>M√°ximo en grupo</label><input type="number" id="enemy-groupMax" min="2" placeholder="4"></div>
                    <div class="form-group"><label>Probabilidad grupo (%)</label><input type="number" id="enemy-groupChance" min="0" max="100" placeholder="20"></div>
                </div>
                <div class="form-group"><label>Narrativa de encuentro</label><textarea id="enemy-desc"></textarea></div>
                <div class="form-group"><label>Regiones donde aparece</label><div class="multi-select" id="enemy-regions"></div></div>
                <div class="form-group"><label>Drops posibles</label><div class="multi-select" id="enemy-drops"></div></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('enemy')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveEnemy()">üíæ</button></div>
                <div class="items-list" id="enemies-list"></div>
            </div>

            <!-- PETS -->
            <div class="editor-section" id="editor-pets">
                <h3>üê∫ Editor de Mascotas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="pet-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="pet-name"></div>
                    <div class="form-group"><label>Salud</label><input type="number" id="pet-health"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="pet-damage"></div>
                    <div class="form-group"><label>Velocidad</label><input type="number" id="pet-speed" placeholder="12"></div>
                    <div class="form-group"><label>Dado domesticar</label><input type="number" id="pet-difficulty"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="pet-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="pet-sprite"></div>
                </div>
                <div class="form-group"><label>Regiones</label><div class="multi-select" id="pet-regions"></div></div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="pet-desc"></textarea></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('pet')">üÜï</button><button class="btn btn-primary" onclick="Editor.savePet()">üíæ</button></div>
                <div class="items-list" id="pets-list"></div>
            </div>

            <!-- NPCS -->
            <div class="editor-section" id="editor-npcs">
                <h3>üßî Editor de NPCs</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="npc-id"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="npc-name"></div>
                    <div class="form-group"><label>Rol</label><select id="npc-role"><option value="merchant">Comerciante</option><option value="blacksmith">Herrero</option><option value="alchemist">Alquimista</option><option value="innkeeper">Tabernero</option><option value="healer">Curandero</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="npc-icon" maxlength="2"></div>
                    <div class="form-group"><label>Sprite</label><input type="text" id="npc-sprite"></div>
                    <div class="form-group"><label>Regi√≥n</label><select id="npc-region"></select></div>
                </div>
                <div class="form-group"><label>Di√°logo</label><textarea id="npc-dialogue"></textarea></div>
                <div class="form-group"><label>Vende</label><div class="multi-select" id="npc-sells"></div></div>
                <div class="form-actions"><button class="btn" onclick="Editor.clear('npc')">üÜï</button><button class="btn btn-primary" onclick="Editor.saveNpc()">üíæ</button></div>
                <div class="items-list" id="npcs-list"></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="inventoryModal">
        <div class="modal modal-lg"><div class="modal-header"><span class="modal-title">üéí Inventario</span><button class="modal-close" data-close="inventoryModal">&times;</button></div>
        <div class="inventory-info" id="inventoryInfo">0/10</div><div class="inventory-grid" id="inventoryGrid"></div></div>
    </div>
    <div class="modal-overlay" id="itemDetailModal">
        <div class="modal"><div class="modal-header"><span class="modal-title">Detalles</span><button class="modal-close" data-close="itemDetailModal">&times;</button></div>
        <div class="modal-body"><div class="item-detail"><div class="item-detail-icon" id="detailIcon">üì¶</div><div class="item-detail-name" id="detailName">Item</div><div class="item-detail-type" id="detailType">Tipo</div><div class="item-detail-desc" id="detailDesc">...</div><div class="item-stats-grid" id="detailStats"></div><div class="item-actions" id="detailActions"></div></div></div></div>
    </div>
    <div class="modal-overlay" id="regionModal">
        <div class="modal modal-lg"><div class="modal-header"><span class="modal-title">üó∫Ô∏è Viajar</span><button class="modal-close" data-close="regionModal">&times;</button></div>
        <div class="modal-body"><div class="regions-grid" id="regionsGrid"></div></div></div>
    </div>
    <div class="modal-overlay" id="townModal">
        <div class="modal"><div class="modal-header"><span class="modal-title" id="townTitle">üèòÔ∏è Pueblo</span><button class="modal-close" data-close="townModal">&times;</button></div><div class="modal-body" id="townContent"></div></div>
    </div>
    <div class="modal-overlay" id="shopModal">
        <div class="modal modal-lg"><div class="modal-header"><span class="modal-title" id="shopTitle">üè™ Tienda</span><button class="modal-close" data-close="shopModal">&times;</button></div><div class="modal-body" id="shopContent"></div></div>
    </div>
    <div class="dice-overlay" id="diceOverlay"><div class="dice-display"><div class="dice-icon">üé≤</div><div class="dice-label" id="diceLabel">D20</div><div class="dice-result" id="diceResult">--</div></div></div>
    <div class="toast-container" id="toastContainer"></div>

<script>
// ==================== UTILITIES ====================
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const roll=d=>{if(typeof d==='number')return d;const m=String(d).match(/(\d+)?d(\d+)([+-]\d+)?/i);if(!m)return parseInt(d)||0;let t=parseInt(m[3])||0;for(let i=0;i<(parseInt(m[1])||1);i++)t+=Math.floor(Math.random()*parseInt(m[2]))+1;return t};
const d20=()=>Math.floor(Math.random()*20)+1;
const dX=x=>Math.floor(Math.random()*x)+1;
const pick=a=>a.length?a[Math.floor(Math.random()*a.length)]:null;
const hpClass=p=>p>60?'':p>30?'medium':p>15?'low':'critical';
const sprite=i=>i?.sprite?`<img src="${i.sprite}">`:(i?.icon||'üì¶');
const genId=p=>`${p}_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;
const toast=(m,t='info')=>{const e=document.createElement('div');e.className=`toast ${t}`;e.textContent=m;$('#toastContainer').appendChild(e);setTimeout(()=>e.remove(),3000)};
const openModal=id=>$(`#${id}`).classList.add('active');
const closeModal=id=>$(`#${id}`).classList.remove('active');
const showDice=async(r,s=20,c=false)=>{$('#diceLabel').textContent=`D${s}`;$('#diceResult').textContent=r;$('#diceResult').classList.toggle('crit',c);$('#diceOverlay').classList.add('active');await new Promise(r=>setTimeout(r,500));$('#diceOverlay').classList.remove('active')};
const scrollChron=()=>{const c=$('#chroniclesContent');c.scrollTop=c.scrollHeight};
const delay=ms=>new Promise(r=>setTimeout(r,ms));

// ==================== GAME DATA ====================
const Data={
    regions:[
        {id:'pueblo',name:'Pueblo Inicio',icon:'üèòÔ∏è',type:'safe',desc:'Un tranquilo pueblo.',narratives:['El sol brilla sobre las casas.']},
        {id:'bosque',name:'Bosque Sombr√≠o',icon:'üå≤',type:'danger',desc:'Un bosque antiguo.',narratives:['Los √°rboles se alzan imponentes.','Un sendero serpentea entre helechos.']},
        {id:'mazmorra',name:'Mazmorras',icon:'üèöÔ∏è',type:'danger',desc:'Ruinas peligrosas.',narratives:['El eco resuena en la oscuridad.','Antorchas titilantes iluminan el camino.']},
        {id:'montana',name:'Monta√±as',icon:'‚õ∞Ô∏è',type:'danger',desc:'Cumbres heladas.',narratives:['El viento a√∫lla entre los picos.']},
        {id:'pantano',name:'Pantano',icon:'üåø',type:'danger',desc:'Aguas estancadas.',narratives:['El agua burbujea con gases.']},
        {id:'mar',name:'Alta Mar',icon:'üåä',type:'danger',desc:'Aguas profundas.',narratives:['Las olas mecen tu embarcaci√≥n.']},
        {id:'desierto',name:'Desierto',icon:'üèúÔ∏è',type:'danger',desc:'Dunas interminables.',narratives:['El calor distorsiona el horizonte.']}
    ],
    races:[
        {id:'human',name:'Humano',icon:'üßë',bonus:{health:1,speed:10},desc:'Vers√°tiles.'},
        {id:'elf',name:'Elfo',icon:'üßù',bonus:{precision:1,speed:12},desc:'√Ågiles.'},
        {id:'dwarf',name:'Enano',icon:'üßî',bonus:{armor:1,speed:8},desc:'Resistentes.'},
        {id:'orc',name:'Orco',icon:'üëπ',bonus:{damage:1,speed:9},desc:'Fuertes.'},
        {id:'halfling',name:'Mediano',icon:'üßí',bonus:{evasion:1,speed:11},desc:'Escurridizos.'}
    ],
    weapons:[
        {id:'w1',name:'Daga',damage:'1d4',icon:'üó°Ô∏è',value:10,rarity:'common'},
        {id:'w2',name:'Espada',damage:'1d6',icon:'‚öîÔ∏è',value:20,rarity:'common'},
        {id:'w3',name:'Hacha',damage:'1d6',icon:'ü™ì',value:20,rarity:'common'},
        {id:'w4',name:'Espada Larga',damage:'1d8',icon:'‚öîÔ∏è',value:50,rarity:'rare'},
        {id:'w5',name:'Tridente',damage:'1d8',icon:'üî±',value:45,rarity:'rare'}
    ],
    armors:[
        {id:'a1',name:'T√∫nica cuero',defense:1,icon:'ü¶∫',value:15,rarity:'common'},
        {id:'a2',name:'Cuero reforzado',defense:2,icon:'ü¶∫',value:30,rarity:'common'},
        {id:'a3',name:'Cota de malla',defense:3,icon:'‚õìÔ∏è',value:75,rarity:'rare'},
        {id:'a4',name:'Placas',defense:5,icon:'üõ°Ô∏è',value:150,rarity:'epic'}
    ],
    items:[
        {id:'i1',name:'Poci√≥n menor',type:'potion',effect:'1d8',icon:'üß™',value:10,rarity:'common'},
        {id:'i2',name:'Ant√≠doto',type:'antidote',icon:'üíä',value:15,rarity:'common'},
        {id:'i3',name:'Bomba humo',type:'escape',icon:'üí®',value:25,rarity:'common'},
        {id:'i4',name:'Carne',type:'food',effect:'1d4',icon:'ü•©',value:5,rarity:'common'},
        {id:'i5',name:'Poci√≥n mayor',type:'potion',effect:'2d8',icon:'üß™',value:35,rarity:'rare'}
    ],
    enemies:[
        {id:'e1',name:'Rata Gigante',health:8,damage:'1d4',difficulty:6,armor:0,speed:12,icon:'üêÄ',loot:[3,8],drops:['i1'],regions:['mazmorra'],canGroup:true,groupMin:2,groupMax:5,groupChance:40,desc:'Ratas del tama√±o de perros.'},
        {id:'e2',name:'Goblin',health:12,damage:'1d6',difficulty:8,armor:0,speed:10,icon:'üë∫',loot:[5,12],drops:['i1','w1'],regions:['bosque','mazmorra'],canGroup:true,groupMin:2,groupMax:4,groupChance:30,desc:'Goblins escu√°lidos.'},
        {id:'e3',name:'Esqueleto',health:15,damage:'1d6',difficulty:10,armor:1,speed:8,icon:'üíÄ',loot:[8,20],drops:['i1'],regions:['mazmorra'],canGroup:true,groupMin:2,groupMax:3,groupChance:25,desc:'Huesos que crujen al alzarse.'},
        {id:'e4',name:'Orco Guerrero',health:30,damage:'1d8',difficulty:12,armor:2,speed:9,icon:'üëπ',loot:[15,35],drops:['w2'],regions:['bosque','montana'],canGroup:false,desc:'Un orco musculoso.'},
        {id:'e5',name:'Troll',health:45,damage:'2d6',difficulty:14,armor:3,speed:7,icon:'üßå',loot:[30,60],drops:['a2'],regions:['pantano'],canGroup:false,desc:'Un troll emerge del lodo.'},
        {id:'e6',name:'Lobo',health:18,damage:'1d6',difficulty:9,armor:0,speed:14,icon:'üê∫',loot:[5,15],drops:['i4'],regions:['bosque','montana'],canGroup:true,groupMin:2,groupMax:6,groupChance:50,desc:'Lobos hambrientos.'},
        {id:'e7',name:'Sirena',health:25,damage:'1d8',difficulty:12,armor:0,speed:11,icon:'üßú‚Äç‚ôÄÔ∏è',loot:[20,45],drops:['i5'],regions:['mar'],canGroup:false,desc:'Una sirena letal.',effect:'poison'},
        {id:'e8',name:'Escorpi√≥n',health:20,damage:'1d6',difficulty:10,armor:2,speed:10,icon:'ü¶Ç',loot:[10,25],drops:['i2'],regions:['desierto'],canGroup:true,groupMin:2,groupMax:4,groupChance:35,desc:'Escorpiones gigantes.',effect:'poison'},
        {id:'e9',name:'Yeti',health:40,damage:'2d6',difficulty:14,armor:2,speed:8,icon:'‚ùÑÔ∏è',loot:[35,70],drops:['a3'],regions:['montana'],canGroup:false,desc:'Un rugido entre las cumbres.'}
    ],
    pets:[
        {id:'p1',name:'Lobo',health:20,damage:'1d6',difficulty:24,speed:14,icon:'üê∫',regions:['bosque','montana']},
        {id:'p2',name:'Oso',health:35,damage:'1d8',difficulty:30,speed:9,icon:'üêª',regions:['bosque','montana']},
        {id:'p3',name:'√Åguila',health:15,damage:'1d4',difficulty:24,speed:16,icon:'ü¶Ö',regions:['montana']}
    ],
    npcs:[
        {id:'n1',name:'Grimbold',role:'blacksmith',icon:'üßî',region:'pueblo',dialogue:'¬°Mis armas son las mejores!',sells:['w1','w2','w3','w4']},
        {id:'n2',name:'Elara',role:'alchemist',icon:'üßô‚Äç‚ôÄÔ∏è',region:'pueblo',dialogue:'Mis pociones curan...',sells:['i1','i2','i5']},
        {id:'n3',name:'Tobias',role:'innkeeper',icon:'üßë‚Äçüç≥',region:'pueblo',dialogue:'¬°Cerveza fr√≠a!',sells:['i4']}
    ],
    traps:[
        {name:'P√∫as',damage:'1d6',effect:'bleed',detectDiff:10,dodgeDiff:12},
        {name:'Dardo venenoso',damage:'1d4',effect:'poison',detectDiff:12,dodgeDiff:10},
        {name:'Foso',damage:'2d6',effect:null,detectDiff:8,dodgeDiff:14}
    ],
    find(t,id){return this[t]?.find(x=>x.id===id)},
    findItem(id){return this.find('weapons',id)||this.find('armors',id)||this.find('items',id)},
    getRegion(id){return this.regions.find(r=>r.id===id)||this.regions[0]},
    getEnemiesForRegion(rid){return this.enemies.filter(e=>(e.regions||[]).includes(rid))},
    getPetsForRegion(rid){return this.pets.filter(p=>!p.regions?.length||(p.regions||[]).includes(rid))},
    getNpcsForRegion(rid){return this.npcs.filter(n=>n.region===rid)},
    save(){const d={regions:this.regions,races:this.races,weapons:this.weapons,armors:this.armors,items:this.items,enemies:this.enemies,pets:this.pets,npcs:this.npcs};localStorage.setItem('rpg_data',JSON.stringify(d));if(FB.db&&FB.ok)FB.db.ref('gameData').set(d)},
    load(){const s=localStorage.getItem('rpg_data');if(s)try{const d=JSON.parse(s);Object.keys(d).forEach(k=>{if(this[k])this[k]=d[k]})}catch(e){}}
};

// ==================== FIREBASE ====================
const FB={db:null,ok:false,init(){try{firebase.initializeApp({apiKey:"AIzaSyAV4eSg9QjyE08zwtFsvjAomuMYVcNik9k",databaseURL:"https://rpggo-756a7-default-rtdb.firebaseio.com",projectId:"rpggo-756a7"});this.db=firebase.database();this.db.ref('.info/connected').on('value',s=>{this.ok=s.val()===true;$('#fbStatus').classList.toggle('connected',this.ok);$('#fbStatusText').textContent=this.ok?'‚úì':'‚úó';if(this.ok)this.load()})}catch(e){}},load(){if(!this.db)return;this.db.ref('gameData').once('value').then(s=>{const d=s.val();if(d){Object.keys(d).forEach(k=>{if(Data[k])Data[k]=d[k]});Editor.renderAll()}})}};

// ==================== GAME STATE ====================
let G={p:null,combat:false,enemies:[],turn:0,region:null,item:null,turnOrder:[],currentActorIdx:0,playerActed:false};

// ==================== STORY ====================
const Story={
    add(t,c=''){const e=document.createElement('div');e.className=`story-entry ${c?'story-'+c:''}`;e.innerHTML=t;$('#chroniclesContent').appendChild(e);setTimeout(scrollChron,50)},
    clear(){$('#chroniclesContent').innerHTML=''}
};

// ==================== REGIONS ====================
const Regions={
    openSelector(){
        if(G.combat){toast('No en combate','error');return}
        const grid=$('#regionsGrid');grid.innerHTML='';
        Data.regions.forEach(r=>{
            const cur=G.region?.id===r.id;
            const div=document.createElement('div');
            div.className=`region-card ${r.type} ${cur?'current':''}`;
            div.innerHTML=`<div class="region-card-icon">${r.icon}</div><div class="region-card-name">${r.name}</div><div class="region-card-type">${r.type==='safe'?'üè† Segura':'‚ö†Ô∏è Peligrosa'}</div>${cur?'<div style="color:var(--gold);font-size:.55rem">üìç Aqu√≠</div>':''}`;
            div.onclick=()=>this.travelTo(r);
            grid.appendChild(div);
        });
        openModal('regionModal');
    },
    travelTo(r){
        closeModal('regionModal');
        if(G.region?.id===r.id){toast('Ya est√°s aqu√≠','info');return}
        G.region=r;
        Story.add(`<strong>üó∫Ô∏è Viajas a ${r.name}</strong>`,'region');
        Story.add(`${r.icon} ${r.desc}`,'narrative');
        Game.updateUI();
        if(r.type==='safe'){
            const npcs=Data.getNpcsForRegion(r.id);
            if(npcs.length)setTimeout(()=>Town.visit(r),400);
            else{Story.add('Lugar tranquilo para descansar.','system');Game.exploreActions()}
        }else{Story.add('Zona peligrosa. ¬°Prep√°rate!','system');Game.exploreActions()}
    }
};

// ==================== MAIN GAME ====================
const Game={
    init(){this.load()||this.new()},
    new(){
        const race=pick(Data.races),weapon={...pick(Data.weapons.slice(0,3)),uid:genId('i')},armor={...pick(Data.armors.slice(0,2)),uid:genId('i')},item={...pick(Data.items),uid:genId('i')};
        const baseSpeed=10+(race.bonus.speed||0);
        G.p={name:pick(['Aldric','Brynn','Cedric','Dara','Freya','Gideon','Kira','Mira']),race,maxHp:20+(race.bonus.health||0),hp:20+(race.bonus.health||0),weapon,armor,inv:[item],maxSlots:10,gold:0,silver:20,effects:[],pet:null,defending:false,speed:baseSpeed};
        G.combat=false;G.enemies=[];G.turn=0;G.region=Data.getRegion('pueblo');
        Story.clear();
        Story.add(`<strong style="color:var(--gold);font-size:1.1rem">‚öîÔ∏è Aventuras de Acero y Runas ‚öîÔ∏è</strong>`);
        Story.add(`Eres <strong>${G.p.name}</strong>, ${race.name} ${race.icon}.`,'narrative');
        Story.add(`Equipado: ${weapon.name}, ${armor.name}. Velocidad: ${baseSpeed}`,'system');
        this.updateUI();this.exploreActions();
    },
    save(){localStorage.setItem('rpg_save',JSON.stringify({p:G.p,region:G.region}));toast('Guardado','success')},
    load(){const s=localStorage.getItem('rpg_save');if(!s)return false;try{const d=JSON.parse(s);G.p=d.p;G.region=d.region?Data.getRegion(d.region.id):Data.getRegion('pueblo');G.combat=false;Story.add('Partida cargada.','system');this.updateUI();this.exploreActions();return true}catch(e){return false}},
    updateUI(){
        const p=G.p;if(!p)return;
        $('#charAvatar').innerHTML=p.race.sprite?`<img src="${p.race.sprite}">`:p.race.icon;
        $('#charName').textContent=p.name;$('#charRace').textContent=p.race.name;
        const hp=(p.hp/p.maxHp)*100;$('#hpFill').style.width=hp+'%';$('#hpFill').className=`hp-fill ${hpClass(hp)}`;$('#hpText').textContent=`${p.hp}/${p.maxHp}`;
        const rb=$('#regionBadge');rb.className=`region-badge ${G.region.type}`;rb.innerHTML=`<span>${G.region.icon} ${G.region.name}</span><div style="font-size:.55rem;color:var(--text-dim)">Click para viajar</div>`;
        $('#statArmor').textContent=this.armor();$('#statEvasion').textContent=p.race.bonus.evasion||0;$('#statPrecision').textContent=p.race.bonus.precision||0;$('#statSpeed').textContent=p.speed||10;
        $('#weaponIcon').innerHTML=sprite(p.weapon);$('#weaponName').textContent=p.weapon?.name||'Pu√±os';$('#weaponStats').textContent=`Da√±o: ${p.weapon?.damage||'1d2'}`;
        $('#armorIcon').innerHTML=sprite(p.armor);$('#armorName').textContent=p.armor?.name||'---';$('#armorStats').textContent=`Def: ${p.armor?.defense||0}`;
        $('#goldAmount').textContent=p.gold;$('#silverAmount').textContent=p.silver;
        const canEq=!G.combat&&G.region.type==='safe';$('#weaponSlot').classList.toggle('disabled',!canEq);$('#armorSlot').classList.toggle('disabled',!canEq);
    },
    armor(){return(G.p.armor?.defense||0)+(G.p.race.bonus.armor||0)},
    setActions(acts){const c=$('#actionsContainer');c.innerHTML='';acts.forEach(a=>{const b=document.createElement('button');b.className=`btn ${a.cls||''}`;b.textContent=a.text;b.disabled=a.disabled||false;b.onclick=a.fn;c.appendChild(b)})},
    exploreActions(){
        const acts=[{text:'üó∫Ô∏è Viajar',fn:()=>Regions.openSelector()}];
        if(G.region.type==='danger')acts.unshift({text:'‚öîÔ∏è Explorar',fn:()=>Explore.start(),cls:'btn-primary'});
        else{const npcs=Data.getNpcsForRegion(G.region.id);if(npcs.length)acts.push({text:'üèòÔ∏è NPCs',fn:()=>Town.visit(G.region)})}
        acts.push({text:'üéí Inventario',fn:()=>Inv.open()},{text:'üíæ Guardar',fn:()=>this.save()});
        this.setActions(acts);
    }
};

// ==================== EXPLORATION ====================
const Explore={
    start(){
        if(G.region.type==='safe')return;
        const narr=G.region.narratives||['Exploras...'];
        Story.add(pick(narr),'narrative');
        Game.setActions([{text:'...',disabled:true}]);
        setTimeout(()=>{const r=dX(100);if(r<=55)this.enemy();else if(r<=75)this.trap();else if(r<=88)this.treasure();else if(r<=96)this.pet();else this.safe()},800);
    },
    enemy(){
        const pool=Data.getEnemiesForRegion(G.region.id);
        if(!pool.length){Story.add('No hay peligros...','system');Game.exploreActions();return}
        const template=pick(pool);
        let enemies=[{...template}];
        // Check for group
        if(template.canGroup&&Math.random()*100<(template.groupChance||20)){
            const min=template.groupMin||2,max=template.groupMax||4;
            const count=Math.floor(Math.random()*(max-min+1))+min;
            enemies=[];
            for(let i=0;i<count;i++)enemies.push({...template});
            Story.add(`<strong>¬°Un grupo de ${count} ${template.name}s aparece!</strong>`,'combat');
        }else{
            Story.add(template.desc||`Un ${template.name} aparece.`,'narrative');
            Story.add(`<strong>¬°${template.name} ataca!</strong>`,'combat');
        }
        Game.setActions([{text:'‚öîÔ∏è ¬°Luchar!',fn:()=>Combat.start(enemies),cls:'btn-primary'},{text:'üí® Huir',fn:()=>this.flee(enemies),cls:'btn-danger'}]);
    },
    async flee(enemies){const r=d20();await showDice(r,20,r>=14);Story.add(`Huida: ${r} vs 14`,'system');if(r>=14){Story.add('¬°Escapas!','narrative');Game.exploreActions()}else{Story.add('¬°No escapas!','combat');Combat.start(enemies)}},
    trap(){
        const trap=pick(Data.traps);Story.add('Algo no est√° bien...','narrative');
        setTimeout(async()=>{
            Story.add(`<strong>¬°Trampa: ${trap.name}!</strong>`,'trap');
            const det=d20();await showDice(det,20,det>=trap.detectDiff);
            Story.add(`Percepci√≥n: ${det} vs ${trap.detectDiff}`,'system');
            if(det>=trap.detectDiff){
                Story.add('¬°La detectas!','system');
                Game.setActions([{text:'üèÉ Esquivar',fn:async()=>{const r=d20()+(G.p.race.bonus.evasion||0);await showDice(r,20,r>=trap.dodgeDiff);Story.add(`Esquive: ${r} vs ${trap.dodgeDiff}`,'system');if(r>=trap.dodgeDiff){Story.add('¬°Esquivada!','loot');Game.exploreActions()}else this.trapDmg(trap,true)},cls:'btn-primary'}]);
            }else{Story.add('No la ves...','trap');this.trapDmg(trap,false)}
        },800);
    },
    trapDmg(trap,reduced){
        let dmg=roll(trap.damage);if(reduced)dmg=Math.ceil(dmg*0.5);
        const arm=Math.floor(Game.armor()/2);const final=Math.max(0,dmg-arm);
        Story.add(`<span style="font-family:monospace">${trap.name}: ${dmg} da√±o ‚àí ${arm} armadura = <strong>${final>0?final+' da√±o':'BLOQUEADO'}</strong></span>`,'system');
        if(final>0){G.p.hp-=final;if(trap.effect)Combat.applyEff(G.p,trap.effect)}
        Game.updateUI();
        if(G.p.hp<=0){Story.add('<strong style="color:var(--red-bright)">üíÄ Has muerto...</strong>','combat');Game.setActions([{text:'üîÑ Nuevo',fn:()=>Game.new(),cls:'btn-primary'}])}
        else Game.exploreActions();
    },
    treasure(){Story.add('¬°Algo brilla!','narrative');setTimeout(()=>{const mp=dX(30)+10;G.p.silver+=mp;while(G.p.silver>=99){G.p.silver-=99;G.p.gold++}Story.add(`+${mp} MP`,'loot');if(Math.random()<0.3&&G.p.inv.length<G.p.maxSlots){const it={...pick(Data.items),uid:genId('i')};G.p.inv.push(it);Story.add(`+${it.icon} ${it.name}`,'loot')}Game.updateUI();Game.exploreActions()},800)},
    pet(){
        if(G.p.pet){this.safe();return}
        const pool=Data.getPetsForRegion(G.region.id);if(!pool.length){this.treasure();return}
        const pet=pick(pool);Story.add(`${pet.icon} Un ${pet.name} aparece.`,'narrative');
        const meat=G.p.inv.some(i=>i.type==='food');
        Game.setActions([{text:'ü•© Domesticar',fn:async()=>{const idx=G.p.inv.findIndex(i=>i.type==='food');if(idx>=0)G.p.inv.splice(idx,1);const r=dX(pet.difficulty);const th=Math.ceil(pet.difficulty*0.6);await showDice(r,pet.difficulty,r>=th);Story.add(`D${pet.difficulty}: ${r} (necesitas ${th}+)`,'system');if(r>=th){G.p.pet={...pet,hp:pet.health,maxHp:pet.health};Story.add(`<strong style="color:var(--green-bright)">¬°${pet.name} es tu compa√±ero!</strong>`,'loot');toast('¬°Compa√±ero!','success')}else Story.add('Se aleja.','narrative');Game.updateUI();Game.exploreActions()},disabled:!meat,cls:meat?'btn-primary':''},{text:'üö∂ Dejar',fn:()=>{Story.add('Te alejas.','narrative');Game.exploreActions()}}]);
    },
    safe(){Story.add('Un lugar tranquilo.','narrative');const h=Math.floor(G.p.maxHp*0.3);G.p.hp=Math.min(G.p.maxHp,G.p.hp+h);G.p.effects=[];Story.add(`<span style="color:var(--green-bright)">+${h} HP</span>`,'system');Game.updateUI();Game.exploreActions()}
};

// ==================== COMBAT SYSTEM - COMPLETE REWRITE ====================
const Combat={
    start(enemyTemplates){
        G.combat=true;
        G.enemies=enemyTemplates.map((e,i)=>({
            ...e,
            uid:genId('enemy'),
            hp:e.health,
            maxHp:e.health,
            armor:e.armor||0,
            speed:e.speed||10,
            effects:[],
            name:enemyTemplates.length>1?`${e.name} ${i+1}`:e.name
        }));
        G.turn=0;
        G.playerActed=false;
        $('#combatArena').classList.remove('hidden');
        $('#combatLog').innerHTML='';
        this.newTurn();
    },
    
    // Calculate initiative order at start of each turn
    calcInitiative(){
        const entities=[];
        // Player
        entities.push({type:'player',entity:G.p,speed:G.p.speed||10,name:G.p.name,initiative:d20()});
        // Pet
        if(G.p.pet&&G.p.pet.hp>0){
            entities.push({type:'pet',entity:G.p.pet,speed:G.p.pet.speed||10,name:G.p.pet.name,initiative:d20()});
        }
        // Enemies
        G.enemies.filter(e=>e.hp>0).forEach(e=>{
            entities.push({type:'enemy',entity:e,speed:e.speed||10,name:e.name,initiative:d20()});
        });
        // Sort by speed desc, then initiative desc
        entities.sort((a,b)=>{
            if(b.speed!==a.speed)return b.speed-a.speed;
            return b.initiative-a.initiative;
        });
        return entities;
    },
    
    newTurn(){
        G.turn++;
        G.turnOrder=this.calcInitiative();
        G.currentActorIdx=0;
        G.playerActed=false;
        G.p.defending=false;
        
        this.log(`<div class="log-turn-header">‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TURNO ${G.turn} ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê</div>`);
        
        // Show initiative order
        const orderStr=G.turnOrder.map((e,i)=>`${i+1}. ${e.name} (Vel:${e.speed}, Init:${e.initiative})`).join(' ‚Üí ');
        this.log(`<div class="log-initiative">‚ö° Orden: ${orderStr}</div>`);
        
        $('#turnCounter').textContent=G.turn;
        this.renderEntities();
        this.processNextActor();
    },
    
    async processNextActor(){
        if(G.currentActorIdx>=G.turnOrder.length){
            // End of turn - process effects and start new turn
            await this.endTurn();
            return;
        }
        
        const actor=G.turnOrder[G.currentActorIdx];
        
        // Skip dead entities
        if(actor.entity.hp<=0){
            G.currentActorIdx++;
            this.processNextActor();
            return;
        }
        
        this.renderEntities();
        
        if(actor.type==='player'){
            this.showPlayerActions();
        }else if(actor.type==='pet'){
            await this.petAction();
            G.currentActorIdx++;
            await delay(400);
            this.processNextActor();
        }else{
            await this.enemyAction(actor.entity);
            G.currentActorIdx++;
            await delay(400);
            this.processNextActor();
        }
    },
    
    async endTurn(){
        // Process effects for all entities
        this.processEffects(G.p,'Jugador');
        if(G.p.pet&&G.p.pet.hp>0)this.processEffects(G.p.pet,G.p.pet.name);
        G.enemies.filter(e=>e.hp>0).forEach(e=>this.processEffects(e,e.name));
        
        this.renderEntities();
        Game.updateUI();
        
        // Check victory/defeat
        if(G.p.hp<=0){
            this.defeat();return;
        }
        if(G.enemies.every(e=>e.hp<=0)){
            this.victory();return;
        }
        
        await delay(600);
        this.newTurn();
    },
    
    showPlayerActions(){
        const ca=$('#combatActions');ca.innerHTML='';
        
        // Target selector if multiple enemies
        const alive=G.enemies.filter(e=>e.hp>0);
        let targetSelect='';
        if(alive.length>1){
            targetSelect=`<select class="target-select" id="targetSelect">${alive.map(e=>`<option value="${e.uid}">${e.icon} ${e.name} (${e.hp}HP)</option>`).join('')}</select>`;
        }
        
        ca.innerHTML=targetSelect;
        
        [{text:'‚öîÔ∏è Atacar',fn:()=>this.playerAttack(),cls:'btn-primary'},{text:'üõ°Ô∏è Defender',fn:()=>this.playerDefend()},{text:'üéí Item',fn:()=>Inv.open()},{text:'üí® Huir',fn:()=>this.playerFlee(),cls:'btn-danger'}].forEach(a=>{
            const b=document.createElement('button');b.className=`btn ${a.cls||''}`;b.textContent=a.text;b.onclick=a.fn;ca.appendChild(b);
        });
    },
    
    getSelectedTarget(){
        const sel=$('#targetSelect');
        if(sel){
            return G.enemies.find(e=>e.uid===sel.value);
        }
        return G.enemies.find(e=>e.hp>0);
    },
    
    async playerAttack(){
        const target=this.getSelectedTarget();
        if(!target||target.hp<=0)return;
        
        const p=G.p;
        const attackRoll=d20();
        const precision=p.race.bonus.precision||0;
        const total=attackRoll+precision;
        const isCrit=attackRoll===20;
        const isPifia=attackRoll===1;
        
        await showDice(attackRoll,20,isCrit);
        
        this.log(`<div class="log-action player-action">`);
        this.log(`<strong>${p.name}</strong> ataca a <strong>${target.name}</strong>`);
        this.log(`üéØ Tirada ataque: D20 = ${attackRoll}${precision?` + ${precision} prec`:''} = <strong>${total}</strong> vs Dificultad ${target.difficulty}`);
        
        if(isPifia){
            this.log(`<span class="log-result log-miss">¬°PIFIA! Fallo autom√°tico</span>`);
        }else if(total>=target.difficulty){
            // Hit! Calculate damage
            const weaponDmg=p.weapon?.damage||'1d2';
            let dmgRoll=roll(weaponDmg);
            const dmgBonus=p.race.bonus.damage||0;
            let baseDmg=dmgRoll+dmgBonus;
            
            this.log(`‚öîÔ∏è Tirada da√±o: ${weaponDmg} = ${dmgRoll}${dmgBonus?` + ${dmgBonus} bono`:''} = ${baseDmg}`);
            
            if(isCrit){
                baseDmg*=2;
                this.log(`<span class="log-result log-crit">¬°¬°CR√çTICO!! √ó2 = ${baseDmg}</span>`);
            }
            
            const targetArmor=target.armor||0;
            const finalDmg=Math.max(0,baseDmg-targetArmor);
            
            this.log(`<div class="log-calc">üí• ${baseDmg} da√±o ‚àí ${targetArmor} armadura = <strong>${finalDmg>0?finalDmg+' DA√ëO':'BLOQUEADO (0)'}</strong></div>`);
            
            if(finalDmg>0){
                target.hp-=finalDmg;
                this.log(`<span class="log-damage">${target.name} recibe ${finalDmg} de da√±o. (HP: ${Math.max(0,target.hp)}/${target.maxHp})</span>`);
                if(p.weapon?.effect)this.applyEff(target,p.weapon.effect);
            }else{
                this.log(`<span class="log-result log-block">¬°La armadura bloquea todo el da√±o!</span>`);
            }
            
            if(target.hp<=0){
                this.log(`<div class="log-death">üíÄ ${target.name} ha sido derrotado!</div>`);
            }
        }else{
            this.log(`<span class="log-result log-miss">FALLO - No supera la dificultad</span>`);
        }
        
        this.log(`</div>`);
        this.renderEntities();
        Game.updateUI();
        
        G.currentActorIdx++;
        await delay(400);
        this.processNextActor();
    },
    
    playerDefend(){
        G.p.defending=true;
        this.log(`<div class="log-action player-action"><strong>${G.p.name}</strong> se prepara para defender. <span class="log-heal">+4 Evasi√≥n este turno</span></div>`);
        
        G.currentActorIdx++;
        this.processNextActor();
    },
    
    async playerFlee(){
        const r=d20();await showDice(r,20,r>=12);
        this.log(`<div class="log-action player-action">üèÉ Intento de huida: D20 = ${r} vs 12</div>`);
        if(r>=12){
            this.log(`<span class="log-result log-heal">¬°Escape exitoso!</span>`);
            this.escape();
        }else{
            this.log(`<span class="log-result log-miss">¬°No logra escapar!</span>`);
            G.currentActorIdx++;
            this.processNextActor();
        }
    },
    
    async petAction(){
        const pet=G.p.pet;
        if(!pet||pet.hp<=0)return;
        
        const target=G.enemies.find(e=>e.hp>0);
        if(!target)return;
        
        this.log(`<div class="log-action pet-action">`);
        this.log(`<strong>${pet.icon} ${pet.name}</strong> ataca a <strong>${target.name}</strong>`);
        
        // Pets always hit but with reduced effectiveness
        const dmgRoll=roll(pet.damage);
        const targetArmor=target.armor||0;
        const finalDmg=Math.max(0,dmgRoll-targetArmor);
        
        this.log(`‚öîÔ∏è Da√±o: ${pet.damage} = ${dmgRoll} ‚àí ${targetArmor} armadura = <strong>${finalDmg>0?finalDmg:'0 (bloqueado)'}</strong>`);
        
        if(finalDmg>0){
            target.hp-=finalDmg;
            this.log(`<span class="log-damage">${target.name}: ${finalDmg} da√±o (HP: ${Math.max(0,target.hp)})</span>`);
        }
        
        if(target.hp<=0)this.log(`<div class="log-death">üíÄ ${target.name} derrotado!</div>`);
        this.log(`</div>`);
        this.renderEntities();
    },
    
    async enemyAction(enemy){
        if(enemy.hp<=0)return;
        
        const p=G.p;
        const evasion=(p.race.bonus.evasion||0)+(p.defending?4:0);
        const dodgeRoll=d20();
        const totalDodge=dodgeRoll+evasion;
        
        this.log(`<div class="log-action enemy-action">`);
        this.log(`<strong>${enemy.icon} ${enemy.name}</strong> ataca a <strong>${p.name}</strong>`);
        this.log(`üõ°Ô∏è Esquive: D20 = ${dodgeRoll}${evasion?` + ${evasion} eva`:''} = <strong>${totalDodge}</strong> vs 12`);
        
        if(totalDodge>=12){
            this.log(`<span class="log-result log-heal">¬°ESQUIVADO!</span>`);
        }else{
            const dmgRoll=roll(enemy.damage);
            const isCrit=Math.random()<0.1;
            let baseDmg=dmgRoll;
            
            this.log(`‚öîÔ∏è Tirada da√±o: ${enemy.damage} = ${dmgRoll}`);
            
            if(isCrit){
                baseDmg=Math.ceil(baseDmg*1.5);
                this.log(`<span class="log-result log-crit">¬°GOLPE CR√çTICO! √ó1.5 = ${baseDmg}</span>`);
            }
            
            const playerArmor=Game.armor();
            const finalDmg=Math.max(0,baseDmg-playerArmor);
            
            this.log(`<div class="log-calc">üí• ${baseDmg} da√±o ‚àí ${playerArmor} armadura = <strong>${finalDmg>0?finalDmg+' DA√ëO':'BLOQUEADO (0)'}</strong></div>`);
            
            if(finalDmg>0){
                p.hp-=finalDmg;
                this.log(`<span class="log-damage">${p.name} recibe ${finalDmg} de da√±o. (HP: ${Math.max(0,p.hp)}/${p.maxHp})</span>`);
                if(enemy.effect)this.applyEff(p,enemy.effect);
            }else{
                this.log(`<span class="log-result log-block">¬°Tu armadura bloquea el da√±o!</span>`);
            }
        }
        
        this.log(`</div>`);
        this.renderEntities();
        Game.updateUI();
    },
    
    applyEff(target,type){
        const effs={bleed:{dmg:1,turns:3,max:3},poison:{dmg:2,turns:2,max:2},fire:{dmg:'1d4',turns:2,max:1}};
        const ef=effs[type];if(!ef)return;
        if(!target.effects)target.effects=[];
        const ex=target.effects.find(e=>e.type===type);
        if(ex){if(ex.stacks<ef.max)ex.stacks++;ex.turns=ef.turns}
        else target.effects.push({type,dmg:ef.dmg,turns:ef.turns,stacks:1});
        this.log(`<span class="log-effect">üî• Efecto aplicado: ${type}</span>`);
    },
    
    processEffects(entity,name){
        if(!entity.effects?.length)return;
        let total=0;
        entity.effects.forEach(ef=>{
            const d=(typeof ef.dmg==='string'?roll(ef.dmg):ef.dmg)*(ef.stacks||1);
            total+=d;ef.turns--;
        });
        entity.effects=entity.effects.filter(e=>e.turns>0);
        if(total>0){
            entity.hp-=total;
            this.log(`<span class="log-effect">ü©∏ ${name} sufre ${total} da√±o por efectos</span>`);
        }
    },
    
    renderEntities(){
        const container=$('#combatEntities');container.innerHTML='';
        
        // Player
        const pHp=(G.p.hp/G.p.maxHp)*100;
        const pActive=G.turnOrder[G.currentActorIdx]?.type==='player';
        container.innerHTML+=`
            <div class="combatant player ${pActive?'active':''}">
                <div class="combatant-sprite">${sprite({icon:G.p.race.icon,sprite:G.p.race.sprite})}</div>
                <div class="combatant-name">${G.p.name}</div>
                <div class="combatant-stats">‚öîÔ∏è${G.p.weapon?.damage||'1d2'} üõ°Ô∏è${Game.armor()}</div>
                <div class="combatant-speed">‚ö° Vel: ${G.p.speed||10}</div>
                <div class="hp-container"><div class="hp-fill ${hpClass(pHp)}" style="width:${pHp}%"></div><div class="hp-text">${G.p.hp}/${G.p.maxHp}</div></div>
                <div class="effects-row">${(G.p.effects||[]).map(e=>`<span class="effect-tag eff-${e.type}">${e.type} ${e.turns}</span>`).join('')}</div>
            </div>
        `;
        
        // Pet
        if(G.p.pet){
            const pet=G.p.pet;
            const petHp=(pet.hp/pet.maxHp)*100;
            const petActive=G.turnOrder[G.currentActorIdx]?.type==='pet';
            container.innerHTML+=`
                <div class="combatant pet ${pet.hp<=0?'dead':''} ${petActive?'active':''}">
                    <div class="combatant-sprite">${pet.icon}</div>
                    <div class="combatant-name">${pet.name}</div>
                    <div class="combatant-stats">‚öîÔ∏è${pet.damage}</div>
                    <div class="combatant-speed">‚ö° Vel: ${pet.speed||10}</div>
                    <div class="hp-container"><div class="hp-fill ${hpClass(petHp)}" style="width:${petHp}%"></div><div class="hp-text">${pet.hp}/${pet.maxHp}</div></div>
                </div>
            `;
        }
        
        // Enemies
        G.enemies.forEach(e=>{
            const eHp=(e.hp/e.maxHp)*100;
            const eActive=G.turnOrder[G.currentActorIdx]?.entity?.uid===e.uid;
            container.innerHTML+=`
                <div class="combatant enemy ${e.hp<=0?'dead':''} ${eActive?'active':''}">
                    <div class="combatant-sprite">${sprite(e)}</div>
                    <div class="combatant-name">${e.name}</div>
                    <div class="combatant-stats">‚öîÔ∏è${e.damage} üõ°Ô∏è${e.armor||0}</div>
                    <div class="combatant-speed">‚ö° Vel: ${e.speed||10}</div>
                    <div class="hp-container"><div class="hp-fill ${hpClass(eHp)}" style="width:${eHp}%"></div><div class="hp-text">${Math.max(0,e.hp)}/${e.maxHp}</div></div>
                    <div class="effects-row">${(e.effects||[]).map(ef=>`<span class="effect-tag eff-${ef.type}">${ef.type} ${ef.turns}</span>`).join('')}</div>
                </div>
            `;
        });
    },
    
    log(html){$('#combatLog').innerHTML+=html;$('#combatLog').scrollTop=999999},
    
    victory(){
        $('#combatArena').classList.add('hidden');
        G.combat=false;
        Story.add(`<strong style="color:var(--green-bright)">üéâ ¬°Victoria!</strong>`,'loot');
        let totalLoot=0;
        G.enemies.forEach(e=>{
            if(e.loot){const mp=dX(e.loot[1]-e.loot[0])+e.loot[0];totalLoot+=mp}
            if(e.drops)e.drops.forEach(did=>{if(Math.random()<0.3&&G.p.inv.length<G.p.maxSlots){const it=Data.findItem(did);if(it){G.p.inv.push({...it,uid:genId('i')});Story.add(`+${it.icon} ${it.name}`,'loot')}}});
        });
        G.p.silver+=totalLoot;while(G.p.silver>=99){G.p.silver-=99;G.p.gold++}
        Story.add(`+${totalLoot} MP`,'loot');
        G.enemies=[];Game.updateUI();Game.exploreActions();
    },
    
    defeat(){
        $('#combatArena').classList.add('hidden');
        G.combat=false;
        Story.add('<strong style="color:var(--red-bright)">üíÄ Has sido derrotado...</strong>','combat');
        Game.setActions([{text:'üîÑ Nuevo',fn:()=>Game.new(),cls:'btn-primary'}]);
    },
    
    escape(){
        $('#combatArena').classList.add('hidden');
        G.combat=false;G.enemies=[];
        Story.add('Escapas del combate.','system');
        Game.updateUI();Game.exploreActions();
    }
};

// ==================== INVENTORY ====================
const Inv={
    open(){this.render();openModal('inventoryModal')},
    render(){$('#inventoryInfo').textContent=`${G.p.inv.length}/${G.p.maxSlots}`;const g=$('#inventoryGrid');g.innerHTML='';G.p.inv.forEach(it=>{const s=document.createElement('div');s.className=`inv-slot rarity-${it.rarity||'common'}`;s.innerHTML=`<div class="inv-slot-icon">${sprite(it)}</div><div class="inv-slot-name">${it.name}</div>`;s.onclick=()=>this.detail(it,'inv');g.appendChild(s)});for(let i=G.p.inv.length;i<G.p.maxSlots;i++){const s=document.createElement('div');s.className='inv-slot empty';s.innerHTML='<div class="inv-slot-name" style="color:var(--text-dim)">vac√≠o</div>';g.appendChild(s)}},
    detail(it,ctx){
        G.item=it;$('#detailIcon').innerHTML=sprite(it);$('#detailName').textContent=it.name;$('#detailType').textContent=it.damage?'Arma':it.defense!==undefined?'Armadura':it.type||'Item';$('#detailDesc').textContent=it.desc||'---';
        let st='';if(it.damage)st+=`<div class="item-stat-box"><div class="item-stat-label">Da√±o</div><div class="item-stat-value">${it.damage}</div></div>`;if(it.defense!==undefined)st+=`<div class="item-stat-box"><div class="item-stat-label">Defensa</div><div class="item-stat-value">${it.defense}</div></div>`;if(it.effect&&(it.type==='potion'||it.type==='food'))st+=`<div class="item-stat-box"><div class="item-stat-label">Cura</div><div class="item-stat-value">${it.effect}</div></div>`;if(it.value)st+=`<div class="item-stat-box"><div class="item-stat-label">Valor</div><div class="item-stat-value">${it.value}MP</div></div>`;$('#detailStats').innerHTML=st;
        const canEq=!G.combat&&G.region.type==='safe';let acts='';
        if(ctx.startsWith('eq-')){if(canEq)acts=`<button class="btn btn-danger" onclick="Inv.unequip('${ctx.split('-')[1]}')">‚ùå Desequipar</button>`;else acts='<span style="color:var(--text-dim)">Solo zona segura</span>'}
        else{if(it.damage&&canEq)acts+=`<button class="btn btn-primary" onclick="Inv.equip('weapon')">‚öîÔ∏è Equipar</button>`;if(it.defense!==undefined&&canEq)acts+=`<button class="btn btn-primary" onclick="Inv.equip('armor')">üõ°Ô∏è Equipar</button>`;if(it.type==='potion'||it.type==='food')acts+=`<button class="btn btn-primary" onclick="Inv.use()">‚ú® Usar</button>`;if(it.type==='antidote')acts+=`<button class="btn btn-primary" onclick="Inv.use()">üíä Usar</button>`;if(it.type==='escape'&&G.combat)acts+=`<button class="btn btn-primary" onclick="Inv.use()">üí® Usar</button>`}
        acts+=`<button class="btn" onclick="closeModal('itemDetailModal')">Cerrar</button>`;$('#detailActions').innerHTML=acts;openModal('itemDetailModal');
    },
    equip(slot){const it=G.item;if(!it?.uid)return;closeModal('itemDetailModal');if(slot==='weapon'){if(G.p.weapon?.uid)G.p.inv.push(G.p.weapon);G.p.weapon=it}else{if(G.p.armor?.uid)G.p.inv.push(G.p.armor);G.p.armor=it}G.p.inv=G.p.inv.filter(i=>i.uid!==it.uid);Story.add(`Equipas ${it.icon} ${it.name}.`,'system');toast('Equipado','success');Game.updateUI();this.render()},
    unequip(slot){if(G.p.inv.length>=G.p.maxSlots){toast('Inventario lleno','error');return}closeModal('itemDetailModal');if(slot==='weapon'){if(G.p.weapon?.uid)G.p.inv.push(G.p.weapon);G.p.weapon={name:'Pu√±os',damage:'1d2',icon:'‚úä'}}else{if(G.p.armor?.uid)G.p.inv.push(G.p.armor);G.p.armor={name:'---',defense:0,icon:'üë§'}}Story.add('Guardas equipo.','system');toast('Desequipado','info');Game.updateUI()},
    use(){const it=G.item;if(!it?.uid)return;closeModal('itemDetailModal');closeModal('inventoryModal');if(it.type==='potion'||it.type==='food'){const h=roll(it.effect||'1d4');const a=Math.min(h,G.p.maxHp-G.p.hp);G.p.hp+=a;Story.add(`${it.icon}: <span style="color:var(--green-bright)">+${a}HP</span>`,'system')}else if(it.type==='antidote'){G.p.effects=G.p.effects.filter(e=>e.type!=='poison');Story.add('Veneno curado.','system')}else if(it.type==='escape'&&G.combat){G.p.inv=G.p.inv.filter(i=>i.uid!==it.uid);Combat.escape();return}G.p.inv=G.p.inv.filter(i=>i.uid!==it.uid);Game.updateUI();if(G.combat)Combat.renderEntities()}
};

// ==================== TOWN ====================
const Town={
    npc:null,
    visit(r){const npcs=Data.getNpcsForRegion(r.id);if(!npcs.length)return;$('#townTitle').textContent=`${r.icon} ${r.name}`;const roles={merchant:'Comerciante',blacksmith:'Herrero',alchemist:'Alquimista',innkeeper:'Tabernero',healer:'Curandero'};let h='<div style="display:grid;gap:.4rem">';npcs.forEach(n=>{h+=`<div class="item-card" onclick="Town.interact('${n.id}')"><span class="item-card-icon">${sprite(n)}</span><div class="item-card-info"><div class="item-card-name">${n.name}</div><div class="item-card-stats">${roles[n.role]||n.role}</div></div></div>`});h+='</div>';$('#townContent').innerHTML=h;openModal('townModal')},
    interact(id){const n=Data.find('npcs',id);if(!n)return;closeModal('townModal');this.npc=n;Story.add(`<strong>${n.name}</strong>: "${n.dialogue||'¬°Saludos!'}"`,`dialogue`);if(n.sells?.length)setTimeout(()=>this.shop(n),400);else if(n.role==='healer'){if(G.p.silver>=10){G.p.silver-=10;G.p.hp=G.p.maxHp;G.p.effects=[];Story.add('Curaci√≥n completa. (-10MP)','system')}else Story.add('"No tienes dinero."','dialogue');Game.updateUI()}else if(n.role==='innkeeper'){if(G.p.silver>=5){G.p.silver-=5;const h=Math.floor(G.p.maxHp*0.5);G.p.hp=Math.min(G.p.maxHp,G.p.hp+h);Story.add(`+${h}HP (-5MP)`,'system')}Game.updateUI()}},
    shop(n){$('#shopTitle').textContent=`üè™ ${n.name}`;let h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:.8rem"><div><h4 style="color:var(--gold);margin-bottom:.4rem;font-size:.8rem">Venta</h4><div style="display:grid;gap:.2rem;max-height:180px;overflow-y:auto">';(n.sells||[]).forEach(iid=>{const it=Data.findItem(iid);if(it){const can=G.p.silver>=it.value&&G.p.inv.length<G.p.maxSlots;h+=`<div class="item-card" style="opacity:${can?1:.5}"><span class="item-card-icon">${sprite(it)}</span><div class="item-card-info"><div class="item-card-name">${it.name}</div><div class="item-card-stats">${it.value}MP</div></div><button class="btn btn-sm" onclick="Town.buy('${it.id}')" ${can?'':'disabled'}>Comprar</button></div>`}});h+='</div></div><div><h4 style="color:var(--gold);margin-bottom:.4rem;font-size:.8rem">Vender</h4><div style="display:grid;gap:.2rem;max-height:180px;overflow-y:auto">';G.p.inv.forEach(it=>{const sp=Math.floor((it.value||10)*0.5);h+=`<div class="item-card"><span class="item-card-icon">${sprite(it)}</span><div class="item-card-info"><div class="item-card-name">${it.name}</div><div class="item-card-stats">${sp}MP</div></div><button class="btn btn-sm" onclick="Town.sell('${it.uid}',${sp})">Vender</button></div>`});h+=`</div></div></div><div style="text-align:center;margin-top:.6rem;color:var(--text-dim)">${G.p.gold}MO ${G.p.silver}MP</div>`;$('#shopContent').innerHTML=h;openModal('shopModal')},
    buy(iid){const it=Data.findItem(iid);if(!it||G.p.silver<it.value||G.p.inv.length>=G.p.maxSlots)return;G.p.silver-=it.value;G.p.inv.push({...it,uid:genId('i')});Story.add(`Compras ${it.icon} ${it.name}`,'system');toast('Comprado','success');Game.updateUI();if(this.npc)this.shop(this.npc)},
    sell(uid,price){const it=G.p.inv.find(i=>i.uid===uid);if(!it)return;G.p.inv=G.p.inv.filter(i=>i.uid!==uid);G.p.silver+=price;while(G.p.silver>=99){G.p.silver-=99;G.p.gold++}Story.add(`Vendes ${it.icon} ${it.name}`,'system');toast('Vendido','success');Game.updateUI();if(this.npc)this.shop(this.npc)}
};

// ==================== EDITOR ====================
const Editor={
    clear(t){const f={region:['region-id','region-name','region-icon','region-desc','region-narratives'],race:['race-id','race-name','race-icon','race-sprite','race-hp','race-armor','race-evasion','race-precision','race-damage','race-speed','race-desc'],weapon:['weapon-id','weapon-name','weapon-damage','weapon-icon','weapon-sprite','weapon-value','weapon-desc'],armor:['armor-id','armor-name','armor-defense','armor-icon','armor-sprite','armor-value','armor-desc'],item:['item-id','item-name','item-icon','item-sprite','item-effect','item-value','item-desc'],enemy:['enemy-id','enemy-name','enemy-health','enemy-damage','enemy-difficulty','enemy-armor','enemy-speed','enemy-icon','enemy-sprite','enemy-loot-min','enemy-loot-max','enemy-groupMin','enemy-groupMax','enemy-groupChance','enemy-desc'],pet:['pet-id','pet-name','pet-health','pet-damage','pet-speed','pet-difficulty','pet-icon','pet-sprite','pet-desc'],npc:['npc-id','npc-name','npc-icon','npc-sprite','npc-dialogue']};(f[t]||[]).forEach(id=>{const e=$(`#${id}`);if(e)e.value=''});$$('.multi-select input').forEach(c=>c.checked=false)},
    saveRegion(){const n=$('#region-narratives').value.split('\n').filter(x=>x.trim());const r={id:$('#region-id').value||genId('reg'),name:$('#region-name').value,icon:$('#region-icon').value||'üó∫Ô∏è',type:$('#region-type').value,desc:$('#region-desc').value||'',narratives:n};if(!r.name){toast('Falta nombre','error');return}const i=Data.regions.findIndex(x=>x.id===r.id);if(i>=0)Data.regions[i]=r;else Data.regions.push(r);Data.save();this.renderRegions();this.updateSelects();this.clear('region');toast('Guardado','success')},
    editRegion(id){const r=Data.find('regions',id);if(!r)return;$('#region-id').value=r.id;$('#region-name').value=r.name;$('#region-icon').value=r.icon||'';$('#region-type').value=r.type||'danger';$('#region-desc').value=r.desc||'';$('#region-narratives').value=(r.narratives||[]).join('\n')},
    deleteRegion(id){if(!confirm('¬øEliminar?'))return;Data.regions=Data.regions.filter(r=>r.id!==id);Data.save();this.renderRegions();this.updateSelects();toast('Eliminado','info')},
    saveRace(){const r={id:$('#race-id').value||genId('race'),name:$('#race-name').value,icon:$('#race-icon').value||'üë§',sprite:$('#race-sprite').value||'',bonus:{health:parseInt($('#race-hp').value)||0,armor:parseInt($('#race-armor').value)||0,evasion:parseInt($('#race-evasion').value)||0,precision:parseInt($('#race-precision').value)||0,damage:parseInt($('#race-damage').value)||0,speed:parseInt($('#race-speed').value)||10},desc:$('#race-desc').value||''};if(!r.name){toast('Falta nombre','error');return}const i=Data.races.findIndex(x=>x.id===r.id);if(i>=0)Data.races[i]=r;else Data.races.push(r);Data.save();this.renderRaces();this.clear('race');toast('Guardado','success')},
    editRace(id){const r=Data.find('races',id);if(!r)return;$('#race-id').value=r.id;$('#race-name').value=r.name;$('#race-icon').value=r.icon||'';$('#race-sprite').value=r.sprite||'';$('#race-hp').value=r.bonus?.health||'';$('#race-armor').value=r.bonus?.armor||'';$('#race-evasion').value=r.bonus?.evasion||'';$('#race-precision').value=r.bonus?.precision||'';$('#race-damage').value=r.bonus?.damage||'';$('#race-speed').value=r.bonus?.speed||10;$('#race-desc').value=r.desc||''},
    deleteRace(id){if(!confirm('¬øEliminar?'))return;Data.races=Data.races.filter(r=>r.id!==id);Data.save();this.renderRaces();toast('Eliminado','info')},
    saveWeapon(){const w={id:$('#weapon-id').value||genId('w'),name:$('#weapon-name').value,damage:$('#weapon-damage').value||'1d4',icon:$('#weapon-icon').value||'‚öîÔ∏è',sprite:$('#weapon-sprite').value||'',rarity:$('#weapon-rarity').value,value:parseInt($('#weapon-value').value)||10,effect:$('#weapon-effect').value||null,desc:$('#weapon-desc').value||''};if(!w.name){toast('Falta nombre','error');return}const i=Data.weapons.findIndex(x=>x.id===w.id);if(i>=0)Data.weapons[i]=w;else Data.weapons.push(w);Data.save();this.renderWeapons();this.updateSelects();this.clear('weapon');toast('Guardado','success')},
    saveArmor(){const a={id:$('#armor-id').value||genId('a'),name:$('#armor-name').value,defense:parseInt($('#armor-defense').value)||0,icon:$('#armor-icon').value||'üõ°Ô∏è',sprite:$('#armor-sprite').value||'',rarity:$('#armor-rarity').value,value:parseInt($('#armor-value').value)||10,desc:$('#armor-desc').value||''};if(!a.name){toast('Falta nombre','error');return}const i=Data.armors.findIndex(x=>x.id===a.id);if(i>=0)Data.armors[i]=a;else Data.armors.push(a);Data.save();this.renderArmors();this.updateSelects();this.clear('armor');toast('Guardado','success')},
    saveItem(){const it={id:$('#item-id').value||genId('i'),name:$('#item-name').value,type:$('#item-type').value,icon:$('#item-icon').value||'üì¶',sprite:$('#item-sprite').value||'',effect:$('#item-effect').value||'',value:parseInt($('#item-value').value)||10,rarity:$('#item-rarity').value,desc:$('#item-desc').value||''};if(!it.name){toast('Falta nombre','error');return}const i=Data.items.findIndex(x=>x.id===it.id);if(i>=0)Data.items[i]=it;else Data.items.push(it);Data.save();this.renderItems();this.updateSelects();this.clear('item');toast('Guardado','success')},
    saveEnemy(){const regions=Array.from($$('#enemy-regions input:checked')).map(c=>c.value);const drops=Array.from($$('#enemy-drops input:checked')).map(c=>c.value);if(!regions.length){toast('Selecciona regi√≥n','error');return}const e={id:$('#enemy-id').value||genId('e'),name:$('#enemy-name').value,health:parseInt($('#enemy-health').value)||20,damage:$('#enemy-damage').value||'1d6',difficulty:parseInt($('#enemy-difficulty').value)||10,armor:parseInt($('#enemy-armor').value)||0,speed:parseInt($('#enemy-speed').value)||10,icon:$('#enemy-icon').value||'üëπ',sprite:$('#enemy-sprite').value||'',effect:$('#enemy-effect').value||null,loot:[parseInt($('#enemy-loot-min').value)||5,parseInt($('#enemy-loot-max').value)||20],regions,drops,canGroup:$('#enemy-canGroup').value==='true',groupMin:parseInt($('#enemy-groupMin').value)||2,groupMax:parseInt($('#enemy-groupMax').value)||4,groupChance:parseInt($('#enemy-groupChance').value)||20,desc:$('#enemy-desc').value||''};if(!e.name){toast('Falta nombre','error');return}const i=Data.enemies.findIndex(x=>x.id===e.id);if(i>=0)Data.enemies[i]=e;else Data.enemies.push(e);Data.save();this.renderEnemies();this.clear('enemy');toast('Guardado','success')},
    editEnemy(id){const e=Data.find('enemies',id);if(!e)return;$('#enemy-id').value=e.id;$('#enemy-name').value=e.name;$('#enemy-health').value=e.health||'';$('#enemy-damage').value=e.damage||'';$('#enemy-difficulty').value=e.difficulty||'';$('#enemy-armor').value=e.armor||'';$('#enemy-speed').value=e.speed||10;$('#enemy-icon').value=e.icon||'';$('#enemy-sprite').value=e.sprite||'';$('#enemy-effect').value=e.effect||'';$('#enemy-loot-min').value=e.loot?.[0]||'';$('#enemy-loot-max').value=e.loot?.[1]||'';$('#enemy-canGroup').value=e.canGroup?'true':'false';$('#enemy-groupMin').value=e.groupMin||2;$('#enemy-groupMax').value=e.groupMax||4;$('#enemy-groupChance').value=e.groupChance||20;$('#enemy-desc').value=e.desc||'';setTimeout(()=>{$$('#enemy-regions input').forEach(c=>c.checked=(e.regions||[]).includes(c.value));$$('#enemy-drops input').forEach(c=>c.checked=(e.drops||[]).includes(c.value))},50)},
    savePet(){const regions=Array.from($$('#pet-regions input:checked')).map(c=>c.value);const p={id:$('#pet-id').value||genId('p'),name:$('#pet-name').value,health:parseInt($('#pet-health').value)||20,damage:$('#pet-damage').value||'1d4',speed:parseInt($('#pet-speed').value)||12,difficulty:parseInt($('#pet-difficulty').value)||24,icon:$('#pet-icon').value||'üê∫',sprite:$('#pet-sprite').value||'',regions,desc:$('#pet-desc').value||''};if(!p.name){toast('Falta nombre','error');return}const i=Data.pets.findIndex(x=>x.id===p.id);if(i>=0)Data.pets[i]=p;else Data.pets.push(p);Data.save();this.renderPets();this.clear('pet');toast('Guardado','success')},
    editPet(id){const p=Data.find('pets',id);if(!p)return;$('#pet-id').value=p.id;$('#pet-name').value=p.name;$('#pet-health').value=p.health||'';$('#pet-damage').value=p.damage||'';$('#pet-speed').value=p.speed||12;$('#pet-difficulty').value=p.difficulty||'';$('#pet-icon').value=p.icon||'';$('#pet-sprite').value=p.sprite||'';$('#pet-desc').value=p.desc||'';setTimeout(()=>$$('#pet-regions input').forEach(c=>c.checked=(p.regions||[]).includes(c.value)),50)},
    saveNpc(){const sells=Array.from($$('#npc-sells input:checked')).map(c=>c.value);const n={id:$('#npc-id').value||genId('n'),name:$('#npc-name').value,role:$('#npc-role').value,icon:$('#npc-icon').value||'üßî',sprite:$('#npc-sprite').value||'',region:$('#npc-region').value,dialogue:$('#npc-dialogue').value||'',sells};if(!n.name){toast('Falta nombre','error');return}const i=Data.npcs.findIndex(x=>x.id===n.id);if(i>=0)Data.npcs[i]=n;else Data.npcs.push(n);Data.save();this.renderNpcs();this.clear('npc');toast('Guardado','success')},
    editNpc(id){const n=Data.find('npcs',id);if(!n)return;$('#npc-id').value=n.id;$('#npc-name').value=n.name;$('#npc-role').value=n.role||'merchant';$('#npc-icon').value=n.icon||'';$('#npc-sprite').value=n.sprite||'';$('#npc-region').value=n.region||'';$('#npc-dialogue').value=n.dialogue||'';setTimeout(()=>$$('#npc-sells input').forEach(c=>c.checked=(n.sells||[]).includes(c.value)),50)},
    edit(t,p,id){const it=Data.find(t,id);if(!it)return;Object.keys(it).forEach(k=>{const e=$(`#${p}-${k}`);if(e)e.value=it[k]||''})},
    del(t,id){if(!confirm('¬øEliminar?'))return;Data[t]=Data[t].filter(x=>x.id!==id);Data.save();this.renderAll();toast('Eliminado','info')},
    renderAll(){this.renderRegions();this.renderRaces();this.renderWeapons();this.renderArmors();this.renderItems();this.renderEnemies();this.renderPets();this.renderNpcs();this.updateSelects()},
    renderRegions(){$('#regions-list').innerHTML=Data.regions.map(r=>`<div class="item-card" onclick="Editor.editRegion('${r.id}')"><span class="item-card-icon">${r.icon}</span><div class="item-card-info"><div class="item-card-name">${r.name}</div><div class="item-card-stats">${r.type==='safe'?'üè†':'‚ö†Ô∏è'}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editRegion('${r.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.deleteRegion('${r.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderRaces(){$('#races-list').innerHTML=Data.races.map(r=>`<div class="item-card" onclick="Editor.editRace('${r.id}')"><span class="item-card-icon">${sprite(r)}</span><div class="item-card-info"><div class="item-card-name">${r.name}</div><div class="item-card-stats">Vel:${r.bonus?.speed||10}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editRace('${r.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.deleteRace('${r.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderWeapons(){$('#weapons-list').innerHTML=Data.weapons.map(w=>`<div class="item-card" onclick="Editor.edit('weapons','weapon','${w.id}')"><span class="item-card-icon">${sprite(w)}</span><div class="item-card-info"><div class="item-card-name">${w.name}</div><div class="item-card-stats">${w.damage}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.edit('weapons','weapon','${w.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('weapons','${w.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderArmors(){$('#armors-list').innerHTML=Data.armors.map(a=>`<div class="item-card" onclick="Editor.edit('armors','armor','${a.id}')"><span class="item-card-icon">${sprite(a)}</span><div class="item-card-info"><div class="item-card-name">${a.name}</div><div class="item-card-stats">Def:${a.defense}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.edit('armors','armor','${a.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('armors','${a.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderItems(){$('#items-list').innerHTML=Data.items.map(i=>`<div class="item-card" onclick="Editor.edit('items','item','${i.id}')"><span class="item-card-icon">${sprite(i)}</span><div class="item-card-info"><div class="item-card-name">${i.name}</div><div class="item-card-stats">${i.type}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.edit('items','item','${i.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('items','${i.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderEnemies(){$('#enemies-list').innerHTML=Data.enemies.map(e=>`<div class="item-card" onclick="Editor.editEnemy('${e.id}')"><span class="item-card-icon">${sprite(e)}</span><div class="item-card-info"><div class="item-card-name">${e.name}</div><div class="item-card-stats">HP:${e.health} Vel:${e.speed||10} ${e.canGroup?'üë•':'üë§'}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editEnemy('${e.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('enemies','${e.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderPets(){$('#pets-list').innerHTML=Data.pets.map(p=>`<div class="item-card" onclick="Editor.editPet('${p.id}')"><span class="item-card-icon">${sprite(p)}</span><div class="item-card-info"><div class="item-card-name">${p.name}</div><div class="item-card-stats">Vel:${p.speed||12}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editPet('${p.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('pets','${p.id}')">üóëÔ∏è</button></div></div>`).join('')},
    renderNpcs(){$('#npcs-list').innerHTML=Data.npcs.map(n=>`<div class="item-card" onclick="Editor.editNpc('${n.id}')"><span class="item-card-icon">${sprite(n)}</span><div class="item-card-info"><div class="item-card-name">${n.name}</div><div class="item-card-stats">${n.role}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();Editor.editNpc('${n.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();Editor.del('npcs','${n.id}')">üóëÔ∏è</button></div></div>`).join('')},
    updateSelects(){const dr=Data.regions.filter(r=>r.type==='danger');const rh=dr.map(r=>`<label><input type="checkbox" value="${r.id}"> ${r.icon} ${r.name}</label>`).join('');$('#enemy-regions').innerHTML=rh;$('#pet-regions').innerHTML=rh;const sr=Data.regions.filter(r=>r.type==='safe');$('#npc-region').innerHTML=sr.map(r=>`<option value="${r.id}">${r.icon} ${r.name}</option>`).join('');const all=[...Data.weapons,...Data.armors,...Data.items];const ih=all.map(it=>`<label><input type="checkbox" value="${it.id}"> ${it.icon||'üì¶'} ${it.name}</label>`).join('');$('#enemy-drops').innerHTML=ih;$('#npc-sells').innerHTML=ih}
};

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded',()=>{
    FB.init();Data.load();Editor.renderAll();Game.init();
    $$('.nav-btn').forEach(b=>b.addEventListener('click',()=>{$$('.nav-btn').forEach(x=>x.classList.remove('active'));$$('.tab-content').forEach(x=>x.classList.remove('active'));b.classList.add('active');$(`#tab-${b.dataset.tab}`).classList.add('active')}));
    $$('.editor-tab').forEach(t=>t.addEventListener('click',()=>{$$('.editor-tab').forEach(x=>x.classList.remove('active'));$$('.editor-section').forEach(x=>x.classList.remove('active'));t.classList.add('active');$(`#editor-${t.dataset.editor}`).classList.add('active');Editor.updateSelects()}));
    $$('.modal-close').forEach(b=>b.addEventListener('click',()=>closeModal(b.dataset.close)));
    $$('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')}));
    $('#weaponSlot').addEventListener('click',()=>{if(G.combat||G.region.type!=='safe'){toast('Solo zona segura','error');return}if(G.p.weapon?.uid)Inv.detail(G.p.weapon,'eq-weapon')});
    $('#armorSlot').addEventListener('click',()=>{if(G.combat||G.region.type!=='safe'){toast('Solo zona segura','error');return}if(G.p.armor?.uid)Inv.detail(G.p.armor,'eq-armor')});
});
</script>
</body>
</html>
