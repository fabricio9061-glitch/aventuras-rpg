<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aventuras de Acero y Runas</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg-dark: #0a0908;
            --bg-panel: #1a1614;
            --bg-panel-light: #2a2320;
            --bg-input: #151210;
            --gold: #d4a437;
            --gold-dim: #a67c00;
            --gold-bright: #ffd700;
            --red: #8b0000;
            --red-bright: #dc143c;
            --green: #2d5a27;
            --green-bright: #4caf50;
            --blue: #1e3a5f;
            --blue-bright: #4a9eff;
            --purple: #4a1a6b;
            --purple-bright: #9c27b0;
            --orange: #ff6b35;
            --text: #e8dcc4;
            --text-dim: #8a8078;
            --border: #3d3530;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Crimson Text', Georgia, serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }

        .main-nav {
            display: flex;
            justify-content: center;
            background: var(--bg-panel);
            border-bottom: 2px solid var(--gold-dim);
            position: sticky;
            top: 0;
            z-index: 50;
            flex-wrap: wrap;
        }

        .nav-btn {
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            padding: 0.5rem 0.9rem;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-btn:hover { color: var(--gold); }
        .nav-btn.active { color: var(--gold-bright); background: rgba(212,164,55,0.15); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .firebase-status {
            position: fixed;
            top: 0.3rem;
            right: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.6rem;
            background: var(--bg-panel);
            padding: 0.1rem 0.3rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            z-index: 100;
        }

        .status-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--red); }
        .status-dot.connected { background: var(--green-bright); }

        /* Game Layout - ORIGINAL */
        .game-container {
            display: grid;
            grid-template-columns: 1fr 280px;
            grid-template-rows: 1fr auto;
            gap: 0.5rem;
            max-width: 1100px;
            margin: 0 auto;
            padding: 0.5rem;
            min-height: calc(100vh - 38px);
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .panel-title {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            color: var(--gold);
            margin-bottom: 0.4rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* Story Panel - LEFT SIDE */
        .story-panel {
            grid-row: 1;
            grid-column: 1;
            display: flex;
            flex-direction: column;
            max-height: 70vh;
        }

        .story-content {
            flex: 1;
            overflow-y: auto;
            line-height: 1.55;
            font-size: 0.88rem;
            padding-right: 0.3rem;
        }

        .story-content::-webkit-scrollbar { width: 3px; }
        .story-content::-webkit-scrollbar-thumb { background: var(--gold-dim); }

        .story-entry {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 3px;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; } }

        .story-narrative {
            background: linear-gradient(135deg, rgba(30,25,22,0.95), rgba(45,38,33,0.8));
            border-left: 3px solid var(--gold-dim);
            font-style: italic;
        }

        .story-combat { background: rgba(139,0,0,0.18); border-left: 3px solid var(--red); }
        .story-loot { background: rgba(212,164,55,0.18); border-left: 3px solid var(--gold); }
        .story-system { background: rgba(74,158,255,0.12); border-left: 3px solid var(--blue-bright); font-size: 0.8rem; }
        .story-trap { background: rgba(255,107,53,0.18); border-left: 3px solid var(--orange); }
        .story-dialogue { background: rgba(156,39,176,0.12); border-left: 3px solid var(--purple-bright); }

        /* Character Panel - RIGHT SIDE */
        .char-panel {
            grid-row: 1;
            grid-column: 2;
            font-size: 0.75rem;
            overflow-y: auto;
            max-height: 70vh;
        }

        .char-section { margin-bottom: 0.4rem; }

        .char-header { display: flex; align-items: center; gap: 0.35rem; margin-bottom: 0.3rem; }
        .char-avatar {
            font-size: 1.5rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-dark);
            border: 2px solid var(--gold-dim);
            border-radius: 4px;
        }

        .char-name { font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--gold-bright); }
        .char-race { font-size: 0.65rem; color: var(--text-dim); }

        .health-section .bar-outer {
            height: 14px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .health-section .bar-inner { height: 100%; transition: width 0.4s; }
        .health-section .bar-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 0.6rem;
            color: white;
            text-shadow: 1px 1px black;
            top: 50%;
            transform: translateY(-50%);
        }

        .hp-high { background: linear-gradient(180deg, var(--green-bright), var(--green)); }
        .hp-medium { background: linear-gradient(180deg, var(--gold-bright), var(--gold-dim)); }
        .hp-low { background: linear-gradient(180deg, var(--orange), #cc4400); }
        .hp-critical { background: linear-gradient(180deg, var(--red-bright), var(--red)); animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.7; } }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.2rem; }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.15rem 0.25rem;
            background: var(--bg-panel-light);
            border-radius: 2px;
            font-size: 0.65rem;
        }
        .stat-label { color: var(--text-dim); }
        .stat-value { color: var(--gold); }

        .equip-slot {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem;
            background: var(--bg-panel-light);
            border-radius: 3px;
            margin-bottom: 0.2rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .equip-slot:hover:not(.disabled) { border-color: var(--gold-dim); background: var(--bg-dark); }
        .equip-slot.disabled { opacity: 0.5; cursor: not-allowed; }

        .equip-icon { font-size: 1rem; width: 22px; text-align: center; }
        .equip-icon img { width: 22px; height: 22px; object-fit: contain; }
        .equip-name { font-size: 0.7rem; }
        .equip-stats { font-size: 0.6rem; color: var(--text-dim); }

        .currency-row { display: flex; gap: 0.5rem; font-size: 0.75rem; }
        .coin-gold { color: var(--gold-bright); }
        .coin-silver { color: #c0c0c0; }

        .location-badge {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.2rem 0.4rem;
            font-size: 0.65rem;
            text-align: center;
        }
        .location-badge.safe { border-color: var(--green); color: var(--green-bright); }
        .location-badge.danger { border-color: var(--red); color: var(--red-bright); }

        /* Actions Panel - BOTTOM */
        .actions-panel { grid-column: 1 / -1; grid-row: 2; }
        .actions-grid { display: flex; flex-wrap: wrap; gap: 0.35rem; }

        .action-btn {
            font-family: 'Cinzel', serif;
            font-size: 0.7rem;
            padding: 0.35rem 0.7rem;
            background: var(--bg-panel-light);
            border: 1px solid var(--gold-dim);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 2px;
        }

        .action-btn:hover:not(:disabled) { background: var(--gold-dim); color: var(--bg-dark); transform: translateY(-1px); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn.primary { background: var(--gold-dim); color: var(--bg-dark); }
        .action-btn.danger { border-color: var(--red); color: var(--red-bright); }
        .action-btn.danger:hover:not(:disabled) { background: var(--red); color: white; }

        /* Combat Arena */
        .combat-arena {
            display: none;
            grid-column: 1 / -1;
            grid-row: 1;
            background: linear-gradient(180deg, rgba(139,0,0,0.2), transparent);
            border: 2px solid var(--red);
            border-radius: 6px;
            padding: 0.6rem;
        }

        .combat-arena.active { display: block; }

        .combat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid var(--red);
        }

        .combat-title { font-family: 'Cinzel', serif; font-size: 0.85rem; color: var(--red-bright); }
        .turn-indicator { background: var(--red); color: white; padding: 0.15rem 0.5rem; border-radius: 3px; font-family: 'Cinzel', serif; font-size: 0.7rem; }

        .combat-main { display: grid; grid-template-columns: 1fr 260px; gap: 0.6rem; }

        .combatants-row { display: flex; justify-content: space-around; align-items: center; gap: 0.5rem; margin-bottom: 0.4rem; }

        .combatant {
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 5px;
            padding: 0.4rem;
            text-align: center;
            min-width: 120px;
        }

        .combatant.player { border-color: var(--gold-dim); }
        .combatant.enemy { border-color: var(--red); }

        .combatant-sprite { font-size: 1.8rem; margin-bottom: 0.15rem; }
        .combatant-sprite img { width: 56px; height: 56px; object-fit: contain; }
        .combatant-name { font-family: 'Cinzel', serif; font-size: 0.8rem; }
        .combatant-stats { font-size: 0.65rem; color: var(--text-dim); margin-bottom: 0.25rem; }

        .hp-bar-container {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 3px;
            height: 16px;
            position: relative;
            overflow: hidden;
        }

        .hp-bar-fill { height: 100%; transition: width 0.4s; }
        .hp-bar-text {
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 0.6rem;
            color: white;
            text-shadow: 1px 1px 1px black;
            top: 50%;
            transform: translateY(-50%);
        }

        .vs-icon { font-size: 1.1rem; color: var(--gold); }

        .effects-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.15rem; margin-top: 0.25rem; min-height: 16px; }
        .effect-tag { font-size: 0.55rem; padding: 0.08rem 0.2rem; border-radius: 2px; }
        .eff-bleed { background: rgba(139,0,0,0.6); border: 1px solid var(--red); }
        .eff-poison { background: rgba(0,100,0,0.6); border: 1px solid var(--green-bright); }
        .eff-fire { background: rgba(255,100,0,0.5); border: 1px solid orange; }

        .combat-log {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            max-height: 180px;
        }

        .combat-log-header { background: var(--bg-panel-light); padding: 0.3rem; font-family: 'Cinzel', serif; font-size: 0.65rem; color: var(--gold); border-bottom: 1px solid var(--border); }
        .combat-log-content { flex: 1; overflow-y: auto; padding: 0.3rem; font-size: 0.7rem; }
        .log-turn-header { background: var(--bg-panel-light); color: var(--gold); padding: 0.2rem; margin: 0.2rem -0.3rem; text-align: center; font-size: 0.65rem; }
        .log-entry { padding: 0.15rem 0; border-bottom: 1px dashed rgba(255,255,255,0.08); }
        .log-section { margin: 0.15rem 0; padding-left: 0.3rem; border-left: 2px solid var(--border); }
        .log-section.player-action { border-left-color: var(--gold-dim); }
        .log-section.enemy-action { border-left-color: var(--red); }
        .log-damage { color: var(--orange); }
        .log-heal { color: var(--green-bright); }
        .log-miss { color: var(--text-dim); font-style: italic; }
        .log-crit { color: var(--gold-bright); font-weight: bold; }
        .log-dice { color: var(--blue-bright); font-family: monospace; }

        .combat-actions {
            display: flex;
            justify-content: center;
            gap: 0.35rem;
            flex-wrap: wrap;
            margin-top: 0.4rem;
            padding-top: 0.4rem;
            border-top: 1px solid var(--border);
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 100;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 0.75rem;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-panel);
            border: 2px solid var(--gold-dim);
            border-radius: 6px;
            padding: 0.85rem;
            max-width: 550px;
            width: 100%;
            max-height: 82vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-large { max-width: 850px; }

        .modal-close {
            position: absolute;
            top: 0.3rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.1rem;
            cursor: pointer;
        }
        .modal-close:hover { color: var(--gold); }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            color: var(--gold);
            margin-bottom: 0.6rem;
            text-align: center;
            padding-bottom: 0.35rem;
            border-bottom: 1px solid var(--border);
        }

        /* Item Detail */
        .item-detail { text-align: center; }
        .item-detail-icon { font-size: 3rem; margin-bottom: 0.3rem; }
        .item-detail-icon img { width: 72px; height: 72px; object-fit: contain; }
        .item-detail-name { font-family: 'Cinzel', serif; font-size: 1.1rem; color: var(--gold-bright); }
        .item-detail-type { color: var(--text-dim); font-size: 0.75rem; margin-bottom: 0.6rem; }
        .item-detail-desc { background: var(--bg-dark); padding: 0.6rem; border-radius: 4px; margin-bottom: 0.6rem; text-align: left; font-size: 0.8rem; }
        .item-detail-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 0.35rem; margin-bottom: 0.6rem; }
        .item-stat { background: var(--bg-panel-light); padding: 0.35rem; border-radius: 3px; }
        .item-stat-label { font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; }
        .item-stat-value { font-size: 0.85rem; color: var(--gold); font-family: 'Cinzel', serif; }
        .item-detail-actions { display: flex; gap: 0.35rem; justify-content: center; flex-wrap: wrap; }

        /* Inventory */
        .inventory-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.25rem; }
        .inv-slot {
            aspect-ratio: 1;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            padding: 0.1rem;
        }
        .inv-slot:hover { border-color: var(--gold-dim); transform: scale(1.03); }
        .inv-slot-icon { font-size: 1.3rem; }
        .inv-slot-icon img { width: 28px; height: 28px; object-fit: contain; }
        .inv-slot-name { font-size: 0.48rem; text-align: center; color: var(--text-dim); margin-top: 0.08rem; }
        .inv-slot-empty { color: var(--text-dim); font-size: 0.5rem; }
        .rarity-common { border-color: #555; }
        .rarity-rare { border-color: var(--blue-bright); }
        .rarity-epic { border-color: var(--purple-bright); }
        .rarity-legendary { border-color: var(--gold-bright); box-shadow: 0 0 4px var(--gold); }

        /* Editor */
        .editor-container { max-width: 1050px; margin: 0 auto; padding: 0.6rem; }
        .editor-tabs { display: flex; gap: 0.15rem; flex-wrap: wrap; background: var(--bg-panel); padding: 0.25rem; border-radius: 4px; margin-bottom: 0.5rem; }
        .editor-tab {
            padding: 0.3rem 0.6rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            cursor: pointer;
            font-family: 'Cinzel', serif;
            font-size: 0.65rem;
            border-radius: 2px;
        }
        .editor-tab:hover { border-color: var(--gold-dim); color: var(--gold); }
        .editor-tab.active { background: var(--gold-dim); color: var(--bg-dark); }

        .editor-section { display: none; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 0.65rem; }
        .editor-section.active { display: block; }
        .editor-section h3 { font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 0.5rem; font-size: 0.85rem; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.4rem; margin-bottom: 0.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.12rem; }
        .form-group label { font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea {
            background: var(--bg-input);
            border: 1px solid var(--border);
            padding: 0.3rem;
            color: var(--text);
            font-size: 0.75rem;
            border-radius: 3px;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--gold-dim); }
        .form-actions { display: flex; gap: 0.35rem; justify-content: flex-end; padding-top: 0.35rem; border-top: 1px solid var(--border); }

        .items-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.3rem; margin-top: 0.5rem; max-height: 250px; overflow-y: auto; }
        .item-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.3rem;
            display: flex;
            gap: 0.3rem;
            align-items: center;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .item-card:hover { border-color: var(--gold-dim); }
        .item-card.base-item { border-left: 2px solid var(--blue-bright); }
        .item-card-icon { font-size: 1.1rem; width: 24px; text-align: center; }
        .item-card-icon img { width: 24px; height: 24px; object-fit: contain; }
        .item-card-info { flex: 1; }
        .item-card-name { color: var(--gold); font-size: 0.75rem; }
        .item-card-stats { color: var(--text-dim); font-size: 0.6rem; }
        .item-card-actions { display: flex; gap: 0.15rem; }

        .icon-btn { background: none; border: 1px solid var(--border); color: var(--text-dim); padding: 0.12rem 0.2rem; cursor: pointer; font-size: 0.55rem; border-radius: 2px; }
        .icon-btn:hover { border-color: var(--gold-dim); color: var(--gold); }
        .icon-btn.delete:hover { border-color: var(--red); color: var(--red-bright); }

        .multi-select { background: var(--bg-input); border: 1px solid var(--border); border-radius: 3px; padding: 0.3rem; max-height: 80px; overflow-y: auto; font-size: 0.7rem; }
        .multi-select label { display: flex; align-items: center; gap: 0.3rem; padding: 0.08rem; cursor: pointer; }

        /* Rules */
        .rules-container { max-width: 900px; margin: 0 auto; padding: 0.6rem; }
        .rules-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0.5rem; }
        .rules-section { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 6px; padding: 0.6rem; }
        .rules-section h3 { font-family: 'Cinzel', serif; color: var(--gold); margin-bottom: 0.35rem; font-size: 0.85rem; }
        .rules-section p, .rules-section li { font-size: 0.78rem; margin-bottom: 0.2rem; }
        .rules-section ul { padding-left: 1rem; }
        .rules-table { width: 100%; border-collapse: collapse; margin: 0.25rem 0; font-size: 0.72rem; }
        .rules-table th, .rules-table td { border: 1px solid var(--border); padding: 0.2rem 0.3rem; text-align: left; }
        .rules-table th { background: var(--bg-panel-light); color: var(--gold); }
        .highlight-box { background: var(--bg-dark); border-left: 3px solid var(--gold); padding: 0.4rem; margin: 0.25rem 0; font-size: 0.78rem; }

        /* Toast */
        .toast-container { position: fixed; top: 2.2rem; right: 0.6rem; z-index: 200; }
        .toast { padding: 0.35rem 0.7rem; border-radius: 3px; margin-bottom: 0.25rem; animation: slideIn 0.3s, fadeOut 0.3s 2.5s forwards; font-size: 0.75rem; }
        @keyframes slideIn { from { transform: translateX(100%); } }
        @keyframes fadeOut { to { opacity: 0; } }
        .toast.success { background: var(--green); }
        .toast.error { background: var(--red); }
        .toast.info { background: var(--blue); }

        /* Dice */
        .dice-display { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 1rem 1.25rem; border-radius: 8px; border: 2px solid var(--gold-dim); text-align: center; z-index: 150; }
        .dice-display.active { display: block; }
        .dice-icon { font-size: 2.2rem; animation: roll 0.4s; }
        @keyframes roll { 0% { transform: rotate(0) scale(0.5); } 50% { transform: rotate(180deg) scale(1.2); } 100% { transform: rotate(360deg) scale(1); } }
        .dice-label { font-size: 0.7rem; color: var(--text-dim); }
        .dice-result { font-family: 'Cinzel', serif; font-size: 1.6rem; color: var(--gold-bright); }
        .dice-result.crit { color: var(--red-bright); text-shadow: 0 0 8px var(--red); }

        @media (max-width: 768px) {
            .game-container { grid-template-columns: 1fr; }
            .story-panel { grid-column: 1; }
            .char-panel { grid-column: 1; grid-row: 2; max-height: none; }
            .actions-panel { grid-row: 3; }
            .combat-main { grid-template-columns: 1fr; }
            .combatants-row { flex-direction: column; }
            .rules-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="firebase-status"><div class="status-dot" id="fbDot"></div><span id="fbText">...</span></div>

    <nav class="main-nav">
        <button class="nav-btn active" onclick="switchTab('game')">‚öîÔ∏è Juego</button>
        <button class="nav-btn" onclick="switchTab('rules')">üìú Reglas</button>
        <button class="nav-btn" onclick="switchTab('editor')">üõ†Ô∏è Editor</button>
    </nav>

    <!-- GAME TAB -->
    <div class="tab-content active" id="gameTab">
        <div class="game-container">
            <div class="combat-arena" id="combatArena">
                <div class="combat-header">
                    <div class="combat-title">‚öîÔ∏è COMBATE</div>
                    <div class="turn-indicator">Turno <span id="turnNumber">1</span></div>
                </div>
                <div class="combat-main">
                    <div>
                        <div class="combatants-row">
                            <div class="combatant player">
                                <div class="combatant-sprite" id="pSprite">üßô</div>
                                <div class="combatant-name" id="pCombatName">Jugador</div>
                                <div class="combatant-stats">‚öîÔ∏è <span id="pCombatDmg">1d4</span> | üõ°Ô∏è <span id="pCombatDef">0</span></div>
                                <div class="hp-bar-container"><div class="hp-bar-text" id="pHpText">20/20</div><div class="hp-bar-fill hp-high" id="pHpBar" style="width:100%"></div></div>
                                <div class="effects-row" id="pEffects"></div>
                            </div>
                            <div class="vs-icon">‚öî</div>
                            <div class="combatant enemy">
                                <div class="combatant-sprite" id="eSprite">üëπ</div>
                                <div class="combatant-name" id="eCombatName">Enemigo</div>
                                <div class="combatant-stats">‚öîÔ∏è <span id="eCombatDmg">1d6</span> | Dif: <span id="eCombatDiff">10</span></div>
                                <div class="hp-bar-container"><div class="hp-bar-text" id="eHpText">30/30</div><div class="hp-bar-fill hp-high" id="eHpBar" style="width:100%"></div></div>
                                <div class="effects-row" id="eEffects"></div>
                            </div>
                        </div>
                        <div class="combat-actions" id="combatActions"></div>
                    </div>
                    <div class="combat-log">
                        <div class="combat-log-header">üìú Registro</div>
                        <div class="combat-log-content" id="combatLogContent"></div>
                    </div>
                </div>
            </div>

            <main class="story-panel panel">
                <h2 class="panel-title">üìñ Cr√≥nica</h2>
                <div class="story-content" id="storyContent"></div>
            </main>

            <aside class="char-panel panel">
                <h2 class="panel-title">Personaje</h2>
                <div class="char-section">
                    <div class="char-header">
                        <div class="char-avatar" id="charAvatar">üßô</div>
                        <div><div class="char-name" id="charName">---</div><div class="char-race" id="charRace">---</div></div>
                    </div>
                </div>
                <div class="char-section health-section">
                    <div class="bar-outer"><div class="bar-text" id="hpDisplay">0/0</div><div class="bar-inner hp-high" id="hpBar" style="width:100%"></div></div>
                </div>
                <div class="char-section"><div class="location-badge" id="locationBadge">üìç Zona Segura</div></div>
                <div class="char-section">
                    <div class="stats-grid">
                        <div class="stat-item"><span class="stat-label">Armadura</span><span class="stat-value" id="statArm">0</span></div>
                        <div class="stat-item"><span class="stat-label">Evasi√≥n</span><span class="stat-value" id="statEva">0</span></div>
                        <div class="stat-item"><span class="stat-label">Precisi√≥n</span><span class="stat-value" id="statPrec">0</span></div>
                        <div class="stat-item"><span class="stat-label">Da√±o+</span><span class="stat-value" id="statDmg">0</span></div>
                    </div>
                </div>
                <div class="char-section">
                    <div class="equip-slot" id="weaponSlot" onclick="handleEquipClick('weapon')">
                        <div class="equip-icon" id="weaponIcon">‚öîÔ∏è</div>
                        <div><div class="equip-name" id="weaponName">---</div><div class="equip-stats" id="weaponStats">---</div></div>
                    </div>
                    <div class="equip-slot" id="armorSlot" onclick="handleEquipClick('armor')">
                        <div class="equip-icon" id="armorIcon">üõ°Ô∏è</div>
                        <div><div class="equip-name" id="armorName">---</div><div class="equip-stats" id="armorStats">---</div></div>
                    </div>
                </div>
                <div class="char-section">
                    <div class="currency-row">
                        <span><span class="coin-gold">‚óè</span> <span id="goldAmt">0</span> MO</span>
                        <span><span class="coin-silver">‚óè</span> <span id="silverAmt">0</span> MP</span>
                    </div>
                </div>
                <div class="char-section" id="petSection" style="display:none;">
                    <div class="panel-title" style="font-size:0.6rem;">Compa√±ero</div>
                    <div id="petDisplay"></div>
                </div>
            </aside>

            <nav class="actions-panel panel">
                <div class="actions-grid" id="actionsGrid"></div>
            </nav>
        </div>
    </div>

    <!-- RULES TAB - COMPLETE -->
    <div class="tab-content" id="rulesTab">
        <div class="rules-container">
            <h2 style="text-align:center;color:var(--gold);font-family:'Cinzel',serif;margin-bottom:0.6rem;">üìú Reglas Completas</h2>
            <div class="rules-grid">
                <div class="rules-section">
                    <h3>üé≠ 1. Creaci√≥n de Personaje</h3>
                    <p><strong>Raza (D5):</strong></p>
                    <ul>
                        <li><strong>1 - Humano:</strong> +1 salud m√°xima</li>
                        <li><strong>2 - Elfo:</strong> +1 precisi√≥n en ataques</li>
                        <li><strong>3 - Enano:</strong> +1 armadura</li>
                        <li><strong>4 - Orco:</strong> +1 da√±o f√≠sico</li>
                        <li><strong>5 - Mediano:</strong> +1 evasi√≥n</li>
                    </ul>
                    <p><strong>Arma inicial (D4):</strong></p>
                    <ul>
                        <li>1: Daga (1d4) | 2: Espada corta (1d6)</li>
                        <li>3: Hacha (1d6) | 4: Bast√≥n (1d4)</li>
                    </ul>
                    <p><strong>Armadura inicial (D4):</strong></p>
                    <ul>
                        <li>1: T√∫nica cuero (1) | 2: Cuero reforzado (2)</li>
                        <li>3: Cota malla (3) | 4: T√∫nica tela (0)</li>
                    </ul>
                    <p><strong>Objeto inicial (D6):</strong> Poci√≥n, Ant√≠doto, Bomba humo, Pergamino, Linterna, Carne</p>
                    <p><strong>Inicio:</strong> 20 MP, 10 espacios inventario</p>
                </div>

                <div class="rules-section">
                    <h3>‚öîÔ∏è 2. Sistema de Combate</h3>
                    <div class="highlight-box">
                        <strong>Atacar:</strong> D20 + precisi√≥n ‚â• dificultad enemigo<br>
                        <strong>Da√±o:</strong> Dado del arma + bonos<br>
                        <strong>Cr√≠tico (20 natural):</strong> Da√±o √ó2<br>
                        <strong>Pifia (1 natural):</strong> Fallo autom√°tico
                    </div>
                    <table class="rules-table">
                        <tr><th>Tipo Enemigo</th><th>Dificultad</th></tr>
                        <tr><td>D√©bil</td><td>6-8</td></tr>
                        <tr><td>Moderado</td><td>9-12</td></tr>
                        <tr><td>Fuerte</td><td>13-15</td></tr>
                        <tr><td>√âpico</td><td>16-18</td></tr>
                        <tr><td>Legendario</td><td>19-20</td></tr>
                    </table>
                    <div class="highlight-box">
                        <strong>Esquivar:</strong> D20 + evasi√≥n ‚â• 12<br>
                        <strong>Armadura:</strong> Reduce da√±o recibido<br>
                        <strong>Defender:</strong> +4 a evasi√≥n este turno
                    </div>
                </div>

                <div class="rules-section">
                    <h3>ü©∏ 3. Efectos de Estado</h3>
                    <table class="rules-table">
                        <tr><th>Efecto</th><th>Da√±o/Turno</th><th>Duraci√≥n</th><th>Acumula</th></tr>
                        <tr><td>ü©∏ Sangrado</td><td>1</td><td>3 turnos</td><td>S√≠ (√ó3)</td></tr>
                        <tr><td>‚ò†Ô∏è Veneno</td><td>2</td><td>2 turnos</td><td>S√≠ (√ó2)</td></tr>
                        <tr><td>üî• Fuego</td><td>1d4</td><td>2 turnos</td><td>No</td></tr>
                        <tr><td>‚ùÑÔ∏è Fr√≠o</td><td>-evasi√≥n</td><td>2 turnos</td><td>No</td></tr>
                        <tr><td>‚ö° El√©ctrico</td><td>1d6 +aturdir</td><td>1 turno</td><td>No</td></tr>
                    </table>
                    <p>Los efectos que acumulan aumentan su da√±o por cada aplicaci√≥n.</p>
                </div>

                <div class="rules-section">
                    <h3>ü™§ 4. Trampas</h3>
                    <p>Al explorar puedes encontrar trampas:</p>
                    <div class="highlight-box">
                        <strong>1. Detectar:</strong> D20 ‚â• dificultad de trampa<br>
                        <strong>2. Esquivar:</strong> D20 + evasi√≥n ‚â• 12<br>
                        <strong>3. Desactivar:</strong> D20 ‚â• 15 (recompensa MP)
                    </div>
                    <table class="rules-table">
                        <tr><th>Trampa</th><th>Da√±o</th><th>Efecto</th><th>Detectar</th></tr>
                        <tr><td>P√∫as ocultas</td><td>1d6</td><td>Sangrado</td><td>10</td></tr>
                        <tr><td>Dardo venenoso</td><td>1d4</td><td>Veneno</td><td>12</td></tr>
                        <tr><td>Foso</td><td>2d6</td><td>-</td><td>8</td></tr>
                        <tr><td>Runa explosiva</td><td>2d8</td><td>Fuego</td><td>14</td></tr>
                    </table>
                </div>

                <div class="rules-section">
                    <h3>üéí 5. Equipamiento</h3>
                    <div class="highlight-box">
                        <strong>‚ö†Ô∏è Regla importante:</strong><br>
                        Solo puedes equipar/desequipar armas y armaduras en <strong>zonas seguras</strong> (pueblo, refugio, descanso).<br>
                        Durante combate o en zonas de peligro NO puedes cambiar equipo.
                    </div>
                    <p><strong>Inventario:</strong></p>
                    <ul>
                        <li>Inicio: 10 espacios</li>
                        <li>Mochila peque√±a: +5 espacios (10 MP)</li>
                        <li>Mochila mediana: +10 espacios (25 MP)</li>
                        <li>Mochila grande: +20 espacios (50 MP)</li>
                    </ul>
                </div>

                <div class="rules-section">
                    <h3>üí∞ 6. Econom√≠a</h3>
                    <div class="highlight-box">
                        <strong>99 MP (Monedas Plata) = 1 MO (Moneda Oro)</strong>
                    </div>
                    <p><strong>Precios aproximados:</strong></p>
                    <ul>
                        <li>Objetos comunes: 5-20 MP</li>
                        <li>Objetos raros: 1-5 MO</li>
                        <li>Objetos √©picos: 10-20 MO</li>
                        <li>Legendarios: No se venden</li>
                    </ul>
                    <p><strong>Vender:</strong> 50% del valor original</p>
                </div>

                <div class="rules-section">
                    <h3>üê∫ 7. Domesticaci√≥n</h3>
                    <p>Puedes domesticar animales usando <strong>carne</strong>:</p>
                    <table class="rules-table">
                        <tr><th>Tipo</th><th>Dado</th><th>√âxito</th></tr>
                        <tr><td>Com√∫n (lobo, √°guila)</td><td>D24</td><td>‚â• 60%</td></tr>
                        <tr><td>Raro (oso)</td><td>D30</td><td>‚â• 60%</td></tr>
                        <tr><td>√âpico (tigre)</td><td>D60</td><td>‚â• 60%</td></tr>
                        <tr><td>Legendario (drag√≥n)</td><td>D100</td><td>‚â• 60%</td></tr>
                    </table>
                    <div class="highlight-box">
                        Solo 1 mascota a la vez. Si muere, no revive.<br>
                        Las mascotas atacan autom√°ticamente en combate.
                    </div>
                </div>

                <div class="rules-section">
                    <h3>‚ò†Ô∏è 8. Muerte</h3>
                    <div class="highlight-box" style="border-color:var(--red);">
                        <strong>Si tu HP llega a 0:</strong><br>
                        ‚Ä¢ Pierdes 50% de tus monedas<br>
                        ‚Ä¢ Pierdes todos los objetos NO equipados<br>
                        ‚Ä¢ Debes crear un nuevo personaje
                    </div>
                </div>

                <div class="rules-section">
                    <h3>üèòÔ∏è 9. Pueblo y NPCs</h3>
                    <p><strong>Servicios disponibles:</strong></p>
                    <ul>
                        <li><strong>Herrero:</strong> Compra/venta armas</li>
                        <li><strong>Alquimista:</strong> Pociones y ant√≠dotos</li>
                        <li><strong>Tabernero:</strong> Descanso (+50% HP, 5 MP)</li>
                        <li><strong>Curandero:</strong> Curaci√≥n total (10 MP)</li>
                        <li><strong>Comerciante:</strong> Items varios</li>
                    </ul>
                </div>

                <div class="rules-section">
                    <h3>üó∫Ô∏è 10. Exploraci√≥n</h3>
                    <p><strong>Eventos posibles:</strong></p>
                    <ul>
                        <li>50% - Encuentro con enemigo</li>
                        <li>20% - Trampa</li>
                        <li>15% - Tesoro</li>
                        <li>10% - Encuentro con animal</li>
                        <li>5% - Zona de descanso</li>
                    </ul>
                    <p><strong>Huir antes del combate:</strong> D20 ‚â• 14</p>
                    <p><strong>Huir durante combate:</strong> D20 ‚â• 12</p>
                </div>

                <div class="rules-section">
                    <h3>üé≤ 11. Tiradas de Dado</h3>
                    <table class="rules-table">
                        <tr><th>Dificultad</th><th>N√∫mero</th></tr>
                        <tr><td>F√°cil</td><td>8</td></tr>
                        <tr><td>Moderado</td><td>10</td></tr>
                        <tr><td>Dif√≠cil</td><td>12</td></tr>
                        <tr><td>Muy dif√≠cil</td><td>14</td></tr>
                        <tr><td>Casi imposible</td><td>16+</td></tr>
                    </table>
                </div>

                <div class="rules-section">
                    <h3>‚ö° 12. Cr√≠ticos</h3>
                    <div class="highlight-box">
                        <strong>Jugador:</strong> 20 natural = da√±o √ó2<br>
                        <strong>Enemigo:</strong> 10% probabilidad = da√±o √ó1.25
                    </div>
                    <p>Los cr√≠ticos ignoran parte de la armadura y pueden aplicar efectos especiales del arma.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- EDITOR TAB -->
    <div class="tab-content" id="editorTab">
        <div class="editor-container">
            <div class="editor-tabs">
                <button class="editor-tab active" onclick="switchEditorTab('weapons')">‚öîÔ∏è Armas</button>
                <button class="editor-tab" onclick="switchEditorTab('armors')">üõ°Ô∏è Armaduras</button>
                <button class="editor-tab" onclick="switchEditorTab('items')">üéí Items</button>
                <button class="editor-tab" onclick="switchEditorTab('enemies')">üëπ Enemigos</button>
                <button class="editor-tab" onclick="switchEditorTab('pets')">üê∫ Mascotas</button>
                <button class="editor-tab" onclick="switchEditorTab('npcs')">üßî NPCs</button>
            </div>

            <div class="editor-section active" id="weaponsEditor">
                <h3>‚öîÔ∏è Editor de Armas <span style="font-size:0.65rem;color:var(--text-dim);">(Click en cualquier arma para editar)</span></h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID (√∫nico)</label><input type="text" id="wId" placeholder="auto-generado"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="wName" placeholder="Espada..."></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="wDamage" placeholder="1d8"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="wIcon" placeholder="‚öîÔ∏è" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="wSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Rareza</label><select id="wRarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="wValue" placeholder="50"></div>
                    <div class="form-group"><label>Efecto</label><select id="wEffect"><option value="">Ninguno</option><option value="bleed">Sangrado</option><option value="poison">Veneno</option><option value="fire">Fuego</option></select></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="wDesc" rows="2" placeholder="Descripci√≥n del arma..."></textarea></div>
                <div class="form-actions">
                    <button class="action-btn" onclick="clearForm('weapon')">üÜï Nuevo</button>
                    <button class="action-btn primary" onclick="saveWeapon()">üíæ Guardar</button>
                </div>
                <div class="items-list" id="weaponsList"></div>
            </div>

            <div class="editor-section" id="armorsEditor">
                <h3>üõ°Ô∏è Editor de Armaduras</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="aId" placeholder="auto"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="aName" placeholder="Cota..."></div>
                    <div class="form-group"><label>Defensa</label><input type="number" id="aDefense" placeholder="3"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="aIcon" placeholder="üõ°Ô∏è" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="aSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Rareza</label><select id="aRarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="aValue" placeholder="100"></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="aDesc" rows="2" placeholder="Descripci√≥n..."></textarea></div>
                <div class="form-actions">
                    <button class="action-btn" onclick="clearForm('armor')">üÜï Nuevo</button>
                    <button class="action-btn primary" onclick="saveArmor()">üíæ Guardar</button>
                </div>
                <div class="items-list" id="armorsList"></div>
            </div>

            <div class="editor-section" id="itemsEditor">
                <h3>üéí Editor de Items</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="iId" placeholder="auto"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="iName" placeholder="Poci√≥n..."></div>
                    <div class="form-group"><label>Tipo</label><select id="iType"><option value="potion">Poci√≥n</option><option value="food">Comida</option><option value="antidote">Ant√≠doto</option><option value="escape">Escape</option><option value="backpack">Mochila</option><option value="scroll">Pergamino</option><option value="tool">Herramienta</option><option value="misc">Otro</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="iIcon" placeholder="üß™" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="iSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Efecto</label><input type="text" id="iEffect" placeholder="1d8 o 5"></div>
                    <div class="form-group"><label>Valor MP</label><input type="number" id="iValue" placeholder="10"></div>
                    <div class="form-group"><label>Rareza</label><select id="iRarity"><option value="common">Com√∫n</option><option value="rare">Raro</option><option value="epic">√âpico</option><option value="legendary">Legendario</option></select></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="iDesc" rows="2" placeholder="Descripci√≥n..."></textarea></div>
                <div class="form-actions">
                    <button class="action-btn" onclick="clearForm('item')">üÜï Nuevo</button>
                    <button class="action-btn primary" onclick="saveItem()">üíæ Guardar</button>
                </div>
                <div class="items-list" id="itemsList"></div>
            </div>

            <div class="editor-section" id="enemiesEditor">
                <h3>üëπ Editor de Enemigos</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="enId" placeholder="auto"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="enName" placeholder="Troll..."></div>
                    <div class="form-group"><label>Salud</label><input type="number" id="enHealth" placeholder="30"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="enDamage" placeholder="1d8"></div>
                    <div class="form-group"><label>Dificultad</label><input type="number" id="enDiff" placeholder="10" min="1" max="20"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="enIcon" placeholder="üëπ" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="enSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Efecto ataque</label><select id="enEffect"><option value="">Ninguno</option><option value="bleed">Sangrado</option><option value="poison">Veneno</option><option value="fire">Fuego</option></select></div>
                    <div class="form-group"><label>H√°bitat</label><select id="enHabitat"><option value="any">Cualquiera</option><option value="forest">Bosque</option><option value="dungeon">Mazmorra</option><option value="mountain">Monta√±a</option><option value="swamp">Pantano</option><option value="ruins">Ruinas</option></select></div>
                    <div class="form-group"><label>MP min</label><input type="number" id="enLootMin" placeholder="5"></div>
                    <div class="form-group"><label>MP max</label><input type="number" id="enLootMax" placeholder="20"></div>
                </div>
                <div class="form-group"><label>Narrativa de encuentro</label><textarea id="enDesc" rows="3" placeholder="El troll emerge de las sombras, su piel verde cubierta de cicatrices..."></textarea></div>
                <div class="form-group"><label>Drops posibles</label><div class="multi-select" id="enDropsSelect"></div></div>
                <div class="form-actions">
                    <button class="action-btn" onclick="clearForm('enemy')">üÜï Nuevo</button>
                    <button class="action-btn primary" onclick="saveEnemy()">üíæ Guardar</button>
                </div>
                <div class="items-list" id="enemiesList"></div>
            </div>

            <div class="editor-section" id="petsEditor">
                <h3>üê∫ Editor de Mascotas</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="petId" placeholder="auto"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="petName" placeholder="Lobo..."></div>
                    <div class="form-group"><label>Salud</label><input type="number" id="petHealth" placeholder="20"></div>
                    <div class="form-group"><label>Da√±o</label><input type="text" id="petDamage" placeholder="1d6"></div>
                    <div class="form-group"><label>Dado domesticar</label><input type="number" id="petDiff" placeholder="24"></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="petIcon" placeholder="üê∫" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="petSprite" placeholder="https://..."></div>
                </div>
                <div class="form-group"><label>Descripci√≥n</label><textarea id="petDesc" rows="2" placeholder="Un lobo salvaje te observa..."></textarea></div>
                <div class="form-actions">
                    <button class="action-btn" onclick="clearForm('pet')">üÜï Nuevo</button>
                    <button class="action-btn primary" onclick="savePet()">üíæ Guardar</button>
                </div>
                <div class="items-list" id="petsList"></div>
            </div>

            <div class="editor-section" id="npcsEditor">
                <h3>üßî Editor de NPCs</h3>
                <div class="form-grid">
                    <div class="form-group"><label>ID</label><input type="text" id="npcId" placeholder="auto"></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="npcName" placeholder="Aldric..."></div>
                    <div class="form-group"><label>Rol</label><select id="npcRole"><option value="merchant">Comerciante</option><option value="blacksmith">Herrero</option><option value="alchemist">Alquimista</option><option value="innkeeper">Tabernero</option><option value="baker">Panadero</option><option value="healer">Curandero</option><option value="guard">Guardia</option><option value="questgiver">Misiones</option><option value="villager">Aldeano</option></select></div>
                    <div class="form-group"><label>Emoji</label><input type="text" id="npcIcon" placeholder="üßî" maxlength="2"></div>
                    <div class="form-group"><label>Sprite URL</label><input type="text" id="npcSprite" placeholder="https://..."></div>
                    <div class="form-group"><label>Ubicaci√≥n</label><input type="text" id="npcLocation" placeholder="Plaza..."></div>
                </div>
                <div class="form-group"><label>Di√°logo</label><textarea id="npcDialogue" rows="2" placeholder="¬°Bienvenido, viajero!"></textarea></div>
                <div class="form-group"><label>Items que vende (comerciantes)</label><div class="multi-select" id="npcShopSelect"></div></div>
                <div class="form-actions">
                    <button class="action-btn" onclick="clearForm('npc')">üÜï Nuevo</button>
                    <button class="action-btn primary" onclick="saveNpc()">üíæ Guardar</button>
                </div>
                <div class="items-list" id="npcsList"></div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="inventoryModal">
        <div class="modal modal-large">
            <button class="modal-close" onclick="closeModal('inventoryModal')">&times;</button>
            <h3 class="modal-title">üéí Inventario</h3>
            <div id="invInfo" style="text-align:center;margin-bottom:0.4rem;color:var(--text-dim);font-size:0.75rem;"></div>
            <div class="inventory-grid" id="invGrid"></div>
        </div>
    </div>

    <div class="modal-overlay" id="itemDetailModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('itemDetailModal')">&times;</button>
            <div class="item-detail">
                <div class="item-detail-icon" id="detailIcon">üì¶</div>
                <div class="item-detail-name" id="detailName">Item</div>
                <div class="item-detail-type" id="detailType">Tipo</div>
                <div class="item-detail-desc" id="detailDesc">Descripci√≥n...</div>
                <div class="item-detail-stats" id="detailStats"></div>
                <div class="item-detail-actions" id="detailActions"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="townModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('townModal')">&times;</button>
            <h3 class="modal-title">üèòÔ∏è Pueblo</h3>
            <div id="townContent"></div>
        </div>
    </div>

    <div class="modal-overlay" id="shopModal">
        <div class="modal modal-large">
            <button class="modal-close" onclick="closeModal('shopModal')">&times;</button>
            <h3 class="modal-title" id="shopTitle">üè™ Tienda</h3>
            <div id="shopContent"></div>
        </div>
    </div>

    <div class="dice-display" id="diceDisplay">
        <div class="dice-icon">üé≤</div>
        <div class="dice-label" id="diceLabel">D20</div>
        <div class="dice-result" id="diceResult">--</div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <script>
        // ==================== FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAV4eSg9QjyE08zwtFsvjAomuMYVcNik9k",
            databaseURL: "https://rpggo-756a7-default-rtdb.firebaseio.com",
            projectId: "rpggo-756a7"
        };

        let db = null, fbConnected = false;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            db.ref('.info/connected').on('value', s => {
                fbConnected = s.val() === true;
                document.getElementById('fbDot').classList.toggle('connected', fbConnected);
                document.getElementById('fbText').textContent = fbConnected ? '‚úì' : '‚úó';
                if (fbConnected) loadFromFirebase();
            });
        } catch(e) { console.error(e); }

        // ==================== DATA ====================
        let gameData = {
            weapons: [
                { id: 'bw1', name: 'Daga', damage: '1d4', icon: 'üó°Ô∏è', value: 10, rarity: 'common', desc: 'Una daga oxidada pero afilada.' },
                { id: 'bw2', name: 'Espada corta', damage: '1d6', icon: '‚öîÔ∏è', value: 20, rarity: 'common', desc: 'Espada equilibrada de todo aventurero.' },
                { id: 'bw3', name: 'Hacha de mano', damage: '1d6', icon: 'ü™ì', value: 20, rarity: 'common', desc: 'Hacha ligera para combate.' },
                { id: 'bw4', name: 'Bast√≥n', damage: '1d4', icon: 'ü™Ñ', value: 10, rarity: 'common', desc: 'Bast√≥n de madera con punta de hierro.' }
            ],
            armors: [
                { id: 'ba1', name: 'T√∫nica de cuero', defense: 1, icon: 'ü¶∫', value: 15, rarity: 'common', desc: 'Cuero curtido b√°sico.' },
                { id: 'ba2', name: 'Cuero reforzado', defense: 2, icon: 'ü¶∫', value: 30, rarity: 'common', desc: 'Cuero con placas de metal.' },
                { id: 'ba3', name: 'Cota de malla', defense: 3, icon: '‚õìÔ∏è', value: 75, rarity: 'rare', desc: 'Anillos de acero entrelazados.' },
                { id: 'ba4', name: 'T√∫nica de tela', defense: 0, icon: 'üëï', value: 5, rarity: 'common', desc: 'Simple ropa de viaje.' }
            ],
            items: [
                { id: 'bi1', name: 'Poci√≥n menor', type: 'potion', effect: '1d8', icon: 'üß™', value: 10, rarity: 'common', desc: 'Restaura 1d8 HP.' },
                { id: 'bi2', name: 'Poci√≥n de man√°', type: 'potion', effect: '1d4', icon: 'üíß', value: 10, rarity: 'common', desc: 'Restaura energ√≠a m√°gica.' },
                { id: 'bi3', name: 'Ant√≠doto', type: 'antidote', icon: 'üíä', value: 15, rarity: 'common', desc: 'Cura veneno.' },
                { id: 'bi4', name: 'Bomba de humo', type: 'escape', icon: 'üí®', value: 25, rarity: 'common', desc: 'Escape instant√°neo del combate.' },
                { id: 'bi5', name: 'Pergamino', type: 'scroll', icon: 'üìú', value: 20, rarity: 'common', desc: 'Pergamino m√°gico.' },
                { id: 'bi6', name: 'Linterna', type: 'tool', icon: 'üî¶', value: 15, rarity: 'common', desc: 'Ilumina √°reas oscuras.' },
                { id: 'bi7', name: 'Carne', type: 'food', effect: '1d4', icon: 'ü•©', value: 5, rarity: 'common', desc: 'Restaura HP. Sirve para domesticar.' }
            ],
            enemies: [
                { id: 'be1', name: 'Rata Gigante', health: 10, damage: '1d4', difficulty: 6, icon: 'üêÄ', loot: [5, 10], drops: ['bi1'], habitat: 'dungeon', desc: 'Una rata del tama√±o de un perro te mira con ojos hambrientos desde las sombras.' },
                { id: 'be2', name: 'Goblin', health: 15, damage: '1d6', difficulty: 8, icon: 'üë∫', loot: [8, 15], drops: ['bi1', 'bw1'], habitat: 'forest', desc: 'Un goblin escu√°lido salta de entre los arbustos, blandiendo una daga oxidada.' },
                { id: 'be3', name: 'Esqueleto', health: 20, damage: '1d6', difficulty: 10, icon: 'üíÄ', loot: [10, 25], drops: ['bi1'], habitat: 'ruins', desc: 'Los huesos crujen mientras el esqueleto se alza, sus cuencas vac√≠as brillando.' },
                { id: 'be4', name: 'Orco Guerrero', health: 35, damage: '1d8', difficulty: 12, icon: 'üëπ', loot: [20, 40], drops: ['bw2'], habitat: 'mountain', desc: 'Un orco musculoso bloquea el camino, su hacha manchada de sangre seca.' },
                { id: 'be5', name: 'Troll', health: 50, damage: '2d6', difficulty: 14, icon: 'üßå', loot: [40, 80], drops: ['ba2'], habitat: 'swamp', desc: 'El suelo tiembla cuando el troll emerge del pantano, su piel cubierta de musgo.' },
                { id: 'be6', name: 'Drag√≥n Joven', health: 80, damage: '2d8', difficulty: 17, effect: 'fire', icon: 'üêâ', loot: [100, 200], drops: [], habitat: 'mountain', desc: 'Un rugido ensordecedor anuncia la llegada del drag√≥n, sus escamas brillando como rub√≠es.' }
            ],
            pets: [
                { id: 'bp1', name: 'Lobo', health: 20, damage: '1d6', difficulty: 24, icon: 'üê∫', desc: 'Un lobo solitario te observa con curiosidad.' },
                { id: 'bp2', name: 'Oso', health: 35, damage: '1d8', difficulty: 30, icon: 'üêª', desc: 'Un oso pardo gru√±e suavemente.' },
                { id: 'bp3', name: '√Åguila', health: 15, damage: '1d4', difficulty: 24, icon: 'ü¶Ö', desc: 'Un √°guila majestuosa planea sobre ti.' },
                { id: 'bp4', name: 'Tigre', health: 30, damage: '2d6', difficulty: 60, icon: 'üêØ', desc: 'Un tigre descansa a la sombra.' }
            ],
            npcs: [
                { id: 'bn1', name: 'Grimbold', role: 'blacksmith', icon: 'üßî', location: 'Herrer√≠a', dialogue: '¬°Ah, un cliente! Mis armas son las mejores del reino.', sells: ['bw1', 'bw2', 'bw3'] },
                { id: 'bn2', name: 'Elara', role: 'alchemist', icon: 'üßô‚Äç‚ôÄÔ∏è', location: 'Botica', dialogue: 'Bienvenido. Mis pociones pueden curar... o matar.', sells: ['bi1', 'bi2', 'bi3'] },
                { id: 'bn3', name: 'Tobias', role: 'innkeeper', icon: 'üßë‚Äçüç≥', location: 'Taberna', dialogue: '¬°Si√©ntate, amigo! Una cerveza fr√≠a cura el alma.', sells: ['bi7'] }
            ]
        };

        const BASE_RACES = [
            { name: 'Humano', bonus: { health: 1 }, icon: 'üßë', desc: '+1 HP' },
            { name: 'Elfo', bonus: { precision: 1 }, icon: 'üßù', desc: '+1 Precisi√≥n' },
            { name: 'Enano', bonus: { armor: 1 }, icon: 'üßî', desc: '+1 Armadura' },
            { name: 'Orco', bonus: { damage: 1 }, icon: 'üëπ', desc: '+1 Da√±o' },
            { name: 'Mediano', bonus: { evasion: 1 }, icon: 'üßí', desc: '+1 Evasi√≥n' }
        ];

        const TRAPS = [
            { name: 'Trampa de p√∫as', damage: '1d6', effect: 'bleed', detectDiff: 10, dodgeDiff: 12, narrative: 'El suelo cede revelando un foso lleno de p√∫as oxidadas.' },
            { name: 'Dardo venenoso', damage: '1d4', effect: 'poison', detectDiff: 12, dodgeDiff: 10, narrative: 'Peque√±os orificios en la pared esconden dardos impregnados de veneno.' },
            { name: 'Foso oculto', damage: '2d6', effect: null, detectDiff: 8, dodgeDiff: 14, narrative: 'Las tablas crujen peligrosamente. Debajo, un pozo profundo.' },
            { name: 'Runa explosiva', damage: '2d8', effect: 'fire', detectDiff: 14, dodgeDiff: 12, narrative: 'S√≠mbolos arcanos brillan en el suelo, pulsando con energ√≠a destructiva.' }
        ];

        const LOCATIONS = {
            danger: [
                { name: 'Bosque Sombr√≠o', habitat: 'forest', narratives: ['Los √°rboles se alzan como gigantes silenciosos. El aire huele a musgo y hojas podridas.', 'Un sendero serpentea entre helechos gigantes y ra√≠ces retorcidas.'] },
                { name: 'Ruinas Antiguas', habitat: 'ruins', narratives: ['Columnas rotas cuentan la historia de una civilizaci√≥n olvidada.', 'El viento silba entre las piedras ca√≠das.'] },
                { name: 'Pantano Maldito', habitat: 'swamp', narratives: ['El agua estancada burbujea con gases nocivos.', 'Cada paso es una lucha contra el lodo.'] },
                { name: 'Caverna Profunda', habitat: 'dungeon', narratives: ['La oscuridad es casi total. El goteo del agua resuena.', 'El t√∫nel se estrecha. Marcas de garras cubren las paredes.'] },
                { name: 'Paso de Monta√±a', habitat: 'mountain', narratives: ['El viento a√∫lla entre los picos nevados.', 'Rocas sueltas amenazan con ceder bajo tus pies.'] }
            ],
            safe: [
                { name: 'Claro del Bosque', narratives: ['Un rayo de sol ilumina un peque√±o claro donde flores silvestres danzan.'] },
                { name: 'Refugio de Piedra', narratives: ['Una cueva natural ofrece protecci√≥n. Restos de fogatas indican que otros han descansado aqu√≠.'] }
            ]
        };

        const EXPLORATION_INTROS = [
            'Te adentras en lo desconocido, cada paso resonando con determinaci√≥n...',
            'El camino se bifurca ante ti. Siguiendo tu instinto, eliges avanzar...',
            'Una brisa cargada de presagios acaricia tu rostro mientras exploras...'
        ];

        function findItem(id) {
            return gameData.weapons.find(x => x.id === id) || gameData.armors.find(x => x.id === id) || gameData.items.find(x => x.id === id);
        }

        function getSprite(item) {
            if (item?.sprite) return `<img src="${item.sprite}" alt="${item.name}">`;
            return item?.icon || 'üì¶';
        }

        // ==================== GAME STATE ====================
        let game = { player: null, inCombat: false, enemy: null, turn: 0, location: { name: 'Pueblo', type: 'safe' } };
        let currentDetailItem = null; // FIX: Store current item for modal

        // ==================== UTILITIES ====================
        function roll(n) { if (typeof n === 'number') return n; const m = String(n).match(/(\d+)?d(\d+)([+-]\d+)?/i); if (!m) return parseInt(n) || 0; let t = parseInt(m[3]) || 0; for (let i = 0; i < (parseInt(m[1]) || 1); i++) t += Math.floor(Math.random() * parseInt(m[2])) + 1; return Math.max(1, t); }
        function d20() { return Math.floor(Math.random() * 20) + 1; }
        function dX(x) { return Math.floor(Math.random() * x) + 1; }
        function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        function hpClass(pct) { return pct > 60 ? 'hp-high' : pct > 30 ? 'hp-medium' : pct > 15 ? 'hp-low' : 'hp-critical'; }
        function toast(msg, type = 'info') { const t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = msg; document.getElementById('toasts').appendChild(t); setTimeout(() => t.remove(), 3000); }
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        async function showDice(result, sides = 20, crit = false) {
            const d = document.getElementById('diceDisplay');
            document.getElementById('diceLabel').textContent = `D${sides}`;
            document.getElementById('diceResult').textContent = result;
            document.getElementById('diceResult').classList.toggle('crit', crit);
            d.classList.add('active');
            await new Promise(r => setTimeout(r, 600));
            d.classList.remove('active');
        }

        // ==================== STORY ====================
        function addStory(txt, type = '') { const c = document.getElementById('storyContent'); const d = document.createElement('div'); d.className = 'story-entry ' + (type ? 'story-' + type : ''); d.innerHTML = txt; c.appendChild(d); c.scrollTop = c.scrollHeight; }
        function clearCombatLog() { document.getElementById('combatLogContent').innerHTML = ''; }
        function addTurnHeader(n) { document.getElementById('combatLogContent').innerHTML += `<div class="log-turn-header">‚ïê TURNO ${n} ‚ïê</div>`; }
        function addLogSection(title, entries, type = '') { let h = `<div class="log-section ${type}"><div style="font-size:0.6rem;color:var(--text-dim);">${title}</div>`; entries.forEach(e => h += `<div class="log-entry ${e.cls||''}">${e.text}</div>`); document.getElementById('combatLogContent').innerHTML += h + '</div>'; document.getElementById('combatLogContent').scrollTop = 99999; }

        // ==================== UI ====================
        function updateUI() {
            const p = game.player; if (!p) return;
            document.getElementById('charAvatar').textContent = p.race.icon;
            document.getElementById('charName').textContent = p.name;
            document.getElementById('charRace').textContent = `${p.race.name} (${p.race.desc})`;
            const pct = (p.hp / p.maxHp) * 100;
            document.getElementById('hpDisplay').textContent = `${p.hp} / ${p.maxHp}`;
            document.getElementById('hpBar').style.width = pct + '%';
            document.getElementById('hpBar').className = 'bar-inner ' + hpClass(pct);
            document.getElementById('statArm').textContent = p.totalArmor();
            document.getElementById('statEva').textContent = p.race.bonus.evasion || 0;
            document.getElementById('statPrec').textContent = p.race.bonus.precision || 0;
            document.getElementById('statDmg').textContent = p.race.bonus.damage || 0;
            document.getElementById('weaponIcon').innerHTML = getSprite(p.weapon);
            document.getElementById('weaponName').textContent = p.weapon.name;
            document.getElementById('weaponStats').textContent = `Da√±o: ${p.weapon.damage}`;
            document.getElementById('armorIcon').innerHTML = getSprite(p.armor);
            document.getElementById('armorName').textContent = p.armor.name;
            document.getElementById('armorStats').textContent = `Def: ${p.armor.defense}`;
            document.getElementById('goldAmt').textContent = p.gold;
            document.getElementById('silverAmt').textContent = p.silver;
            const locBadge = document.getElementById('locationBadge');
            locBadge.className = 'location-badge ' + (game.location.type === 'safe' ? 'safe' : 'danger');
            locBadge.textContent = `üìç ${game.location.name}`;
            const canEquip = !game.inCombat && game.location.type === 'safe';
            document.getElementById('weaponSlot').classList.toggle('disabled', !canEquip);
            document.getElementById('armorSlot').classList.toggle('disabled', !canEquip);
            const petSec = document.getElementById('petSection');
            if (p.pet) { petSec.style.display = 'block'; const pp = (p.pet.hp / p.pet.maxHp) * 100; document.getElementById('petDisplay').innerHTML = `<div style="display:flex;gap:0.3rem;align-items:center;background:var(--bg-dark);padding:0.25rem;border-radius:3px;border:1px solid var(--green);"><span style="font-size:1.2rem;">${getSprite(p.pet)}</span><div style="flex:1;"><div style="color:var(--green-bright);font-size:0.7rem;">${p.pet.name}</div><div class="hp-bar-container" style="height:6px;"><div class="hp-bar-fill ${hpClass(pp)}" style="width:${pp}%"></div></div></div></div>`; } else { petSec.style.display = 'none'; }
        }

        function updateCombatUI() {
            const p = game.player, e = game.enemy;
            document.getElementById('turnNumber').textContent = game.turn;
            document.getElementById('pSprite').innerHTML = getSprite({ icon: p.race.icon });
            document.getElementById('pCombatName').textContent = p.name;
            document.getElementById('pCombatDmg').textContent = p.weapon.damage;
            document.getElementById('pCombatDef').textContent = p.totalArmor();
            const pp = (p.hp / p.maxHp) * 100;
            document.getElementById('pHpText').textContent = `${p.hp}/${p.maxHp}`;
            document.getElementById('pHpBar').style.width = pp + '%';
            document.getElementById('pHpBar').className = 'hp-bar-fill ' + hpClass(pp);
            document.getElementById('pEffects').innerHTML = p.effects.map(ef => `<span class="effect-tag eff-${ef.type}">${ef.type} ${ef.turns}t</span>`).join('');
            document.getElementById('eSprite').innerHTML = getSprite(e);
            document.getElementById('eCombatName').textContent = e.name;
            document.getElementById('eCombatDmg').textContent = e.damage;
            document.getElementById('eCombatDiff').textContent = e.difficulty;
            const ep = (e.hp / e.maxHp) * 100;
            document.getElementById('eHpText').textContent = `${e.hp}/${e.maxHp}`;
            document.getElementById('eHpBar').style.width = ep + '%';
            document.getElementById('eHpBar').className = 'hp-bar-fill ' + hpClass(ep);
            document.getElementById('eEffects').innerHTML = (e.effects || []).map(ef => `<span class="effect-tag eff-${ef.type}">${ef.type} ${ef.turns}t</span>`).join('');
            const ca = document.getElementById('combatActions'); ca.innerHTML = '';
            [{ text: '‚öîÔ∏è Atacar', fn: playerAttack, cls: 'primary' }, { text: 'üéí Item', fn: () => { renderInventory(); openModal('inventoryModal'); } }, { text: 'üõ°Ô∏è Defender', fn: playerDefend }, { text: 'üí® Huir', fn: attemptFlee, cls: 'danger' }].forEach(a => { const b = document.createElement('button'); b.className = 'action-btn ' + (a.cls || ''); b.textContent = a.text; b.onclick = a.fn; ca.appendChild(b); });
        }

        // ==================== EQUIPMENT - FIXED ====================
        function handleEquipClick(slot) {
            if (game.inCombat) { toast('No puedes cambiar equipo en combate', 'error'); return; }
            if (game.location.type !== 'safe') { toast('Solo en zona segura', 'error'); return; }
            const item = slot === 'weapon' ? game.player.weapon : game.player.armor;
            showItemDetail(item, 'equipped-' + slot);
        }

        function showItemDetail(item, context = 'inventory') {
            if (!item) return;
            currentDetailItem = item; // STORE REFERENCE
            document.getElementById('detailIcon').innerHTML = getSprite(item);
            document.getElementById('detailName').textContent = item.name;
            document.getElementById('detailType').textContent = item.damage ? 'Arma' : item.defense !== undefined ? 'Armadura' : item.type || 'Item';
            document.getElementById('detailDesc').textContent = item.desc || 'Sin descripci√≥n.';
            let stats = '';
            if (item.damage) stats += `<div class="item-stat"><div class="item-stat-label">Da√±o</div><div class="item-stat-value">${item.damage}</div></div>`;
            if (item.defense !== undefined) stats += `<div class="item-stat"><div class="item-stat-label">Defensa</div><div class="item-stat-value">${item.defense}</div></div>`;
            if (item.effect && (item.type === 'potion' || item.type === 'food')) stats += `<div class="item-stat"><div class="item-stat-label">Cura</div><div class="item-stat-value">${item.effect}</div></div>`;
            if (item.value) stats += `<div class="item-stat"><div class="item-stat-label">Valor</div><div class="item-stat-value">${item.value} MP</div></div>`;
            document.getElementById('detailStats').innerHTML = stats;
            
            let actions = '';
            const canEquip = !game.inCombat && game.location.type === 'safe';
            
            if (context.startsWith('equipped-')) {
                if (canEquip) {
                    const slot = context.split('-')[1];
                    actions += `<button class="action-btn danger" onclick="unequipItem('${slot}')">‚ùå Desequipar</button>`;
                } else {
                    actions += `<div style="font-size:0.75rem;color:var(--text-dim);padding:0.3rem;">Solo en zona segura</div>`;
                }
            } else {
                // From inventory
                if (item.damage && canEquip) {
                    actions += `<button class="action-btn primary" onclick="doEquipItem('weapon')">‚öîÔ∏è Equipar Arma</button>`;
                }
                if (item.defense !== undefined && canEquip) {
                    actions += `<button class="action-btn primary" onclick="doEquipItem('armor')">üõ°Ô∏è Equipar Armadura</button>`;
                }
                if (item.type === 'potion' || item.type === 'food') {
                    actions += `<button class="action-btn primary" onclick="doUseItem()">‚ú® Usar</button>`;
                }
                if (item.type === 'antidote') {
                    actions += `<button class="action-btn primary" onclick="doUseItem()">üíä Usar</button>`;
                }
                if (item.type === 'escape' && game.inCombat) {
                    actions += `<button class="action-btn primary" onclick="doUseItem()">üí® Usar</button>`;
                }
                if (item.type === 'backpack') {
                    actions += `<button class="action-btn primary" onclick="doUseItem()">üéí Usar</button>`;
                }
            }
            actions += `<button class="action-btn" onclick="closeModal('itemDetailModal')">Cerrar</button>`;
            document.getElementById('detailActions').innerHTML = actions;
            openModal('itemDetailModal');
        }

        function doEquipItem(type) {
            const item = currentDetailItem;
            if (!item || !item.uid) return;
            const p = game.player;
            closeModal('itemDetailModal');
            
            if (type === 'weapon') {
                if (p.weapon && p.weapon.uid) p.inventory.push(p.weapon);
                p.weapon = item;
            } else {
                if (p.armor && p.armor.uid) p.inventory.push(p.armor);
                p.armor = item;
            }
            p.inventory = p.inventory.filter(i => i.uid !== item.uid);
            
            addStory(`Te equipas con <strong>${item.name}</strong>.`, 'system');
            toast('Equipado', 'success');
            updateUI();
            renderInventory();
        }

        function unequipItem(type) {
            const p = game.player;
            if (p.inventory.length >= p.maxSlots) { toast('Inventario lleno', 'error'); return; }
            closeModal('itemDetailModal');
            
            if (type === 'weapon') {
                if (p.weapon && p.weapon.uid) p.inventory.push(p.weapon);
                p.weapon = { name: 'Pu√±os', damage: '1d2', icon: '‚úä', value: 0, defense: undefined, desc: 'Tus propios pu√±os.' };
            } else {
                if (p.armor && p.armor.uid) p.inventory.push(p.armor);
                p.armor = { name: 'Sin armadura', defense: 0, icon: 'üë§', value: 0, desc: 'Sin protecci√≥n.' };
            }
            
            addStory('Guardas tu equipo en el inventario.', 'system');
            toast('Desequipado', 'info');
            updateUI();
        }

        function doUseItem() {
            const item = currentDetailItem;
            if (!item || !item.uid) return;
            const p = game.player;
            closeModal('itemDetailModal');
            closeModal('inventoryModal');
            
            if (item.type === 'potion' || item.type === 'food') {
                const heal = roll(item.effect || '1d4');
                const actual = Math.min(heal, p.maxHp - p.hp);
                p.hp += actual;
                addStory(`Usas ${item.name}: <span style="color:var(--green-bright);">+${actual} HP</span>`, 'system');
            } else if (item.type === 'antidote') {
                p.effects = p.effects.filter(e => e.type !== 'poison');
                addStory(`Usas ${item.name}: Veneno curado`, 'system');
            } else if (item.type === 'escape' && game.inCombat) {
                p.inventory = p.inventory.filter(i => i.uid !== item.uid);
                addStory('Lanzas una bomba de humo y escapas.', 'narrative');
                endCombatEscape();
                return;
            } else if (item.type === 'backpack') {
                const slots = parseInt(item.effect) || 5;
                p.maxSlots += slots;
                addStory(`+${slots} espacios de inventario`, 'system');
            }
            
            p.inventory = p.inventory.filter(i => i.uid !== item.uid);
            updateUI();
            if (game.inCombat) updateCombatUI();
        }

        function renderInventory() {
            const p = game.player;
            document.getElementById('invInfo').textContent = `${p.inventory.length} / ${p.maxSlots} espacios`;
            const grid = document.getElementById('invGrid'); grid.innerHTML = '';
            p.inventory.forEach(item => {
                const slot = document.createElement('div');
                slot.className = `inv-slot rarity-${item.rarity || 'common'}`;
                slot.innerHTML = `<div class="inv-slot-icon">${getSprite(item)}</div><div class="inv-slot-name">${item.name}</div>`;
                slot.onclick = () => showItemDetail(item, game.inCombat ? 'combat' : 'inventory');
                grid.appendChild(slot);
            });
            for (let i = p.inventory.length; i < p.maxSlots; i++) {
                const slot = document.createElement('div');
                slot.className = 'inv-slot';
                slot.innerHTML = '<div class="inv-slot-empty">vac√≠o</div>';
                grid.appendChild(slot);
            }
        }

        // ==================== EXPLORATION ====================
        function explore() {
            addStory(pick(EXPLORATION_INTROS), 'narrative');
            setActions([{ text: '...', disabled: true }]);
            
            setTimeout(() => {
                const isDanger = Math.random() < 0.7;
                const locGroup = isDanger ? pick(LOCATIONS.danger) : pick(LOCATIONS.safe);
                game.location = { name: locGroup.name, type: isDanger ? 'danger' : 'safe', habitat: locGroup.habitat };
                
                addStory(`<strong>${locGroup.name}</strong>`, 'narrative');
                addStory(pick(locGroup.narratives), 'narrative');
                updateUI();

                setTimeout(() => {
                    if (!isDanger) { triggerSafeEvent(); return; }
                    const r = dX(100);
                    if (r <= 50) triggerEnemyEncounter();
                    else if (r <= 70) triggerTrap();
                    else if (r <= 85) triggerTreasure();
                    else if (r <= 95) triggerPetEncounter();
                    else triggerSafeEvent();
                }, 1200);
            }, 800);
        }

        function triggerEnemyEncounter() {
            const habitat = game.location.habitat;
            const pool = gameData.enemies.filter(e => e.habitat === habitat || e.habitat === 'any' || !e.habitat);
            const enemy = pick(pool.length > 0 ? pool : gameData.enemies);
            
            addStory(enemy.desc || `Un ${enemy.name} aparece ante ti.`, 'narrative');
            setTimeout(() => {
                addStory(`<strong>¬°${enemy.name} se prepara para atacar!</strong>`, 'combat');
                setActions([
                    { text: '‚öîÔ∏è ¬°Luchar!', fn: () => startCombat(enemy), cls: 'primary' },
                    { text: 'üí® Huir', fn: () => attemptFleeBeforeCombat(enemy), cls: 'danger' }
                ]);
            }, 600);
        }

        async function attemptFleeBeforeCombat(enemy) {
            const fleeRoll = d20();
            await showDice(fleeRoll);
            addStory(`Tirada de huida: <strong>${fleeRoll}</strong> vs 14`, 'system');
            if (fleeRoll >= 14) {
                addStory('¬°Escapas antes de que te alcance!', 'narrative');
                game.location = { name: 'Sendero', type: 'safe' };
                updateUI(); showExploreActions();
            } else {
                addStory('¬°No logras escapar! El combate es inevitable.', 'combat');
                startCombat(enemy);
            }
        }

        async function triggerTrap() {
            const trap = pick(TRAPS);
            addStory('Algo no est√° bien. Tus instintos se activan...', 'narrative');
            setTimeout(async () => {
                addStory(`<strong>¬°Trampa!</strong> ${trap.narrative}`, 'trap');
                const detectRoll = d20();
                await showDice(detectRoll);
                addStory(`Percepci√≥n: <strong>${detectRoll}</strong> vs ${trap.detectDiff}`, 'system');
                if (detectRoll >= trap.detectDiff) {
                    addStory('¬°Detectas la trampa a tiempo!', 'system');
                    setActions([
                        { text: 'üèÉ Esquivar', fn: () => attemptDodgeTrap(trap), cls: 'primary' },
                        { text: 'üîß Desactivar', fn: () => attemptDisableTrap(trap) }
                    ]);
                } else {
                    addStory('No notas el peligro hasta que es tarde...', 'trap');
                    await applyTrapDamage(trap, false);
                }
            }, 800);
        }

        async function attemptDodgeTrap(trap) {
            const dodgeRoll = d20() + (game.player.race.bonus.evasion || 0);
            await showDice(dodgeRoll);
            addStory(`Esquive: <strong>${dodgeRoll}</strong> vs ${trap.dodgeDiff}`, 'system');
            if (dodgeRoll >= trap.dodgeDiff) { addStory('¬°Te apartas a tiempo!', 'loot'); showExploreActions(); }
            else { await applyTrapDamage(trap, true); }
        }

        async function attemptDisableTrap(trap) {
            const disableRoll = d20();
            await showDice(disableRoll);
            addStory(`Desactivaci√≥n: <strong>${disableRoll}</strong> vs 15`, 'system');
            if (disableRoll >= 15) { const r = dX(15) + 5; game.player.silver += r; addStory(`¬°√âxito! Encuentras ${r} MP.`, 'loot'); }
            else if (disableRoll >= 10) { addStory('El mecanismo se resiste... te apartas.', 'system'); }
            else { addStory('¬°Activas la trampa!', 'trap'); await applyTrapDamage(trap, false); return; }
            updateUI(); showExploreActions();
        }

        async function applyTrapDamage(trap, reduced) {
            let dmg = roll(trap.damage); if (reduced) dmg = Math.ceil(dmg * 0.5);
            const armor = Math.floor(game.player.totalArmor() / 2);
            const finalDmg = Math.max(1, dmg - armor);
            game.player.hp -= finalDmg;
            addStory(`${trap.name}: <span style="color:var(--red-bright);">${finalDmg} da√±o</span>`, 'combat');
            if (trap.effect) { applyEffect(game.player, trap.effect); }
            updateUI();
            if (game.player.hp <= 0) { addStory('<strong style="color:var(--red-bright);">Has muerto...</strong>', 'combat'); setActions([{ text: 'üîÑ Nuevo Personaje', fn: startNewGame, cls: 'primary' }]); }
            else showExploreActions();
        }

        function triggerTreasure() {
            addStory('¬°Algo brilla entre los escombros!', 'narrative');
            setTimeout(() => {
                const mp = dX(30) + 10;
                game.player.silver += mp;
                while (game.player.silver >= 99) { game.player.silver -= 99; game.player.gold++; }
                addStory(`Encuentras <strong>${mp} MP</strong>`, 'loot');
                if (Math.random() < 0.3 && game.player.inventory.length < game.player.maxSlots) {
                    const item = pick(gameData.items);
                    game.player.inventory.push({ ...item, uid: Date.now() });
                    addStory(`Tambi√©n: <strong>${item.name}</strong>`, 'loot');
                }
                updateUI(); showExploreActions();
            }, 800);
        }

        function triggerPetEncounter() {
            if (game.player.pet) { triggerSafeEvent(); return; }
            const pet = pick(gameData.pets);
            addStory(pet.desc || `Un ${pet.name} aparece.`, 'narrative');
            const hasMeat = game.player.inventory.some(i => i.type === 'food');
            setActions([
                { text: 'ü•© Domesticar', fn: () => attemptTame(pet), disabled: !hasMeat, cls: hasMeat ? 'primary' : '' },
                { text: '‚öîÔ∏è Cazar', fn: () => startCombat({ ...pet, health: pet.health, difficulty: 10, loot: [5, 15], drops: ['bi7'] }) },
                { text: 'üö∂ Dejar', fn: () => { addStory('Te alejas silenciosamente.', 'narrative'); showExploreActions(); } }
            ]);
        }

        async function attemptTame(pet) {
            const p = game.player;
            const idx = p.inventory.findIndex(i => i.type === 'food');
            if (idx !== -1) p.inventory.splice(idx, 1);
            addStory(`Ofreces comida al ${pet.name}...`, 'narrative');
            const tameRoll = dX(pet.difficulty);
            const threshold = Math.ceil(pet.difficulty * 0.6);
            await showDice(tameRoll, pet.difficulty, tameRoll >= threshold);
            addStory(`D${pet.difficulty}: <strong>${tameRoll}</strong> (necesitas ${threshold}+)`, 'system');
            if (tameRoll >= threshold) {
                p.pet = { ...pet, hp: pet.health, maxHp: pet.health };
                addStory(`<strong style="color:var(--green-bright);">¬°${pet.name} es ahora tu compa√±ero!</strong>`, 'loot');
                toast('Compa√±ero obtenido', 'success');
            } else {
                addStory(`El ${pet.name} toma la comida y se aleja.`, 'narrative');
            }
            updateUI(); showExploreActions();
        }

        function triggerSafeEvent() {
            addStory('Encuentras un lugar tranquilo para descansar.', 'narrative');
            game.location = { name: 'Refugio', type: 'safe' };
            const heal = Math.floor(game.player.maxHp * 0.3);
            game.player.hp = Math.min(game.player.maxHp, game.player.hp + heal);
            game.player.effects = [];
            addStory(`<span style="color:var(--green-bright);">+${heal} HP</span>. Estados curados. <em>Zona segura.</em>`, 'system');
            updateUI(); showExploreActions();
        }

        // ==================== COMBAT ====================
        function startCombat(enemy) {
            game.inCombat = true;
            game.enemy = { ...enemy, hp: enemy.health, maxHp: enemy.health, effects: [] };
            game.turn = 1;
            document.getElementById('combatArena').classList.add('active');
            clearCombatLog(); addTurnHeader(1);
            updateCombatUI(); updateUI();
            document.getElementById('actionsGrid').innerHTML = '<span style="color:var(--text-dim)">En combate...</span>';
        }

        async function playerAttack() {
            const p = game.player, e = game.enemy;
            const attackRoll = d20(), precision = p.race.bonus.precision || 0, total = attackRoll + precision, isCrit = attackRoll === 20;
            await showDice(attackRoll, 20, isCrit);
            const logs = [{ text: `D20: ${attackRoll}${precision ? `+${precision}` : ''} = ${total} vs ${e.difficulty}` }];
            if (attackRoll === 1) { logs.push({ text: '¬°Pifia!', cls: 'log-miss' }); }
            else if (total >= e.difficulty) {
                let dmg = roll(p.weapon.damage) + (p.race.bonus.damage || 0);
                if (isCrit) { dmg *= 2; logs.push({ text: '¬°CR√çTICO! √ó2', cls: 'log-crit' }); }
                e.hp -= dmg;
                logs.push({ text: `${dmg} da√±o`, cls: 'log-damage' });
                if (p.weapon.effect) applyEffect(e, p.weapon.effect);
                if (p.pet) { const pd = roll(p.pet.damage); e.hp -= pd; logs.push({ text: `${p.pet.icon} +${pd}` }); }
                if (e.hp <= 0) { addLogSection(`‚öîÔ∏è ${p.name}`, logs, 'player-action'); endCombat(true); return; }
            } else { logs.push({ text: 'Fallo', cls: 'log-miss' }); }
            addLogSection(`‚öîÔ∏è ${p.name}`, logs, 'player-action');
            updateCombatUI();
            await enemyTurn();
        }

        function playerDefend() {
            game.player.defending = true;
            addLogSection(`üõ°Ô∏è Defender`, [{ text: '+4 evasi√≥n' }], 'player-action');
            enemyTurn();
        }

        async function attemptFlee() {
            const fleeRoll = d20();
            await showDice(fleeRoll);
            if (fleeRoll >= 12) { addLogSection('üèÉ Huida', [{ text: `${fleeRoll} ‚â• 12 ¬°Escape!`, cls: 'log-heal' }], 'player-action'); endCombatEscape(); }
            else { addLogSection('üèÉ Huida', [{ text: `${fleeRoll} < 12 Fallido`, cls: 'log-miss' }], 'player-action'); await enemyTurn(); }
        }

        async function enemyTurn() {
            const p = game.player, e = game.enemy;
            processEffects(e); updateCombatUI(); if (e.hp <= 0) { endCombat(true); return; }
            const logs = [];
            const dodgeRoll = d20(), evasion = (p.race.bonus.evasion || 0) + (p.defending ? 4 : 0), totalDodge = dodgeRoll + evasion;
            logs.push({ text: `Esquive: ${dodgeRoll}${evasion ? `+${evasion}` : ''} = ${totalDodge} vs 12` });
            if (totalDodge >= 12) { logs.push({ text: '¬°Esquivado!', cls: 'log-heal' }); }
            else {
                let dmg = roll(e.damage);
                if (Math.random() < 0.1) { dmg = Math.ceil(dmg * 1.25); logs.push({ text: 'Cr√≠tico!', cls: 'log-crit' }); }
                const armor = p.totalArmor(), final = Math.max(1, dmg - armor);
                p.hp -= final;
                logs.push({ text: `${final} da√±o`, cls: 'log-damage' });
                if (e.effect) applyEffect(p, e.effect);
            }
            addLogSection(`üëπ ${e.name}`, logs, 'enemy-action');
            processEffects(p);
            p.defending = false;
            game.turn++;
            updateCombatUI(); updateUI();
            if (p.hp <= 0) endCombat(false);
            else addTurnHeader(game.turn);
        }

        function applyEffect(target, type) {
            const data = { bleed: { dmg: 1, turns: 3, max: 3 }, poison: { dmg: 2, turns: 2, max: 2 }, fire: { dmg: '1d4', turns: 2, max: 1 } };
            const eff = data[type]; if (!eff) return;
            if (!target.effects) target.effects = [];
            const existing = target.effects.find(e => e.type === type);
            if (existing) { if (existing.stacks < eff.max) existing.stacks++; existing.turns = eff.turns; }
            else target.effects.push({ type, dmg: eff.dmg, turns: eff.turns, stacks: 1 });
        }

        function processEffects(target) {
            if (!target.effects) return;
            let total = 0;
            target.effects.forEach((eff, i) => { total += (typeof eff.dmg === 'string' ? roll(eff.dmg) : eff.dmg) * (eff.stacks || 1); eff.turns--; });
            target.effects = target.effects.filter(e => e.turns > 0);
            if (total > 0) target.hp -= total;
        }

        function endCombatEscape() {
            document.getElementById('combatArena').classList.remove('active');
            game.inCombat = false;
            game.enemy = null;
            game.location = { name: 'Sendero', type: 'safe' };
            addStory('Escapas del combate.', 'system');
            updateUI(); showExploreActions();
        }

        function endCombat(victory) {
            document.getElementById('combatArena').classList.remove('active');
            game.inCombat = false;
            if (victory) {
                const e = game.enemy;
                addStory(`¬°<strong style="color:var(--green-bright);">Victoria</strong> contra ${e.name}!`, 'loot');
                if (e.loot) { const mp = dX(e.loot[1] - e.loot[0]) + e.loot[0]; game.player.silver += mp; while (game.player.silver >= 99) { game.player.silver -= 99; game.player.gold++; } addStory(`+${mp} MP`, 'loot'); }
                if (e.drops) { e.drops.forEach(dropId => { if (Math.random() < 0.3 && game.player.inventory.length < game.player.maxSlots) { const item = findItem(dropId); if (item) { game.player.inventory.push({ ...item, uid: Date.now() + Math.random() }); addStory(`+${item.name}`, 'loot'); } } }); }
                game.location = { name: 'Campo de batalla', type: 'safe' };
            } else {
                addStory('<strong style="color:var(--red-bright);">Has ca√≠do...</strong>', 'combat');
                setActions([{ text: 'üîÑ Nuevo Personaje', fn: startNewGame, cls: 'primary' }]);
                return;
            }
            game.enemy = null;
            updateUI(); showExploreActions();
        }

        // ==================== TOWN ====================
        function visitTown() {
            game.location = { name: 'Pueblo', type: 'safe' };
            updateUI();
            addStory('Llegas al pueblo. Varios comerciantes ofrecen sus servicios.', 'narrative');
            const roleNames = { merchant: 'Comerciante', blacksmith: 'Herrero', alchemist: 'Alquimista', innkeeper: 'Tabernero', baker: 'Panadero', healer: 'Curandero', guard: 'Guardia', questgiver: 'Misiones', villager: 'Aldeano' };
            let html = '<div style="display:grid;gap:0.35rem;">';
            gameData.npcs.forEach(npc => { html += `<div class="item-card" onclick="interactNpc('${npc.id}')" style="cursor:pointer;"><span class="item-card-icon">${getSprite(npc)}</span><div class="item-card-info"><div class="item-card-name">${npc.name}</div><div class="item-card-stats">${roleNames[npc.role] || npc.role} - ${npc.location || 'Plaza'}</div></div></div>`; });
            html += '</div>';
            document.getElementById('townContent').innerHTML = html;
            openModal('townModal');
        }

        function interactNpc(npcId) {
            const npc = gameData.npcs.find(n => n.id === npcId); if (!npc) return;
            closeModal('townModal');
            addStory(`<strong>${npc.name}</strong>: "${npc.dialogue || '¬°Saludos!'}"`, 'dialogue');
            if (npc.sells && npc.sells.length > 0) { setTimeout(() => openShop(npc), 400); }
            else if (npc.role === 'healer') {
                if (game.player.silver >= 10) { game.player.silver -= 10; game.player.hp = game.player.maxHp; game.player.effects = []; addStory('Curaci√≥n completa. (-10 MP)', 'system'); }
                else addStory('"No tienes suficiente dinero."', 'dialogue');
                updateUI();
            } else if (npc.role === 'innkeeper') {
                if (game.player.silver >= 5) { game.player.silver -= 5; game.player.hp = Math.min(game.player.maxHp, game.player.hp + Math.floor(game.player.maxHp * 0.5)); addStory('Descansas. +50% HP (-5 MP)', 'system'); }
                updateUI();
            }
        }

        function openShop(npc) {
            document.getElementById('shopTitle').textContent = `üè™ ${npc.name}`;
            let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;">';
            html += '<div><h4 style="color:var(--gold);margin-bottom:0.4rem;font-size:0.8rem;">En venta</h4><div style="display:grid;gap:0.25rem;max-height:200px;overflow-y:auto;">';
            (npc.sells || []).forEach(itemId => { const item = findItem(itemId); if (item) { const canBuy = game.player.silver >= item.value && game.player.inventory.length < game.player.maxSlots; html += `<div class="item-card" style="opacity:${canBuy ? 1 : 0.5}"><span class="item-card-icon">${getSprite(item)}</span><div class="item-card-info"><div class="item-card-name">${item.name}</div><div class="item-card-stats">${item.value} MP</div></div><button class="action-btn" onclick="buyItem('${item.id}')" ${canBuy ? '' : 'disabled'}>Comprar</button></div>`; } });
            html += '</div></div>';
            html += '<div><h4 style="color:var(--gold);margin-bottom:0.4rem;font-size:0.8rem;">Vender</h4><div style="display:grid;gap:0.25rem;max-height:200px;overflow-y:auto;">';
            game.player.inventory.forEach(item => { const sellPrice = Math.floor((item.value || 10) * 0.5); html += `<div class="item-card"><span class="item-card-icon">${getSprite(item)}</span><div class="item-card-info"><div class="item-card-name">${item.name}</div><div class="item-card-stats">${sellPrice} MP</div></div><button class="action-btn" onclick="sellItem('${item.uid}', ${sellPrice})">Vender</button></div>`; });
            html += '</div></div></div>';
            html += `<div style="text-align:center;margin-top:0.5rem;color:var(--text-dim);font-size:0.75rem;">Dinero: ${game.player.gold} MO ${game.player.silver} MP</div>`;
            document.getElementById('shopContent').innerHTML = html;
            openModal('shopModal');
        }

        function buyItem(itemId) {
            const item = findItem(itemId); if (!item || game.player.silver < item.value || game.player.inventory.length >= game.player.maxSlots) return;
            game.player.silver -= item.value;
            game.player.inventory.push({ ...item, uid: Date.now() });
            addStory(`Compras ${item.name}`, 'system');
            toast('Comprado', 'success'); updateUI();
            const npc = gameData.npcs.find(n => document.getElementById('shopTitle').textContent.includes(n.name));
            if (npc) openShop(npc);
        }

        function sellItem(uid, price) {
            const item = game.player.inventory.find(i => i.uid == uid); if (!item) return;
            game.player.inventory = game.player.inventory.filter(i => i.uid != uid);
            game.player.silver += price;
            while (game.player.silver >= 99) { game.player.silver -= 99; game.player.gold++; }
            addStory(`Vendes ${item.name}`, 'system');
            toast('Vendido', 'success'); updateUI();
            const npc = gameData.npcs.find(n => document.getElementById('shopTitle').textContent.includes(n.name));
            if (npc) openShop(npc);
        }

        // ==================== ACTIONS ====================
        function setActions(acts) {
            const g = document.getElementById('actionsGrid'); g.innerHTML = '';
            acts.forEach(a => { const b = document.createElement('button'); b.className = 'action-btn ' + (a.cls || ''); b.textContent = a.text; b.disabled = a.disabled; b.onclick = a.fn; g.appendChild(b); });
        }

        function showExploreActions() {
            setActions([
                { text: 'üó∫Ô∏è Explorar', fn: explore, cls: 'primary' },
                { text: 'üèòÔ∏è Pueblo', fn: visitTown },
                { text: 'üéí Inventario', fn: () => { renderInventory(); openModal('inventoryModal'); } },
                { text: 'üíæ Guardar', fn: saveGame }
            ]);
        }

        // ==================== CHARACTER ====================
        class Player {
            constructor() {
                this.name = pick(['Aldric', 'Brynn', 'Cedric', 'Dara', 'Freya', 'Gideon', 'Kira', 'Mira', 'Orion', 'Sera', 'Theron', 'Lyra']);
                this.race = BASE_RACES[dX(5) - 1];
                this.weapon = { ...gameData.weapons[dX(4) - 1], uid: Date.now() };
                this.armor = { ...gameData.armors[dX(4) - 1], uid: Date.now() + 1 };
                const startItem = { ...gameData.items[dX(gameData.items.length) - 1], uid: Date.now() + 2 };
                this.maxHp = 20 + (this.race.bonus.health || 0);
                this.hp = this.maxHp;
                this.gold = 0;
                this.silver = 20;
                this.inventory = [startItem];
                this.maxSlots = 10;
                this.effects = [];
                this.pet = null;
                this.defending = false;
            }
            totalArmor() { return (this.armor?.defense || 0) + (this.race.bonus.armor || 0); }
        }

        // ==================== SAVE/LOAD ====================
        function saveGame() {
            const data = { player: game.player, location: game.location, gameData: gameData, timestamp: Date.now() };
            if (db && fbConnected) db.ref('saveData').set(data);
            localStorage.setItem('rpgSave', JSON.stringify(data));
            toast('Guardado', 'success');
        }

        function loadFromFirebase() {
            if (!db) return;
            db.ref('gameData').once('value').then(snap => {
                const data = snap.val();
                if (data) {
                    ['weapons', 'armors', 'items', 'enemies', 'pets', 'npcs'].forEach(k => { if (data[k]) gameData[k] = data[k]; });
                    renderAllLists();
                    updateDropSelects();
                }
            });
        }

        function startNewGame() {
            game = { player: new Player(), inCombat: false, enemy: null, turn: 0, location: { name: 'Pueblo', type: 'safe' } };
            document.getElementById('storyContent').innerHTML = '';
            document.getElementById('combatArena').classList.remove('active');
            addStory('<strong style="font-size:1rem;color:var(--gold);">‚öîÔ∏è Nueva Aventura ‚öîÔ∏è</strong>', '');
            addStory(`Eres <strong>${game.player.name}</strong>, un ${game.player.race.name} ${game.player.race.icon} en busca de fortuna y gloria.`, 'narrative');
            addStory(`Equipado con ${game.player.weapon.name} y ${game.player.armor.name}. Tienes ${game.player.silver} MP.`, 'system');
            updateUI(); showExploreActions();
        }

        // ==================== TABS ====================
        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function switchEditorTab(tab) {
            document.querySelectorAll('.editor-tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.editor-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Editor').classList.add('active');
            if (tab === 'enemies' || tab === 'npcs') updateDropSelects();
        }

        // ==================== EDITOR - EDIT ALL ====================
        let editingId = null;

        function saveToFirebase() {
            if (db && fbConnected) db.ref('gameData').set(gameData);
            localStorage.setItem('rpgGameData', JSON.stringify(gameData));
        }

        function clearForm(type) {
            editingId = null;
            const fields = {
                weapon: ['wId', 'wName', 'wDamage', 'wIcon', 'wSprite', 'wValue', 'wDesc'],
                armor: ['aId', 'aName', 'aDefense', 'aIcon', 'aSprite', 'aValue', 'aDesc'],
                item: ['iId', 'iName', 'iIcon', 'iSprite', 'iEffect', 'iValue', 'iDesc'],
                enemy: ['enId', 'enName', 'enHealth', 'enDamage', 'enDiff', 'enIcon', 'enSprite', 'enLootMin', 'enLootMax', 'enDesc'],
                pet: ['petId', 'petName', 'petHealth', 'petDamage', 'petDiff', 'petIcon', 'petSprite', 'petDesc'],
                npc: ['npcId', 'npcName', 'npcIcon', 'npcSprite', 'npcLocation', 'npcDialogue']
            };
            (fields[type] || []).forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            document.querySelectorAll('.multi-select input').forEach(c => c.checked = false);
        }

        // WEAPONS
        function saveWeapon() {
            const id = document.getElementById('wId').value || 'w_' + Date.now();
            const w = { id, name: document.getElementById('wName').value, damage: document.getElementById('wDamage').value, icon: document.getElementById('wIcon').value || '‚öîÔ∏è', sprite: document.getElementById('wSprite').value || '', rarity: document.getElementById('wRarity').value, value: parseInt(document.getElementById('wValue').value) || 10, effect: document.getElementById('wEffect').value || null, desc: document.getElementById('wDesc').value || '' };
            if (!w.name || !w.damage) { toast('Faltan campos', 'error'); return; }
            const idx = gameData.weapons.findIndex(x => x.id === id);
            if (idx >= 0) gameData.weapons[idx] = w; else gameData.weapons.push(w);
            saveToFirebase(); renderWeaponsList(); updateDropSelects(); clearForm('weapon'); toast('Guardado', 'success');
        }

        function editWeapon(id) {
            const w = gameData.weapons.find(x => x.id === id); if (!w) return;
            editingId = id;
            document.getElementById('wId').value = w.id;
            document.getElementById('wName').value = w.name;
            document.getElementById('wDamage').value = w.damage;
            document.getElementById('wIcon').value = w.icon || '';
            document.getElementById('wSprite').value = w.sprite || '';
            document.getElementById('wRarity').value = w.rarity || 'common';
            document.getElementById('wValue').value = w.value || '';
            document.getElementById('wEffect').value = w.effect || '';
            document.getElementById('wDesc').value = w.desc || '';
        }

        function deleteWeapon(id) { if (!confirm('¬øEliminar?')) return; gameData.weapons = gameData.weapons.filter(x => x.id !== id); saveToFirebase(); renderWeaponsList(); updateDropSelects(); toast('Eliminado', 'info'); }

        // ARMORS
        function saveArmor() {
            const id = document.getElementById('aId').value || 'a_' + Date.now();
            const a = { id, name: document.getElementById('aName').value, defense: parseInt(document.getElementById('aDefense').value) || 0, icon: document.getElementById('aIcon').value || 'üõ°Ô∏è', sprite: document.getElementById('aSprite').value || '', rarity: document.getElementById('aRarity').value, value: parseInt(document.getElementById('aValue').value) || 10, desc: document.getElementById('aDesc').value || '' };
            if (!a.name) { toast('Falta nombre', 'error'); return; }
            const idx = gameData.armors.findIndex(x => x.id === id);
            if (idx >= 0) gameData.armors[idx] = a; else gameData.armors.push(a);
            saveToFirebase(); renderArmorsList(); updateDropSelects(); clearForm('armor'); toast('Guardado', 'success');
        }

        function editArmor(id) { const a = gameData.armors.find(x => x.id === id); if (!a) return; document.getElementById('aId').value = a.id; document.getElementById('aName').value = a.name; document.getElementById('aDefense').value = a.defense || ''; document.getElementById('aIcon').value = a.icon || ''; document.getElementById('aSprite').value = a.sprite || ''; document.getElementById('aRarity').value = a.rarity || 'common'; document.getElementById('aValue').value = a.value || ''; document.getElementById('aDesc').value = a.desc || ''; }
        function deleteArmor(id) { if (!confirm('¬øEliminar?')) return; gameData.armors = gameData.armors.filter(x => x.id !== id); saveToFirebase(); renderArmorsList(); updateDropSelects(); toast('Eliminado', 'info'); }

        // ITEMS
        function saveItem() {
            const id = document.getElementById('iId').value || 'i_' + Date.now();
            const i = { id, name: document.getElementById('iName').value, type: document.getElementById('iType').value, icon: document.getElementById('iIcon').value || 'üì¶', sprite: document.getElementById('iSprite').value || '', effect: document.getElementById('iEffect').value, value: parseInt(document.getElementById('iValue').value) || 10, desc: document.getElementById('iDesc').value || '', rarity: document.getElementById('iRarity').value };
            if (!i.name) { toast('Falta nombre', 'error'); return; }
            const idx = gameData.items.findIndex(x => x.id === id);
            if (idx >= 0) gameData.items[idx] = i; else gameData.items.push(i);
            saveToFirebase(); renderItemsList(); updateDropSelects(); clearForm('item'); toast('Guardado', 'success');
        }

        function editItem(id) { const i = gameData.items.find(x => x.id === id); if (!i) return; document.getElementById('iId').value = i.id; document.getElementById('iName').value = i.name; document.getElementById('iType').value = i.type || 'potion'; document.getElementById('iIcon').value = i.icon || ''; document.getElementById('iSprite').value = i.sprite || ''; document.getElementById('iEffect').value = i.effect || ''; document.getElementById('iValue').value = i.value || ''; document.getElementById('iDesc').value = i.desc || ''; document.getElementById('iRarity').value = i.rarity || 'common'; }
        function deleteItem(id) { if (!confirm('¬øEliminar?')) return; gameData.items = gameData.items.filter(x => x.id !== id); saveToFirebase(); renderItemsList(); updateDropSelects(); toast('Eliminado', 'info'); }

        // ENEMIES
        function saveEnemy() {
            const id = document.getElementById('enId').value || 'e_' + Date.now();
            const drops = Array.from(document.querySelectorAll('#enDropsSelect input:checked')).map(c => c.value);
            const e = { id, name: document.getElementById('enName').value, health: parseInt(document.getElementById('enHealth').value) || 20, damage: document.getElementById('enDamage').value || '1d6', difficulty: parseInt(document.getElementById('enDiff').value) || 10, icon: document.getElementById('enIcon').value || 'üëπ', sprite: document.getElementById('enSprite').value || '', effect: document.getElementById('enEffect').value || null, habitat: document.getElementById('enHabitat').value || 'any', loot: [parseInt(document.getElementById('enLootMin').value) || 5, parseInt(document.getElementById('enLootMax').value) || 20], drops, desc: document.getElementById('enDesc').value || '' };
            if (!e.name) { toast('Falta nombre', 'error'); return; }
            const idx = gameData.enemies.findIndex(x => x.id === id);
            if (idx >= 0) gameData.enemies[idx] = e; else gameData.enemies.push(e);
            saveToFirebase(); renderEnemiesList(); clearForm('enemy'); toast('Guardado', 'success');
        }

        function editEnemy(id) { const e = gameData.enemies.find(x => x.id === id); if (!e) return; document.getElementById('enId').value = e.id; document.getElementById('enName').value = e.name; document.getElementById('enHealth').value = e.health || ''; document.getElementById('enDamage').value = e.damage || ''; document.getElementById('enDiff').value = e.difficulty || '10'; document.getElementById('enIcon').value = e.icon || ''; document.getElementById('enSprite').value = e.sprite || ''; document.getElementById('enEffect').value = e.effect || ''; document.getElementById('enHabitat').value = e.habitat || 'any'; document.getElementById('enLootMin').value = e.loot?.[0] || ''; document.getElementById('enLootMax').value = e.loot?.[1] || ''; document.getElementById('enDesc').value = e.desc || ''; setTimeout(() => document.querySelectorAll('#enDropsSelect input').forEach(c => c.checked = (e.drops || []).includes(c.value)), 50); }
        function deleteEnemy(id) { if (!confirm('¬øEliminar?')) return; gameData.enemies = gameData.enemies.filter(x => x.id !== id); saveToFirebase(); renderEnemiesList(); toast('Eliminado', 'info'); }

        // PETS
        function savePet() {
            const id = document.getElementById('petId').value || 'p_' + Date.now();
            const p = { id, name: document.getElementById('petName').value, health: parseInt(document.getElementById('petHealth').value) || 20, damage: document.getElementById('petDamage').value || '1d4', difficulty: parseInt(document.getElementById('petDiff').value) || 24, icon: document.getElementById('petIcon').value || 'üê∫', sprite: document.getElementById('petSprite').value || '', desc: document.getElementById('petDesc').value || '' };
            if (!p.name) { toast('Falta nombre', 'error'); return; }
            const idx = gameData.pets.findIndex(x => x.id === id);
            if (idx >= 0) gameData.pets[idx] = p; else gameData.pets.push(p);
            saveToFirebase(); renderPetsList(); clearForm('pet'); toast('Guardado', 'success');
        }

        function editPet(id) { const p = gameData.pets.find(x => x.id === id); if (!p) return; document.getElementById('petId').value = p.id; document.getElementById('petName').value = p.name; document.getElementById('petHealth').value = p.health || ''; document.getElementById('petDamage').value = p.damage || ''; document.getElementById('petDiff').value = p.difficulty || '24'; document.getElementById('petIcon').value = p.icon || ''; document.getElementById('petSprite').value = p.sprite || ''; document.getElementById('petDesc').value = p.desc || ''; }
        function deletePet(id) { if (!confirm('¬øEliminar?')) return; gameData.pets = gameData.pets.filter(x => x.id !== id); saveToFirebase(); renderPetsList(); toast('Eliminado', 'info'); }

        // NPCS
        function saveNpc() {
            const id = document.getElementById('npcId').value || 'n_' + Date.now();
            const sells = Array.from(document.querySelectorAll('#npcShopSelect input:checked')).map(c => c.value);
            const n = { id, name: document.getElementById('npcName').value, role: document.getElementById('npcRole').value, icon: document.getElementById('npcIcon').value || 'üßî', sprite: document.getElementById('npcSprite').value || '', location: document.getElementById('npcLocation').value || '', dialogue: document.getElementById('npcDialogue').value || '', sells };
            if (!n.name) { toast('Falta nombre', 'error'); return; }
            const idx = gameData.npcs.findIndex(x => x.id === id);
            if (idx >= 0) gameData.npcs[idx] = n; else gameData.npcs.push(n);
            saveToFirebase(); renderNpcsList(); clearForm('npc'); toast('Guardado', 'success');
        }

        function editNpc(id) { const n = gameData.npcs.find(x => x.id === id); if (!n) return; document.getElementById('npcId').value = n.id; document.getElementById('npcName').value = n.name; document.getElementById('npcRole').value = n.role || 'merchant'; document.getElementById('npcIcon').value = n.icon || ''; document.getElementById('npcSprite').value = n.sprite || ''; document.getElementById('npcLocation').value = n.location || ''; document.getElementById('npcDialogue').value = n.dialogue || ''; setTimeout(() => document.querySelectorAll('#npcShopSelect input').forEach(c => c.checked = (n.sells || []).includes(c.value)), 50); }
        function deleteNpc(id) { if (!confirm('¬øEliminar?')) return; gameData.npcs = gameData.npcs.filter(x => x.id !== id); saveToFirebase(); renderNpcsList(); toast('Eliminado', 'info'); }

        function renderAllLists() { renderWeaponsList(); renderArmorsList(); renderItemsList(); renderEnemiesList(); renderPetsList(); renderNpcsList(); }

        function renderWeaponsList() { document.getElementById('weaponsList').innerHTML = gameData.weapons.map(w => `<div class="item-card" onclick="editWeapon('${w.id}')"><span class="item-card-icon">${getSprite(w)}</span><div class="item-card-info"><div class="item-card-name">${w.name}</div><div class="item-card-stats">${w.damage} | ${w.value}MP</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();editWeapon('${w.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();deleteWeapon('${w.id}')">üóëÔ∏è</button></div></div>`).join(''); }
        function renderArmorsList() { document.getElementById('armorsList').innerHTML = gameData.armors.map(a => `<div class="item-card" onclick="editArmor('${a.id}')"><span class="item-card-icon">${getSprite(a)}</span><div class="item-card-info"><div class="item-card-name">${a.name}</div><div class="item-card-stats">Def:${a.defense} | ${a.value}MP</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();editArmor('${a.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();deleteArmor('${a.id}')">üóëÔ∏è</button></div></div>`).join(''); }
        function renderItemsList() { document.getElementById('itemsList').innerHTML = gameData.items.map(i => `<div class="item-card" onclick="editItem('${i.id}')"><span class="item-card-icon">${getSprite(i)}</span><div class="item-card-info"><div class="item-card-name">${i.name}</div><div class="item-card-stats">${i.type} | ${i.value}MP</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();editItem('${i.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();deleteItem('${i.id}')">üóëÔ∏è</button></div></div>`).join(''); }
        function renderEnemiesList() { document.getElementById('enemiesList').innerHTML = gameData.enemies.map(e => `<div class="item-card" onclick="editEnemy('${e.id}')"><span class="item-card-icon">${getSprite(e)}</span><div class="item-card-info"><div class="item-card-name">${e.name}</div><div class="item-card-stats">HP:${e.health} | ${e.damage} | Dif:${e.difficulty}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();editEnemy('${e.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();deleteEnemy('${e.id}')">üóëÔ∏è</button></div></div>`).join(''); }
        function renderPetsList() { document.getElementById('petsList').innerHTML = gameData.pets.map(p => `<div class="item-card" onclick="editPet('${p.id}')"><span class="item-card-icon">${getSprite(p)}</span><div class="item-card-info"><div class="item-card-name">${p.name}</div><div class="item-card-stats">HP:${p.health} | ${p.damage} | D${p.difficulty}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();editPet('${p.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();deletePet('${p.id}')">üóëÔ∏è</button></div></div>`).join(''); }
        function renderNpcsList() { const roleNames = { merchant: 'Comerciante', blacksmith: 'Herrero', alchemist: 'Alquimista', innkeeper: 'Tabernero', baker: 'Panadero', healer: 'Curandero', guard: 'Guardia', questgiver: 'Misiones', villager: 'Aldeano' }; document.getElementById('npcsList').innerHTML = gameData.npcs.map(n => `<div class="item-card" onclick="editNpc('${n.id}')"><span class="item-card-icon">${getSprite(n)}</span><div class="item-card-info"><div class="item-card-name">${n.name}</div><div class="item-card-stats">${roleNames[n.role] || n.role}</div></div><div class="item-card-actions"><button class="icon-btn" onclick="event.stopPropagation();editNpc('${n.id}')">‚úèÔ∏è</button><button class="icon-btn delete" onclick="event.stopPropagation();deleteNpc('${n.id}')">üóëÔ∏è</button></div></div>`).join(''); }

        function updateDropSelects() {
            const all = [...gameData.weapons, ...gameData.armors, ...gameData.items];
            document.getElementById('enDropsSelect').innerHTML = all.map(it => `<label><input type="checkbox" value="${it.id}"> ${it.icon} ${it.name}</label>`).join('');
            document.getElementById('npcShopSelect').innerHTML = all.map(it => `<label><input type="checkbox" value="${it.id}"> ${it.icon} ${it.name}</label>`).join('');
        }

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            const savedData = localStorage.getItem('rpgGameData');
            if (savedData) { try { gameData = JSON.parse(savedData); } catch(e) {} }
            renderAllLists();
            updateDropSelects();
            
            const saved = localStorage.getItem('rpgSave');
            if (saved) {
                addStory('<span style="color:var(--gold);">Aventuras de Acero y Runas</span>', '');
                addStory('Partida guardada encontrada.', 'system');
                setActions([
                    { text: 'üÜï Nuevo', fn: startNewGame, cls: 'primary' },
                    { text: 'üìÇ Continuar', fn: () => { try { const data = JSON.parse(saved); if (data.player) { game.player = Object.assign(new Player(), data.player); if (data.location) game.location = data.location; updateUI(); showExploreActions(); addStory('Partida cargada.', 'system'); } } catch(e) { startNewGame(); } } }
                ]);
            } else startNewGame();
        });
    </script>
</body>
</html>
